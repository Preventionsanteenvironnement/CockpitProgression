<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard â€” Cockpit Progression PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --primary: #6366f1;
            --primary-light: #e0e7ff;
            --success: #22c55e;
            --success-light: #dcfce7;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --border: #e2e8f0;
            --radius: 14px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* â”€â”€ LOGIN â”€â”€ */
        .login-screen {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
        }
        .login-card {
            background: var(--card); border-radius: 20px; padding: 50px 40px;
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            max-width: 400px; width: 100%;
        }
        .login-icon { font-size: 3.5em; margin-bottom: 15px; }
        .login-card h2 { font-size: 1.6em; font-weight: 800; margin-bottom: 8px; }
        .login-card p { color: var(--muted); margin-bottom: 30px; }
        .btn-google {
            display: inline-flex; align-items: center; gap: 12px;
            padding: 14px 30px; border: 2px solid var(--border); border-radius: 50px;
            background: white; font-size: 1em; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: all 0.2s;
        }
        .btn-google:hover { border-color: var(--primary); background: var(--primary-light); }

        /* â”€â”€ HEADER â”€â”€ */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header h1 { font-size: 1.5em; font-weight: 800; }
        .back-link {
            font-size: 0.85em; color: var(--muted); text-decoration: none;
            display: inline-flex; align-items: center; gap: 4px;
        }
        .back-link:hover { color: var(--primary); }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .user-email { font-size: 0.8em; color: var(--muted); }
        .btn-logout {
            padding: 8px 16px; border: 1px solid var(--border); border-radius: 8px;
            background: white; font-size: 0.8em; cursor: pointer; font-family: inherit;
        }
        .btn-logout:hover { background: var(--danger-light); color: var(--danger); border-color: var(--danger); }

        /* â”€â”€ TABS â”€â”€ */
        .tabs {
            display: flex; gap: 4px; margin-bottom: 20px; background: var(--bg);
            border-radius: 12px; padding: 4px; border: 1px solid var(--border);
            overflow-x: auto; -webkit-overflow-scrolling: touch;
        }
        .tab {
            flex: 1; padding: 10px 15px; border: none; border-radius: 10px;
            background: transparent; font-family: inherit; font-size: 0.82em;
            font-weight: 600; cursor: pointer; color: var(--muted);
            transition: all 0.2s; white-space: nowrap; min-width: fit-content;
        }
        .tab.active { background: white; color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }

        .section { display: none; }
        .section.active { display: block; }

        /* â”€â”€ CARD â”€â”€ */
        .card {
            background: var(--card); border-radius: var(--radius); padding: 22px;
            margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .card-title {
            font-weight: 700; font-size: 1em; margin-bottom: 18px;
            display: flex; align-items: center; gap: 8px;
        }
        .card-title .count {
            background: var(--primary-light); color: var(--primary);
            padding: 2px 10px; border-radius: 20px; font-size: 0.8em;
        }

        /* â”€â”€ SELECT â”€â”€ */
        select {
            padding: 12px 40px 12px 14px;
            border: 2px solid var(--border); border-radius: 12px;
            font-size: 0.95em; font-family: inherit;
            background: white; color: var(--text);
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center; background-size: 18px;
            cursor: pointer;
        }
        select:focus { outline: none; border-color: var(--primary); }

        /* â”€â”€ FILTERS â”€â”€ */
        .filter-bar {
            display: flex; align-items: center; gap: 12px; margin-bottom: 18px;
            flex-wrap: wrap;
        }
        .filter-bar label { font-size: 0.85em; font-weight: 700; color: var(--muted); }

        /* â”€â”€ LEGEND â”€â”€ */
        .legend {
            display: flex; flex-wrap: wrap; gap: 14px; margin-bottom: 18px;
            font-size: 0.75em; font-weight: 600; color: var(--muted);
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-dot {
            width: 14px; height: 14px; border-radius: 4px; flex-shrink: 0;
        }

        /* â”€â”€ TIMELINE BY CLASS â”€â”€ */
        .timeline-weeks {
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        .timeline-row {
            display: flex; gap: 3px; min-width: max-content; margin-bottom: 8px;
        }
        .timeline-cell {
            width: 36px; height: 40px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.6em; font-weight: 700; color: white; cursor: default;
            position: relative; flex-shrink: 0;
        }
        .timeline-cell.c-normal { background: #e2e8f0; color: var(--muted); }
        .timeline-cell.c-vacances { background: #f0f0f0; color: #ccc; }
        .timeline-cell.c-realise { background: var(--success); }
        .timeline-cell.c-en-cours { background: var(--warning); }
        .timeline-cell.c-annule { background: var(--danger); }
        .timeline-cell.c-pfmp { background: #8b5cf6; }
        .timeline-cell.c-sortie { background: #06b6d4; }
        .timeline-cell.c-bac { background: #ec4899; }
        .timeline-cell.c-ferie { background: #a1a1aa; }
        .timeline-cell.c-current { outline: 3px solid var(--primary); outline-offset: 1px; }

        .timeline-cell .tooltip {
            display: none; position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%); background: var(--text); color: white;
            padding: 6px 10px; border-radius: 8px; font-size: 1.6em; font-weight: 500;
            white-space: nowrap; z-index: 50; margin-bottom: 6px;
            pointer-events: none; min-width: 120px; text-align: center;
        }
        .timeline-cell:hover .tooltip { display: block; }

        .month-headers {
            display: flex; gap: 3px; margin-bottom: 4px; min-width: max-content;
        }
        .month-label {
            font-size: 0.7em; font-weight: 700; color: var(--muted);
            text-align: center; flex-shrink: 0;
        }

        /* â”€â”€ MODULE GRID â”€â”€ */
        .module-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }
        .module-class-card {
            padding: 14px; border-radius: 12px; border: 2px solid var(--border);
            transition: all 0.15s;
        }
        .module-class-card:hover { border-color: var(--primary); }
        .mc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .mc-classe { font-weight: 800; font-size: 0.9em; }
        .mc-badge {
            padding: 3px 10px; border-radius: 20px; font-size: 0.7em; font-weight: 700;
        }
        .mc-badge.b-terminee { background: var(--success-light); color: #166534; }
        .mc-badge.b-en-cours { background: var(--warning-light); color: #92400e; }
        .mc-badge.b-non-commence { background: #f1f5f9; color: var(--muted); }
        .mc-badge.b-eval { background: #dbeafe; color: #1e40af; }
        .mc-detail { font-size: 0.78em; color: var(--muted); }
        .mc-progress { margin-top: 8px; height: 6px; background: #f1f5f9; border-radius: 3px; overflow: hidden; }
        .mc-progress-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .mc-progress-fill.p-success { background: var(--success); }
        .mc-progress-fill.p-warning { background: var(--warning); }

        /* â”€â”€ YEAR TIMELINE â”€â”€ */
        .year-grid {
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        .year-table { border-collapse: separate; border-spacing: 2px; min-width: max-content; }
        .year-table th {
            font-size: 0.65em; font-weight: 700; color: var(--muted);
            padding: 4px 2px; text-align: center; position: sticky; top: 0;
            background: var(--card); z-index: 2;
        }
        .year-table td.class-label {
            font-size: 0.72em; font-weight: 700; padding: 4px 10px 4px 4px;
            white-space: nowrap; position: sticky; left: 0;
            background: var(--card); z-index: 1;
        }
        .year-table td.week-cell {
            width: 20px; height: 22px; border-radius: 3px; cursor: default;
            position: relative;
        }
        .year-table td.week-cell .tooltip {
            display: none; position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%); background: var(--text); color: white;
            padding: 5px 9px; border-radius: 6px; font-size: 10px; font-weight: 500;
            white-space: nowrap; z-index: 50; margin-bottom: 4px;
            pointer-events: none;
        }
        .year-table td.week-cell:hover .tooltip { display: block; }

        /* â”€â”€ ALERTS â”€â”€ */
        .alert-item {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 16px; border-radius: 10px; margin-bottom: 8px;
            font-size: 0.85em; font-weight: 500;
        }
        .alert-item.warn { background: var(--warning-light); color: #92400e; }
        .alert-item.err { background: var(--danger-light); color: #991b1b; }
        .alert-item.info { background: #dbeafe; color: #1e40af; }
        .alert-icon { font-size: 1.2em; flex-shrink: 0; }
        .alert-text { flex: 1; }
        .alert-date { font-size: 0.8em; color: inherit; opacity: 0.7; white-space: nowrap; }

        /* â”€â”€ STATS ROW â”€â”€ */
        .stats-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px; margin-bottom: 20px;
        }
        .mini-stat {
            background: var(--card); border-radius: 12px; padding: 14px;
            text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .mini-stat .val { font-size: 1.8em; font-weight: 800; }
        .mini-stat .lbl { font-size: 0.7em; color: var(--muted); font-weight: 600; margin-top: 2px; }
        .mini-stat.s-primary .val { color: var(--primary); }
        .mini-stat.s-success .val { color: var(--success); }
        .mini-stat.s-warning .val { color: var(--warning); }
        .mini-stat.s-danger .val { color: var(--danger); }

        /* â”€â”€ EMPTY â”€â”€ */
        .empty { text-align: center; padding: 40px 20px; color: var(--muted); }
        .empty .icon { font-size: 2.5em; margin-bottom: 10px; }

        /* â”€â”€ TOAST â”€â”€ */
        .toast {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success); color: white;
            padding: 14px 30px; border-radius: 14px;
            font-weight: 700; z-index: 1000; opacity: 0;
            transition: all 0.3s ease; font-size: 0.95em;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* â”€â”€ RESPONSIVE â”€â”€ */
        @media (max-width: 700px) {
            .container { padding: 12px; }
            .header h1 { font-size: 1.2em; }
            .tabs { gap: 2px; }
            .tab { padding: 8px 10px; font-size: 0.75em; }
            .timeline-cell { width: 28px; height: 32px; font-size: 0.5em; }
            .module-grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â• -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <div class="login-icon">ğŸ“ˆ</div>
        <h2>Dashboard Progression</h2>
        <p>Suivi de progression PSE</p>
        <button class="btn-google" id="btnGoogle">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Connexion Google
        </button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â• -->
<div id="mainScreen" style="display:none;">
<div class="container">

    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <a href="index.html" class="back-link">â† Accueil</a>
            <h1>ğŸ“ˆ Dashboard</h1>
        </div>
        <div class="header-actions">
            <span class="user-email" id="userEmail"></span>
            <button class="btn-logout" id="btnLogout">Deco</button>
        </div>
    </div>

    <!-- STATS -->
    <div class="stats-row" id="statsRow">
        <div class="mini-stat s-primary"><div class="val" id="stClasses">-</div><div class="lbl">Classes</div></div>
        <div class="mini-stat s-success"><div class="val" id="stRealise">-</div><div class="lbl">Semaines validees</div></div>
        <div class="mini-stat s-warning"><div class="val" id="stEnCours">-</div><div class="lbl">En cours</div></div>
        <div class="mini-stat s-danger"><div class="val" id="stAlertes">-</div><div class="lbl">Alertes</div></div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab active" data-tab="classe">Par classe</button>
        <button class="tab" data-tab="module">Par module</button>
        <button class="tab" data-tab="timeline">Timeline annee</button>
        <button class="tab" data-tab="alertes">Alertes</button>
    </div>

    <!-- â”€â”€ VUE 1 : PAR CLASSE â”€â”€ -->
    <div id="tabClasse" class="section active">
        <div class="filter-bar">
            <label>Classe :</label>
            <select id="filterClasse"><option value="">-- Toutes --</option></select>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-dot" style="background:var(--success);"></div> Realise</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--warning);"></div> En cours</div>
            <div class="legend-item"><div class="legend-dot" style="background:#e2e8f0;"></div> Normal (a faire)</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--danger);"></div> Annule</div>
            <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;"></div> PFMP</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f0f0f0; border:1px solid #ddd;"></div> Vacances</div>
            <div class="legend-item"><div class="legend-dot" style="background:#06b6d4;"></div> Sortie</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ec4899;"></div> BAC</div>
        </div>

        <div id="classeContent">
            <div class="empty"><div class="icon">ğŸ“¥</div><p>Importez vos CSV depuis l'accueil.</p></div>
        </div>
    </div>

    <!-- â”€â”€ VUE 2 : PAR MODULE â”€â”€ -->
    <div id="tabModule" class="section">
        <div class="filter-bar">
            <label>Module :</label>
            <select id="filterModule"><option value="">-- Tous --</option></select>
        </div>

        <div id="moduleContent">
            <div class="empty"><div class="icon">ğŸ“¥</div><p>Importez vos CSV depuis l'accueil.</p></div>
        </div>
    </div>

    <!-- â”€â”€ VUE 3 : TIMELINE ANNEE â”€â”€ -->
    <div id="tabTimeline" class="section">
        <div class="legend">
            <div class="legend-item"><div class="legend-dot" style="background:var(--success);"></div> Realise</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--warning);"></div> En cours</div>
            <div class="legend-item"><div class="legend-dot" style="background:#e2e8f0;"></div> A faire</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f0f0f0; border:1px solid #ddd;"></div> Vacances</div>
            <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;"></div> PFMP</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--danger);"></div> Annule</div>
        </div>

        <div class="card">
            <div class="card-title">Progression annuelle toutes classes</div>
            <div id="timelineContent" class="year-grid">
                <div class="empty"><div class="icon">ğŸ“¥</div><p>Importez vos CSV depuis l'accueil.</p></div>
            </div>
        </div>
    </div>

    <!-- â”€â”€ VUE 4 : ALERTES â”€â”€ -->
    <div id="tabAlertes" class="section">
        <div id="alertesContent">
            <div class="empty"><div class="icon">âœ…</div><p>Aucune alerte.</p></div>
        </div>
    </div>

</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
        getFirestore, doc, getDocs, collection
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import {
        getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect,
        getRedirectResult, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // â•â•â•â•â•â•â• FIREBASE â•â•â•â•â•â•â•
    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.firebasestorage.app",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    let allPrevue = [];
    let allLogs = [];
    let logsByClasse = {};

    // â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            loadAll();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
        }
    });

    document.getElementById('btnGoogle').addEventListener('click', async () => {
        try { await signInWithPopup(auth, googleProvider); }
        catch (e) {
            if (e.code === 'auth/popup-blocked' || e.code === 'auth/cancelled-popup-request') {
                await signInWithRedirect(auth, googleProvider);
            } else { alert('Erreur: ' + e.message); }
        }
    });
    getRedirectResult(auth).catch(function() {});
    document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

    // â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•
    document.querySelectorAll('.tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
            btn.classList.add('active');
            document.getElementById('tab' + capitalize(btn.dataset.tab)).classList.add('active');
        });
    });

    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    // â•â•â•â•â•â•â• LOAD ALL DATA â•â•â•â•â•â•â•
    async function loadAll() {
        try {
            var prevueSnap = await getDocs(collection(db, 'progression_prevue'));
            allPrevue = [];
            prevueSnap.forEach(function(d) { allPrevue.push({ id: d.id, ...d.data() }); });
            allPrevue.sort(function(a, b) { return a.classeId.localeCompare(b.classeId); });

            var logsSnap = await getDocs(collection(db, 'progression_logs'));
            allLogs = [];
            logsSnap.forEach(function(d) { allLogs.push({ id: d.id, ...d.data() }); });

            // Index logs by classeId
            logsByClasse = {};
            allLogs.forEach(function(log) {
                var key = log.classeId || log.classeDocId || '';
                if (!logsByClasse[key]) logsByClasse[key] = [];
                logsByClasse[key].push(log);
            });

            renderStats();
            populateFilters();
            renderClasseView();
            renderModuleView();
            renderTimeline();
            renderAlertes();
        } catch (err) {
            console.error('loadAll error:', err);
        }
    }

    // â•â•â•â•â•â•â• STATS â•â•â•â•â•â•â•
    function renderStats() {
        document.getElementById('stClasses').textContent = allPrevue.length;

        var totalRealise = 0;
        var totalEnCours = 0;
        allPrevue.forEach(function(p) {
            (p.semaines || []).forEach(function(s) {
                if (s.valide || s.statut === 'Realise' || s.statut === 'RÃ©alisÃ©') totalRealise++;
            });
        });
        // Count "en cours" from logs
        allLogs.forEach(function(log) {
            if (log.statut === 'en_cours') totalEnCours++;
        });

        document.getElementById('stRealise').textContent = totalRealise;
        document.getElementById('stEnCours').textContent = totalEnCours;

        var alertCount = computeAlerts().length;
        document.getElementById('stAlertes').textContent = alertCount;
    }

    // â•â•â•â•â•â•â• FILTERS â•â•â•â•â•â•â•
    function populateFilters() {
        // Classe filter
        var selClasse = document.getElementById('filterClasse');
        selClasse.innerHTML = '<option value="">-- Toutes --</option>';
        allPrevue.forEach(function(p) {
            var opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.classeId + ' (' + p.niveau + ')';
            selClasse.appendChild(opt);
        });
        selClasse.addEventListener('change', renderClasseView);

        // Module filter â€” collect all unique modules across all classes
        var allModules = {};
        allPrevue.forEach(function(p) {
            (p.semaines || []).forEach(function(s) {
                var m = cleanModuleName(s.module || '');
                if (m && m !== 'N/A' && m !== 'Presentation PSE' && m !== 'PrÃ©sentation PSE') {
                    allModules[m] = true;
                }
            });
        });

        var selModule = document.getElementById('filterModule');
        selModule.innerHTML = '<option value="">-- Tous --</option>';
        Object.keys(allModules).sort().forEach(function(m) {
            var opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            selModule.appendChild(opt);
        });
        selModule.addEventListener('change', renderModuleView);
    }

    // â•â•â•â•â•â•â• HELPER : clean module name â•â•â•â•â•â•â•
    function cleanModuleName(raw) {
        if (!raw) return '';
        // Remove evaluation/correction suffixes to get base module
        var cleaned = raw.replace(/\n/g, ' ').trim();
        // Remove trailing " â€“ Ã‰valuation", " â€“ Correction" etc for grouping
        return cleaned;
    }

    // Get base module name (without Ã‰valuation/Correction)
    function baseModuleName(raw) {
        var c = cleanModuleName(raw);
        return c.replace(/\s*[â€“-]\s*(Ã‰valuation|Evaluation|Correction)$/i, '').trim();
    }

    // â•â•â•â•â•â•â• PARSE DATE â•â•â•â•â•â•â•
    function parseDate(dateStr) {
        if (!dateStr) return null;
        // Format: DD/MM/YYYY
        var parts = dateStr.split('/');
        if (parts.length === 3) {
            return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }
        // Try ISO
        var d = new Date(dateStr);
        return isNaN(d.getTime()) ? null : d;
    }

    // Get current week monday date string for highlighting
    function getCurrentWeekMonday() {
        var now = new Date();
        var day = now.getDay();
        var diff = now.getDate() - day + (day === 0 ? -6 : 1);
        var monday = new Date(now);
        monday.setDate(diff);
        var dd = String(monday.getDate()).padStart(2, '0');
        var mm = String(monday.getMonth() + 1).padStart(2, '0');
        return dd + '/' + mm + '/' + monday.getFullYear();
    }

    // â•â•â•â•â•â•â• SITUATION â†’ COLOR CLASS â•â•â•â•â•â•â•
    function situationClass(sem) {
        var sit = (sem.situation || '').toLowerCase();
        if (sit.includes('vacances')) return 'c-vacances';
        if (sit.includes('pfmp')) return 'c-pfmp';
        if (sit.includes('bac')) return 'c-bac';
        if (sit.includes('sortie')) return 'c-sortie';
        if (sit.includes('annul')) return 'c-annule';
        if (sit.includes('feri') || sit.includes('fÃ©ri')) return 'c-ferie';

        // Check if realized from CSV data
        if (sem.valide || sem.statut === 'Realise' || sem.statut === 'RÃ©alisÃ©') return 'c-realise';

        return 'c-normal';
    }

    // Same but for year timeline cells (returns bg color)
    function situationColor(sem) {
        var sit = (sem.situation || '').toLowerCase();
        if (sit.includes('vacances')) return '#f0f0f0';
        if (sit.includes('pfmp')) return '#8b5cf6';
        if (sit.includes('bac')) return '#ec4899';
        if (sit.includes('sortie')) return '#06b6d4';
        if (sit.includes('annul')) return '#dc2626';
        if (sit.includes('feri') || sit.includes('fÃ©ri')) return '#a1a1aa';
        if (sem.valide || sem.statut === 'Realise' || sem.statut === 'RÃ©alisÃ©') return '#22c55e';
        return '#e2e8f0';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VUE 1 : PAR CLASSE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderClasseView() {
        var container = document.getElementById('classeContent');
        var filterVal = document.getElementById('filterClasse').value;

        var classesToShow = filterVal
            ? allPrevue.filter(function(p) { return p.id === filterVal; })
            : allPrevue;

        if (classesToShow.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">ğŸ“¥</div><p>Aucune classe importee.</p></div>';
            return;
        }

        container.innerHTML = '';
        var currentMonday = getCurrentWeekMonday();

        classesToShow.forEach(function(prevue) {
            var card = document.createElement('div');
            card.className = 'card';

            // Title with class name and badge
            var niveauLabel = prevue.niveau === 'CAP' ? 'CAP' : 'BAC PRO';
            var titleHtml = '<div class="card-title">' + prevue.classeId +
                ' <span class="count">' + niveauLabel + '</span></div>';

            // Month headers
            var semaines = prevue.semaines || [];
            var monthsHtml = buildMonthHeaders(semaines);

            // Week cells
            var cellsHtml = '';
            var currentModule = '';
            semaines.forEach(function(sem) {
                var cls = situationClass(sem);
                var isCurrent = sem.date === currentMonday;

                // Determine display text
                var label = sem.semaine || '';
                var module = cleanModuleName(sem.module || '');
                if (module && module !== 'N/A') currentModule = module;

                var tooltipText = sem.date + ' (' + sem.semaine + ')';
                if (module && module !== 'N/A') tooltipText += '\\n' + module;
                if (sem.seance && sem.seance !== 'N/A') tooltipText += ' â€” ' + sem.seance;
                if (sem.situation && sem.situation !== 'Normal') tooltipText += '\\n' + sem.situation;

                cellsHtml += '<div class="timeline-cell ' + cls + (isCurrent ? ' c-current' : '') + '">' +
                    label.replace('S', '') +
                    '<div class="tooltip">' + tooltipText.replace(/\\n/g, '<br>') + '</div>' +
                    '</div>';
            });

            // Module summary table
            var modulesSummary = buildModuleSummary(prevue);

            card.innerHTML = titleHtml +
                '<div class="timeline-weeks">' +
                '<div class="month-headers">' + monthsHtml + '</div>' +
                '<div class="timeline-row">' + cellsHtml + '</div>' +
                '</div>' +
                modulesSummary;

            container.appendChild(card);
        });
    }

    function buildMonthHeaders(semaines) {
        var months = [];
        var currentMonth = -1;
        var count = 0;
        var monthNames = ['Jan', 'Fev', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aout', 'Sep', 'Oct', 'Nov', 'Dec'];

        semaines.forEach(function(sem, idx) {
            var d = parseDate(sem.date);
            if (!d) return;
            var m = d.getMonth();
            if (m !== currentMonth) {
                if (currentMonth >= 0) {
                    months.push({ label: monthNames[currentMonth], count: count });
                }
                currentMonth = m;
                count = 1;
            } else {
                count++;
            }
        });
        if (currentMonth >= 0) {
            months.push({ label: monthNames[currentMonth], count: count });
        }

        var html = '';
        months.forEach(function(m) {
            // Each cell is 36px + 3px gap = 39px
            var width = m.count * 39 - 3;
            html += '<div class="month-label" style="width:' + width + 'px;">' + m.label + '</div>';
        });
        return html;
    }

    function buildModuleSummary(prevue) {
        // Group semaines by module (base name)
        var moduleMap = {};
        var order = [];
        (prevue.semaines || []).forEach(function(s) {
            var m = cleanModuleName(s.module || '');
            if (!m || m === 'N/A') return;
            var base = baseModuleName(m);
            if (!base) return;
            if (!moduleMap[base]) {
                moduleMap[base] = { total: 0, realise: 0, hasEval: false, evalDone: false };
                order.push(base);
            }
            moduleMap[base].total++;
            if (s.valide || s.statut === 'Realise' || s.statut === 'RÃ©alisÃ©') moduleMap[base].realise++;
            if (m.match(/[eÃ©E]valuation/i)) {
                moduleMap[base].hasEval = true;
                if (s.valide || s.statut === 'Realise' || s.statut === 'RÃ©alisÃ©') moduleMap[base].evalDone = true;
            }
        });

        if (order.length === 0) return '';

        var html = '<div style="margin-top:15px;">';
        html += '<div style="font-weight:700; font-size:0.85em; margin-bottom:8px;">Modules :</div>';
        html += '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
        order.forEach(function(name) {
            var info = moduleMap[name];
            var pct = info.total > 0 ? Math.round(info.realise / info.total * 100) : 0;
            var bgColor = pct === 100 ? 'var(--success-light)' : pct > 0 ? 'var(--warning-light)' : '#f1f5f9';
            var borderColor = pct === 100 ? 'var(--success)' : pct > 0 ? 'var(--warning)' : 'var(--border)';
            var textColor = pct === 100 ? '#166534' : pct > 0 ? '#92400e' : 'var(--muted)';

            // Short display name
            var shortName = name.length > 30 ? name.substring(0, 30) + '...' : name;

            html += '<div style="padding:5px 10px; border-radius:8px; font-size:0.72em; font-weight:600; ' +
                'background:' + bgColor + '; border:1px solid ' + borderColor + '; color:' + textColor + ';">' +
                shortName + ' <span style="opacity:0.7;">(' + pct + '%)</span></div>';
        });
        html += '</div></div>';
        return html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VUE 2 : PAR MODULE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderModuleView() {
        var container = document.getElementById('moduleContent');
        var filterVal = document.getElementById('filterModule').value;

        // Collect: for each module, which classes have it and status
        var moduleData = {};

        allPrevue.forEach(function(prevue) {
            (prevue.semaines || []).forEach(function(sem) {
                var m = cleanModuleName(sem.module || '');
                if (!m || m === 'N/A') return;

                var base = baseModuleName(m);
                if (!base) return;

                if (filterVal && base !== filterVal && m !== filterVal) return;

                if (!moduleData[base]) moduleData[base] = {};
                if (!moduleData[base][prevue.classeId]) {
                    moduleData[base][prevue.classeId] = {
                        classeId: prevue.classeId,
                        niveau: prevue.niveau,
                        total: 0,
                        realise: 0,
                        lastSeance: '',
                        evalDone: false,
                        hasEval: false
                    };
                }
                var entry = moduleData[base][prevue.classeId];
                entry.total++;
                if (sem.valide || sem.statut === 'Realise' || sem.statut === 'RÃ©alisÃ©') {
                    entry.realise++;
                    if (sem.seance && sem.seance !== 'N/A') entry.lastSeance = sem.seance;
                }
                if (m.match(/[eÃ©E]valuation/i)) {
                    entry.hasEval = true;
                    if (sem.valide || sem.statut === 'Realise' || sem.statut === 'RÃ©alisÃ©') entry.evalDone = true;
                }
            });
        });

        var moduleNames = Object.keys(moduleData).sort();
        if (moduleNames.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">ğŸ“¥</div><p>Aucun module trouve.</p></div>';
            return;
        }

        container.innerHTML = '';

        moduleNames.forEach(function(moduleName) {
            var classes = moduleData[moduleName];
            var card = document.createElement('div');
            card.className = 'card';

            var classCount = Object.keys(classes).length;
            card.innerHTML = '<div class="card-title">' + moduleName + ' <span class="count">' + classCount + ' classes</span></div>';

            var grid = document.createElement('div');
            grid.className = 'module-grid';

            var classIds = Object.keys(classes).sort();
            classIds.forEach(function(classeId) {
                var info = classes[classeId];
                var pct = info.total > 0 ? Math.round(info.realise / info.total * 100) : 0;

                var statusLabel, badgeClass;
                if (pct === 100) {
                    statusLabel = info.evalDone ? 'Eval terminee' : 'Termine';
                    badgeClass = info.evalDone ? 'b-eval' : 'b-terminee';
                } else if (pct > 0) {
                    statusLabel = 'En cours';
                    badgeClass = 'b-en-cours';
                } else {
                    statusLabel = 'Non commence';
                    badgeClass = 'b-non-commence';
                }

                var detail = info.lastSeance ? 'Dernier : ' + info.lastSeance : pct + '% complete';
                var progressClass = pct === 100 ? 'p-success' : 'p-warning';

                var itemDiv = document.createElement('div');
                itemDiv.className = 'module-class-card';
                itemDiv.innerHTML =
                    '<div class="mc-header">' +
                    '<span class="mc-classe">' + classeId + '</span>' +
                    '<span class="mc-badge ' + badgeClass + '">' + statusLabel + '</span>' +
                    '</div>' +
                    '<div class="mc-detail">' + detail + '</div>' +
                    '<div class="mc-progress"><div class="mc-progress-fill ' + progressClass + '" style="width:' + pct + '%;"></div></div>';

                grid.appendChild(itemDiv);
            });

            card.appendChild(grid);
            container.appendChild(card);
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VUE 3 : TIMELINE ANNEE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderTimeline() {
        var container = document.getElementById('timelineContent');

        if (allPrevue.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">ğŸ“¥</div><p>Aucune donnee importee.</p></div>';
            return;
        }

        // Build table: rows = classes, columns = weeks
        // First, collect all unique week dates across all classes
        var allWeeks = [];
        var weekSet = {};
        allPrevue.forEach(function(p) {
            (p.semaines || []).forEach(function(s) {
                if (s.date && !weekSet[s.date]) {
                    weekSet[s.date] = true;
                    allWeeks.push({ date: s.date, semaine: s.semaine, parsed: parseDate(s.date) });
                }
            });
        });
        allWeeks.sort(function(a, b) {
            if (!a.parsed || !b.parsed) return 0;
            return a.parsed.getTime() - b.parsed.getTime();
        });

        if (allWeeks.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">ğŸ“Š</div><p>Pas de semaines.</p></div>';
            return;
        }

        var currentMonday = getCurrentWeekMonday();

        // Build month header spans
        var monthNames = ['Jan', 'Fev', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aout', 'Sep', 'Oct', 'Nov', 'Dec'];

        var table = document.createElement('table');
        table.className = 'year-table';

        // Header row: month names
        var thead = document.createElement('thead');
        var thRow = document.createElement('tr');
        thRow.innerHTML = '<th></th>'; // Empty cell for class labels

        // Group weeks by month for colspan
        var monthGroups = [];
        var prevMonth = -1;
        allWeeks.forEach(function(w) {
            if (!w.parsed) return;
            var m = w.parsed.getMonth();
            if (m !== prevMonth) {
                monthGroups.push({ month: m, count: 1 });
                prevMonth = m;
            } else {
                monthGroups[monthGroups.length - 1].count++;
            }
        });

        monthGroups.forEach(function(mg) {
            var th = document.createElement('th');
            th.colSpan = mg.count;
            th.textContent = monthNames[mg.month];
            thRow.appendChild(th);
        });
        thead.appendChild(thRow);

        // Week numbers sub-header
        var weekRow = document.createElement('tr');
        weekRow.innerHTML = '<th></th>';
        allWeeks.forEach(function(w) {
            var th = document.createElement('th');
            th.textContent = (w.semaine || '').replace('S', '');
            th.style.fontSize = '0.55em';
            th.style.color = '#94a3b8';
            weekRow.appendChild(th);
        });
        thead.appendChild(weekRow);
        table.appendChild(thead);

        // Body: one row per class
        var tbody = document.createElement('tbody');
        allPrevue.forEach(function(prevue) {
            var tr = document.createElement('tr');

            // Class label cell
            var tdLabel = document.createElement('td');
            tdLabel.className = 'class-label';
            tdLabel.textContent = prevue.classeId;
            tr.appendChild(tdLabel);

            // Build week lookup for this class
            var weekMap = {};
            (prevue.semaines || []).forEach(function(s) {
                weekMap[s.date] = s;
            });

            // One cell per week
            allWeeks.forEach(function(w) {
                var td = document.createElement('td');
                td.className = 'week-cell';
                var sem = weekMap[w.date];
                var color = sem ? situationColor(sem) : '#f8fafc';
                td.style.background = color;

                var isCurrent = w.date === currentMonday;
                if (isCurrent) {
                    td.style.outline = '2px solid var(--primary)';
                    td.style.outlineOffset = '0px';
                    td.style.zIndex = '3';
                    td.style.position = 'relative';
                }

                // Tooltip
                if (sem) {
                    var tipText = w.date + ' (' + w.semaine + ')';
                    var module = cleanModuleName(sem.module || '');
                    if (module && module !== 'N/A') tipText += ' â€” ' + module;
                    if (sem.situation && sem.situation !== 'Normal') tipText += ' â€” ' + sem.situation;
                    td.innerHTML = '<div class="tooltip">' + tipText + '</div>';
                }

                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.innerHTML = '';
        container.appendChild(table);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VUE 4 : ALERTES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function computeAlerts() {
        var alerts = [];

        // 1. From logs: checklist-based alerts
        allLogs.forEach(function(log) {
            var cl = log.checklist || {};
            if (cl.copies_ramassees && !cl.copies_corrigees) {
                alerts.push({
                    type: 'warn', icon: 'ğŸ“',
                    text: log.classeId + ' â€” Copies a corriger',
                    detail: (log.moduleId || '') + (log.seance ? ' â€” ' + log.seance : ''),
                    date: log.date || '',
                    priority: 2
                });
            }
            if (cl.copies_corrigees && !cl.copies_rendues) {
                alerts.push({
                    type: 'warn', icon: 'ğŸ“¤',
                    text: log.classeId + ' â€” Copies a rendre',
                    detail: (log.moduleId || '') + (log.seance ? ' â€” ' + log.seance : ''),
                    date: log.date || '',
                    priority: 1
                });
            }
            if (cl.eval_passee && !cl.eval_corrigee) {
                alerts.push({
                    type: 'err', icon: 'ğŸ”´',
                    text: log.classeId + ' â€” Evaluation a corriger',
                    detail: (log.moduleId || ''),
                    date: log.date || '',
                    priority: 3
                });
            }
            if (cl.eval_corrigee && !cl.eval_rendue) {
                alerts.push({
                    type: 'warn', icon: 'ğŸ“¤',
                    text: log.classeId + ' â€” Evaluation a rendre',
                    detail: (log.moduleId || ''),
                    date: log.date || '',
                    priority: 2
                });
            }
        });

        // 2. Retard vs prevue: semaines before today that are Normal but not validated
        var today = new Date();
        allPrevue.forEach(function(prevue) {
            var behindCount = 0;
            (prevue.semaines || []).forEach(function(sem) {
                if (sem.situation !== 'Normal') return;
                var d = parseDate(sem.date);
                if (!d || d >= today) return;
                if (!sem.valide && sem.statut !== 'Realise' && sem.statut !== 'RÃ©alisÃ©') {
                    behindCount++;
                }
            });
            if (behindCount > 0) {
                alerts.push({
                    type: 'info', icon: 'â°',
                    text: prevue.classeId + ' â€” ' + behindCount + ' semaine' + (behindCount > 1 ? 's' : '') + ' en retard',
                    detail: 'Semaines normales passees non validees',
                    date: '',
                    priority: 1
                });
            }
        });

        // Sort by priority desc, then date desc
        alerts.sort(function(a, b) {
            if (b.priority !== a.priority) return b.priority - a.priority;
            return (b.date || '').localeCompare(a.date || '');
        });

        return alerts;
    }

    function renderAlertes() {
        var container = document.getElementById('alertesContent');
        var alerts = computeAlerts();

        if (alerts.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">âœ…</div><p>Aucune alerte. Tout est a jour !</p></div>';
            return;
        }

        container.innerHTML = '';

        // Group by type
        var errAlerts = alerts.filter(function(a) { return a.type === 'err'; });
        var warnAlerts = alerts.filter(function(a) { return a.type === 'warn'; });
        var infoAlerts = alerts.filter(function(a) { return a.type === 'info'; });

        if (errAlerts.length > 0) {
            var card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = '<div class="card-title">ğŸ”´ Urgences <span class="count">' + errAlerts.length + '</span></div>';
            errAlerts.forEach(function(a) { card.appendChild(createAlertItem(a)); });
            container.appendChild(card);
        }

        if (warnAlerts.length > 0) {
            var card2 = document.createElement('div');
            card2.className = 'card';
            card2.innerHTML = '<div class="card-title">ğŸŸ¡ A traiter <span class="count">' + warnAlerts.length + '</span></div>';
            warnAlerts.forEach(function(a) { card2.appendChild(createAlertItem(a)); });
            container.appendChild(card2);
        }

        if (infoAlerts.length > 0) {
            var card3 = document.createElement('div');
            card3.className = 'card';
            card3.innerHTML = '<div class="card-title">â„¹ï¸ Retards <span class="count">' + infoAlerts.length + '</span></div>';
            infoAlerts.forEach(function(a) { card3.appendChild(createAlertItem(a)); });
            container.appendChild(card3);
        }
    }

    function createAlertItem(alert) {
        var div = document.createElement('div');
        div.className = 'alert-item ' + alert.type;
        div.innerHTML = '<span class="alert-icon">' + alert.icon + '</span>' +
            '<div class="alert-text"><strong>' + alert.text + '</strong>' +
            (alert.detail ? '<br><span style="font-size:0.85em; opacity:0.8;">' + alert.detail + '</span>' : '') +
            '</div>' +
            (alert.date ? '<span class="alert-date">' + alert.date + '</span>' : '');
        return div;
    }

</script>
</body>
</html>
