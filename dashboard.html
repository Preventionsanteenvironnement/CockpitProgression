<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äî Cockpit Progression PSE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --surface: #1e293b;
            --surface-2: #334155;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --primary: #6366f1;
            --primary-light: rgba(99,102,241,0.15);
            --success: #22c55e;
            --success-light: rgba(34,197,94,0.15);
            --warning: #f59e0b;
            --warning-light: rgba(245,158,11,0.15);
            --danger: #dc2626;
            --danger-light: rgba(239,68,68,0.15);
            --border: #334155;
            --radius: 14px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        .login-screen {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
        }
        .login-card {
            background: var(--card); border-radius: 20px; padding: 50px 40px;
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            max-width: 400px; width: 100%;
        }
        .login-icon { font-size: 3.5em; margin-bottom: 15px; }
        .login-card h2 { font-size: 1.6em; font-weight: 800; margin-bottom: 8px; }
        .login-card p { color: var(--muted); margin-bottom: 30px; }
        .btn-google {
            display: inline-flex; align-items: center; gap: 12px;
            padding: 14px 30px; border: 2px solid var(--border); border-radius: 50px;
            background: var(--surface-2); font-size: 1em; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: all 0.2s;
        }
        .btn-google:hover { border-color: var(--primary); background: var(--primary-light); }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header h1 { font-size: 1.5em; font-weight: 800; }
        .back-link {
            font-size: 0.85em; color: var(--muted); text-decoration: none;
            display: inline-flex; align-items: center; gap: 4px;
        }
        .back-link:hover { color: var(--primary); }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .user-email { font-size: 0.8em; color: var(--muted); }
        .btn-logout {
            padding: 8px 16px; border: 1px solid var(--border); border-radius: 8px;
            background: var(--surface-2); font-size: 0.8em; cursor: pointer; font-family: inherit;
        }
        .btn-logout:hover { background: var(--danger-light); color: var(--danger); border-color: var(--danger); }

        /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
        .tabs {
            display: flex; gap: 4px; margin-bottom: 20px; background: var(--bg);
            border-radius: 12px; padding: 4px; border: 1px solid var(--border);
            overflow-x: auto; -webkit-overflow-scrolling: touch;
        }
        .tab {
            flex: 1; padding: 10px 15px; border: none; border-radius: 10px;
            background: transparent; font-family: inherit; font-size: 0.82em;
            font-weight: 600; cursor: pointer; color: var(--muted);
            transition: all 0.2s; white-space: nowrap; min-width: fit-content;
        }
        .tab.active { background: var(--surface-2); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }

        .section { display: none; }
        .section.active { display: block; }

        /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
        .card {
            background: var(--card); border-radius: var(--radius); padding: 22px;
            margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .card-title {
            font-weight: 700; font-size: 1em; margin-bottom: 18px;
            display: flex; align-items: center; gap: 8px;
        }
        .card-title .count {
            background: var(--primary-light); color: var(--primary);
            padding: 2px 10px; border-radius: 20px; font-size: 0.8em;
        }

        /* ‚îÄ‚îÄ SELECT ‚îÄ‚îÄ */
        select {
            padding: 12px 40px 12px 14px;
            border: 2px solid var(--border); border-radius: 12px;
            font-size: 0.95em; font-family: inherit;
            background: var(--surface-2); color: var(--text);
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center; background-size: 18px;
            cursor: pointer;
        }
        select:focus { outline: none; border-color: var(--primary); }

        /* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
        .filter-bar {
            display: flex; align-items: center; gap: 12px; margin-bottom: 18px;
            flex-wrap: wrap;
        }
        .filter-bar label { font-size: 0.85em; font-weight: 700; color: var(--muted); }
        .btn-students {
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text);
            border-radius: 10px;
            padding: 9px 12px;
            font-size: 0.8em;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }
        .btn-students:hover { border-color: var(--primary); color: var(--primary); }
        .students-help {
            font-size: 0.78em;
            color: var(--muted);
            font-weight: 600;
        }

        .students-box {
            margin-top: 14px;
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: 12px;
            padding: 10px 12px;
        }
        .students-box summary {
            cursor: pointer;
            font-size: 0.82em;
            font-weight: 700;
            color: #0f172a;
        }
        .students-list {
            margin-top: 8px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            font-size: 0.78em;
            color: #334155;
        }
        .student-item {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 7px 9px;
            line-height: 1.25;
        }
        .student-code {
            font-weight: 800;
            color: #475569;
            margin-right: 6px;
        }

        /* ‚îÄ‚îÄ LEGEND ‚îÄ‚îÄ */
        .legend {
            display: flex; flex-wrap: wrap; gap: 14px; margin-bottom: 18px;
            font-size: 0.75em; font-weight: 600; color: var(--muted);
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-dot {
            width: 14px; height: 14px; border-radius: 4px; flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ TIMELINE BY CLASS ‚îÄ‚îÄ */
        .timeline-weeks {
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        .timeline-row {
            display: flex; gap: 3px; min-width: max-content; margin-bottom: 8px;
        }
        .timeline-cell {
            width: 36px; height: 40px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.6em; font-weight: 700; color: white; cursor: default;
            position: relative; flex-shrink: 0;
        }
        .timeline-cell.c-normal { background: var(--surface-2); color: var(--muted); }
        .timeline-cell.c-vacances { background: #374151; color: #6b7280; }
        .timeline-cell.c-realise { background: var(--success); }
        .timeline-cell.c-prevu { background: #6366f1; }
        .timeline-cell.c-reporte { background: var(--warning); }
        .timeline-cell.c-non-realise { background: var(--danger); }
        .timeline-cell.c-en-cours { background: var(--warning); }
        .timeline-cell.c-annule { background: var(--danger); }
        .timeline-cell.c-pfmp { background: #8b5cf6; }
        .timeline-cell.c-sortie { background: #06b6d4; }
        .timeline-cell.c-bac { background: #ec4899; }
        .timeline-cell.c-ccf { background: #f472b6; }
        .timeline-cell.c-ferie { background: #a1a1aa; }
        .timeline-cell.c-absence { background: #78716c; }
        .timeline-cell.c-formation { background: #0ea5e9; }
        .timeline-cell.c-current { outline: 3px solid var(--primary); outline-offset: 1px; }
        .timeline-cell .phase-icon { font-size: 1.1em; line-height: 1; }

        .timeline-cell .tooltip {
            display: none; position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%); background: var(--text); color: white;
            padding: 6px 10px; border-radius: 8px; font-size: 1.6em; font-weight: 500;
            white-space: nowrap; z-index: 50; margin-bottom: 6px;
            pointer-events: none; min-width: 120px; text-align: center;
        }
        .timeline-cell:hover .tooltip { display: block; }

        .month-headers {
            display: flex; gap: 3px; margin-bottom: 4px; min-width: max-content;
        }
        .month-label {
            font-size: 0.7em; font-weight: 700; color: var(--muted);
            text-align: center; flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ MODULE GRID ‚îÄ‚îÄ */
        .module-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }
        .module-class-card {
            padding: 14px; border-radius: 12px; border: 2px solid var(--border);
            transition: all 0.15s;
        }
        .module-class-card:hover { border-color: var(--primary); }
        .mc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .mc-classe { font-weight: 800; font-size: 0.9em; }
        .mc-badge {
            padding: 3px 10px; border-radius: 20px; font-size: 0.7em; font-weight: 700;
        }
        .mc-badge.b-terminee { background: var(--success-light); color: #166534; }
        .mc-badge.b-en-cours { background: var(--warning-light); color: #92400e; }
        .mc-badge.b-non-commence { background: #f1f5f9; color: var(--muted); }
        .mc-badge.b-eval { background: #dbeafe; color: #1e40af; }
        .mc-detail { font-size: 0.78em; color: var(--muted); }
        .mc-progress { margin-top: 8px; height: 6px; background: #f1f5f9; border-radius: 3px; overflow: hidden; }
        .mc-progress-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .mc-progress-fill.p-success { background: var(--success); }
        .mc-progress-fill.p-warning { background: var(--warning); }

        /* ‚îÄ‚îÄ YEAR TIMELINE ‚îÄ‚îÄ */
        .year-grid {
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        .year-table { border-collapse: separate; border-spacing: 2px; min-width: max-content; }
        .year-table th {
            font-size: 0.65em; font-weight: 700; color: var(--muted);
            padding: 4px 2px; text-align: center; position: sticky; top: 0;
            background: var(--card); z-index: 2;
        }
        .year-table td.class-label {
            font-size: 0.72em; font-weight: 700; padding: 4px 10px 4px 4px;
            white-space: nowrap; position: sticky; left: 0;
            background: var(--card); z-index: 1;
        }
        .year-table td.week-cell {
            width: 20px; height: 22px; border-radius: 3px; cursor: default;
            position: relative;
        }
        .year-table td.week-cell .tooltip {
            display: none; position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%); background: var(--text); color: white;
            padding: 5px 9px; border-radius: 6px; font-size: 10px; font-weight: 500;
            white-space: nowrap; z-index: 50; margin-bottom: 4px;
            pointer-events: none;
        }
        .year-table td.week-cell:hover .tooltip { display: block; }

        /* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
        .alert-item {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 16px; border-radius: 10px; margin-bottom: 8px;
            font-size: 0.85em; font-weight: 500;
        }
        .alert-item.warn { background: var(--warning-light); color: #92400e; }
        .alert-item.err { background: var(--danger-light); color: #991b1b; }
        .alert-item.info { background: #dbeafe; color: #1e40af; }
        .alert-icon { font-size: 1.2em; flex-shrink: 0; }
        .alert-text { flex: 1; }
        .alert-date { font-size: 0.8em; color: inherit; opacity: 0.7; white-space: nowrap; }

        /* ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ */
        .stats-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px; margin-bottom: 20px;
        }
        .mini-stat {
            background: var(--card); border-radius: 12px; padding: 14px;
            text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .mini-stat .val { font-size: 1.8em; font-weight: 800; }
        .mini-stat .lbl { font-size: 0.7em; color: var(--muted); font-weight: 600; margin-top: 2px; }
        .mini-stat.s-primary .val { color: var(--primary); }
        .mini-stat.s-success .val { color: var(--success); }
        .mini-stat.s-warning .val { color: var(--warning); }
        .mini-stat.s-danger .val { color: var(--danger); }

        /* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
        .empty { text-align: center; padding: 40px 20px; color: var(--muted); }
        .empty .icon { font-size: 2.5em; margin-bottom: 10px; }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success); color: white;
            padding: 14px 30px; border-radius: 14px;
            font-weight: 700; z-index: 1000; opacity: 0;
            transition: all 0.3s ease; font-size: 0.95em;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 700px) {
            .container { padding: 12px; }
            .header h1 { font-size: 1.2em; }
            .tabs { gap: 2px; }
            .tab { padding: 8px 10px; font-size: 0.75em; }
            .timeline-cell { width: 28px; height: 32px; font-size: 0.5em; }
            .module-grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }

        /* ‚îÄ‚îÄ AGENDA ‚îÄ‚îÄ */
        .agenda-day { margin-bottom: 14px; }
        .agenda-day-header { font-weight: 800; font-size: .88em; padding: 8px 12px; border-radius: 10px 10px 0 0; background: var(--bg); border: 1px solid var(--border); border-bottom: none; color: var(--muted); display: flex; align-items: center; gap: 8px; }
        .agenda-day-header.today { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
        .agenda-day-body { border: 1px solid var(--border); border-radius: 0 0 10px 10px; background: var(--surface-2); overflow: hidden; }
        .agenda-slot { display: flex; align-items: stretch; border-bottom: 1px solid #f1f5f9; min-height: 70px; cursor: pointer; transition: all .15s; }
        .agenda-slot:last-child { border-bottom: none; }
        .agenda-slot:hover { background: var(--bg); }
        .agenda-slot:active { transform: scale(.99); }
        .agenda-slot-time { min-width: 70px; padding: 12px 10px; font-size: .72em; font-weight: 700; color: var(--muted); border-right: 3px solid #f1f5f9; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2px; }
        .agenda-slot-time.has-log { border-right-color: var(--success); }
        .agenda-slot-time.is-current { border-right-color: var(--primary); }
        .agenda-slot-body { flex: 1; padding: 10px 13px; display: flex; align-items: center; gap: 10px; }
        .agenda-slot-class { font-weight: 800; font-size: .9em; }
        .agenda-slot-room { font-size: .73em; color: var(--muted); }
        .agenda-slot-status { margin-left: auto; font-size: .78em; font-weight: 700; padding: 4px 10px; border-radius: 15px; white-space: nowrap; }
        .status-realise { background: var(--success-light); color: var(--success); }
        .status-prevu { background: var(--primary-light); color: #4338ca; }
        .status-reporte { background: var(--warning-light); color: #92400e; }
        .status-annule { background: var(--danger-light); color: var(--danger); }
        .status-vide { background: var(--bg); color: var(--muted); }
        .agenda-slot-log { font-size: .73em; color: var(--muted); }
        .agenda-event { padding: 12px 14px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; margin: 8px 12px; }
        .agenda-event.ccf { background: #fce7f3; border-color: #ec4899; }
        .agenda-event.bac { background: #fce7f3; border-color: #ec4899; }
        .agenda-event.pfmp { background: #ede9fe; border-color: #8b5cf6; }
        .agenda-event.reunion { background: rgba(99,102,241,0.12); border-color: #60a5fa; }
        .agenda-event-title { font-weight: 800; font-size: .85em; }
        .agenda-event-detail { font-size: .75em; color: var(--muted); margin-top: 2px; }
        .agenda-event-countdown { font-size: .72em; font-weight: 700; color: var(--danger); margin-top: 3px; }
        .agenda-empty { padding: 20px; text-align: center; font-size: .82em; color: var(--muted); font-style: italic; }
        .week-strip { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 14px; }
        .week-day-card { background: var(--surface-2); border: 2px solid var(--border); border-radius: 10px; padding: 10px 8px; cursor: pointer; transition: all .15s; }
        .week-day-card:hover { border-color: var(--primary); }
        .week-day-card.today { border-color: var(--primary); background: var(--primary-light); }
        .week-day-card.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,.15); }
        .week-day-name { font-size: .68em; font-weight: 700; color: var(--muted); text-transform: uppercase; margin-bottom: 3px; }
        .week-day-num { font-size: 1.2em; font-weight: 800; }
        .week-day-count { font-size: .65em; color: var(--muted); margin-top: 2px; }
        .week-day-dots { display: flex; gap: 2px; flex-wrap: wrap; margin-top: 3px; }
        .week-dot { width: 7px; height: 7px; border-radius: 50%; }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <div class="login-icon">üìà</div>
        <h2>Dashboard Progression</h2>
        <p>Suivi de progression PSE</p>
        <button class="btn-google" id="btnGoogle">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Connexion Google
        </button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="mainScreen" style="display:none;">
<div class="container">

    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <a href="index.html" class="back-link">‚Üê Accueil</a>
            <h1>üìà Dashboard</h1>
        </div>
        <div class="header-actions">
            <span class="user-email" id="userEmail"></span>
            <button class="btn-logout" id="btnLogout">Deco</button>
        </div>
    </div>

    <!-- STATS -->
    <div class="stats-row" id="statsRow">
        <div class="mini-stat s-primary"><div class="val" id="stClasses">-</div><div class="lbl">Classes</div></div>
        <div class="mini-stat s-success"><div class="val" id="stRealise">-</div><div class="lbl">Semaines valid√©es</div></div>
        <div class="mini-stat s-warning"><div class="val" id="stEnCours">-</div><div class="lbl">En cours</div></div>
        <div class="mini-stat s-danger"><div class="val" id="stAlertes">-</div><div class="lbl">Alertes</div></div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab active" data-tab="classe">Par classe</button>
        <button class="tab" data-tab="module">Par module</button>
        <button class="tab" data-tab="timeline">Timeline annee</button>
        <button class="tab" data-tab="alertes">Alertes</button>
        <button class="tab" data-tab="agenda">üìÖ Agenda</button>
        <button class="tab" data-tab="meteo">üìä M√©t√©o</button>
    </div>

    <!-- ‚îÄ‚îÄ VUE 1 : PAR CLASSE ‚îÄ‚îÄ -->
    <div id="tabClasse" class="section active">
        <div class="filter-bar">
            <label>Classe :</label>
            <select id="filterClasse"><option value="">-- Toutes --</option></select>
            <input type="file" id="studentsCsvInput" multiple accept=".csv,.txt" style="display:none;">
            <button type="button" class="btn-students" id="btnImportStudents">Importer CSV √©l√®ves</button>
            <button type="button" class="btn-students" id="btnClearStudents">Effacer liste locale</button>
            <span class="students-help" id="studentsStatus">Aucune liste √©l√®ves locale</span>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-dot" style="background:var(--success);"></div> R√©alis√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:#6366f1;"></div> Pr√©vu</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--warning);"></div> Report√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--danger);"></div> Non r√©alis√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--surface-2);"></div> √Ä faire</div>
            <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;"></div> PFMP</div>
            <div class="legend-item"><div class="legend-dot" style="background:#374151; border:1px solid #4b5563;"></div> Vacances</div>
            <div class="legend-item"><div class="legend-dot" style="background:#06b6d4;"></div> Sortie</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ec4899;"></div> BAC / √âpreuves</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f472b6;"></div> CCF</div>
            <div class="legend-item"><div class="legend-dot" style="background:#78716c;"></div> Absence</div>
            <div class="legend-item"><div class="legend-dot" style="background:#a1a1aa;"></div> F√©ri√©</div>
            <div class="legend-item" style="margin-left:10px; font-weight:700;">E=√âval ¬∑ C=Corr ¬∑ 1,2...=S√©ance</div>
        </div>

        <div id="classeContent">
            <div class="empty"><div class="icon">üì•</div><p>Importez vos CSV depuis l'accueil.</p></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ VUE 2 : PAR MODULE ‚îÄ‚îÄ -->
    <div id="tabModule" class="section">
        <div class="filter-bar">
            <label>Module :</label>
            <select id="filterModule"><option value="">-- Tous --</option></select>
        </div>

        <div id="moduleContent">
            <div class="empty"><div class="icon">üì•</div><p>Importez vos CSV depuis l'accueil.</p></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ VUE 3 : TIMELINE ANNEE ‚îÄ‚îÄ -->
    <div id="tabTimeline" class="section">
        <div class="legend">
            <div class="legend-item"><div class="legend-dot" style="background:var(--success);"></div> R√©alis√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:#6366f1;"></div> Pr√©vu</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--warning);"></div> Report√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--danger);"></div> Non r√©alis√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--surface-2);"></div> √Ä faire</div>
            <div class="legend-item"><div class="legend-dot" style="background:#374151; border:1px solid #4b5563;"></div> Vacances</div>
            <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;"></div> PFMP</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ec4899;"></div> BAC / √âpreuves</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f472b6;"></div> CCF</div>
        </div>

        <div class="card">
            <div class="card-title">Progression annuelle toutes classes</div>
            <div id="timelineContent" class="year-grid">
                <div class="empty"><div class="icon">üì•</div><p>Importez vos CSV depuis l'accueil.</p></div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ VUE 4 : ALERTES ‚îÄ‚îÄ -->
    <div id="tabAlertes" class="section">
        <div id="alertesContent">
            <div class="empty"><div class="icon">‚úÖ</div><p>Aucune alerte.</p></div>
        </div>
    </div>


    <!-- ‚îÄ‚îÄ VUE 5 : AGENDA DYNAMIQUE ‚îÄ‚îÄ -->
    <div id="tabAgenda" class="section">

        <!-- Barre de contr√¥le -->
        <div class="card" style="padding:14px 16px; margin-bottom:14px;">
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <button onclick="agendaGoToToday()" style="padding:8px 16px; border:2px solid var(--primary); border-radius:10px; background:var(--primary-light); color:var(--primary); font-weight:700; font-size:.82em; cursor:pointer; font-family:inherit;">üìç Aujourd'hui</button>
                <button onclick="agendaNav(-1)" style="padding:8px 12px; border:2px solid var(--border); border-radius:10px; background:var(--surface-2); font-size:1em; cursor:pointer;">‚óÄ</button>
                <span id="agendaDateLabel" style="font-weight:800; font-size:.95em; min-width:170px; text-align:center;"></span>
                <button onclick="agendaNav(1)" style="padding:8px 12px; border:2px solid var(--border); border-radius:10px; background:var(--surface-2); font-size:1em; cursor:pointer;">‚ñ∂</button>
                <div style="margin-left:auto; display:flex; gap:6px;">
                    <button id="agendaViewDay" onclick="setAgendaView('day')" style="padding:8px 14px; border:2px solid var(--primary); border-radius:10px; background:var(--primary); color:white; font-weight:700; font-size:.8em; cursor:pointer; font-family:inherit;">Jour</button>
                    <button id="agendaViewWeek" onclick="setAgendaView('week')" style="padding:8px 14px; border:2px solid var(--border); border-radius:10px; background:var(--surface-2); font-weight:700; font-size:.8em; cursor:pointer; font-family:inherit; color:var(--muted);">Semaine</button>
                </div>
                <button onclick="openAddEventModal()" style="padding:8px 16px; border:2px solid var(--success); border-radius:10px; background:var(--success-light); color:var(--success); font-weight:700; font-size:.82em; cursor:pointer; font-family:inherit;">+ √âv√©nement</button>
            </div>
        </div>

        <!-- Contenu agenda -->
        <div id="agendaContent"></div>

    </div>

    <!-- ‚îÄ‚îÄ VUE 6 : M√âT√âO ‚îÄ‚îÄ -->
    <div id="tabMeteo" class="section">
        <!-- Vue selector -->
        <div class="card" style="padding:14px 16px; margin-bottom:14px;">
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <span style="font-weight:700; font-size:.88em;">üìä M√©t√©o de classe</span>
                <div style="margin-left:auto; display:flex; gap:6px;">
                    <button class="meteo-view-btn active" data-view="semaine" onclick="setMeteoView('semaine')" style="padding:8px 14px; border:2px solid var(--primary); border-radius:10px; background:var(--primary); color:white; font-weight:700; font-size:.8em; cursor:pointer; font-family:inherit;">Semaine</button>
                    <button class="meteo-view-btn" data-view="mensuel" onclick="setMeteoView('mensuel')" style="padding:8px 14px; border:2px solid var(--border); border-radius:10px; background:var(--surface-2); font-weight:700; font-size:.8em; cursor:pointer; font-family:inherit; color:var(--muted);">Mensuel</button>
                    <button class="meteo-view-btn" data-view="annuel" onclick="setMeteoView('annuel')" style="padding:8px 14px; border:2px solid var(--border); border-radius:10px; background:var(--surface-2); font-weight:700; font-size:.8em; cursor:pointer; font-family:inherit; color:var(--muted);">Annuel</button>
                    <button class="meteo-view-btn" data-view="classe" onclick="setMeteoView('classe')" style="padding:8px 14px; border:2px solid var(--border); border-radius:10px; background:var(--surface-2); font-weight:700; font-size:.8em; cursor:pointer; font-family:inherit; color:var(--muted);">Par classe</button>
                </div>
            </div>
        </div>

        <!-- Filtre classe (visible en vue "classe" seulement) -->
        <div id="meteoClasseFilter" style="display:none; margin-bottom:14px;">
            <div class="card" style="padding:12px 16px;">
                <label style="font-size:.75em; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px;">Classe :</label>
                <select id="meteoFilterClasse" onchange="renderMeteo()" style="padding:8px 12px; border:2px solid var(--border); border-radius:8px; background:var(--surface-2); color:var(--text); font-family:inherit; font-size:.88em; margin-left:8px;">
                    <option value="">-- Toutes --</option>
                </select>
            </div>
        </div>

        <!-- L√©gende m√©t√©o -->
        <div class="card" style="padding:12px 16px; margin-bottom:14px;">
            <div style="display:flex; flex-wrap:wrap; gap:12px; font-size:.78em; align-items:center;">
                <span style="font-weight:700;">√âchelle :</span>
                <span>üò° 1</span> <span>üòï 2</span> <span>üòê 3</span> <span>üôÇ 4</span> <span>üòä 5</span>
                <span style="margin-left:12px; color:var(--muted);">|</span>
                <span style="display:inline-flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; border-radius:50%; background:#6366f1; display:inline-block;"></span> Global</span>
                <span style="display:inline-flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; border-radius:50%; background:#10b981; display:inline-block;"></span> Cognitif</span>
                <span style="display:inline-flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; border-radius:50%; background:#f59e0b; display:inline-block;"></span> √âmotionnel</span>
                <span style="display:inline-flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; border-radius:50%; background:#ec4899; display:inline-block;"></span> Social</span>
            </div>
        </div>

        <!-- Chart container -->
        <div class="card">
            <div id="meteoChartContainer" style="position:relative; min-height:300px;">
                <canvas id="meteoChart"></canvas>
            </div>
        </div>

        <!-- R√©sum√© stats -->
        <div id="meteoSummary" class="card" style="display:none; margin-top:14px;">
            <div class="card-title">üìà R√©sum√©</div>
            <div id="meteoSummaryContent" style="font-size:.85em;"></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ MODAL AJOUT √âV√âNEMENT ‚îÄ‚îÄ -->
    <div id="eventModalOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:300;" onclick="closeEventModal()"></div>
    <div id="eventModal" style="display:none; position:fixed; bottom:0; left:0; right:0; max-height:85vh; overflow-y:auto; background:var(--surface-2); border-radius:20px 20px 0 0; box-shadow:0 -8px 30px rgba(0,0,0,0.2); z-index:301; padding:22px 20px 36px;">
        <div style="width:40px;height:4px;background:var(--surface-2);border-radius:2px;margin:0 auto 16px;"></div>
        <div style="font-weight:800; font-size:1.05em; margin-bottom:16px;" id="eventModalTitle">üìå Ajouter un √©v√©nement</div>

        <label style="font-size:.72em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Type</label>
        <div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:12px;" id="eventTypeGrid">
            <button class="ev-type-btn" data-type="CCF" onclick="selectEvType('CCF',this)" style="padding:8px 14px;border:2px solid var(--border);border-radius:20px;background:var(--surface-2);font-size:.8em;font-weight:700;cursor:pointer;font-family:inherit;color:var(--muted);">üìã CCF</button>
            <button class="ev-type-btn" data-type="Bac blanc" onclick="selectEvType('Bac blanc',this)" style="padding:8px 14px;border:2px solid var(--border);border-radius:20px;background:var(--surface-2);font-size:.8em;font-weight:700;cursor:pointer;font-family:inherit;color:var(--muted);">üìÑ Bac blanc</button>
            <button class="ev-type-btn" data-type="PFMP" onclick="selectEvType('PFMP',this)" style="padding:8px 14px;border:2px solid var(--border);border-radius:20px;background:var(--surface-2);font-size:.8em;font-weight:700;cursor:pointer;font-family:inherit;color:var(--muted);">üè≠ PFMP</button>
            <button class="ev-type-btn" data-type="R√©union" onclick="selectEvType('R√©union',this)" style="padding:8px 14px;border:2px solid var(--border);border-radius:20px;background:var(--surface-2);font-size:.8em;font-weight:700;cursor:pointer;font-family:inherit;color:var(--muted);">üó£Ô∏è R√©union</button>
            <button class="ev-type-btn" data-type="Sortie scolaire" onclick="selectEvType('Sortie scolaire',this)" style="padding:8px 14px;border:2px solid var(--border);border-radius:20px;background:var(--surface-2);font-size:.8em;font-weight:700;cursor:pointer;font-family:inherit;color:var(--muted);">üéí Sortie</button>
            <button class="ev-type-btn" data-type="F√©ri√©" onclick="selectEvType('F√©ri√©',this)" style="padding:8px 14px;border:2px solid var(--border);border-radius:20px;background:var(--surface-2);font-size:.8em;font-weight:700;cursor:pointer;font-family:inherit;color:var(--muted);">üèñÔ∏è F√©ri√©</button>
            <button class="ev-type-btn" data-type="Autre" onclick="selectEvType('Autre',this)" style="padding:8px 14px;border:2px solid var(--border);border-radius:20px;background:var(--surface-2);font-size:.8em;font-weight:700;cursor:pointer;font-family:inherit;color:var(--muted);">üìå Autre</button>
        </div>

        <label style="font-size:.72em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Titre / description</label>
        <input type="text" id="eventTitle" placeholder="ex: CCF C11 - Terminale Agro" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:10px;font-size:.92em;font-family:inherit;margin-bottom:12px;">

        <label style="font-size:.72em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Classe(s) concern√©e(s)</label>
        <div id="eventClassesGrid" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;"></div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            <div>
                <label style="font-size:.72em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Date</label>
                <input type="date" id="eventDate" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:10px;font-size:.9em;font-family:inherit;">
            </div>
            <div>
                <label style="font-size:.72em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Date fin (optionnel)</label>
                <input type="date" id="eventDateEnd" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:10px;font-size:.9em;font-family:inherit;">
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
            <div>
                <label style="font-size:.72em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Heure d√©but</label>
                <input type="time" id="eventTimeStart" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:10px;font-size:.9em;font-family:inherit;">
            </div>
            <div>
                <label style="font-size:.72em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px;">Heure fin</label>
                <input type="time" id="eventTimeEnd" style="width:100%;padding:11px;border:2px solid var(--border);border-radius:10px;font-size:.9em;font-family:inherit;">
            </div>
        </div>

        <button onclick="saveEvent()" style="width:100%;padding:16px;border:none;border-radius:12px;background:linear-gradient(135deg,#10b981,#059669);color:white;font-size:1em;font-weight:800;cursor:pointer;font-family:inherit;">üíæ Enregistrer l'√©v√©nement</button>
        <button onclick="closeEventModal()" style="width:100%;padding:14px;border:2px solid var(--border);border-radius:12px;background:var(--surface-2);font-size:.9em;font-weight:700;cursor:pointer;font-family:inherit;margin-top:8px;color:var(--muted);">Annuler</button>
    </div>

    <!-- ‚îÄ‚îÄ MODAL √âDITION S√âANCE ‚îÄ‚îÄ -->
    <div id="editSeanceOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:300;" onclick="closeEditSeance()"></div>
    <div id="editSeanceModal" style="display:none; position:fixed; bottom:0; left:0; right:0; max-height:85vh; overflow-y:auto; background:var(--surface-2); border-radius:20px 20px 0 0; box-shadow:0 -8px 30px rgba(0,0,0,0.2); z-index:301; padding:22px 20px 36px;">
        <div style="width:40px;height:4px;background:var(--surface-2);border-radius:2px;margin:0 auto 16px;"></div>
        <div id="editSeanceContent"></div>
    </div>

<!-- ‚îÄ‚îÄ WEEK DETAIL PANEL ‚îÄ‚îÄ -->
<div id="weekDetailOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:200;" onclick="closeWeekDetail()"></div>
<div id="weekDetail" style="display:none; position:fixed; bottom:0; left:0; right:0; max-height:70vh; overflow-y:auto; background:var(--surface-2); border-radius:20px 20px 0 0; box-shadow:0 -8px 30px rgba(0,0,0,0.15); z-index:201; padding:24px 20px 30px; transition:transform 0.3s ease;">
    <div style="width:40px; height:4px; background:var(--surface-2); border-radius:2px; margin:0 auto 16px;"></div>
    <div id="weekDetailContent"></div>
</div>

</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script src="../PSE/data_eleves.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
        getFirestore, doc, setDoc, updateDoc, getDoc, getDocs, collection, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import {
        getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect,
        getRedirectResult, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IMPORTS UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    import {
        FIREBASE_CONFIG, MODULES_PSE, CLASSES_CONFIG, THEME_LABELS,
        CLASS_ALIAS_GROUPS as CAG_UTILS, CLASS_GROUPS,
        EDT, VACANCES, FERIES, PFMP, ALL_CLASSES,
        normalizeClass as normalizeClassUtil, classesMatch as classesMatchUtil,
        detectClassGroup as detectClassGroupUtil,
        getSemaineType, coursSePasse, getLundi, formatDateISO, formatDateFR,
        isVacances, isFerie, isPFMP, isAbsencePerso,
        getCoursForDay, computeSeancesDisponibles,
        cleanModuleName as cleanModuleNameUtil, baseModuleName as baseModuleNameUtil,
        capitalize as capitalizeUtil, parseDate as parseDateUtil,
        getCurrentWeekMonday as getCurrentWeekMondayUtil,
        isRealise as isRealiseUtil, isPrevu as isPrevuUtil,
        isReporte as isReporteUtil, isNonRealise as isNonRealiseUtil,
        phaseLabel as phaseLabelUtil, situationClass as situationClassUtil,
        situationColor as situationColorUtil,
        meteoToScore, METEO_SCORES, STUDENTS_STORAGE_KEY,
        ANNEE_SCOLAIRE, MOIS_COURTS, formatDateCourt, formatSemaineLabel,
        getNiveauForClasse, getModulesForClasse
    } from './assets/utils.js';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const app = initializeApp(FIREBASE_CONFIG);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    let allPrevue = [];
    let allLogs = [];
    let logsByClasse = {};
    let unsubPrevue = null;
    let unsubLogs = null;
    // STUDENTS_STORAGE_KEY imported from utils.js
    let localStudents = [];
    let codeClasseIndex = {};

    // CLASS_ALIAS_GROUPS, normalizeKey, detectClassGroup, classesMatch
    // now use imported versions from utils.js
    function normalizeKey(v) { return normalizeClassUtil(v); }
    function detectClassGroup(raw) { return detectClassGroupUtil(raw); }
    function classesMatch(a, b) { return classesMatchUtil(a, b); }

    function looksLikeCode(raw) {
        var n = normalizeKey(raw);
        return /^([A-Z]{2}\d{2}|PROFPSE|[A-Z0-9]{5,12})$/.test(n);
    }

    function looksLikeClass(raw) {
        var n = normalizeKey(raw);
        if (!n) return false;
        if (n === 'N' || n === 'NA' || n === 'AUCUN' || n === 'AUTRE') return false;
        if (/^(B1|B2|BT|C1|C2|CAP|TAGORA|BPSE2|CPSE1)/.test(n)) return true;
        if (/AGORA|MELEC|PSR|JP|HORT|CAN|VAN|GATL/.test(n)) return true;
        return false;
    }

    function parseCsvLine(line, delimiter) {
        var out = [];
        var cur = '';
        var inQuotes = false;
        for (var i = 0; i < line.length; i++) {
            var ch = line[i];
            if (ch === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    cur += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (ch === delimiter && !inQuotes) {
                out.push(cur.trim());
                cur = '';
            } else {
                cur += ch;
            }
        }
        out.push(cur.trim());
        return out;
    }

    function detectDelimiter(line) {
        var candidates = [',', ';', '\t'];
        var best = ',';
        var bestCount = -1;
        candidates.forEach(function(d) {
            var count = (line.match(new RegExp('\\' + d, 'g')) || []).length;
            if (count > bestCount) {
                best = d;
                bestCount = count;
            }
        });
        return best;
    }

    function normalizeHeader(raw) {
        return normalizeKey(raw);
    }

    function buildCodeClasseIndex() {
        codeClasseIndex = {};
        var bdd = window.BDD_ELEVES;
        if (!Array.isArray(bdd)) return;
        bdd.forEach(function(e) {
            var code = normalizeKey(e && e.userCode);
            var classe = (e && e.classe) ? e.classe : '';
            if (code && classe) codeClasseIndex[code] = classe;
        });
    }

    function saveLocalStudents() {
        try { localStorage.setItem(STUDENTS_STORAGE_KEY, JSON.stringify(localStudents)); }
        catch (_) {}
    }

    function loadLocalStudents() {
        try {
            var raw = localStorage.getItem(STUDENTS_STORAGE_KEY);
            var parsed = raw ? JSON.parse(raw) : [];
            localStudents = Array.isArray(parsed) ? parsed : [];
        } catch (_) {
            localStudents = [];
        }
    }

    function parseStudentsCsv(text, filename) {
        var lines = (text || '').replace(/\r/g, '').split('\n').map(function(l) { return l.trim(); }).filter(Boolean);
        if (lines.length === 0) return [];
        var delimiter = detectDelimiter(lines[0]);
        var firstCols = parseCsvLine(lines[0], delimiter);

        var headerMap = {};
        var hasHeader = false;
        firstCols.forEach(function(h, idx) {
            var nh = normalizeHeader(h);
            if (['CODE', 'USERCODE', 'IDENTIFIANT', 'CODEELEVE', 'ID'].includes(nh)) { headerMap.code = idx; hasHeader = true; }
            if (['CLASSE', 'CLASS', 'GROUPE'].includes(nh)) { headerMap.classe = idx; hasHeader = true; }
            if (['PRENOM', 'PRENOMELEVE'].includes(nh)) { headerMap.prenom = idx; hasHeader = true; }
            if (['NOM', 'NOMFAMILLE'].includes(nh)) { headerMap.nom = idx; hasHeader = true; }
            if (['ELEVE', 'NOMPRENOM', 'PRENOMNOM', 'NOMETPRENOM', 'FULLNAME'].includes(nh)) { headerMap.fullname = idx; hasHeader = true; }
        });

        var startRow = hasHeader ? 1 : 0;
        var records = [];
        for (var i = startRow; i < lines.length; i++) {
            var cols = parseCsvLine(lines[i], delimiter);
            if (!cols.length) continue;

            var code = '';
            var classe = '';
            var name = '';

            if (hasHeader) {
                if (headerMap.code !== undefined) code = cols[headerMap.code] || '';
                if (headerMap.classe !== undefined) classe = cols[headerMap.classe] || '';
                if (headerMap.fullname !== undefined) {
                    name = cols[headerMap.fullname] || '';
                } else {
                    var prenom = headerMap.prenom !== undefined ? (cols[headerMap.prenom] || '') : '';
                    var nom = headerMap.nom !== undefined ? (cols[headerMap.nom] || '') : '';
                    name = (prenom + ' ' + nom).trim();
                }
            } else {
                var c0 = cols[0] || '';
                var c1 = cols[1] || '';
                var c2 = cols[2] || '';

                if (looksLikeCode(c0)) {
                    code = c0;
                    name = c1;
                    if (looksLikeClass(c2)) classe = c2;
                } else if (looksLikeClass(c0)) {
                    classe = c0;
                    name = c1;
                    if (looksLikeCode(c2)) code = c2;
                } else {
                    name = c0;
                    if (looksLikeClass(c1)) classe = c1;
                    else if (looksLikeCode(c1)) code = c1;
                }
            }

            code = normalizeKey(code);
            if (!classe && code && codeClasseIndex[code]) classe = codeClasseIndex[code];
            if (!name && code) name = code;

            if (!name && !code) continue;
            records.push({
                code: code || '',
                name: (name || '').trim(),
                classe: (classe || '').trim(),
                source: filename || 'import',
                rowKey: (filename || 'import') + ':' + i
            });
        }
        return records;
    }

    function mergeStudents(newRecords) {
        var map = {};
        function keyOf(r) {
            var codeKey = normalizeKey(r.code || '');
            if (codeKey) return 'C:' + codeKey;
            var rowKey = normalizeKey(r.rowKey || '');
            if (rowKey) return 'R:' + rowKey;
            return 'N:' + normalizeKey(r.name || '') + '|K:' + normalizeKey(r.classe || '');
        }
        localStudents.forEach(function(r) { map[keyOf(r)] = Object.assign({}, r); });
        newRecords.forEach(function(r) {
            var key = keyOf(r);
            if (!map[key]) {
                map[key] = Object.assign({}, r);
                return;
            }
            var cur = map[key];
            if (!cur.name && r.name) cur.name = r.name;
            if (!cur.classe && r.classe) cur.classe = r.classe;
            if (!cur.code && r.code) cur.code = r.code;
            cur.source = r.source || cur.source;
        });
        localStudents = Object.keys(map).map(function(k) { return map[k]; });
        localStudents.sort(function(a, b) {
            var ac = (a.classe || '').localeCompare(b.classe || '');
            if (ac !== 0) return ac;
            return (a.name || a.code || '').localeCompare(b.name || b.code || '');
        });
    }

    function getStudentsForClass(classeId) {
        if (!classeId) return [];
        return localStudents.filter(function(s) {
            return s.classe && classesMatch(s.classe, classeId);
        });
    }

    function buildStudentsBlock(classeId) {
        var students = getStudentsForClass(classeId);
        if (students.length === 0) {
            return '<div class="students-box"><div class="students-help">Aucun √©l√®ve local pour cette classe.</div></div>';
        }

        var list = students.map(function(s) {
            var code = s.code ? ('<span class="student-code">' + s.code + '</span>') : '';
            var label = s.name || s.code || '√âl√®ve';
            return '<div class="student-item">' + code + label + '</div>';
        }).join('');

        return '<details class="students-box">' +
            '<summary>√âl√®ves de la classe (' + students.length + ')</summary>' +
            '<div class="students-list">' + list + '</div>' +
            '</details>';
    }

    function updateStudentsStatus() {
        var info = document.getElementById('studentsStatus');
        if (!info) return;
        var classSet = {};
        localStudents.forEach(function(s) {
            if (s.classe) classSet[normalizeKey(s.classe)] = true;
        });
        var nbClasses = Object.keys(classSet).length;
        if (!localStudents.length) {
            info.textContent = 'Aucune liste √©l√®ves locale';
        } else {
            info.textContent = localStudents.length + ' √©l√®ve(s) ¬∑ ' + nbClasses + ' classe(s) (stockage local t√©l√©phone)';
        }
    }

    async function importStudentsFiles(fileList) {
        if (!fileList || !fileList.length) return;
        var imported = [];
        for (var i = 0; i < fileList.length; i++) {
            var file = fileList[i];
            var text = await file.text();
            var records = parseStudentsCsv(text, file.name);
            imported = imported.concat(records);
        }
        mergeStudents(imported);
        saveLocalStudents();
        updateStudentsStatus();
        refreshViews();
        showToast('‚úÖ √âl√®ves import√©s: ' + imported.length + ' ligne(s)');
    }

    function setupStudentsImportUI() {
        var input = document.getElementById('studentsCsvInput');
        var btnImport = document.getElementById('btnImportStudents');
        var btnClear = document.getElementById('btnClearStudents');
        if (!input || !btnImport || !btnClear) return;

        btnImport.addEventListener('click', function() { input.click(); });
        input.addEventListener('change', async function(e) {
            var files = Array.from(e.target.files || []);
            try {
                await importStudentsFiles(files);
            } catch (err) {
                console.error('Import √©l√®ves CSV error:', err);
                showToast('‚ùå Erreur import √©l√®ves');
            } finally {
                input.value = '';
            }
        });

        btnClear.addEventListener('click', function() {
            localStudents = [];
            saveLocalStudents();
            updateStudentsStatus();
            refreshViews();
            showToast('üóëÔ∏è Liste √©l√®ves locale effac√©e');
        });
    }

    buildCodeClasseIndex();
    loadLocalStudents();
    setupStudentsImportUI();
    updateStudentsStatus();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            loadAll();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
        }
    });

    document.getElementById('btnGoogle').addEventListener('click', async () => {
        try { await signInWithPopup(auth, googleProvider); }
        catch (e) {
            if (e.code === 'auth/popup-blocked' || e.code === 'auth/cancelled-popup-request') {
                await signInWithRedirect(auth, googleProvider);
            } else { alert('Erreur: ' + e.message); }
        }
    });
    getRedirectResult(auth).catch(function() {});
    document.getElementById('btnLogout').addEventListener('click', function() {
        if (unsubPrevue) { unsubPrevue(); unsubPrevue = null; }
        if (unsubLogs) { unsubLogs(); unsubLogs = null; }
        signOut(auth);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.querySelectorAll('.tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
            btn.classList.add('active');
            document.getElementById('tab' + capitalize(btn.dataset.tab)).classList.add('active');
        });
    });

    function capitalize(s) {
        if (s === 'agenda') return 'Agenda';
        if (s === 'meteo') return 'Meteo';
        return s.charAt(0).toUpperCase() + s.slice(1);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOAD ALL DATA (real-time) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function refreshViews() {
        // Index logs by classeId
        logsByClasse = {};
        allLogs.forEach(function(log) {
            var key = log.classeId || log.classeDocId || '';
            if (!logsByClasse[key]) logsByClasse[key] = [];
            logsByClasse[key].push(log);
        });
        updateStudentsStatus();
        renderStats();
        populateFilters();
        renderClasseView();
        renderModuleView();
        renderTimeline();
        renderAlertes();
        // Rafra√Æchir agenda si actif
        if (document.getElementById('tabAgenda') && document.getElementById('tabAgenda').classList.contains('active')) renderAgenda();
        // Rafra√Æchir m√©t√©o si actif
        if (document.getElementById('tabMeteo') && document.getElementById('tabMeteo').classList.contains('active')) renderMeteo();
    }

    function loadAll() {
        // Cleanup previous listeners
        if (unsubPrevue) { unsubPrevue(); unsubPrevue = null; }
        if (unsubLogs) { unsubLogs(); unsubLogs = null; }

        unsubPrevue = onSnapshot(collection(db, 'progression_prevue'), function(snap) {
            allPrevue = [];
            snap.forEach(function(d) { allPrevue.push({ id: d.id, ...d.data() }); });
            allPrevue.sort(function(a, b) { return a.classeId.localeCompare(b.classeId); });
            refreshViews();
        }, function(err) { console.error('onSnapshot prevue error:', err); });

        unsubLogs = onSnapshot(collection(db, 'progression_logs'), function(snap) {
            allLogs = [];
            snap.forEach(function(d) { allLogs.push({ id: d.id, ...d.data() }); });
            refreshViews();
        }, function(err) { console.error('onSnapshot logs error:', err); });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEEK DETAIL PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.closeWeekDetail = function() {
        document.getElementById('weekDetail').style.display = 'none';
        document.getElementById('weekDetailOverlay').style.display = 'none';
    };

    function showWeekDetail(classeId, sem, classeDocId) {
        var panel = document.getElementById('weekDetail');
        var overlay = document.getElementById('weekDetailOverlay');
        var content = document.getElementById('weekDetailContent');

        // Find matching log
        var matchLog = null;
        allLogs.forEach(function(log) {
            if ((log.classeId === classeId || log.classeDocId === classeDocId) && log.date) {
                var parts = (sem.date || '').match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (parts) {
                    var semDate = new Date(parseInt(parts[3]), parseInt(parts[2]) - 1, parseInt(parts[1]));
                    var logDate = new Date(log.date);
                    var diff = Math.abs(semDate - logDate) / (1000 * 60 * 60 * 24);
                    if (diff < 7 && (!matchLog || log.date > matchLog.date)) matchLog = log;
                }
            }
        });

        // Detect niveau for module list
        var niveau = '';
        try { niveau = getNiveauForClasse(classeId); } catch(e) {}
        var modulesList = [];
        try { modulesList = getModulesForClasse(classeId); } catch(e) {}

        var html = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">';
        html += '<h3 style="font-size:1.1em; font-weight:800;">' + classeId + ' ‚Äî ' + (sem.semaine || sem.date || '') + '</h3>';
        html += '<button onclick="closeWeekDetail()" style="background:none; border:none; font-size:1.3em; cursor:pointer; color:var(--muted);">‚úï</button>';
        html += '</div>';

        // Current state
        html += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:0.85em; margin-bottom:14px; padding:12px; border-radius:10px; background:var(--surface-2);">';
        html += '<div><strong>Date :</strong> ' + (sem.date || '-') + '</div>';
        html += '<div><strong>Situation :</strong> ' + (sem.situation || 'Normal') + '</div>';
        html += '<div><strong>Module :</strong> ' + (sem.moduleBase || sem.module || '-') + '</div>';
        html += '<div><strong>Phase :</strong> ' + (sem.phase || 'cours') + '</div>';
        html += '<div><strong>S√©ance :</strong> ' + (sem.seance || '-') + '</div>';
        html += '<div><strong>Statut :</strong> ' + (sem.statut || '-') + '</div>';
        html += '</div>';

        // Log info
        if (matchLog) {
            html += '<div style="padding:12px; border-radius:10px; background:var(--success-light); border:1px solid rgba(16,185,129,0.3); font-size:0.82em; margin-bottom:14px;">';
            html += '<strong>‚úÖ Log du ' + matchLog.date + '</strong><br>';
            html += (matchLog.moduleId || '') + ' ‚Äî ' + (matchLog.seance || '') + ' [' + (matchLog.statut || '') + ']';
            if (matchLog.qualite) html += '<br>Qualit√© : ' + matchLog.qualite;
            if (matchLog.absences > 0) html += '<br>Absences : ' + matchLog.absences;
            if (matchLog.absencesNoms) html += ' (' + matchLog.absencesNoms + ')';
            if (matchLog.remarque) html += '<br>üí¨ ' + matchLog.remarque;
            html += '</div>';
        }

        // ‚îÄ‚îÄ EDITING SECTION ‚îÄ‚îÄ
        html += '<div style="border-top:1px solid var(--border); padding-top:14px; margin-top:6px;">';
        html += '<div style="font-weight:700; font-size:.88em; margin-bottom:10px;">‚úèÔ∏è Modifier la planification</div>';

        // Module selector
        html += '<label style="font-size:.72em; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; display:block; margin-bottom:4px;">Module</label>';
        html += '<select id="editWeekModule" style="width:100%; padding:10px; border:2px solid var(--border); border-radius:8px; background:var(--surface-2); color:var(--text); font-family:inherit; font-size:.85em; margin-bottom:10px;">';
        html += '<option value="">-- S√©lectionner --</option>';
        modulesList.forEach(function(m) {
            var selected = (sem.module && sem.module.includes(m)) || (sem.moduleBase && sem.moduleBase.includes(m)) ? ' selected' : '';
            html += '<option value="' + m + '"' + selected + '>' + m + '</option>';
        });
        html += '</select>';

        // S√©ance chips (multi-select)
        html += '<label style="font-size:.72em; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; display:block; margin-bottom:4px;">S√©ance(s)</label>';
        html += '<div id="editWeekSeances" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;">';
        var seancesList = ['S1','S2','S3','S4','S5','S6'];
        var currentSeance = (sem.seance || '').toUpperCase();
        seancesList.forEach(function(s) {
            var isActive = currentSeance.includes(s);
            html += '<button class="edit-seance-chip" data-seance="' + s + '" onclick="toggleWeekSeanceChip(this)" style="padding:7px 14px; border:2px solid ' + (isActive ? 'var(--primary)' : 'var(--border)') + '; border-radius:20px; background:' + (isActive ? 'var(--primary)' : 'var(--surface-2)') + '; color:' + (isActive ? 'white' : 'var(--muted)') + '; font-size:.78em; font-weight:700; cursor:pointer; font-family:inherit;">' + s + '</button>';
        });
        html += '</div>';

        // Phase chips
        html += '<label style="font-size:.72em; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; display:block; margin-bottom:4px;">Phase</label>';
        html += '<div id="editWeekPhase" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;">';
        var phases = ['Cours','√âvaluation','Correction','TP','R√©vision'];
        var currentPhase = (sem.phase || 'Cours');
        phases.forEach(function(p) {
            var isActive = currentPhase.toLowerCase() === p.toLowerCase();
            html += '<button class="edit-phase-chip" data-phase="' + p + '" onclick="toggleWeekPhaseChip(this)" style="padding:7px 14px; border:2px solid ' + (isActive ? '#10b981' : 'var(--border)') + '; border-radius:20px; background:' + (isActive ? '#10b981' : 'var(--surface-2)') + '; color:' + (isActive ? 'white' : 'var(--muted)') + '; font-size:.78em; font-weight:700; cursor:pointer; font-family:inherit;">' + p + '</button>';
        });
        html += '</div>';

        // Situation dropdown
        html += '<label style="font-size:.72em; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; display:block; margin-bottom:4px;">Situation</label>';
        html += '<select id="editWeekSituation" style="width:100%; padding:10px; border:2px solid var(--border); border-radius:8px; background:var(--surface-2); color:var(--text); font-family:inherit; font-size:.85em; margin-bottom:14px;">';
        var situations = ['Normal','Vacances scolaires','PFMP','Jours f√©ri√©s','CCF','BAC BLANC','Sortie scolaire','Annul√©','Formation','Absent'];
        situations.forEach(function(s) {
            var selected = (sem.situation || 'Normal') === s ? ' selected' : '';
            html += '<option value="' + s + '"' + selected + '>' + s + '</option>';
        });
        html += '</select>';

        // Save button
        html += '<button onclick="saveWeekEdit(\'' + classeDocId + '\',\'' + (sem.date || '') + '\')" style="width:100%; padding:14px; border:none; border-radius:12px; background:linear-gradient(135deg,#10b981,#059669); color:white; font-size:.95em; font-weight:800; cursor:pointer; font-family:inherit; margin-bottom:8px;">üíæ Enregistrer</button>';

        // Propagate button
        html += '<button onclick="propagateWeekEdit(\'' + classeDocId + '\',\'' + (sem.date || '') + '\')" style="width:100%; padding:12px; border:2px solid var(--primary); border-radius:12px; background:var(--primary-light); color:var(--primary); font-size:.85em; font-weight:700; cursor:pointer; font-family:inherit; margin-bottom:8px;">üì° Propager sur les semaines suivantes</button>';

        // Link to log
        var logLink = 'log.html';
        if (sem.date) {
            var dateParts = (sem.date || '').match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (dateParts) {
                var isoDate = dateParts[3] + '-' + dateParts[2].padStart(2,'0') + '-' + dateParts[1].padStart(2,'0');
                logLink = 'log.html?date=' + isoDate + '&classe=' + encodeURIComponent(classeId);
            }
        }
        html += '<a href="' + logLink + '" style="display:block; text-align:center; padding:12px; border-radius:12px; border:2px solid var(--border); color:var(--text); font-weight:700; text-decoration:none; font-size:.85em;">üìù Saisir dans log.html</a>';

        html += '</div>';

        content.innerHTML = html;
        overlay.style.display = 'block';
        panel.style.display = 'block';
    }

    // Timeline editing helpers
    window.toggleWeekSeanceChip = function(btn) {
        var isActive = btn.style.background === 'var(--primary)';
        if (isActive) {
            btn.style.borderColor = 'var(--border)';
            btn.style.background = 'var(--surface-2)';
            btn.style.color = 'var(--muted)';
        } else {
            btn.style.borderColor = 'var(--primary)';
            btn.style.background = 'var(--primary)';
            btn.style.color = 'white';
        }
    };

    window.toggleWeekPhaseChip = function(btn) {
        // Single select ‚Äî deactivate all then activate clicked
        document.querySelectorAll('#editWeekPhase .edit-phase-chip').forEach(function(b) {
            b.style.borderColor = 'var(--border)';
            b.style.background = 'var(--surface-2)';
            b.style.color = 'var(--muted)';
        });
        btn.style.borderColor = '#10b981';
        btn.style.background = '#10b981';
        btn.style.color = 'white';
    };

    window.saveWeekEdit = async function(classeDocId, dateStr) {
        if (!classeDocId) { showToast('Progression non trouv√©e'); return; }
        var prevue = allPrevue.find(function(p) { return p.id === classeDocId; });
        if (!prevue || !prevue.semaines) { showToast('Progression non trouv√©e'); return; }

        var module = (document.getElementById('editWeekModule') || {}).value || '';
        var situation = (document.getElementById('editWeekSituation') || {}).value || 'Normal';

        // Collect selected seances
        var selectedSeances = [];
        document.querySelectorAll('#editWeekSeances .edit-seance-chip').forEach(function(btn) {
            if (btn.style.color === 'white') selectedSeances.push(btn.dataset.seance);
        });
        var seance = selectedSeances.join('+');

        // Get phase
        var phase = 'Cours';
        document.querySelectorAll('#editWeekPhase .edit-phase-chip').forEach(function(btn) {
            if (btn.style.color === 'white') phase = btn.dataset.phase;
        });

        // Find the matching semaine
        var target = dateStr;
        var found = false;
        prevue.semaines.forEach(function(sem) {
            if (sem.date === target) {
                if (module) sem.module = module;
                if (seance) sem.seance = seance;
                sem.phase = phase;
                sem.situation = situation;
                found = true;
            }
        });

        if (!found) { showToast('Semaine non trouv√©e'); return; }

        try {
            await updateDoc(doc(db, 'progression_prevue', classeDocId), { semaines: prevue.semaines });
            showToast('‚úÖ Planification mise √† jour');
            closeWeekDetail();
        } catch(e) { showToast('Erreur : ' + e.message); }
    };

    window.propagateWeekEdit = async function(classeDocId, dateStr) {
        if (!classeDocId) { showToast('Progression non trouv√©e'); return; }
        var prevue = allPrevue.find(function(p) { return p.id === classeDocId; });
        if (!prevue || !prevue.semaines) { showToast('Progression non trouv√©e'); return; }

        var module = (document.getElementById('editWeekModule') || {}).value || '';
        var situation = (document.getElementById('editWeekSituation') || {}).value || 'Normal';
        var selectedSeances = [];
        document.querySelectorAll('#editWeekSeances .edit-seance-chip').forEach(function(btn) {
            if (btn.style.color === 'white') selectedSeances.push(btn.dataset.seance);
        });
        var phase = 'Cours';
        document.querySelectorAll('#editWeekPhase .edit-phase-chip').forEach(function(btn) {
            if (btn.style.color === 'white') phase = btn.dataset.phase;
        });

        if (!module) { showToast('S√©lectionnez un module pour propager'); return; }

        // Find the starting week and propagate forward
        var startIdx = -1;
        for (var i = 0; i < prevue.semaines.length; i++) {
            if (prevue.semaines[i].date === dateStr) { startIdx = i; break; }
        }
        if (startIdx < 0) { showToast('Semaine non trouv√©e'); return; }

        var seanceIdx = 0;
        var allSeances = ['S1','S2','S3','S4','S5','S6'];
        // Start from the first selected seance
        if (selectedSeances.length > 0) {
            seanceIdx = allSeances.indexOf(selectedSeances[0]);
            if (seanceIdx < 0) seanceIdx = 0;
        }

        var count = 0;
        for (var j = startIdx; j < prevue.semaines.length && seanceIdx < allSeances.length; j++) {
            var sem = prevue.semaines[j];
            var sit = (sem.situation || '').toLowerCase();
            // Skip vacances, PFMP, f√©ri√©s
            if (sit.includes('vacances') || sit.includes('pfmp') || sit.includes('feri') || sit.includes('f√©ri')) continue;

            sem.module = module;
            sem.seance = allSeances[seanceIdx];
            sem.phase = phase;
            if (situation !== 'Normal') sem.situation = situation;
            seanceIdx++;
            count++;
        }

        try {
            await updateDoc(doc(db, 'progression_prevue', classeDocId), { semaines: prevue.semaines });
            showToast('‚úÖ Propag√© sur ' + count + ' semaine' + (count > 1 ? 's' : ''));
            closeWeekDetail();
        } catch(e) { showToast('Erreur : ' + e.message); }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderStats() {
        document.getElementById('stClasses').textContent = allPrevue.length;

        var totalRealise = 0;
        var totalEnCours = 0;
        var today = new Date();
        allPrevue.forEach(function(p) {
            var hasActiveSemaine = false;
            (p.semaines || []).forEach(function(s) {
                if (s.valide || s.statut === 'Realise' || s.statut === 'R√©alis√©') {
                    totalRealise++;
                } else {
                    // Semaine pass√©e, situation normale, non valid√©e = en cours
                    var sit = (s.situation || 'Normal').toLowerCase();
                    var isNormal = sit === 'normal' || sit === '' || sit === 'n/a';
                    if (isNormal && s.date) {
                        var parts = s.date.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                        if (parts) {
                            var semDate = new Date(parseInt(parts[3]), parseInt(parts[2]) - 1, parseInt(parts[1]));
                            var diffDays = (today - semDate) / (1000 * 60 * 60 * 24);
                            if (diffDays >= 0 && diffDays < 14) hasActiveSemaine = true;
                        }
                    }
                }
            });
            if (hasActiveSemaine) totalEnCours++;
        });

        document.getElementById('stRealise').textContent = totalRealise;
        document.getElementById('stEnCours').textContent = totalEnCours;

        var alertCount = computeAlerts().length;
        document.getElementById('stAlertes').textContent = alertCount;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILTERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function populateFilters() {
        // Classe filter
        var selClasse = document.getElementById('filterClasse');
        selClasse.innerHTML = '<option value="">-- Toutes --</option>';
        allPrevue.forEach(function(p) {
            var opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.classeId + ' (' + p.niveau + ')';
            selClasse.appendChild(opt);
        });
        selClasse.addEventListener('change', renderClasseView);

        // Module filter ‚Äî collect all unique modules across all classes
        var allModules = {};
        allPrevue.forEach(function(p) {
            (p.semaines || []).forEach(function(s) {
                var m = cleanModuleName(s.module || '');
                if (m && m !== 'N/A' && m !== 'Presentation PSE' && m !== 'Pr√©sentation PSE') {
                    allModules[m] = true;
                }
            });
        });

        var selModule = document.getElementById('filterModule');
        selModule.innerHTML = '<option value="">-- Tous --</option>';
        Object.keys(allModules).sort().forEach(function(m) {
            var opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            selModule.appendChild(opt);
        });
        selModule.addEventListener('change', renderModuleView);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPER : clean module name ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function cleanModuleName(str) {
        if (!str) return '';
        return str.replace(/\n/g,' ').replace(/\s+/g,' ').trim().substring(0,60);
    }

    // Get base module name (without √âvaluation/Correction)
    function baseModuleName(raw) {
        var c = cleanModuleName(raw);
        return c.replace(/\s*[‚Äì-]\s*(√âvaluation|Evaluation|Correction)$/i, '').trim();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARSE DATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function parseDate(dateStr) {
        if (!dateStr) return null;
        // Format: DD/MM/YYYY
        var parts = dateStr.split('/');
        if (parts.length === 3) {
            return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }
        // Try ISO
        var d = new Date(dateStr);
        return isNaN(d.getTime()) ? null : d;
    }

    // Get current week monday date string for highlighting
    function getCurrentWeekMonday() {
        var now = new Date();
        var day = now.getDay();
        var diff = now.getDate() - day + (day === 0 ? -6 : 1);
        var monday = new Date(now);
        monday.setDate(diff);
        var dd = String(monday.getDate()).padStart(2, '0');
        var mm = String(monday.getMonth() + 1).padStart(2, '0');
        return dd + '/' + mm + '/' + monday.getFullYear();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATUT HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function isRealise(sem) {
        return sem.valide || sem.statut === 'Realise' || sem.statut === 'R√©alis√©';
    }
    function isPrevu(sem) {
        return sem.statut === 'Pr√©vu' || sem.statut === 'Prevu';
    }
    function isReporte(sem) {
        return sem.statut === 'Report√©' || sem.statut === 'Reporte';
    }
    function isNonRealise(sem) {
        return sem.statut === 'Non r√©alis√©' || sem.statut === 'Non realise' || sem.statut === 'Non r√©alis√©';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PHASE ‚Üí LABEL DANS CELLULE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function phaseLabel(sem) {
        var phase = (sem.phase || '').toLowerCase();
        if (phase === 'evaluation') return 'E';
        if (phase === 'correction') return 'C';
        if (phase === 'presentation') return 'P';
        // S√©ance number
        var seance = (sem.seance || '').trim();
        if (seance && seance !== 'N/A') {
            var m = seance.match(/(\d[\d\-]*)/);
            if (m) return m[1];
        }
        return '';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SITUATION ‚Üí COLOR CLASS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function situationClass(sem) {
        var sit = (sem.situation || '').toLowerCase();
        if (sit.includes('vacances')) return 'c-vacances';
        if (sit.includes('pfmp')) return 'c-pfmp';
        if (sit.includes('bac blanc') || sit.includes('epreuv')) return 'c-bac';
        if (sit.includes('ccf')) return 'c-ccf';
        if (sit.includes('sortie')) return 'c-sortie';
        if (sit.includes('annul')) return 'c-annule';
        if (sit.includes('feri') || sit.includes('f√©ri')) return 'c-ferie';
        if (sit.includes('absence') || sit.includes('formation')) return 'c-absence';

        // Statut-based colors (CSV + logs)
        if (isRealise(sem)) return 'c-realise';
        if (isReporte(sem)) return 'c-reporte';
        if (isNonRealise(sem)) return 'c-non-realise';
        if (isPrevu(sem)) return 'c-prevu';

        return 'c-normal';
    }

    // Same but for year timeline cells (returns bg color)
    function situationColor(sem) {
        var sit = (sem.situation || '').toLowerCase();
        if (sit.includes('vacances')) return '#374151';
        if (sit.includes('pfmp')) return '#8b5cf6';
        if (sit.includes('bac blanc') || sit.includes('epreuv')) return '#ec4899';
        if (sit.includes('ccf')) return '#f472b6';
        if (sit.includes('sortie')) return '#06b6d4';
        if (sit.includes('annul')) return '#dc2626';
        if (sit.includes('feri') || sit.includes('f√©ri')) return '#a1a1aa';
        if (sit.includes('absence') || sit.includes('formation')) return '#78716c';
        if (isRealise(sem)) return '#22c55e';
        if (isReporte(sem)) return '#f59e0b';
        if (isNonRealise(sem)) return '#dc2626';
        if (isPrevu(sem)) return '#6366f1';
        return '#334155';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VUE 1 : PAR CLASSE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderClasseView() {
        var container = document.getElementById('classeContent');
        var filterVal = document.getElementById('filterClasse').value;

        var classesToShow = filterVal
            ? allPrevue.filter(function(p) { return p.id === filterVal; })
            : allPrevue;

        if (classesToShow.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üì•</div><p>Aucune classe import√©e.</p></div>';
            return;
        }

        container.innerHTML = '';
        var currentMonday = getCurrentWeekMonday();

        classesToShow.forEach(function(prevue) {
            var card = document.createElement('div');
            card.className = 'card';

            // Title with class name and badge
            var niveauLabel = prevue.niveau === 'CAP' ? 'CAP' : 'BAC PRO';
            var titleHtml = '<div class="card-title">' + prevue.classeId +
                ' <span class="count">' + niveauLabel + '</span></div>';

            // Month headers
            var semaines = prevue.semaines || [];
            var monthsHtml = buildMonthHeaders(semaines);

            // Week cells
            var cellsHtml = '';
            var currentModule = '';
            semaines.forEach(function(sem, i) {
                var cls = situationClass(sem);
                var isCurrent = sem.date === currentMonday;

                // Determine display text ‚Äî show phase icon or week number
                var label = sem.semaine || '';
                var module = cleanModuleName(sem.module || '');
                var moduleBaseClean = (sem.moduleBase || module || '').replace(/\n/g, ' ').trim();
                if (module && module !== 'N/A') currentModule = module;

                // Cell content: phase label (E/C/number) or week number
                var cellContent = '';
                var pLabel = phaseLabel(sem);
                var sit = (sem.situation || '').toLowerCase();
                var isSpecialSit = sit.includes('vacances') || sit.includes('pfmp') || sit.includes('feri') || sit.includes('f√©ri');

                if (!isSpecialSit && module && module !== 'N/A' && pLabel) {
                    cellContent = '<span class="phase-icon">' + pLabel + '</span>';
                } else {
                    cellContent = label.replace('S', '');
                }

                // Build rich tooltip
                var tooltipText = sem.date + ' (' + sem.semaine + ')';
                if (sem.ab) tooltipText += ' ‚Äî Sem. ' + sem.ab;
                if (module && module !== 'N/A') tooltipText += '\\nüìö ' + module;
                if (sem.phase && sem.phase !== 'cours' && module && module !== 'N/A') {
                    tooltipText += '\\nüîñ Phase : ' + sem.phase.charAt(0).toUpperCase() + sem.phase.slice(1);
                }
                if (sem.transition) {
                    tooltipText += ' ‚Üí ' + sem.transition.replace(/_/g, ' ');
                }
                if (sem.suiteModule && sem.suiteModule !== 'N/A') {
                    tooltipText += '\\n‚û© ' + sem.suiteModule.replace(/[‚û©‚û´‚á®]\s*/g, '');
                }
                if (sem.seance && sem.seance !== 'N/A') tooltipText += '\\nüìù ' + sem.seance;
                if (sem.statut && sem.statut !== 'N/A') tooltipText += '\\nüìå ' + sem.statut;
                if (sem.nbSeancesPrevues && sem.nbSeancesPrevues > 0) tooltipText += '\\nüî¢ ' + sem.nbSeancesPrevues + ' s√©ances pr√©vues';
                if (sem.evalDiag && sem.evalDiag !== 'N/A') tooltipText += '\\nüîç Diag: ' + sem.evalDiag;
                if (sem.evalForm && sem.evalForm !== 'N/A') tooltipText += '\\nüìä Form: ' + sem.evalForm;
                if (sem.evaluation && sem.evaluation !== 'N/A') tooltipText += '\\nüìù √âval: ' + sem.evaluation;
                if (sem.situation && sem.situation !== 'Normal') tooltipText += '\\n‚ö° ' + sem.situation;

                cellsHtml += '<div class="timeline-cell ' + cls + (isCurrent ? ' c-current' : '') + '" data-sem-idx="' + i + '" style="cursor:pointer;">' +
                    cellContent +
                    '<div class="tooltip">' + tooltipText.replace(/\\n/g, '<br>') + '</div>' +
                    '</div>';
            });

            // Module summary table
            var modulesSummary = buildModuleSummary(prevue);

            card.innerHTML = titleHtml +
                '<div class="timeline-weeks">' +
                '<div class="month-headers">' + monthsHtml + '</div>' +
                '<div class="timeline-row">' + cellsHtml + '</div>' +
                '</div>' +
                modulesSummary +
                buildStudentsBlock(prevue.classeId);

            // Click handler for timeline cells
            (function(p) {
                card.addEventListener('click', function(e) {
                    var cell = e.target.closest('.timeline-cell');
                    if (!cell || !cell.dataset.semIdx) return;
                    var idx = parseInt(cell.dataset.semIdx);
                    if (p.semaines && p.semaines[idx]) {
                        showWeekDetail(p.classeId, p.semaines[idx], p.id);
                    }
                });
            })(prevue);

            container.appendChild(card);
        });
    }

    function buildMonthHeaders(semaines) {
        var months = [];
        var currentMonth = -1;
        var count = 0;
        var monthNames = ['Jan', 'Fev', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aout', 'Sep', 'Oct', 'Nov', 'Dec'];

        semaines.forEach(function(sem, idx) {
            var d = parseDate(sem.date);
            if (!d) return;
            var m = d.getMonth();
            if (m !== currentMonth) {
                if (currentMonth >= 0) {
                    months.push({ label: monthNames[currentMonth], count: count });
                }
                currentMonth = m;
                count = 1;
            } else {
                count++;
            }
        });
        if (currentMonth >= 0) {
            months.push({ label: monthNames[currentMonth], count: count });
        }

        var html = '';
        months.forEach(function(m) {
            // Each cell is 36px + 3px gap = 39px
            var width = m.count * 39 - 3;
            html += '<div class="month-label" style="width:' + width + 'px;">' + m.label + '</div>';
        });
        return html;
    }

    function buildModuleSummary(prevue) {
        // Group semaines by module (base name)
        var moduleMap = {};
        var order = [];
        (prevue.semaines || []).forEach(function(s) {
            var m = cleanModuleName(s.module || '');
            if (!m || m === 'N/A') return;
            var base = baseModuleName(m);
            if (!base) return;
            if (!moduleMap[base]) {
                moduleMap[base] = {
                    total: 0, realise: 0, reporte: 0, prevu: 0,
                    hasEval: false, evalDone: false, hasCorrection: false, correctionDone: false,
                    nbSeancesPrevues: 0, seancesRealisees: 0, lastSeance: '',
                    evalDiag: '', evalForm: '', evaluation: '',
                    currentPhase: ''
                };
                order.push(base);
            }
            var info = moduleMap[base];
            info.total++;

            // Track nb s√©ances pr√©vues (take the max found)
            if (s.nbSeancesPrevues && s.nbSeancesPrevues > info.nbSeancesPrevues) {
                info.nbSeancesPrevues = s.nbSeancesPrevues;
            }

            var phase = (s.phase || 'cours').toLowerCase();

            if (isRealise(s)) {
                info.realise++;
                if (phase === 'cours' || phase === 'presentation') info.seancesRealisees++;
                if (s.seance && s.seance !== 'N/A') info.lastSeance = s.seance;
            }
            if (isReporte(s)) info.reporte++;
            if (isPrevu(s)) info.prevu++;

            if (phase === 'evaluation') {
                info.hasEval = true;
                if (isRealise(s)) info.evalDone = true;
            }
            if (phase === 'correction') {
                info.hasCorrection = true;
                if (isRealise(s)) info.correctionDone = true;
            }

            // Track evaluations types
            if (s.evalDiag && s.evalDiag !== 'N/A') info.evalDiag = s.evalDiag;
            if (s.evalForm && s.evalForm !== 'N/A') info.evalForm = s.evalForm;
            if (s.evaluation && s.evaluation !== 'N/A') info.evaluation = s.evaluation;

            // Track current phase (last non-realized)
            if (!isRealise(s)) info.currentPhase = phase;
        });

        if (order.length === 0) return '';

        var html = '<div style="margin-top:15px;">';
        html += '<div style="font-weight:700; font-size:0.85em; margin-bottom:8px;">Modules :</div>';
        html += '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
        order.forEach(function(name) {
            var info = moduleMap[name];
            var pct = info.total > 0 ? Math.round(info.realise / info.total * 100) : 0;
            var bgColor = pct === 100 ? 'var(--success-light)' : pct > 0 ? 'var(--warning-light)' : '#f1f5f9';
            var borderColor = pct === 100 ? 'var(--success)' : pct > 0 ? 'var(--warning)' : 'var(--border)';
            var textColor = pct === 100 ? '#166534' : pct > 0 ? '#92400e' : 'var(--muted)';

            // Short display name
            var shortName = name.length > 30 ? name.substring(0, 30) + '...' : name;

            // Build detail line
            var detail = '';
            if (info.nbSeancesPrevues > 0) {
                detail += info.seancesRealisees + '/' + info.nbSeancesPrevues + ' s√©ances';
            } else {
                detail += info.realise + '/' + info.total + ' sem.';
            }
            if (info.hasEval) detail += info.evalDone ? ' ¬∑ ‚úÖ √âval' : ' ¬∑ ‚è≥ √âval';
            if (info.hasCorrection) detail += info.correctionDone ? ' ¬∑ ‚úÖ Corr' : ' ¬∑ ‚è≥ Corr';
            if (info.reporte > 0) detail += ' ¬∑ üîÑ' + info.reporte;

            // Evaluation types
            var evalDetail = '';
            if (info.evalDiag) evalDetail += 'üîç' + info.evalDiag + ' ';
            if (info.evalForm) evalDetail += 'üìä' + info.evalForm + ' ';
            if (info.evaluation) evalDetail += 'üìù' + info.evaluation;

            html += '<div style="padding:6px 10px; border-radius:8px; font-size:0.72em; font-weight:600; ' +
                'background:' + bgColor + '; border:1px solid ' + borderColor + '; color:' + textColor + ';">' +
                shortName +
                '<div style="font-weight:500; font-size:0.9em; opacity:0.8; margin-top:2px;">' + detail + '</div>' +
                (evalDetail ? '<div style="font-weight:500; font-size:0.85em; opacity:0.7; margin-top:1px;">' + evalDetail + '</div>' : '') +
                '</div>';
        });
        html += '</div></div>';
        return html;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VUE 2 : PAR MODULE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderModuleView() {
        var container = document.getElementById('moduleContent');
        var filterVal = document.getElementById('filterModule').value;

        // Collect: for each module, which classes have it and status
        var moduleData = {};

        allPrevue.forEach(function(prevue) {
            (prevue.semaines || []).forEach(function(sem) {
                var m = cleanModuleName(sem.module || '');
                if (!m || m === 'N/A') return;

                var base = baseModuleName(m);
                if (!base) return;

                if (filterVal && base !== filterVal && m !== filterVal) return;

                if (!moduleData[base]) moduleData[base] = {};
                if (!moduleData[base][prevue.classeId]) {
                    moduleData[base][prevue.classeId] = {
                        classeId: prevue.classeId,
                        niveau: prevue.niveau,
                        total: 0,
                        realise: 0,
                        reporte: 0,
                        lastSeance: '',
                        evalDone: false,
                        hasEval: false,
                        hasCorrection: false,
                        correctionDone: false,
                        nbSeancesPrevues: 0,
                        evalDiag: '',
                        evalForm: '',
                        evaluation: ''
                    };
                }
                var entry = moduleData[base][prevue.classeId];
                entry.total++;
                if (sem.nbSeancesPrevues && sem.nbSeancesPrevues > entry.nbSeancesPrevues) {
                    entry.nbSeancesPrevues = sem.nbSeancesPrevues;
                }
                if (isRealise(sem)) {
                    entry.realise++;
                    if (sem.seance && sem.seance !== 'N/A') entry.lastSeance = sem.seance;
                }
                if (isReporte(sem)) entry.reporte++;
                var phase = (sem.phase || 'cours').toLowerCase();
                if (phase === 'evaluation') {
                    entry.hasEval = true;
                    if (isRealise(sem)) entry.evalDone = true;
                }
                if (phase === 'correction') {
                    entry.hasCorrection = true;
                    if (isRealise(sem)) entry.correctionDone = true;
                }
                if (sem.evalDiag && sem.evalDiag !== 'N/A') entry.evalDiag = sem.evalDiag;
                if (sem.evalForm && sem.evalForm !== 'N/A') entry.evalForm = sem.evalForm;
                if (sem.evaluation && sem.evaluation !== 'N/A') entry.evaluation = sem.evaluation;
            });
        });

        var moduleNames = Object.keys(moduleData).sort();
        if (moduleNames.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üì•</div><p>Aucun module trouv√©.</p></div>';
            return;
        }

        container.innerHTML = '';

        moduleNames.forEach(function(moduleName) {
            var classes = moduleData[moduleName];
            var card = document.createElement('div');
            card.className = 'card';

            var classCount = Object.keys(classes).length;
            card.innerHTML = '<div class="card-title">' + moduleName + ' <span class="count">' + classCount + ' classes</span></div>';

            var grid = document.createElement('div');
            grid.className = 'module-grid';

            var classIds = Object.keys(classes).sort();
            classIds.forEach(function(classeId) {
                var info = classes[classeId];
                var pct = info.total > 0 ? Math.round(info.realise / info.total * 100) : 0;

                var statusLabel, badgeClass;
                if (pct === 100) {
                    statusLabel = info.evalDone ? '√âval termin√©e' : 'Termin√©';
                    badgeClass = info.evalDone ? 'b-eval' : 'b-terminee';
                } else if (pct > 0) {
                    statusLabel = 'En cours';
                    badgeClass = 'b-en-cours';
                } else {
                    statusLabel = 'Non commenc√©';
                    badgeClass = 'b-non-commence';
                }

                // Build detail line
                var detail = '';
                if (info.nbSeancesPrevues > 0) {
                    var seancesR = info.realise - (info.hasEval && info.evalDone ? 1 : 0) - (info.hasCorrection && info.correctionDone ? 1 : 0);
                    detail = seancesR + '/' + info.nbSeancesPrevues + ' s√©ances';
                } else if (info.lastSeance) {
                    detail = 'Dernier : ' + info.lastSeance;
                } else {
                    detail = pct + '% compl√©t√©';
                }
                if (info.hasEval) detail += info.evalDone ? ' ¬∑ ‚úÖ √âval' : ' ¬∑ ‚è≥ √âval';
                if (info.hasCorrection) detail += info.correctionDone ? ' ¬∑ ‚úÖ Corr' : ' ¬∑ ‚è≥ Corr';
                if (info.reporte > 0) detail += ' ¬∑ üîÑ ' + info.reporte + ' report√©';

                // Eval types
                var evalLine = '';
                if (info.evalDiag) evalLine += 'üîç ' + info.evalDiag + ' ';
                if (info.evalForm) evalLine += 'üìä ' + info.evalForm + ' ';
                if (info.evaluation) evalLine += 'üìù ' + info.evaluation;

                var progressClass = pct === 100 ? 'p-success' : 'p-warning';

                var itemDiv = document.createElement('div');
                itemDiv.className = 'module-class-card';
                itemDiv.innerHTML =
                    '<div class="mc-header">' +
                    '<span class="mc-classe">' + classeId + '</span>' +
                    '<span class="mc-badge ' + badgeClass + '">' + statusLabel + '</span>' +
                    '</div>' +
                    '<div class="mc-detail">' + detail + '</div>' +
                    (evalLine ? '<div class="mc-detail" style="font-size:0.78em; margin-top:2px;">' + evalLine + '</div>' : '') +
                    '<div class="mc-progress"><div class="mc-progress-fill ' + progressClass + '" style="width:' + pct + '%;"></div></div>';

                grid.appendChild(itemDiv);
            });

            card.appendChild(grid);
            container.appendChild(card);
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VUE 3 : TIMELINE ANNEE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderTimeline() {
        var container = document.getElementById('timelineContent');

        if (allPrevue.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üì•</div><p>Aucune donn√©e import√©e.</p></div>';
            return;
        }

        // Build table: rows = classes, columns = weeks
        // First, collect all unique week dates across all classes
        var allWeeks = [];
        var weekSet = {};
        allPrevue.forEach(function(p) {
            (p.semaines || []).forEach(function(s) {
                if (s.date && !weekSet[s.date]) {
                    weekSet[s.date] = true;
                    allWeeks.push({ date: s.date, semaine: s.semaine, parsed: parseDate(s.date) });
                }
            });
        });
        allWeeks.sort(function(a, b) {
            if (!a.parsed || !b.parsed) return 0;
            return a.parsed.getTime() - b.parsed.getTime();
        });

        if (allWeeks.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üìä</div><p>Pas de semaines.</p></div>';
            return;
        }

        var currentMonday = getCurrentWeekMonday();

        // Build month header spans
        var monthNames = ['Jan', 'Fev', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aout', 'Sep', 'Oct', 'Nov', 'Dec'];

        var table = document.createElement('table');
        table.className = 'year-table';

        // Header row: month names
        var thead = document.createElement('thead');
        var thRow = document.createElement('tr');
        thRow.innerHTML = '<th></th>'; // Empty cell for class labels

        // Group weeks by month for colspan
        var monthGroups = [];
        var prevMonth = -1;
        allWeeks.forEach(function(w) {
            if (!w.parsed) return;
            var m = w.parsed.getMonth();
            if (m !== prevMonth) {
                monthGroups.push({ month: m, count: 1 });
                prevMonth = m;
            } else {
                monthGroups[monthGroups.length - 1].count++;
            }
        });

        monthGroups.forEach(function(mg) {
            var th = document.createElement('th');
            th.colSpan = mg.count;
            th.textContent = monthNames[mg.month];
            thRow.appendChild(th);
        });
        thead.appendChild(thRow);

        // Week numbers sub-header
        var weekRow = document.createElement('tr');
        weekRow.innerHTML = '<th></th>';
        allWeeks.forEach(function(w) {
            var th = document.createElement('th');
            th.textContent = (w.semaine || '').replace('S', '');
            th.style.fontSize = '0.55em';
            th.style.color = '#94a3b8';
            weekRow.appendChild(th);
        });
        thead.appendChild(weekRow);
        table.appendChild(thead);

        // Body: one row per class
        var tbody = document.createElement('tbody');
        allPrevue.forEach(function(prevue) {
            var tr = document.createElement('tr');

            // Class label cell
            var tdLabel = document.createElement('td');
            tdLabel.className = 'class-label';
            tdLabel.textContent = prevue.classeId;
            tr.appendChild(tdLabel);

            // Build week lookup for this class
            var weekMap = {};
            (prevue.semaines || []).forEach(function(s) {
                weekMap[s.date] = s;
            });

            // One cell per week
            allWeeks.forEach(function(w) {
                var td = document.createElement('td');
                td.className = 'week-cell';
                var sem = weekMap[w.date];
                var color = sem ? situationColor(sem) : '#1e293b';
                td.style.background = color;

                var isCurrent = w.date === currentMonday;
                if (isCurrent) {
                    td.style.outline = '2px solid var(--primary)';
                    td.style.outlineOffset = '0px';
                    td.style.zIndex = '3';
                    td.style.position = 'relative';
                }

                // Tooltip + click
                if (sem) {
                    var tipText = w.date + ' (' + w.semaine + ')';
                    var module = cleanModuleName(sem.module || '');
                    if (module && module !== 'N/A') tipText += ' ‚Äî ' + module;
                    if (sem.situation && sem.situation !== 'Normal') tipText += ' ‚Äî ' + sem.situation;
                    td.innerHTML = '<div class="tooltip">' + tipText + '</div>';
                    td.style.cursor = 'pointer';
                    (function(p, s) {
                        td.addEventListener('click', function() {
                            showWeekDetail(p.classeId, s, p.id);
                        });
                    })(prevue, sem);
                }

                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.innerHTML = '';
        container.appendChild(table);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VUE 4 : ALERTES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function computeAlerts() {
        var alerts = [];
        var today = new Date();
        var todayISO = today.toISOString().split('T')[0];

        // ‚îÄ‚îÄ 1. COPIES CHAIN: ramass√©es ‚Üí corrig√©es ‚Üí rendues ‚îÄ‚îÄ
        allLogs.forEach(function(log) {
            var cl = log.checklist || {};
            var dateLabel = log.date || '';
            var moduleLabel = (log.moduleId || '') + (log.seance ? ' ‚Äî ' + log.seance : '');

            // Copies ramass√©es mais pas encore corrig√©es
            if (cl.copies_ramassees && !cl.copies_corrigees) {
                var daysSince = dateLabel ? Math.floor((today - new Date(dateLabel)) / 86400000) : 0;
                alerts.push({
                    type: daysSince > 7 ? 'err' : 'warn',
                    icon: 'üìù',
                    text: log.classeId + ' ‚Äî Copies √† corriger',
                    detail: moduleLabel + (daysSince > 0 ? ' (ramass√©es il y a ' + daysSince + 'j)' : ''),
                    date: dateLabel,
                    priority: daysSince > 7 ? 4 : 2
                });
            }
            // Copies corrig√©es mais pas rendues
            if (cl.copies_corrigees && !cl.copies_rendues) {
                var daysSinceCorr = dateLabel ? Math.floor((today - new Date(dateLabel)) / 86400000) : 0;
                alerts.push({
                    type: daysSinceCorr > 5 ? 'err' : 'warn',
                    icon: 'üì§',
                    text: log.classeId + ' ‚Äî Copies √† rendre',
                    detail: moduleLabel + (daysSinceCorr > 0 ? ' (corrig√©es il y a ' + daysSinceCorr + 'j)' : ''),
                    date: dateLabel,
                    priority: daysSinceCorr > 5 ? 3 : 1
                });
            }
            // √âvaluation pass√©e mais pas corrig√©e
            if (cl.eval_passee && !cl.eval_corrigee) {
                var daysSinceEval = dateLabel ? Math.floor((today - new Date(dateLabel)) / 86400000) : 0;
                alerts.push({
                    type: 'err',
                    icon: 'üî¥',
                    text: log.classeId + ' ‚Äî √âvaluation √† corriger',
                    detail: (log.moduleId || '') + (daysSinceEval > 0 ? ' (pass√©e il y a ' + daysSinceEval + 'j)' : ''),
                    date: dateLabel,
                    priority: 4
                });
            }
            // √âvaluation corrig√©e mais pas rendue
            if (cl.eval_corrigee && !cl.eval_rendue) {
                alerts.push({
                    type: 'warn',
                    icon: 'üì§',
                    text: log.classeId + ' ‚Äî √âvaluation √† rendre',
                    detail: (log.moduleId || ''),
                    date: dateLabel,
                    priority: 2
                });
            }
        });

        // ‚îÄ‚îÄ 2. CCF COUNTDOWNS (s√©ances restantes avant fin d'ann√©e) ‚îÄ‚îÄ
        var finAnnee = new Date('2026-06-30');
        allPrevue.forEach(function(prevue) {
            var classeId = prevue.classeId || '';
            // Check if class has CCF modules (BAC PRO)
            var hasCCF = false;
            (prevue.semaines || []).forEach(function(sem) {
                if ((sem.situation || '').toLowerCase().includes('ccf') || (sem.phase || '').toLowerCase().includes('ccf')) hasCCF = true;
            });

            // Compute remaining s√©ances using utils if EDT data is available
            try {
                var remaining = computeSeancesDisponibles(classeId, todayISO, '2026-06-30', EDT, VACANCES, FERIES, PFMP);
                if (remaining && remaining.count <= 8 && remaining.count > 0) {
                    alerts.push({
                        type: remaining.count <= 3 ? 'err' : 'warn',
                        icon: '‚è≥',
                        text: classeId + ' ‚Äî ' + remaining.count + ' s√©ance' + (remaining.count > 1 ? 's' : '') + ' restante' + (remaining.count > 1 ? 's' : ''),
                        detail: 'Jusqu\'au 30 juin 2026' + (hasCCF ? ' ‚ö†Ô∏è CCF √† pr√©voir' : ''),
                        date: '',
                        priority: remaining.count <= 3 ? 5 : 2
                    });
                }
            } catch(e) { /* skip if EDT not matching */ }
        });

        // ‚îÄ‚îÄ 3. COURS NON SAISIS (pass√©s sans log) ‚îÄ‚îÄ
        // Check the last 2 weeks for missing logs
        var twoWeeksAgo = new Date(today.getTime() - 14 * 86400000);
        var twoWeeksISO = twoWeeksAgo.toISOString().split('T')[0];
        var missingByClasse = {};

        // Iterate over EDT to find courses that should have happened
        for (var dayOffset = 0; dayOffset < 14; dayOffset++) {
            var checkDate = new Date(twoWeeksAgo.getTime() + dayOffset * 86400000);
            if (checkDate >= today) break;
            var checkISO = checkDate.toISOString().split('T')[0];
            var dayOfWeek = checkDate.getDay(); // 0=Sun

            EDT.forEach(function(cours) {
                if (cours.jour !== dayOfWeek) return;
                if (!coursSePasse(cours, checkDate)) return;
                var classeId = cours.classe || '';
                if (isVacances(checkDate, VACANCES) || isFerie(checkDate, FERIES) || isPFMP(checkDate, classeId, PFMP)) return;

                // Check if a log exists for this class + date
                var hasLog = allLogs.some(function(log) {
                    return log.date === checkISO && classesMatch(log.classeId || log.classeDocId || '', classeId);
                });
                if (!hasLog) {
                    if (!missingByClasse[classeId]) missingByClasse[classeId] = 0;
                    missingByClasse[classeId]++;
                }
            });
        }

        Object.keys(missingByClasse).forEach(function(classeId) {
            var count = missingByClasse[classeId];
            if (count > 0) {
                alerts.push({
                    type: count > 3 ? 'err' : 'info',
                    icon: 'üìã',
                    text: classeId + ' ‚Äî ' + count + ' cours non saisi' + (count > 1 ? 's' : ''),
                    detail: 'Derni√®res 2 semaines ‚Äî cliquez pour saisir',
                    date: '',
                    priority: count > 3 ? 3 : 1
                });
            }
        });

        // ‚îÄ‚îÄ 4. RETARD vs progression_prevue ‚îÄ‚îÄ
        allPrevue.forEach(function(prevue) {
            var behindCount = 0;
            var reporteCount = 0;
            var prevuRetardCount = 0;
            (prevue.semaines || []).forEach(function(sem) {
                var sit = (sem.situation || '').toLowerCase();
                if (sit.includes('vacances') || sit.includes('pfmp') || sit.includes('feri') || sit.includes('f√©ri')) return;
                var d = parseDate(sem.date);
                if (!d || d >= today) return;

                if (!isRealise(sem) && !isReporte(sem) && !isNonRealise(sem) && !isPrevu(sem) && sit === 'normal') {
                    behindCount++;
                }
                if (isReporte(sem)) reporteCount++;
                if (isPrevu(sem)) prevuRetardCount++;
            });
            if (behindCount > 0) {
                alerts.push({
                    type: 'info', icon: '‚è∞',
                    text: prevue.classeId + ' ‚Äî ' + behindCount + ' semaine' + (behindCount > 1 ? 's' : '') + ' en retard',
                    detail: 'Semaines pass√©es non renseign√©es',
                    date: '',
                    priority: 1
                });
            }
            if (reporteCount > 0) {
                alerts.push({
                    type: 'warn', icon: 'üîÑ',
                    text: prevue.classeId + ' ‚Äî ' + reporteCount + ' s√©ance' + (reporteCount > 1 ? 's' : '') + ' report√©e' + (reporteCount > 1 ? 's' : ''),
                    detail: 'S√©ances report√©es √† replanifier',
                    date: '',
                    priority: 2
                });
            }
            if (prevuRetardCount > 0) {
                alerts.push({
                    type: 'warn', icon: '‚ö†Ô∏è',
                    text: prevue.classeId + ' ‚Äî ' + prevuRetardCount + ' s√©ance' + (prevuRetardCount > 1 ? 's' : '') + ' pr√©vue' + (prevuRetardCount > 1 ? 's' : '') + ' non r√©alis√©e' + (prevuRetardCount > 1 ? 's' : ''),
                    detail: 'Statut "Pr√©vu" sur des semaines pass√©es',
                    date: '',
                    priority: 2
                });
            }
        });

        // ‚îÄ‚îÄ 5. √âL√àVES ABSENTS avec cours non distribu√©s ‚îÄ‚îÄ
        allLogs.forEach(function(log) {
            if (!log.absencesNoms || !log.checklist) return;
            var cl = log.checklist;
            if (cl.distribuer_cours && !cl.distribuer_absents_done) {
                alerts.push({
                    type: 'info', icon: 'üéí',
                    text: log.classeId + ' ‚Äî Cours √† distribuer aux absents',
                    detail: log.absencesNoms + ' (' + (log.date || '') + ')',
                    date: log.date || '',
                    priority: 1
                });
            }
        });

        // Sort by priority desc, then date desc
        alerts.sort(function(a, b) {
            if (b.priority !== a.priority) return b.priority - a.priority;
            return (b.date || '').localeCompare(a.date || '');
        });

        return alerts;
    }

    function renderAlertes() {
        var container = document.getElementById('alertesContent');
        var alerts = computeAlerts();

        if (alerts.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">‚úÖ</div><p>Aucune alerte. Tout est √† jour !</p></div>';
            return;
        }

        container.innerHTML = '';

        // Summary bar
        var errCount = alerts.filter(function(a) { return a.type === 'err'; }).length;
        var warnCount = alerts.filter(function(a) { return a.type === 'warn'; }).length;
        var infoCount = alerts.filter(function(a) { return a.type === 'info'; }).length;
        var summaryCard = document.createElement('div');
        summaryCard.className = 'card';
        summaryCard.style.cssText = 'padding:14px 18px; margin-bottom:14px;';
        summaryCard.innerHTML = '<div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">' +
            '<span style="font-weight:800; font-size:.92em;">' + alerts.length + ' alerte' + (alerts.length > 1 ? 's' : '') + '</span>' +
            (errCount ? '<span style="padding:4px 12px; border-radius:20px; background:var(--danger-light); color:var(--danger); font-size:.78em; font-weight:700;">üî¥ ' + errCount + ' urgent' + (errCount > 1 ? 'es' : 'e') + '</span>' : '') +
            (warnCount ? '<span style="padding:4px 12px; border-radius:20px; background:var(--warning-light); color:var(--warning); font-size:.78em; font-weight:700;">üü† ' + warnCount + ' attention</span>' : '') +
            (infoCount ? '<span style="padding:4px 12px; border-radius:20px; background:var(--primary-light); color:var(--primary); font-size:.78em; font-weight:700;">üü° ' + infoCount + ' info</span>' : '') +
            '</div>';
        container.appendChild(summaryCard);

        // Group by type
        var errAlerts = alerts.filter(function(a) { return a.type === 'err'; });
        var warnAlerts = alerts.filter(function(a) { return a.type === 'warn'; });
        var infoAlerts = alerts.filter(function(a) { return a.type === 'info'; });

        if (errAlerts.length > 0) {
            var card = document.createElement('div');
            card.className = 'card';
            card.style.borderLeft = '4px solid var(--danger)';
            card.innerHTML = '<div class="card-title">üî¥ Urgent <span class="count" style="background:var(--danger-light); color:var(--danger);">' + errAlerts.length + '</span></div>';
            errAlerts.forEach(function(a) { card.appendChild(createAlertItem(a)); });
            container.appendChild(card);
        }

        if (warnAlerts.length > 0) {
            var card2 = document.createElement('div');
            card2.className = 'card';
            card2.style.borderLeft = '4px solid var(--warning)';
            card2.innerHTML = '<div class="card-title">üü† Attention <span class="count" style="background:var(--warning-light); color:var(--warning);">' + warnAlerts.length + '</span></div>';
            warnAlerts.forEach(function(a) { card2.appendChild(createAlertItem(a)); });
            container.appendChild(card2);
        }

        if (infoAlerts.length > 0) {
            var card3 = document.createElement('div');
            card3.className = 'card';
            card3.style.borderLeft = '4px solid var(--primary)';
            card3.innerHTML = '<div class="card-title">üü° Information <span class="count" style="background:var(--primary-light); color:var(--primary);">' + infoAlerts.length + '</span></div>';
            infoAlerts.forEach(function(a) { card3.appendChild(createAlertItem(a)); });
            container.appendChild(card3);
        }
    }

    function createAlertItem(alert) {
        var div = document.createElement('div');
        div.className = 'alert-item ' + alert.type;
        div.innerHTML = '<span class="alert-icon">' + alert.icon + '</span>' +
            '<div class="alert-text"><strong>' + alert.text + '</strong>' +
            (alert.detail ? '<br><span style="font-size:0.85em; opacity:0.8;">' + alert.detail + '</span>' : '') +
            '</div>' +
            (alert.date ? '<span class="alert-date">' + alert.date + '</span>' : '');
        return div;
    }

    function showToast(message) {
        var toast = document.getElementById('toast');
        if (!toast) return;
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(function() { toast.classList.remove('show'); }, 2400);
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AGENDA DYNAMIQUE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    var agendaCurrentDate = new Date();
    var agendaView = 'day'; // 'day' | 'week'
    var pronoteEvents = [];
    var customEvents = [];

    var EMPLOI_DU_TEMPS_AGENDA = [
        {jour:1,heure:'09:30',heureFin:'10:30',classe:'C2PSR',salle:'010'},
        {jour:1,heure:'10:30',heureFin:'11:30',classe:'C1PSR',salle:'010'},
        {jour:1,heure:'15:00',heureFin:'17:00',classe:'C1PSR',salle:'010'},
        {jour:1,heure:'17:00',heureFin:'18:00',classe:'B2GATL1',salle:'205'},
        {jour:2,heure:'08:30',heureFin:'09:30',classe:'B1MELEC',salle:'205'},
        {jour:2,heure:'09:30',heureFin:'10:30',classe:'C2HORT',salle:'205'},
        {jour:2,heure:'10:30',heureFin:'12:30',classe:'BTAGO',salle:'205'},
        {jour:4,heure:'08:30',heureFin:'09:30',classe:'B2GATL2',salle:'205'},
        {jour:4,heure:'09:30',heureFin:'10:30',classe:'C2JP',salle:'205'},
        {jour:4,heure:'11:30',heureFin:'12:30',classe:'BTMELEC',salle:'205'},
        {jour:4,heure:'14:00',heureFin:'15:00',classe:'C1JP',salle:'205'},
        {jour:5,heure:'08:30',heureFin:'09:30',classe:'C1JP',salle:'118'},
        {jour:5,heure:'09:30',heureFin:'10:30',classe:'B2MELEC',salle:'118'},
        {jour:5,heure:'11:30',heureFin:'12:30',classe:'C1PSR',salle:'205'},
        {jour:5,heure:'15:00',heureFin:'16:00',classe:'C1CAN',salle:'205'}
    ];

    var TYPE_COLORS = {
        'CCF':        { bg:'#fce7f3', border:'#ec4899', cls:'ccf' },
        'Bac blanc':  { bg:'#fce7f3', border:'#ec4899', cls:'bac' },
        'PFMP':       { bg:'#ede9fe', border:'#8b5cf6', cls:'pfmp' },
        'R√©union':    { bg:'rgba(99,102,241,0.12)', border:'#60a5fa', cls:'reunion' },
        'F√©ri√©':      { bg:'#1e293b', border:'#94a3b8', cls:'' },
        'Sortie scolaire':{ bg:'#ecfeff', border:'#06b6d4', cls:'' },
        'Autre':      { bg:'#fef3c7', border:'#fbbf24', cls:'' }
    };

    // Charger Pronote + √©v√©nements perso depuis Firebase
    async function loadAgendaData() {
        try {
            var edtDoc = await getDoc(doc(db, 'progression_config', 'emploi_du_temps'));
            if (edtDoc.exists()) pronoteEvents = edtDoc.data().events || [];
        } catch(e) { pronoteEvents = []; }
        try {
            var evSnap = await getDocs(collection(db, 'agenda_events'));
            customEvents = [];
            evSnap.forEach(function(d) { customEvents.push({id:d.id,...d.data()}); });
        } catch(e) { customEvents = []; }
        renderAgenda();
    }

    function agendaGoToToday() {
        agendaCurrentDate = new Date();
        renderAgenda();
    }

    function agendaNav(direction) {
        if (agendaView === 'day') {
            agendaCurrentDate.setDate(agendaCurrentDate.getDate() + direction);
        } else {
            agendaCurrentDate.setDate(agendaCurrentDate.getDate() + direction * 7);
        }
        renderAgenda();
    }

    window.agendaNav = agendaNav;
    window.agendaGoToToday = agendaGoToToday;

    function setAgendaView(v) {
        agendaView = v;
        document.getElementById('agendaViewDay').style.background = v === 'day' ? 'var(--primary)' : 'white';
        document.getElementById('agendaViewDay').style.color = v === 'day' ? 'white' : 'var(--muted)';
        document.getElementById('agendaViewDay').style.borderColor = v === 'day' ? 'var(--primary)' : 'var(--border)';
        document.getElementById('agendaViewWeek').style.background = v === 'week' ? 'var(--primary)' : 'white';
        document.getElementById('agendaViewWeek').style.color = v === 'week' ? 'white' : 'var(--muted)';
        document.getElementById('agendaViewWeek').style.borderColor = v === 'week' ? 'var(--primary)' : 'var(--border)';
        renderAgenda();
    }
    window.setAgendaView = setAgendaView;

    function getCoursForDay(date) {
        var dateStr = date.toISOString().split('T')[0];
        var courses = [];

        if (pronoteEvents.length > 0) {
            pronoteEvents.forEach(function(ev) {
                if (!ev.start || !ev.classe) return;
                var evDate = new Date(ev.start);
                if (evDate.toISOString().split('T')[0] !== dateStr) return;
                var endDate = ev.end ? new Date(ev.end) : null;
                courses.push({
                    classe: ev.classe,
                    salle: ev.location || '',
                    heure: evDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}),
                    heureFin: endDate ? endDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}) : '',
                    startMs: evDate.getTime()
                });
            });
        } else {
            var dayOfWeek = date.getDay();
            EMPLOI_DU_TEMPS_AGENDA.forEach(function(e) {
                if (e.jour !== dayOfWeek) return;
                var parts = e.heure.split(':');
                var startDate = new Date(date);
                startDate.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);
                courses.push({
                    classe: e.classe, salle: e.salle,
                    heure: e.heure, heureFin: e.heureFin || '',
                    startMs: startDate.getTime()
                });
            });
        }
        courses.sort(function(a,b) { return a.startMs - b.startMs; });
        return courses;
    }

    function getEventsForDay(date) {
        var dateStr = date.toISOString().split('T')[0];
        return customEvents.filter(function(ev) {
            if (!ev.dateStart) return false;
            var start = ev.dateStart, end = ev.dateEnd || ev.dateStart;
            return dateStr >= start && dateStr <= end;
        });
    }

    function getLogForCourse(cours, dateStr) {
        if (!allLogs || allLogs.length === 0) return null;
        var best = null;
        allLogs.forEach(function(log) {
            if (log.date !== dateStr) return;
            if (classesMatch(log.classeId || '', cours.classe)) {
                if (!best || log.timestamp > (best.timestamp||0)) best = log;
            }
        });
        return best;
    }

    function getPrevueForCourse(cours) {
        if (!allPrevue || allPrevue.length === 0) return null;
        for (var i = 0; i < allPrevue.length; i++) {
            if (classesMatch(allPrevue[i].classeId, cours.classe)) return allPrevue[i];
        }
        return null;
    }

    function renderAgenda() {
        if (!document.getElementById('tabAgenda').classList.contains('active')) return;
        if (agendaView === 'day') renderAgendaDay();
        else renderAgendaWeek();
    }

    function renderAgendaDay() {
        var today = new Date();
        today.setHours(0,0,0,0);
        var d = new Date(agendaCurrentDate);
        d.setHours(0,0,0,0);
        var isToday = d.getTime() === today.getTime();
        var jourNoms = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
        var moisNoms = ['janv','f√©vr','mars','avr','mai','juin','juil','ao√ªt','sept','oct','nov','d√©c'];
        var label = jourNoms[d.getDay()] + ' ' + d.getDate() + ' ' + moisNoms[d.getMonth()] + ' ' + d.getFullYear();
        document.getElementById('agendaDateLabel').textContent = label;
        var dateStr = d.toISOString().split('T')[0];
        var courses = getCoursForDay(d);
        var events = getEventsForDay(d);
        var container = document.getElementById('agendaContent');
        container.innerHTML = '';

        // √âv√©nements du jour
        if (events.length > 0) {
            var evCard = document.createElement('div');
            evCard.className = 'card';
            evCard.style.marginBottom = '12px';
            evCard.innerHTML = '<div style="font-weight:800;font-size:.85em;margin-bottom:10px;color:var(--muted);">üìÖ √âV√âNEMENTS DU JOUR</div>';
            events.forEach(function(ev) {
                var colors = TYPE_COLORS[ev.type] || TYPE_COLORS['Autre'];
                var countdown = computeCountdown(ev.dateStart);
                var daysUntil = Math.round((new Date(ev.dateStart) - today)/(1000*60*60*24));
                var evDiv = document.createElement('div');
                evDiv.className = 'agenda-event ' + (colors.cls||'');
                evDiv.style.background = colors.bg;
                evDiv.style.borderColor = colors.border;
                evDiv.innerHTML = '<div class="agenda-event-title">' + (ev.type||'') + ' ‚Äî ' + (ev.title||'') + '</div>' +
                    '<div class="agenda-event-detail">' +
                    (ev.classes && ev.classes.length > 0 ? 'üè´ ' + ev.classes.join(', ') : '') +
                    (ev.timeStart ? ' ¬∑ ' + ev.timeStart + (ev.timeEnd ? '‚Üí'+ev.timeEnd:'') : '') +
                    '</div>' +
                    (daysUntil <= 14 && daysUntil >= 0 ? '<div class="agenda-event-countdown">‚è± Dans ' + daysUntil + ' jour' + (daysUntil>1?'s':'') + '</div>' : '') +
                    '<button onclick="deleteCustomEvent(\'' + ev.id + '\')" style="margin-top:5px;background:none;border:none;color:#9ca3af;font-size:.72em;cursor:pointer;font-family:inherit;">üóë Supprimer</button>';
                evCard.appendChild(evDiv);
            });
            container.appendChild(evCard);
        }

        if (courses.length === 0) {
            var emptyCard = document.createElement('div');
            emptyCard.className = 'card';
            emptyCard.innerHTML = '<div class="agenda-empty">Pas de cours ce jour üéâ<br><small>Utilisez ‚ñ∂ pour naviguer</small></div>';
            container.appendChild(emptyCard);
            return;
        }

        var dayDiv = document.createElement('div');
        dayDiv.className = 'agenda-day';
        var header = document.createElement('div');
        header.className = 'agenda-day-header' + (isToday ? ' today' : '');
        header.innerHTML = (isToday ? 'üìç ' : '') + label + ' ‚Äî ' + courses.length + ' cours';
        dayDiv.appendChild(header);
        var body = document.createElement('div');
        body.className = 'agenda-day-body';

        courses.forEach(function(cours) {
            var log = getLogForCourse(cours, dateStr);
            var prevue = getPrevueForCourse(cours);
            var slot = buildAgendaSlot(cours, log, prevue, dateStr, isToday);
            body.appendChild(slot);
        });
        dayDiv.appendChild(body);
        container.appendChild(dayDiv);
    }

    function renderAgendaWeek() {
        var d = new Date(agendaCurrentDate);
        var day = d.getDay();
        var monday = new Date(d);
        monday.setDate(d.getDate() - (day === 0 ? 6 : day - 1));
        monday.setHours(0,0,0,0);
        var friday = new Date(monday);
        friday.setDate(monday.getDate() + 4);
        var moisNoms = ['janv','f√©vr','mars','avr','mai','juin','juil','ao√ªt','sept','oct','nov','d√©c'];
        var label = 'Semaine du ' + monday.getDate() + ' ' + moisNoms[monday.getMonth()] +
            ' au ' + friday.getDate() + ' ' + moisNoms[friday.getMonth()] + ' ' + friday.getFullYear();
        document.getElementById('agendaDateLabel').textContent = label;
        var today = new Date(); today.setHours(0,0,0,0);
        var container = document.getElementById('agendaContent');
        container.innerHTML = '';

        // Strip des jours
        var strip = document.createElement('div');
        strip.className = 'week-strip';
        var jourNoms = ['', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven'];
        for (var dd = 0; dd < 5; dd++) {
            var dayDate = new Date(monday);
            dayDate.setDate(monday.getDate() + dd);
            var dayCourses = getCoursForDay(dayDate);
            var dayEvents = getEventsForDay(dayDate);
            var isT = dayDate.getTime() === today.getTime();
            var card = document.createElement('div');
            card.className = 'week-day-card' + (isT ? ' today' : '');
            var dots = dayCourses.map(function(c) {
                var dateStr = dayDate.toISOString().split('T')[0];
                var log = getLogForCourse(c, dateStr);
                var color = log ? (log.statut === 'R√©alis√©' ? '#22c55e' : log.statut === 'Report√©' ? '#f59e0b' : '#dc2626') : '#c7d2fe';
                return '<div class="week-dot" style="background:'+color+'"></div>';
            }).join('');
            card.innerHTML = '<div class="week-day-name">' + jourNoms[dayDate.getDay()] + '</div>' +
                '<div class="week-day-num">' + dayDate.getDate() + '</div>' +
                (dayCourses.length > 0 ? '<div class="week-day-count">' + dayCourses.length + ' cours</div>' : '') +
                (dayEvents.length > 0 ? '<div class="week-day-count" style="color:#f59e0b;">'+dayEvents.length+' √©v.</div>' : '') +
                '<div class="week-day-dots">' + dots + '</div>';
            (function(dd2) {
                card.addEventListener('click', function() {
                    var clickedDate = new Date(monday);
                    clickedDate.setDate(monday.getDate() + dd2);
                    agendaCurrentDate = clickedDate;
                    setAgendaView('day');
                });
            })(dd);
            strip.appendChild(card);
        }
        container.appendChild(strip);

        // Cours de la semaine par jour
        for (var d2 = 0; d2 < 5; d2++) {
            var dayDate2 = new Date(monday);
            dayDate2.setDate(monday.getDate() + d2);
            var courses2 = getCoursForDay(dayDate2);
            var events2 = getEventsForDay(dayDate2);
            if (courses2.length === 0 && events2.length === 0) continue;
            var dateStr2 = dayDate2.toISOString().split('T')[0];
            var isT2 = dayDate2.getTime() === today.getTime();
            var dayDiv = document.createElement('div');
            dayDiv.className = 'agenda-day';
            var header2 = document.createElement('div');
            header2.className = 'agenda-day-header' + (isT2 ? ' today' : '');
            header2.innerHTML = jourNoms[dayDate2.getDay()] + ' ' + dayDate2.getDate() + '/' + (dayDate2.getMonth()+1) +
                (isT2 ? ' ‚Äî Aujourd\'hui' : '');
            dayDiv.appendChild(header2);
            var body2 = document.createElement('div');
            body2.className = 'agenda-day-body';
            // Afficher d'abord les √©v√©nements
            events2.forEach(function(ev) {
                var colors = TYPE_COLORS[ev.type] || TYPE_COLORS['Autre'];
                var evDiv = document.createElement('div');
                evDiv.className = 'agenda-event ' + (colors.cls||'');
                evDiv.style.margin = '8px 10px 4px';
                evDiv.style.background = colors.bg;
                evDiv.style.borderColor = colors.border;
                evDiv.innerHTML = '<div class="agenda-event-title">' + (ev.type||'') + (ev.title ? ' ‚Äî '+ev.title : '') + '</div>' +
                    '<div class="agenda-event-detail">' + (ev.classes && ev.classes.length>0 ? ev.classes.join(', ') : '') + '</div>';
                body2.appendChild(evDiv);
            });
            courses2.forEach(function(cours) {
                var log2 = getLogForCourse(cours, dateStr2);
                var prevue2 = getPrevueForCourse(cours);
                var slot = buildAgendaSlot(cours, log2, prevue2, dateStr2, isT2);
                body2.appendChild(slot);
            });
            dayDiv.appendChild(body2);
            container.appendChild(dayDiv);
        }
    }

    function buildAgendaSlot(cours, log, prevue, dateStr, isToday) {
        var slot = document.createElement('div');
        slot.className = 'agenda-slot';

        var now = new Date();
        var startParts = cours.heure ? cours.heure.split(':') : [0,0];
        var courseDate = new Date(dateStr + 'T' + (cours.heure||'00:00') + ':00');
        var diffMin = (now.getTime() - courseDate.getTime()) / 60000;
        var isCurrent = isToday && diffMin >= -5 && diffMin < 70;

        var timeDiv = document.createElement('div');
        timeDiv.className = 'agenda-slot-time' + (log ? ' has-log' : '') + (isCurrent ? ' is-current' : '');
        timeDiv.innerHTML = '<span>' + (cours.heure||'') + '</span>' + (cours.heureFin ? '<span>'+cours.heureFin+'</span>' : '');
        slot.appendChild(timeDiv);

        var bodyDiv = document.createElement('div');
        bodyDiv.className = 'agenda-slot-body';

        var infoDiv = document.createElement('div');
        infoDiv.style.flex = '1';

        // Classe + salle
        var classSpan = document.createElement('div');
        classSpan.innerHTML = '<span class="agenda-slot-class">' + cours.classe + '</span>' +
            (cours.salle ? ' <span class="agenda-slot-room">Salle ' + cours.salle + '</span>' : '');
        infoDiv.appendChild(classSpan);

        // Module pr√©vu
        if (prevue) {
            var weekSem = findCurrentWeekSemaine(prevue, dateStr);
            if (weekSem && weekSem.moduleBase) {
                var modDiv = document.createElement('div');
                modDiv.style.fontSize = '.73em'; modDiv.style.color = 'var(--muted)'; modDiv.style.marginTop = '2px';
                modDiv.textContent = 'üìö ' + cleanModuleName(weekSem.module || weekSem.moduleBase || '');
                infoDiv.appendChild(modDiv);
            }
        }

        // Log existant
        if (log) {
            var logDiv = document.createElement('div');
            logDiv.style.fontSize = '.73em'; logDiv.style.marginTop = '3px';
            var seances = Array.isArray(log.seances) ? log.seances.join('+') : (log.seance||'');
            var meteo = log.meteo ? log.meteo.emoji + ' ' : '';
            logDiv.innerHTML = '<span style="color:var(--success);">' + meteo + (log.moduleId||'') + ' ‚Äî ' + seances + '</span>';
            if (log.arret) logDiv.innerHTML += '<br><span style="color:var(--muted);">üìç ' + log.arret + '</span>';
            infoDiv.appendChild(logDiv);
        }
        bodyDiv.appendChild(infoDiv);

        // Statut badge
        var statusDiv = document.createElement('div');
        statusDiv.className = 'agenda-slot-status';
        var statusToday = new Date(dateStr + 'T12:00:00').getTime() < now.getTime();
        if (log) {
            var statusCls = log.statut === 'R√©alis√©' ? 'status-realise' :
                            log.statut === 'Report√©' ? 'status-reporte' :
                            log.statut === 'Annul√©' ? 'status-annule' : 'status-prevu';
            statusDiv.className += ' ' + statusCls;
            statusDiv.textContent = log.statut || '?';
        } else if (!statusToday || !isToday && statusToday) {
            statusDiv.className += ' status-vide';
            statusDiv.textContent = isCurrent ? '‚ö° En cours' : '‚óã √Ä saisir';
        }
        bodyDiv.appendChild(statusDiv);
        slot.appendChild(bodyDiv);

        // Click ‚Üí ouvrir √©dition s√©ance
        slot.addEventListener('click', function() {
            openEditSeance(cours, log, prevue, dateStr);
        });

        return slot;
    }

    function findCurrentWeekSemaine(prevue, dateStr) {
        if (!prevue || !prevue.semaines) return null;
        var d = new Date(dateStr);
        for (var i = 0; i < prevue.semaines.length; i++) {
            var sem = prevue.semaines[i];
            if (!sem.date) continue;
            var parts = sem.date.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (!parts) continue;
            var semDate = new Date(parseInt(parts[3]), parseInt(parts[2])-1, parseInt(parts[1]));
            var diff = (d - semDate) / (1000*60*60*24);
            if (diff >= 0 && diff < 7) return sem;
        }
        return null;
    }

    function computeCountdown(dateStr) {
        if (!dateStr) return '';
        var today = new Date(); today.setHours(0,0,0,0);
        var target = new Date(dateStr);
        var diff = Math.round((target - today)/(1000*60*60*24));
        if (diff < 0) return diff + 'j';
        if (diff === 0) return 'Aujourd\'hui';
        return 'Dans ' + diff + 'j';
    }

    // ‚îÄ‚îÄ MODAL √âDITION S√âANCE ‚îÄ‚îÄ
    window.openEditSeance = function(cours, log, prevue, dateStr) {
        var modal = document.getElementById('editSeanceModal');
        var overlay = document.getElementById('editSeanceOverlay');
        var content = document.getElementById('editSeanceContent');
        modal.style.display = 'block';
        overlay.style.display = 'block';

        var weekSem = prevue ? findCurrentWeekSemaine(prevue, dateStr) : null;
        var moduleLabel = weekSem ? cleanModuleName(weekSem.module || weekSem.moduleBase || '') : '';
        var meteo = log && log.meteo ? log.meteo.emoji + ' ' : '';
        var seances = log ? (Array.isArray(log.seances) ? log.seances.join(' + ') : (log.seance||'')) : '';

        var html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">' +
            '<div>' +
            '<div style="font-weight:800;font-size:1.1em;">' + cours.classe + (cours.salle?' ‚Äî Salle '+cours.salle:'') + '</div>' +
            '<div style="font-size:.8em;color:var(--muted);">' + cours.heure + (cours.heureFin?'‚Üí'+cours.heureFin:'') + ' ¬∑ ' + dateStr + '</div>' +
            '</div>' +
            '<button onclick="closeEditSeance()" style="background:none;border:none;font-size:1.4em;cursor:pointer;color:var(--muted);">‚úï</button>' +
            '</div>';

        // Module pr√©vu
        if (moduleLabel) {
            html += '<div style="padding:10px 12px;border-radius:9px;background:var(--primary-light);border:1px solid rgba(99,102,241,0.3);font-size:.83em;margin-bottom:12px;">' +
                '<strong>üìö Pr√©vu :</strong> ' + moduleLabel;
            if (weekSem && weekSem.seance) html += ' ‚Äî ' + weekSem.seance;
            if (weekSem && weekSem.situation && weekSem.situation !== 'Normal') {
                html += '<br><span style="color:var(--warning);font-weight:700;">‚ö†Ô∏è ' + weekSem.situation + '</span>';
            }
            html += '</div>';
        }

        // Log existant
        if (log) {
            html += '<div style="padding:11px 12px;border-radius:9px;background:var(--success-light);border:1px solid rgba(16,185,129,0.3);font-size:.83em;margin-bottom:12px;">' +
                '<strong>‚úÖ S√©ance saisie :</strong> ' + meteo + (log.moduleId||'') + (seances ? ' ‚Äî '+seances : '') +
                (log.statut ? ' ['+log.statut+']' : '') +
                (log.arret ? '<br>üìç Arr√™t : '+log.arret : '') +
                (log.remarque ? '<br>üí¨ '+log.remarque : '') +
                '</div>';
        }

        // Actions
        html += '<div style="display:grid;gap:8px;margin-top:4px;">';

        // Saisir / modifier
        var logUrl = 'log.html?date=' + encodeURIComponent(dateStr) + '&classe=' + encodeURIComponent(cours.classe);
        html += '<a href="' + logUrl + '" style="display:flex;align-items:center;gap:10px;padding:14px 16px;border-radius:12px;background:linear-gradient(135deg,#10b981,#059669);color:white;font-weight:700;text-decoration:none;font-size:.92em;">' +
            (log ? '‚úèÔ∏è Modifier la saisie' : 'üìù Saisir la s√©ance') + ' ‚Äî ' + cours.classe + '</a>';

        // Mettre √† jour la progression (situation)
        html += '<button onclick="updateSituationFromAgenda(\'' + (prevue?prevue.id:'') + '\',\'' + dateStr + '\')" style="padding:13px 16px;border-radius:12px;border:2px solid var(--warning);background:var(--warning-light);color:var(--warning);font-weight:700;font-size:.82em;cursor:pointer;font-family:inherit;">üìã Modifier la situation pr√©vue</button>';

        html += '</div>';

        content.innerHTML = html;
    };

    window.closeEditSeance = function() {
        document.getElementById('editSeanceModal').style.display = 'none';
        document.getElementById('editSeanceOverlay').style.display = 'none';
    };

    // ‚îÄ‚îÄ MODIFIER SITUATION DEPUIS AGENDA ‚îÄ‚îÄ
    window.updateSituationFromAgenda = function(classeDocId, dateStr) {
        if (!classeDocId) { showToast('Classe non trouv√©e dans la progression'); return; }
        var situations = ['Normal','Vacances scolaires','PFMP','Jours f√©ri√©s','CCF','BAC BLANC','Sortie scolaire','Annul√©','Formation','Absent'];
        var choix = prompt('Situation pour ' + dateStr + ' :\n' + situations.map(function(s,i){return (i+1)+'. '+s;}).join('\n') + '\n\nEntrez le num√©ro :');
        if (!choix) return;
        var idx = parseInt(choix) - 1;
        if (idx < 0 || idx >= situations.length) { showToast('Num√©ro invalide'); return; }
        var newSituation = situations[idx];
        updateSituationInPrevue(classeDocId, dateStr, newSituation);
    };

    async function updateSituationInPrevue(classeDocId, dateStr, situation) {
        var prevue = allPrevue.find(function(p) { return p.id === classeDocId; });
        if (!prevue || !prevue.semaines) { showToast('Progression non trouv√©e'); return; }
        var target = new Date(dateStr);
        var found = false;
        prevue.semaines.forEach(function(sem) {
            if (!sem.date) return;
            var parts = sem.date.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (!parts) return;
            var semDate = new Date(parseInt(parts[3]), parseInt(parts[2])-1, parseInt(parts[1]));
            var diff = (target - semDate) / (1000*60*60*24);
            if (diff >= 0 && diff < 7) { sem.situation = situation; found = true; }
        });
        if (!found) { showToast('Semaine non trouv√©e dans la progression'); return; }
        try {
            await updateDoc(doc(db, 'progression_prevue', classeDocId), { semaines: prevue.semaines });
            showToast('‚úÖ Situation mise √† jour : ' + situation);
            closeEditSeance();
        } catch(e) { showToast('Erreur : ' + e.message); }
    }

    // ‚îÄ‚îÄ MODAL AJOUT √âV√âNEMENT ‚îÄ‚îÄ
    var eventModalData = { type: '', classes: [] };

    window.openAddEventModal = function() {
        var modal = document.getElementById('eventModal');
        var overlay = document.getElementById('eventModalOverlay');
        eventModalData = { type: '', classes: [] };
        document.getElementById('eventTitle').value = '';
        document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('eventDateEnd').value = '';
        document.getElementById('eventTimeStart').value = '';
        document.getElementById('eventTimeEnd').value = '';
        document.querySelectorAll('.ev-type-btn').forEach(function(b) {
            b.style.borderColor='var(--border)'; b.style.background='white'; b.style.color='var(--muted)';
        });
        // Build classes grid
        var grid = document.getElementById('eventClassesGrid');
        grid.innerHTML = '';
        allPrevue.forEach(function(p) {
            var btn = document.createElement('button');
            btn.style.cssText = 'padding:7px 12px;border:2px solid var(--border);border-radius:18px;background:var(--surface-2);font-size:.77em;font-weight:700;cursor:pointer;font-family:inherit;color:var(--muted);transition:all .15s;';
            btn.textContent = p.classeId;
            btn.addEventListener('click', function() {
                var idx = eventModalData.classes.indexOf(p.classeId);
                if (idx >= 0) {
                    eventModalData.classes.splice(idx,1);
                    btn.style.borderColor='var(--border)'; btn.style.background='white'; btn.style.color='var(--muted)';
                } else {
                    eventModalData.classes.push(p.classeId);
                    btn.style.borderColor='var(--primary)'; btn.style.background='var(--primary-light)'; btn.style.color='var(--primary)';
                }
            });
            grid.appendChild(btn);
        });
        modal.style.display = 'block';
        overlay.style.display = 'block';
    };

    window.closeEventModal = function() {
        document.getElementById('eventModal').style.display = 'none';
        document.getElementById('eventModalOverlay').style.display = 'none';
    };

    window.selectEvType = function(type, btn) {
        document.querySelectorAll('.ev-type-btn').forEach(function(b) {
            b.style.borderColor='var(--border)'; b.style.background='white'; b.style.color='var(--muted)';
        });
        eventModalData.type = type;
        btn.style.borderColor='var(--primary)'; btn.style.background='var(--primary-light)'; btn.style.color='var(--primary)';
    };

    window.saveEvent = async function() {
        if (!eventModalData.type) { showToast('S√©lectionnez un type'); return; }
        var dateStart = document.getElementById('eventDate').value;
        if (!dateStart) { showToast('S√©lectionnez une date'); return; }
        var eventData = {
            type: eventModalData.type,
            title: document.getElementById('eventTitle').value.trim(),
            classes: eventModalData.classes.slice(),
            dateStart: dateStart,
            dateEnd: document.getElementById('eventDateEnd').value || dateStart,
            timeStart: document.getElementById('eventTimeStart').value || '',
            timeEnd: document.getElementById('eventTimeEnd').value || '',
            createdAt: new Date().toISOString()
        };
        try {
            var docId = 'ev_' + Date.now();
            await setDoc(doc(db, 'agenda_events', docId), eventData);
            customEvents.push({id: docId, ...eventData});
            closeEventModal();
            renderAgenda();
            showToast('‚úÖ √âv√©nement ajout√© !');
            // Mettre aussi √† jour la progression pour chaque classe concern√©e
            if (eventData.classes.length > 0) {
                var sitLabel = eventData.type;
                for (var i = 0; i < eventData.classes.length; i++) {
                    var prevueItem = allPrevue.find(function(p) { return p.classeId === eventData.classes[i]; });
                    if (prevueItem) await updateSituationInPrevue(prevueItem.id, dateStart, sitLabel);
                }
            }
        } catch(e) { showToast('Erreur: ' + e.message); }
    };

    window.deleteCustomEvent = async function(eventId) {
        if (!confirm('Supprimer cet √©v√©nement ?')) return;
        try {
            var { deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js");
            await deleteDoc(doc(db, 'agenda_events', eventId));
            customEvents = customEvents.filter(function(e) { return e.id !== eventId; });
            renderAgenda();
            showToast('√âv√©nement supprim√©');
        } catch(e) { showToast('Erreur: ' + e.message); }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // M√âT√âO ‚Äî Chart.js lazy-load + rendering
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    var chartJsLoaded = false;
    var meteoChartInstance = null;
    var currentMeteoView = 'semaine';

    function loadChartJs() {
        return new Promise(function(resolve) {
            if (chartJsLoaded) { resolve(); return; }
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
            script.onload = function() { chartJsLoaded = true; resolve(); };
            document.head.appendChild(script);
        });
    }

    window.setMeteoView = function(view) {
        currentMeteoView = view;
        document.querySelectorAll('.meteo-view-btn').forEach(function(b) {
            if (b.dataset.view === view) {
                b.style.borderColor = 'var(--primary)';
                b.style.background = 'var(--primary)';
                b.style.color = 'white';
            } else {
                b.style.borderColor = 'var(--border)';
                b.style.background = 'var(--surface-2)';
                b.style.color = 'var(--muted)';
            }
        });
        var classeFilter = document.getElementById('meteoClasseFilter');
        if (classeFilter) classeFilter.style.display = (view === 'classe') ? 'block' : 'none';
        renderMeteo();
    };

    function getMeteoData() {
        // Extract meteo scores from all logs
        var data = [];
        allLogs.forEach(function(log) {
            if (!log.date) return;
            var meteoEmoji = log.meteo || '';
            var score = meteoToScore(meteoEmoji);
            if (score === 0 && !log.cps) return; // No meteo data at all

            var cps = log.cps || {};
            data.push({
                date: log.date,
                classeId: log.classeId || log.classeDocId || '',
                global: score,
                cognitif: parseInt(cps.cognitif) || 0,
                emotionnel: parseInt(cps.emotionnel) || 0,
                social: parseInt(cps.social) || 0
            });
        });
        data.sort(function(a, b) { return a.date.localeCompare(b.date); });
        return data;
    }

    function renderMeteoSemaine(data) {
        // Group by date, average scores per day
        var byDate = {};
        data.forEach(function(d) {
            if (!byDate[d.date]) byDate[d.date] = [];
            byDate[d.date].push(d);
        });

        var dates = Object.keys(byDate).sort();
        // Take last 20 entries max for readability
        if (dates.length > 20) dates = dates.slice(-20);

        var labels = dates.map(function(d) {
            var parts = d.split('-');
            return (parts[2] || '') + '/' + (parts[1] || '');
        });

        var globalAvg = dates.map(function(d) {
            var entries = byDate[d].filter(function(e) { return e.global > 0; });
            if (entries.length === 0) return null;
            return entries.reduce(function(s, e) { return s + e.global; }, 0) / entries.length;
        });

        var cogAvg = dates.map(function(d) {
            var entries = byDate[d].filter(function(e) { return e.cognitif > 0; });
            if (entries.length === 0) return null;
            return entries.reduce(function(s, e) { return s + e.cognitif; }, 0) / entries.length;
        });

        var emoAvg = dates.map(function(d) {
            var entries = byDate[d].filter(function(e) { return e.emotionnel > 0; });
            if (entries.length === 0) return null;
            return entries.reduce(function(s, e) { return s + e.emotionnel; }, 0) / entries.length;
        });

        var socAvg = dates.map(function(d) {
            var entries = byDate[d].filter(function(e) { return e.social > 0; });
            if (entries.length === 0) return null;
            return entries.reduce(function(s, e) { return s + e.social; }, 0) / entries.length;
        });

        return {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Global', data: globalAvg, backgroundColor: 'rgba(99,102,241,0.7)', borderRadius: 4, order: 1 },
                    { label: 'Cognitif', data: cogAvg, type: 'line', borderColor: '#10b981', backgroundColor: 'transparent', tension: 0.3, pointRadius: 3, order: 0 },
                    { label: '√âmotionnel', data: emoAvg, type: 'line', borderColor: '#f59e0b', backgroundColor: 'transparent', tension: 0.3, pointRadius: 3, order: 0 },
                    { label: 'Social', data: socAvg, type: 'line', borderColor: '#ec4899', backgroundColor: 'transparent', tension: 0.3, pointRadius: 3, order: 0 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#94a3b8' } } },
                scales: {
                    y: { min: 0, max: 5, ticks: { stepSize: 1, color: '#94a3b8' }, grid: { color: 'rgba(51,65,85,0.5)' } },
                    x: { ticks: { color: '#94a3b8', maxRotation: 45, font: { size: 10 } }, grid: { display: false } }
                }
            }
        };
    }

    function renderMeteoMensuel(data) {
        // Group by month
        var byMonth = {};
        data.forEach(function(d) {
            var m = d.date.substring(0, 7); // YYYY-MM
            if (!byMonth[m]) byMonth[m] = [];
            byMonth[m].push(d);
        });

        var months = Object.keys(byMonth).sort();
        var monthLabels = ['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c'];
        var labels = months.map(function(m) {
            var parts = m.split('-');
            return monthLabels[parseInt(parts[1]) - 1] + ' ' + parts[0].substring(2);
        });

        function avgField(entries, field) {
            var valid = entries.filter(function(e) { return e[field] > 0; });
            if (valid.length === 0) return null;
            return valid.reduce(function(s, e) { return s + e[field]; }, 0) / valid.length;
        }

        return {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Global', data: months.map(function(m) { return avgField(byMonth[m], 'global'); }), borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', fill: true, tension: 0.4, pointRadius: 5 },
                    { label: 'Cognitif', data: months.map(function(m) { return avgField(byMonth[m], 'cognitif'); }), borderColor: '#10b981', tension: 0.4, pointRadius: 4 },
                    { label: '√âmotionnel', data: months.map(function(m) { return avgField(byMonth[m], 'emotionnel'); }), borderColor: '#f59e0b', tension: 0.4, pointRadius: 4 },
                    { label: 'Social', data: months.map(function(m) { return avgField(byMonth[m], 'social'); }), borderColor: '#ec4899', tension: 0.4, pointRadius: 4 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#94a3b8' } } },
                scales: {
                    y: { min: 0, max: 5, ticks: { stepSize: 1, color: '#94a3b8' }, grid: { color: 'rgba(51,65,85,0.5)' } },
                    x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                }
            }
        };
    }

    function renderMeteoAnnuel(data) {
        // Heatmap-style: rows = classes, columns = weeks
        // Fallback to a grouped bar chart (class √ó avg score)
        var byClasse = {};
        data.forEach(function(d) {
            if (!d.classeId) return;
            if (!byClasse[d.classeId]) byClasse[d.classeId] = [];
            byClasse[d.classeId].push(d);
        });
        var classes = Object.keys(byClasse).sort();

        function avgField(entries, field) {
            var valid = entries.filter(function(e) { return e[field] > 0; });
            if (valid.length === 0) return 0;
            return Math.round((valid.reduce(function(s, e) { return s + e[field]; }, 0) / valid.length) * 10) / 10;
        }

        return {
            type: 'bar',
            data: {
                labels: classes,
                datasets: [
                    { label: 'Global', data: classes.map(function(c) { return avgField(byClasse[c], 'global'); }), backgroundColor: 'rgba(99,102,241,0.7)', borderRadius: 4 },
                    { label: 'Cognitif', data: classes.map(function(c) { return avgField(byClasse[c], 'cognitif'); }), backgroundColor: 'rgba(16,185,129,0.7)', borderRadius: 4 },
                    { label: '√âmotionnel', data: classes.map(function(c) { return avgField(byClasse[c], 'emotionnel'); }), backgroundColor: 'rgba(245,158,11,0.7)', borderRadius: 4 },
                    { label: 'Social', data: classes.map(function(c) { return avgField(byClasse[c], 'social'); }), backgroundColor: 'rgba(236,72,153,0.7)', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#94a3b8' } } },
                scales: {
                    y: { min: 0, max: 5, ticks: { stepSize: 1, color: '#94a3b8' }, grid: { color: 'rgba(51,65,85,0.5)' } },
                    x: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { display: false } }
                }
            }
        };
    }

    function renderMeteoClasse(data) {
        var selectedClasse = (document.getElementById('meteoFilterClasse') || {}).value || '';
        var filtered = selectedClasse ? data.filter(function(d) { return classesMatch(d.classeId, selectedClasse); }) : data;

        if (filtered.length === 0) {
            return {
                type: 'bar',
                data: { labels: ['Aucune donn√©e'], datasets: [{ label: '-', data: [0], backgroundColor: '#334155' }] },
                options: { responsive: true, maintainAspectRatio: false }
            };
        }

        // Timeline for this class
        var labels = filtered.map(function(d) {
            var parts = d.date.split('-');
            return (parts[2] || '') + '/' + (parts[1] || '');
        });

        return {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Global', data: filtered.map(function(d) { return d.global || null; }), borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', fill: true, tension: 0.3, pointRadius: 5 },
                    { label: 'Cognitif', data: filtered.map(function(d) { return d.cognitif || null; }), borderColor: '#10b981', tension: 0.3, pointRadius: 4 },
                    { label: '√âmotionnel', data: filtered.map(function(d) { return d.emotionnel || null; }), borderColor: '#f59e0b', tension: 0.3, pointRadius: 4 },
                    { label: 'Social', data: filtered.map(function(d) { return d.social || null; }), borderColor: '#ec4899', tension: 0.3, pointRadius: 4 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#94a3b8' } } },
                scales: {
                    y: { min: 0, max: 5, ticks: { stepSize: 1, color: '#94a3b8' }, grid: { color: 'rgba(51,65,85,0.5)' } },
                    x: { ticks: { color: '#94a3b8', maxRotation: 45, font: { size: 10 } }, grid: { display: false } }
                }
            }
        };
    }

    function renderMeteoSummary(data) {
        var summary = document.getElementById('meteoSummary');
        var content = document.getElementById('meteoSummaryContent');
        if (!summary || !content) return;

        if (data.length === 0) { summary.style.display = 'none'; return; }

        var totalGlobal = 0, countGlobal = 0;
        var totalCog = 0, countCog = 0;
        var totalEmo = 0, countEmo = 0;
        var totalSoc = 0, countSoc = 0;
        data.forEach(function(d) {
            if (d.global > 0) { totalGlobal += d.global; countGlobal++; }
            if (d.cognitif > 0) { totalCog += d.cognitif; countCog++; }
            if (d.emotionnel > 0) { totalEmo += d.emotionnel; countEmo++; }
            if (d.social > 0) { totalSoc += d.social; countSoc++; }
        });

        var html = '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px,1fr)); gap:12px;">';
        html += '<div style="text-align:center; padding:12px; border-radius:10px; background:rgba(99,102,241,0.15);"><div style="font-size:1.6em; font-weight:800;">' + (countGlobal ? (totalGlobal / countGlobal).toFixed(1) : '-') + '</div><div style="font-size:.75em; color:var(--muted);">Global moy.</div></div>';
        html += '<div style="text-align:center; padding:12px; border-radius:10px; background:rgba(16,185,129,0.15);"><div style="font-size:1.6em; font-weight:800;">' + (countCog ? (totalCog / countCog).toFixed(1) : '-') + '</div><div style="font-size:.75em; color:var(--muted);">Cognitif</div></div>';
        html += '<div style="text-align:center; padding:12px; border-radius:10px; background:rgba(245,158,11,0.15);"><div style="font-size:1.6em; font-weight:800;">' + (countEmo ? (totalEmo / countEmo).toFixed(1) : '-') + '</div><div style="font-size:.75em; color:var(--muted);">√âmotionnel</div></div>';
        html += '<div style="text-align:center; padding:12px; border-radius:10px; background:rgba(236,72,153,0.15);"><div style="font-size:1.6em; font-weight:800;">' + (countSoc ? (totalSoc / countSoc).toFixed(1) : '-') + '</div><div style="font-size:.75em; color:var(--muted);">Social</div></div>';
        html += '</div>';
        html += '<div style="margin-top:10px; font-size:.8em; color:var(--muted);">' + data.length + ' s√©ances avec donn√©es m√©t√©o</div>';

        content.innerHTML = html;
        summary.style.display = 'block';
    }

    window.renderMeteo = async function() {
        await loadChartJs();
        var data = getMeteoData();

        // Populate classe filter if needed
        var filterSelect = document.getElementById('meteoFilterClasse');
        if (filterSelect && filterSelect.options.length <= 1) {
            var classes = [];
            allLogs.forEach(function(l) {
                var c = l.classeId || l.classeDocId || '';
                if (c && classes.indexOf(c) < 0) classes.push(c);
            });
            classes.sort();
            classes.forEach(function(c) {
                var opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                filterSelect.appendChild(opt);
            });
        }

        if (data.length === 0) {
            document.getElementById('meteoChartContainer').innerHTML = '<div class="empty" style="padding:40px 0;"><div class="icon">üìä</div><p>Aucune donn√©e m√©t√©o. Saisissez des s√©ances avec l\'emoji m√©t√©o dans log.html.</p></div>';
            document.getElementById('meteoSummary').style.display = 'none';
            return;
        }

        // Destroy old chart
        if (meteoChartInstance) { meteoChartInstance.destroy(); meteoChartInstance = null; }

        // Ensure canvas exists
        var container = document.getElementById('meteoChartContainer');
        container.innerHTML = '<canvas id="meteoChart"></canvas>';
        container.style.minHeight = '350px';
        var canvas = document.getElementById('meteoChart');
        var ctx = canvas.getContext('2d');

        var config;
        switch (currentMeteoView) {
            case 'semaine': config = renderMeteoSemaine(data); break;
            case 'mensuel': config = renderMeteoMensuel(data); break;
            case 'annuel': config = renderMeteoAnnuel(data); break;
            case 'classe': config = renderMeteoClasse(data); break;
            default: config = renderMeteoSemaine(data);
        }

        meteoChartInstance = new Chart(ctx, config);
        renderMeteoSummary(data);
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PATCH TABS ‚Äî Agenda + M√©t√©o lazy-load
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function patchTabsForAgendaAndMeteo() {
        document.querySelectorAll('.tab').forEach(function(btn) {
            btn.addEventListener('click', function() {
                if (btn.dataset.tab === 'agenda') {
                    if (customEvents.length === 0 && pronoteEvents.length === 0) {
                        loadAgendaData();
                    } else {
                        renderAgenda();
                    }
                }
                if (btn.dataset.tab === 'meteo') {
                    renderMeteo();
                }
            });
        });
    }

    // Patch tabs apr√®s init
    patchTabsForAgendaAndMeteo();
</script>
</body>
</html>
