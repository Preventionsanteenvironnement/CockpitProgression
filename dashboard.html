<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äî Cockpit Progression PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --primary: #6366f1;
            --primary-light: #e0e7ff;
            --success: #22c55e;
            --success-light: #dcfce7;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --border: #e2e8f0;
            --radius: 14px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        .login-screen {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
        }
        .login-card {
            background: var(--card); border-radius: 20px; padding: 50px 40px;
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            max-width: 400px; width: 100%;
        }
        .login-icon { font-size: 3.5em; margin-bottom: 15px; }
        .login-card h2 { font-size: 1.6em; font-weight: 800; margin-bottom: 8px; }
        .login-card p { color: var(--muted); margin-bottom: 30px; }
        .btn-google {
            display: inline-flex; align-items: center; gap: 12px;
            padding: 14px 30px; border: 2px solid var(--border); border-radius: 50px;
            background: white; font-size: 1em; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: all 0.2s;
        }
        .btn-google:hover { border-color: var(--primary); background: var(--primary-light); }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header h1 { font-size: 1.5em; font-weight: 800; }
        .back-link {
            font-size: 0.85em; color: var(--muted); text-decoration: none;
            display: inline-flex; align-items: center; gap: 4px;
        }
        .back-link:hover { color: var(--primary); }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .user-email { font-size: 0.8em; color: var(--muted); }
        .btn-logout {
            padding: 8px 16px; border: 1px solid var(--border); border-radius: 8px;
            background: white; font-size: 0.8em; cursor: pointer; font-family: inherit;
        }
        .btn-logout:hover { background: var(--danger-light); color: var(--danger); border-color: var(--danger); }

        /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
        .tabs {
            display: flex; gap: 4px; margin-bottom: 20px; background: var(--bg);
            border-radius: 12px; padding: 4px; border: 1px solid var(--border);
            overflow-x: auto; -webkit-overflow-scrolling: touch;
        }
        .tab {
            flex: 1; padding: 10px 15px; border: none; border-radius: 10px;
            background: transparent; font-family: inherit; font-size: 0.82em;
            font-weight: 600; cursor: pointer; color: var(--muted);
            transition: all 0.2s; white-space: nowrap; min-width: fit-content;
        }
        .tab.active { background: white; color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }

        .section { display: none; }
        .section.active { display: block; }

        /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
        .card {
            background: var(--card); border-radius: var(--radius); padding: 22px;
            margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .card-title {
            font-weight: 700; font-size: 1em; margin-bottom: 18px;
            display: flex; align-items: center; gap: 8px;
        }
        .card-title .count {
            background: var(--primary-light); color: var(--primary);
            padding: 2px 10px; border-radius: 20px; font-size: 0.8em;
        }

        /* ‚îÄ‚îÄ SELECT ‚îÄ‚îÄ */
        select {
            padding: 12px 40px 12px 14px;
            border: 2px solid var(--border); border-radius: 12px;
            font-size: 0.95em; font-family: inherit;
            background: white; color: var(--text);
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center; background-size: 18px;
            cursor: pointer;
        }
        select:focus { outline: none; border-color: var(--primary); }

        /* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
        .filter-bar {
            display: flex; align-items: center; gap: 12px; margin-bottom: 18px;
            flex-wrap: wrap;
        }
        .filter-bar label { font-size: 0.85em; font-weight: 700; color: var(--muted); }

        /* ‚îÄ‚îÄ LEGEND ‚îÄ‚îÄ */
        .legend {
            display: flex; flex-wrap: wrap; gap: 14px; margin-bottom: 18px;
            font-size: 0.75em; font-weight: 600; color: var(--muted);
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-dot {
            width: 14px; height: 14px; border-radius: 4px; flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ TIMELINE BY CLASS ‚îÄ‚îÄ */
        .timeline-weeks {
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        .timeline-row {
            display: flex; gap: 3px; min-width: max-content; margin-bottom: 8px;
        }
        .timeline-cell {
            width: 36px; height: 40px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.6em; font-weight: 700; color: white; cursor: default;
            position: relative; flex-shrink: 0;
        }
        .timeline-cell.c-normal { background: #e2e8f0; color: var(--muted); }
        .timeline-cell.c-vacances { background: #f0f0f0; color: #ccc; }
        .timeline-cell.c-realise { background: var(--success); }
        .timeline-cell.c-prevu { background: #6366f1; }
        .timeline-cell.c-reporte { background: var(--warning); }
        .timeline-cell.c-non-realise { background: var(--danger); }
        .timeline-cell.c-en-cours { background: var(--warning); }
        .timeline-cell.c-annule { background: var(--danger); }
        .timeline-cell.c-pfmp { background: #8b5cf6; }
        .timeline-cell.c-sortie { background: #06b6d4; }
        .timeline-cell.c-bac { background: #ec4899; }
        .timeline-cell.c-ccf { background: #f472b6; }
        .timeline-cell.c-ferie { background: #a1a1aa; }
        .timeline-cell.c-absence { background: #78716c; }
        .timeline-cell.c-formation { background: #0ea5e9; }
        .timeline-cell.c-current { outline: 3px solid var(--primary); outline-offset: 1px; }
        .timeline-cell .phase-icon { font-size: 1.1em; line-height: 1; }

        .timeline-cell .tooltip {
            display: none; position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%); background: var(--text); color: white;
            padding: 6px 10px; border-radius: 8px; font-size: 1.6em; font-weight: 500;
            white-space: nowrap; z-index: 50; margin-bottom: 6px;
            pointer-events: none; min-width: 120px; text-align: center;
        }
        .timeline-cell:hover .tooltip { display: block; }

        .month-headers {
            display: flex; gap: 3px; margin-bottom: 4px; min-width: max-content;
        }
        .month-label {
            font-size: 0.7em; font-weight: 700; color: var(--muted);
            text-align: center; flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ MODULE GRID ‚îÄ‚îÄ */
        .module-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }
        .module-class-card {
            padding: 14px; border-radius: 12px; border: 2px solid var(--border);
            transition: all 0.15s;
        }
        .module-class-card:hover { border-color: var(--primary); }
        .mc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .mc-classe { font-weight: 800; font-size: 0.9em; }
        .mc-badge {
            padding: 3px 10px; border-radius: 20px; font-size: 0.7em; font-weight: 700;
        }
        .mc-badge.b-terminee { background: var(--success-light); color: #166534; }
        .mc-badge.b-en-cours { background: var(--warning-light); color: #92400e; }
        .mc-badge.b-non-commence { background: #f1f5f9; color: var(--muted); }
        .mc-badge.b-eval { background: #dbeafe; color: #1e40af; }
        .mc-detail { font-size: 0.78em; color: var(--muted); }
        .mc-progress { margin-top: 8px; height: 6px; background: #f1f5f9; border-radius: 3px; overflow: hidden; }
        .mc-progress-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .mc-progress-fill.p-success { background: var(--success); }
        .mc-progress-fill.p-warning { background: var(--warning); }

        /* ‚îÄ‚îÄ YEAR TIMELINE ‚îÄ‚îÄ */
        .year-grid {
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        .year-table { border-collapse: separate; border-spacing: 2px; min-width: max-content; }
        .year-table th {
            font-size: 0.65em; font-weight: 700; color: var(--muted);
            padding: 4px 2px; text-align: center; position: sticky; top: 0;
            background: var(--card); z-index: 2;
        }
        .year-table td.class-label {
            font-size: 0.72em; font-weight: 700; padding: 4px 10px 4px 4px;
            white-space: nowrap; position: sticky; left: 0;
            background: var(--card); z-index: 1;
        }
        .year-table td.week-cell {
            width: 20px; height: 22px; border-radius: 3px; cursor: default;
            position: relative;
        }
        .year-table td.week-cell .tooltip {
            display: none; position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%); background: var(--text); color: white;
            padding: 5px 9px; border-radius: 6px; font-size: 10px; font-weight: 500;
            white-space: nowrap; z-index: 50; margin-bottom: 4px;
            pointer-events: none;
        }
        .year-table td.week-cell:hover .tooltip { display: block; }

        /* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
        .alert-item {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 16px; border-radius: 10px; margin-bottom: 8px;
            font-size: 0.85em; font-weight: 500;
        }
        .alert-item.warn { background: var(--warning-light); color: #92400e; }
        .alert-item.err { background: var(--danger-light); color: #991b1b; }
        .alert-item.info { background: #dbeafe; color: #1e40af; }
        .alert-icon { font-size: 1.2em; flex-shrink: 0; }
        .alert-text { flex: 1; }
        .alert-date { font-size: 0.8em; color: inherit; opacity: 0.7; white-space: nowrap; }

        /* ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ */
        .stats-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px; margin-bottom: 20px;
        }
        .mini-stat {
            background: var(--card); border-radius: 12px; padding: 14px;
            text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .mini-stat .val { font-size: 1.8em; font-weight: 800; }
        .mini-stat .lbl { font-size: 0.7em; color: var(--muted); font-weight: 600; margin-top: 2px; }
        .mini-stat.s-primary .val { color: var(--primary); }
        .mini-stat.s-success .val { color: var(--success); }
        .mini-stat.s-warning .val { color: var(--warning); }
        .mini-stat.s-danger .val { color: var(--danger); }

        /* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
        .empty { text-align: center; padding: 40px 20px; color: var(--muted); }
        .empty .icon { font-size: 2.5em; margin-bottom: 10px; }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success); color: white;
            padding: 14px 30px; border-radius: 14px;
            font-weight: 700; z-index: 1000; opacity: 0;
            transition: all 0.3s ease; font-size: 0.95em;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 700px) {
            .container { padding: 12px; }
            .header h1 { font-size: 1.2em; }
            .tabs { gap: 2px; }
            .tab { padding: 8px 10px; font-size: 0.75em; }
            .timeline-cell { width: 28px; height: 32px; font-size: 0.5em; }
            .module-grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <div class="login-icon">üìà</div>
        <h2>Dashboard Progression</h2>
        <p>Suivi de progression PSE</p>
        <button class="btn-google" id="btnGoogle">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Connexion Google
        </button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="mainScreen" style="display:none;">
<div class="container">

    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <a href="index.html" class="back-link">‚Üê Accueil</a>
            <h1>üìà Dashboard</h1>
        </div>
        <div class="header-actions">
            <span class="user-email" id="userEmail"></span>
            <button class="btn-logout" id="btnLogout">Deco</button>
        </div>
    </div>

    <!-- STATS -->
    <div class="stats-row" id="statsRow">
        <div class="mini-stat s-primary"><div class="val" id="stClasses">-</div><div class="lbl">Classes</div></div>
        <div class="mini-stat s-success"><div class="val" id="stRealise">-</div><div class="lbl">Semaines valid√©es</div></div>
        <div class="mini-stat s-warning"><div class="val" id="stEnCours">-</div><div class="lbl">En cours</div></div>
        <div class="mini-stat s-danger"><div class="val" id="stAlertes">-</div><div class="lbl">Alertes</div></div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab active" data-tab="classe">Par classe</button>
        <button class="tab" data-tab="module">Par module</button>
        <button class="tab" data-tab="timeline">Timeline annee</button>
        <button class="tab" data-tab="alertes">Alertes</button>
    </div>

    <!-- ‚îÄ‚îÄ VUE 1 : PAR CLASSE ‚îÄ‚îÄ -->
    <div id="tabClasse" class="section active">
        <div class="filter-bar">
            <label>Classe :</label>
            <select id="filterClasse"><option value="">-- Toutes --</option></select>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-dot" style="background:var(--success);"></div> R√©alis√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:#6366f1;"></div> Pr√©vu</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--warning);"></div> Report√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--danger);"></div> Non r√©alis√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:#e2e8f0;"></div> √Ä faire</div>
            <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;"></div> PFMP</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f0f0f0; border:1px solid #ddd;"></div> Vacances</div>
            <div class="legend-item"><div class="legend-dot" style="background:#06b6d4;"></div> Sortie</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ec4899;"></div> BAC / √âpreuves</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f472b6;"></div> CCF</div>
            <div class="legend-item"><div class="legend-dot" style="background:#78716c;"></div> Absence</div>
            <div class="legend-item"><div class="legend-dot" style="background:#a1a1aa;"></div> F√©ri√©</div>
            <div class="legend-item" style="margin-left:10px; font-weight:700;">E=√âval ¬∑ C=Corr ¬∑ 1,2...=S√©ance</div>
        </div>

        <div id="classeContent">
            <div class="empty"><div class="icon">üì•</div><p>Importez vos CSV depuis l'accueil.</p></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ VUE 2 : PAR MODULE ‚îÄ‚îÄ -->
    <div id="tabModule" class="section">
        <div class="filter-bar">
            <label>Module :</label>
            <select id="filterModule"><option value="">-- Tous --</option></select>
        </div>

        <div id="moduleContent">
            <div class="empty"><div class="icon">üì•</div><p>Importez vos CSV depuis l'accueil.</p></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ VUE 3 : TIMELINE ANNEE ‚îÄ‚îÄ -->
    <div id="tabTimeline" class="section">
        <div class="legend">
            <div class="legend-item"><div class="legend-dot" style="background:var(--success);"></div> R√©alis√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:#6366f1;"></div> Pr√©vu</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--warning);"></div> Report√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--danger);"></div> Non r√©alis√©</div>
            <div class="legend-item"><div class="legend-dot" style="background:#e2e8f0;"></div> √Ä faire</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f0f0f0; border:1px solid #ddd;"></div> Vacances</div>
            <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6;"></div> PFMP</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ec4899;"></div> BAC / √âpreuves</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f472b6;"></div> CCF</div>
        </div>

        <div class="card">
            <div class="card-title">Progression annuelle toutes classes</div>
            <div id="timelineContent" class="year-grid">
                <div class="empty"><div class="icon">üì•</div><p>Importez vos CSV depuis l'accueil.</p></div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ VUE 4 : ALERTES ‚îÄ‚îÄ -->
    <div id="tabAlertes" class="section">
        <div id="alertesContent">
            <div class="empty"><div class="icon">‚úÖ</div><p>Aucune alerte.</p></div>
        </div>
    </div>

<!-- ‚îÄ‚îÄ WEEK DETAIL PANEL ‚îÄ‚îÄ -->
<div id="weekDetailOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:200;" onclick="closeWeekDetail()"></div>
<div id="weekDetail" style="display:none; position:fixed; bottom:0; left:0; right:0; max-height:70vh; overflow-y:auto; background:white; border-radius:20px 20px 0 0; box-shadow:0 -8px 30px rgba(0,0,0,0.15); z-index:201; padding:24px 20px 30px; transition:transform 0.3s ease;">
    <div style="width:40px; height:4px; background:#e2e8f0; border-radius:2px; margin:0 auto 16px;"></div>
    <div id="weekDetailContent"></div>
</div>

</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
        getFirestore, doc, getDocs, collection, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import {
        getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect,
        getRedirectResult, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.firebasestorage.app",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    let allPrevue = [];
    let allLogs = [];
    let logsByClasse = {};
    let unsubPrevue = null;
    let unsubLogs = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            loadAll();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
        }
    });

    document.getElementById('btnGoogle').addEventListener('click', async () => {
        try { await signInWithPopup(auth, googleProvider); }
        catch (e) {
            if (e.code === 'auth/popup-blocked' || e.code === 'auth/cancelled-popup-request') {
                await signInWithRedirect(auth, googleProvider);
            } else { alert('Erreur: ' + e.message); }
        }
    });
    getRedirectResult(auth).catch(function() {});
    document.getElementById('btnLogout').addEventListener('click', function() {
        if (unsubPrevue) { unsubPrevue(); unsubPrevue = null; }
        if (unsubLogs) { unsubLogs(); unsubLogs = null; }
        signOut(auth);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.querySelectorAll('.tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
            btn.classList.add('active');
            document.getElementById('tab' + capitalize(btn.dataset.tab)).classList.add('active');
        });
    });

    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOAD ALL DATA (real-time) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function refreshViews() {
        // Index logs by classeId
        logsByClasse = {};
        allLogs.forEach(function(log) {
            var key = log.classeId || log.classeDocId || '';
            if (!logsByClasse[key]) logsByClasse[key] = [];
            logsByClasse[key].push(log);
        });
        renderStats();
        populateFilters();
        renderClasseView();
        renderModuleView();
        renderTimeline();
        renderAlertes();
    }

    function loadAll() {
        // Cleanup previous listeners
        if (unsubPrevue) { unsubPrevue(); unsubPrevue = null; }
        if (unsubLogs) { unsubLogs(); unsubLogs = null; }

        unsubPrevue = onSnapshot(collection(db, 'progression_prevue'), function(snap) {
            allPrevue = [];
            snap.forEach(function(d) { allPrevue.push({ id: d.id, ...d.data() }); });
            allPrevue.sort(function(a, b) { return a.classeId.localeCompare(b.classeId); });
            refreshViews();
        }, function(err) { console.error('onSnapshot prevue error:', err); });

        unsubLogs = onSnapshot(collection(db, 'progression_logs'), function(snap) {
            allLogs = [];
            snap.forEach(function(d) { allLogs.push({ id: d.id, ...d.data() }); });
            refreshViews();
        }, function(err) { console.error('onSnapshot logs error:', err); });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEEK DETAIL PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.closeWeekDetail = function() {
        document.getElementById('weekDetail').style.display = 'none';
        document.getElementById('weekDetailOverlay').style.display = 'none';
    };

    function showWeekDetail(classeId, sem, classeDocId) {
        var panel = document.getElementById('weekDetail');
        var overlay = document.getElementById('weekDetailOverlay');
        var content = document.getElementById('weekDetailContent');

        // Find matching log
        var matchLog = null;
        allLogs.forEach(function(log) {
            if ((log.classeId === classeId || log.classeDocId === classeDocId) && log.date) {
                // Match by week date
                var parts = (sem.date || '').match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (parts) {
                    var semDate = new Date(parseInt(parts[3]), parseInt(parts[2]) - 1, parseInt(parts[1]));
                    var logDate = new Date(log.date);
                    var diff = Math.abs(semDate - logDate) / (1000 * 60 * 60 * 24);
                    if (diff < 7 && (!matchLog || log.date > matchLog.date)) matchLog = log;
                }
            }
        });

        var html = '<h3 style="margin-bottom:12px; font-size:1.1em;">' + classeId + ' ‚Äî ' + (sem.semaine || sem.date || '') + '</h3>';
        html += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:0.85em; margin-bottom:14px;">';
        html += '<div><strong>Date :</strong> ' + (sem.date || '-') + '</div>';
        html += '<div><strong>Module :</strong> ' + (sem.moduleBase || sem.module || '-') + '</div>';
        html += '<div><strong>Phase :</strong> ' + (sem.phase || 'cours') + '</div>';
        html += '<div><strong>Statut :</strong> ' + (sem.statut || '-') + '</div>';
        html += '<div><strong>S√©ance :</strong> ' + (sem.seance || '-') + '</div>';
        html += '<div><strong>Situation :</strong> ' + (sem.situation || 'Normal') + '</div>';
        if (sem.objectifModule) html += '<div style="grid-column:1/-1;"><strong>Objectif module :</strong> ' + sem.objectifModule + '</div>';
        if (sem.objectifSeance) html += '<div style="grid-column:1/-1;"><strong>Objectif s√©ance :</strong> ' + sem.objectifSeance + '</div>';
        if (sem.evalDiag && sem.evalDiag !== 'N/A') html += '<div><strong>√âval diag :</strong> ' + sem.evalDiag + '</div>';
        if (sem.evalForm && sem.evalForm !== 'N/A') html += '<div><strong>√âval form :</strong> ' + sem.evalForm + '</div>';
        if (sem.evaluation && sem.evaluation !== 'N/A') html += '<div><strong>√âvaluation :</strong> ' + sem.evaluation + '</div>';
        html += '</div>';

        if (matchLog) {
            html += '<div style="padding:12px; border-radius:10px; background:#eff6ff; border:1px solid #bfdbfe; font-size:0.82em; margin-bottom:14px;">';
            html += '<strong>Log du ' + matchLog.date + '</strong><br>';
            html += (matchLog.moduleId || '') + ' ‚Äî ' + (matchLog.seance || '') + ' [' + (matchLog.statut || '') + ']';
            if (matchLog.qualite) html += '<br>Qualit√© : ' + matchLog.qualite;
            if (matchLog.absences > 0) html += '<br>Absences : ' + matchLog.absences;
            if (matchLog.absencesNoms) html += ' (' + matchLog.absencesNoms + ')';
            if (matchLog.remarque) html += '<br>Note : ' + matchLog.remarque;
            html += '</div>';
        }

        html += '<a href="log.html" style="display:block; text-align:center; padding:14px; border-radius:12px; background:linear-gradient(135deg,#10b981,#059669); color:white; font-weight:700; text-decoration:none; font-size:0.95em;">üìù Saisir pour ' + classeId + '</a>';

        content.innerHTML = html;
        overlay.style.display = 'block';
        panel.style.display = 'block';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderStats() {
        document.getElementById('stClasses').textContent = allPrevue.length;

        var totalRealise = 0;
        var totalEnCours = 0;
        var today = new Date();
        allPrevue.forEach(function(p) {
            var hasActiveSemaine = false;
            (p.semaines || []).forEach(function(s) {
                if (s.valide || s.statut === 'Realise' || s.statut === 'R√©alis√©') {
                    totalRealise++;
                } else {
                    // Semaine pass√©e, situation normale, non valid√©e = en cours
                    var sit = (s.situation || 'Normal').toLowerCase();
                    var isNormal = sit === 'normal' || sit === '' || sit === 'n/a';
                    if (isNormal && s.date) {
                        var parts = s.date.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                        if (parts) {
                            var semDate = new Date(parseInt(parts[3]), parseInt(parts[2]) - 1, parseInt(parts[1]));
                            var diffDays = (today - semDate) / (1000 * 60 * 60 * 24);
                            if (diffDays >= 0 && diffDays < 14) hasActiveSemaine = true;
                        }
                    }
                }
            });
            if (hasActiveSemaine) totalEnCours++;
        });

        document.getElementById('stRealise').textContent = totalRealise;
        document.getElementById('stEnCours').textContent = totalEnCours;

        var alertCount = computeAlerts().length;
        document.getElementById('stAlertes').textContent = alertCount;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILTERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function populateFilters() {
        // Classe filter
        var selClasse = document.getElementById('filterClasse');
        selClasse.innerHTML = '<option value="">-- Toutes --</option>';
        allPrevue.forEach(function(p) {
            var opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.classeId + ' (' + p.niveau + ')';
            selClasse.appendChild(opt);
        });
        selClasse.addEventListener('change', renderClasseView);

        // Module filter ‚Äî collect all unique modules across all classes
        var allModules = {};
        allPrevue.forEach(function(p) {
            (p.semaines || []).forEach(function(s) {
                var m = cleanModuleName(s.module || '');
                if (m && m !== 'N/A' && m !== 'Presentation PSE' && m !== 'Pr√©sentation PSE') {
                    allModules[m] = true;
                }
            });
        });

        var selModule = document.getElementById('filterModule');
        selModule.innerHTML = '<option value="">-- Tous --</option>';
        Object.keys(allModules).sort().forEach(function(m) {
            var opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            selModule.appendChild(opt);
        });
        selModule.addEventListener('change', renderModuleView);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPER : clean module name ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function cleanModuleName(raw) {
        if (!raw) return '';
        // Remove evaluation/correction suffixes to get base module
        var cleaned = raw.replace(/\n/g, ' ').trim();
        // Remove trailing " ‚Äì √âvaluation", " ‚Äì Correction" etc for grouping
        return cleaned;
    }

    // Get base module name (without √âvaluation/Correction)
    function baseModuleName(raw) {
        var c = cleanModuleName(raw);
        return c.replace(/\s*[‚Äì-]\s*(√âvaluation|Evaluation|Correction)$/i, '').trim();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARSE DATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function parseDate(dateStr) {
        if (!dateStr) return null;
        // Format: DD/MM/YYYY
        var parts = dateStr.split('/');
        if (parts.length === 3) {
            return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }
        // Try ISO
        var d = new Date(dateStr);
        return isNaN(d.getTime()) ? null : d;
    }

    // Get current week monday date string for highlighting
    function getCurrentWeekMonday() {
        var now = new Date();
        var day = now.getDay();
        var diff = now.getDate() - day + (day === 0 ? -6 : 1);
        var monday = new Date(now);
        monday.setDate(diff);
        var dd = String(monday.getDate()).padStart(2, '0');
        var mm = String(monday.getMonth() + 1).padStart(2, '0');
        return dd + '/' + mm + '/' + monday.getFullYear();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATUT HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function isRealise(sem) {
        return sem.valide || sem.statut === 'Realise' || sem.statut === 'R√©alis√©';
    }
    function isPrevu(sem) {
        return sem.statut === 'Pr√©vu' || sem.statut === 'Prevu';
    }
    function isReporte(sem) {
        return sem.statut === 'Report√©' || sem.statut === 'Reporte';
    }
    function isNonRealise(sem) {
        return sem.statut === 'Non r√©alis√©' || sem.statut === 'Non realise' || sem.statut === 'Non r√©alis√©';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PHASE ‚Üí LABEL DANS CELLULE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function phaseLabel(sem) {
        var phase = (sem.phase || '').toLowerCase();
        if (phase === 'evaluation') return 'E';
        if (phase === 'correction') return 'C';
        if (phase === 'presentation') return 'P';
        // S√©ance number
        var seance = (sem.seance || '').trim();
        if (seance && seance !== 'N/A') {
            var m = seance.match(/(\d[\d\-]*)/);
            if (m) return m[1];
        }
        return '';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SITUATION ‚Üí COLOR CLASS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function situationClass(sem) {
        var sit = (sem.situation || '').toLowerCase();
        if (sit.includes('vacances')) return 'c-vacances';
        if (sit.includes('pfmp')) return 'c-pfmp';
        if (sit.includes('bac blanc') || sit.includes('epreuv')) return 'c-bac';
        if (sit.includes('ccf')) return 'c-ccf';
        if (sit.includes('sortie')) return 'c-sortie';
        if (sit.includes('annul')) return 'c-annule';
        if (sit.includes('feri') || sit.includes('f√©ri')) return 'c-ferie';
        if (sit.includes('absence') || sit.includes('formation')) return 'c-absence';

        // Statut-based colors (CSV + logs)
        if (isRealise(sem)) return 'c-realise';
        if (isReporte(sem)) return 'c-reporte';
        if (isNonRealise(sem)) return 'c-non-realise';
        if (isPrevu(sem)) return 'c-prevu';

        return 'c-normal';
    }

    // Same but for year timeline cells (returns bg color)
    function situationColor(sem) {
        var sit = (sem.situation || '').toLowerCase();
        if (sit.includes('vacances')) return '#f0f0f0';
        if (sit.includes('pfmp')) return '#8b5cf6';
        if (sit.includes('bac blanc') || sit.includes('epreuv')) return '#ec4899';
        if (sit.includes('ccf')) return '#f472b6';
        if (sit.includes('sortie')) return '#06b6d4';
        if (sit.includes('annul')) return '#dc2626';
        if (sit.includes('feri') || sit.includes('f√©ri')) return '#a1a1aa';
        if (sit.includes('absence') || sit.includes('formation')) return '#78716c';
        if (isRealise(sem)) return '#22c55e';
        if (isReporte(sem)) return '#f59e0b';
        if (isNonRealise(sem)) return '#dc2626';
        if (isPrevu(sem)) return '#6366f1';
        return '#e2e8f0';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VUE 1 : PAR CLASSE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderClasseView() {
        var container = document.getElementById('classeContent');
        var filterVal = document.getElementById('filterClasse').value;

        var classesToShow = filterVal
            ? allPrevue.filter(function(p) { return p.id === filterVal; })
            : allPrevue;

        if (classesToShow.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üì•</div><p>Aucune classe import√©e.</p></div>';
            return;
        }

        container.innerHTML = '';
        var currentMonday = getCurrentWeekMonday();

        classesToShow.forEach(function(prevue) {
            var card = document.createElement('div');
            card.className = 'card';

            // Title with class name and badge
            var niveauLabel = prevue.niveau === 'CAP' ? 'CAP' : 'BAC PRO';
            var titleHtml = '<div class="card-title">' + prevue.classeId +
                ' <span class="count">' + niveauLabel + '</span></div>';

            // Month headers
            var semaines = prevue.semaines || [];
            var monthsHtml = buildMonthHeaders(semaines);

            // Week cells
            var cellsHtml = '';
            var currentModule = '';
            semaines.forEach(function(sem) {
                var cls = situationClass(sem);
                var isCurrent = sem.date === currentMonday;

                // Determine display text ‚Äî show phase icon or week number
                var label = sem.semaine || '';
                var module = cleanModuleName(sem.module || '');
                var moduleBaseClean = (sem.moduleBase || module || '').replace(/\n/g, ' ').trim();
                if (module && module !== 'N/A') currentModule = module;

                // Cell content: phase label (E/C/number) or week number
                var cellContent = '';
                var pLabel = phaseLabel(sem);
                var sit = (sem.situation || '').toLowerCase();
                var isSpecialSit = sit.includes('vacances') || sit.includes('pfmp') || sit.includes('feri') || sit.includes('f√©ri');

                if (!isSpecialSit && module && module !== 'N/A' && pLabel) {
                    cellContent = '<span class="phase-icon">' + pLabel + '</span>';
                } else {
                    cellContent = label.replace('S', '');
                }

                // Build rich tooltip
                var tooltipText = sem.date + ' (' + sem.semaine + ')';
                if (sem.ab) tooltipText += ' ‚Äî Sem. ' + sem.ab;
                if (module && module !== 'N/A') tooltipText += '\\nüìö ' + module;
                if (sem.phase && sem.phase !== 'cours' && module && module !== 'N/A') {
                    tooltipText += '\\nüîñ Phase : ' + sem.phase.charAt(0).toUpperCase() + sem.phase.slice(1);
                }
                if (sem.transition) {
                    tooltipText += ' ‚Üí ' + sem.transition.replace(/_/g, ' ');
                }
                if (sem.suiteModule && sem.suiteModule !== 'N/A') {
                    tooltipText += '\\n‚û© ' + sem.suiteModule.replace(/[‚û©‚û´‚á®]\s*/g, '');
                }
                if (sem.seance && sem.seance !== 'N/A') tooltipText += '\\nüìù ' + sem.seance;
                if (sem.statut && sem.statut !== 'N/A') tooltipText += '\\nüìå ' + sem.statut;
                if (sem.nbSeancesPrevues && sem.nbSeancesPrevues > 0) tooltipText += '\\nüî¢ ' + sem.nbSeancesPrevues + ' s√©ances pr√©vues';
                if (sem.evalDiag && sem.evalDiag !== 'N/A') tooltipText += '\\nüîç Diag: ' + sem.evalDiag;
                if (sem.evalForm && sem.evalForm !== 'N/A') tooltipText += '\\nüìä Form: ' + sem.evalForm;
                if (sem.evaluation && sem.evaluation !== 'N/A') tooltipText += '\\nüìù √âval: ' + sem.evaluation;
                if (sem.situation && sem.situation !== 'Normal') tooltipText += '\\n‚ö° ' + sem.situation;

                cellsHtml += '<div class="timeline-cell ' + cls + (isCurrent ? ' c-current' : '') + '" data-sem-idx="' + i + '" style="cursor:pointer;">' +
                    cellContent +
                    '<div class="tooltip">' + tooltipText.replace(/\\n/g, '<br>') + '</div>' +
                    '</div>';
            });

            // Module summary table
            var modulesSummary = buildModuleSummary(prevue);

            card.innerHTML = titleHtml +
                '<div class="timeline-weeks">' +
                '<div class="month-headers">' + monthsHtml + '</div>' +
                '<div class="timeline-row">' + cellsHtml + '</div>' +
                '</div>' +
                modulesSummary;

            // Click handler for timeline cells
            (function(p) {
                card.addEventListener('click', function(e) {
                    var cell = e.target.closest('.timeline-cell');
                    if (!cell || !cell.dataset.semIdx) return;
                    var idx = parseInt(cell.dataset.semIdx);
                    if (p.semaines && p.semaines[idx]) {
                        showWeekDetail(p.classeId, p.semaines[idx], p.id);
                    }
                });
            })(prevue);

            container.appendChild(card);
        });
    }

    function buildMonthHeaders(semaines) {
        var months = [];
        var currentMonth = -1;
        var count = 0;
        var monthNames = ['Jan', 'Fev', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aout', 'Sep', 'Oct', 'Nov', 'Dec'];

        semaines.forEach(function(sem, idx) {
            var d = parseDate(sem.date);
            if (!d) return;
            var m = d.getMonth();
            if (m !== currentMonth) {
                if (currentMonth >= 0) {
                    months.push({ label: monthNames[currentMonth], count: count });
                }
                currentMonth = m;
                count = 1;
            } else {
                count++;
            }
        });
        if (currentMonth >= 0) {
            months.push({ label: monthNames[currentMonth], count: count });
        }

        var html = '';
        months.forEach(function(m) {
            // Each cell is 36px + 3px gap = 39px
            var width = m.count * 39 - 3;
            html += '<div class="month-label" style="width:' + width + 'px;">' + m.label + '</div>';
        });
        return html;
    }

    function buildModuleSummary(prevue) {
        // Group semaines by module (base name)
        var moduleMap = {};
        var order = [];
        (prevue.semaines || []).forEach(function(s) {
            var m = cleanModuleName(s.module || '');
            if (!m || m === 'N/A') return;
            var base = baseModuleName(m);
            if (!base) return;
            if (!moduleMap[base]) {
                moduleMap[base] = {
                    total: 0, realise: 0, reporte: 0, prevu: 0,
                    hasEval: false, evalDone: false, hasCorrection: false, correctionDone: false,
                    nbSeancesPrevues: 0, seancesRealisees: 0, lastSeance: '',
                    evalDiag: '', evalForm: '', evaluation: '',
                    currentPhase: ''
                };
                order.push(base);
            }
            var info = moduleMap[base];
            info.total++;

            // Track nb s√©ances pr√©vues (take the max found)
            if (s.nbSeancesPrevues && s.nbSeancesPrevues > info.nbSeancesPrevues) {
                info.nbSeancesPrevues = s.nbSeancesPrevues;
            }

            var phase = (s.phase || 'cours').toLowerCase();

            if (isRealise(s)) {
                info.realise++;
                if (phase === 'cours' || phase === 'presentation') info.seancesRealisees++;
                if (s.seance && s.seance !== 'N/A') info.lastSeance = s.seance;
            }
            if (isReporte(s)) info.reporte++;
            if (isPrevu(s)) info.prevu++;

            if (phase === 'evaluation') {
                info.hasEval = true;
                if (isRealise(s)) info.evalDone = true;
            }
            if (phase === 'correction') {
                info.hasCorrection = true;
                if (isRealise(s)) info.correctionDone = true;
            }

            // Track evaluations types
            if (s.evalDiag && s.evalDiag !== 'N/A') info.evalDiag = s.evalDiag;
            if (s.evalForm && s.evalForm !== 'N/A') info.evalForm = s.evalForm;
            if (s.evaluation && s.evaluation !== 'N/A') info.evaluation = s.evaluation;

            // Track current phase (last non-realized)
            if (!isRealise(s)) info.currentPhase = phase;
        });

        if (order.length === 0) return '';

        var html = '<div style="margin-top:15px;">';
        html += '<div style="font-weight:700; font-size:0.85em; margin-bottom:8px;">Modules :</div>';
        html += '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
        order.forEach(function(name) {
            var info = moduleMap[name];
            var pct = info.total > 0 ? Math.round(info.realise / info.total * 100) : 0;
            var bgColor = pct === 100 ? 'var(--success-light)' : pct > 0 ? 'var(--warning-light)' : '#f1f5f9';
            var borderColor = pct === 100 ? 'var(--success)' : pct > 0 ? 'var(--warning)' : 'var(--border)';
            var textColor = pct === 100 ? '#166534' : pct > 0 ? '#92400e' : 'var(--muted)';

            // Short display name
            var shortName = name.length > 30 ? name.substring(0, 30) + '...' : name;

            // Build detail line
            var detail = '';
            if (info.nbSeancesPrevues > 0) {
                detail += info.seancesRealisees + '/' + info.nbSeancesPrevues + ' s√©ances';
            } else {
                detail += info.realise + '/' + info.total + ' sem.';
            }
            if (info.hasEval) detail += info.evalDone ? ' ¬∑ ‚úÖ √âval' : ' ¬∑ ‚è≥ √âval';
            if (info.hasCorrection) detail += info.correctionDone ? ' ¬∑ ‚úÖ Corr' : ' ¬∑ ‚è≥ Corr';
            if (info.reporte > 0) detail += ' ¬∑ üîÑ' + info.reporte;

            // Evaluation types
            var evalDetail = '';
            if (info.evalDiag) evalDetail += 'üîç' + info.evalDiag + ' ';
            if (info.evalForm) evalDetail += 'üìä' + info.evalForm + ' ';
            if (info.evaluation) evalDetail += 'üìù' + info.evaluation;

            html += '<div style="padding:6px 10px; border-radius:8px; font-size:0.72em; font-weight:600; ' +
                'background:' + bgColor + '; border:1px solid ' + borderColor + '; color:' + textColor + ';">' +
                shortName +
                '<div style="font-weight:500; font-size:0.9em; opacity:0.8; margin-top:2px;">' + detail + '</div>' +
                (evalDetail ? '<div style="font-weight:500; font-size:0.85em; opacity:0.7; margin-top:1px;">' + evalDetail + '</div>' : '') +
                '</div>';
        });
        html += '</div></div>';
        return html;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VUE 2 : PAR MODULE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderModuleView() {
        var container = document.getElementById('moduleContent');
        var filterVal = document.getElementById('filterModule').value;

        // Collect: for each module, which classes have it and status
        var moduleData = {};

        allPrevue.forEach(function(prevue) {
            (prevue.semaines || []).forEach(function(sem) {
                var m = cleanModuleName(sem.module || '');
                if (!m || m === 'N/A') return;

                var base = baseModuleName(m);
                if (!base) return;

                if (filterVal && base !== filterVal && m !== filterVal) return;

                if (!moduleData[base]) moduleData[base] = {};
                if (!moduleData[base][prevue.classeId]) {
                    moduleData[base][prevue.classeId] = {
                        classeId: prevue.classeId,
                        niveau: prevue.niveau,
                        total: 0,
                        realise: 0,
                        reporte: 0,
                        lastSeance: '',
                        evalDone: false,
                        hasEval: false,
                        hasCorrection: false,
                        correctionDone: false,
                        nbSeancesPrevues: 0,
                        evalDiag: '',
                        evalForm: '',
                        evaluation: ''
                    };
                }
                var entry = moduleData[base][prevue.classeId];
                entry.total++;
                if (sem.nbSeancesPrevues && sem.nbSeancesPrevues > entry.nbSeancesPrevues) {
                    entry.nbSeancesPrevues = sem.nbSeancesPrevues;
                }
                if (isRealise(sem)) {
                    entry.realise++;
                    if (sem.seance && sem.seance !== 'N/A') entry.lastSeance = sem.seance;
                }
                if (isReporte(sem)) entry.reporte++;
                var phase = (sem.phase || 'cours').toLowerCase();
                if (phase === 'evaluation') {
                    entry.hasEval = true;
                    if (isRealise(sem)) entry.evalDone = true;
                }
                if (phase === 'correction') {
                    entry.hasCorrection = true;
                    if (isRealise(sem)) entry.correctionDone = true;
                }
                if (sem.evalDiag && sem.evalDiag !== 'N/A') entry.evalDiag = sem.evalDiag;
                if (sem.evalForm && sem.evalForm !== 'N/A') entry.evalForm = sem.evalForm;
                if (sem.evaluation && sem.evaluation !== 'N/A') entry.evaluation = sem.evaluation;
            });
        });

        var moduleNames = Object.keys(moduleData).sort();
        if (moduleNames.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üì•</div><p>Aucun module trouv√©.</p></div>';
            return;
        }

        container.innerHTML = '';

        moduleNames.forEach(function(moduleName) {
            var classes = moduleData[moduleName];
            var card = document.createElement('div');
            card.className = 'card';

            var classCount = Object.keys(classes).length;
            card.innerHTML = '<div class="card-title">' + moduleName + ' <span class="count">' + classCount + ' classes</span></div>';

            var grid = document.createElement('div');
            grid.className = 'module-grid';

            var classIds = Object.keys(classes).sort();
            classIds.forEach(function(classeId) {
                var info = classes[classeId];
                var pct = info.total > 0 ? Math.round(info.realise / info.total * 100) : 0;

                var statusLabel, badgeClass;
                if (pct === 100) {
                    statusLabel = info.evalDone ? '√âval termin√©e' : 'Termin√©';
                    badgeClass = info.evalDone ? 'b-eval' : 'b-terminee';
                } else if (pct > 0) {
                    statusLabel = 'En cours';
                    badgeClass = 'b-en-cours';
                } else {
                    statusLabel = 'Non commenc√©';
                    badgeClass = 'b-non-commence';
                }

                // Build detail line
                var detail = '';
                if (info.nbSeancesPrevues > 0) {
                    var seancesR = info.realise - (info.hasEval && info.evalDone ? 1 : 0) - (info.hasCorrection && info.correctionDone ? 1 : 0);
                    detail = seancesR + '/' + info.nbSeancesPrevues + ' s√©ances';
                } else if (info.lastSeance) {
                    detail = 'Dernier : ' + info.lastSeance;
                } else {
                    detail = pct + '% compl√©t√©';
                }
                if (info.hasEval) detail += info.evalDone ? ' ¬∑ ‚úÖ √âval' : ' ¬∑ ‚è≥ √âval';
                if (info.hasCorrection) detail += info.correctionDone ? ' ¬∑ ‚úÖ Corr' : ' ¬∑ ‚è≥ Corr';
                if (info.reporte > 0) detail += ' ¬∑ üîÑ ' + info.reporte + ' report√©';

                // Eval types
                var evalLine = '';
                if (info.evalDiag) evalLine += 'üîç ' + info.evalDiag + ' ';
                if (info.evalForm) evalLine += 'üìä ' + info.evalForm + ' ';
                if (info.evaluation) evalLine += 'üìù ' + info.evaluation;

                var progressClass = pct === 100 ? 'p-success' : 'p-warning';

                var itemDiv = document.createElement('div');
                itemDiv.className = 'module-class-card';
                itemDiv.innerHTML =
                    '<div class="mc-header">' +
                    '<span class="mc-classe">' + classeId + '</span>' +
                    '<span class="mc-badge ' + badgeClass + '">' + statusLabel + '</span>' +
                    '</div>' +
                    '<div class="mc-detail">' + detail + '</div>' +
                    (evalLine ? '<div class="mc-detail" style="font-size:0.78em; margin-top:2px;">' + evalLine + '</div>' : '') +
                    '<div class="mc-progress"><div class="mc-progress-fill ' + progressClass + '" style="width:' + pct + '%;"></div></div>';

                grid.appendChild(itemDiv);
            });

            card.appendChild(grid);
            container.appendChild(card);
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VUE 3 : TIMELINE ANNEE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderTimeline() {
        var container = document.getElementById('timelineContent');

        if (allPrevue.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üì•</div><p>Aucune donn√©e import√©e.</p></div>';
            return;
        }

        // Build table: rows = classes, columns = weeks
        // First, collect all unique week dates across all classes
        var allWeeks = [];
        var weekSet = {};
        allPrevue.forEach(function(p) {
            (p.semaines || []).forEach(function(s) {
                if (s.date && !weekSet[s.date]) {
                    weekSet[s.date] = true;
                    allWeeks.push({ date: s.date, semaine: s.semaine, parsed: parseDate(s.date) });
                }
            });
        });
        allWeeks.sort(function(a, b) {
            if (!a.parsed || !b.parsed) return 0;
            return a.parsed.getTime() - b.parsed.getTime();
        });

        if (allWeeks.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üìä</div><p>Pas de semaines.</p></div>';
            return;
        }

        var currentMonday = getCurrentWeekMonday();

        // Build month header spans
        var monthNames = ['Jan', 'Fev', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aout', 'Sep', 'Oct', 'Nov', 'Dec'];

        var table = document.createElement('table');
        table.className = 'year-table';

        // Header row: month names
        var thead = document.createElement('thead');
        var thRow = document.createElement('tr');
        thRow.innerHTML = '<th></th>'; // Empty cell for class labels

        // Group weeks by month for colspan
        var monthGroups = [];
        var prevMonth = -1;
        allWeeks.forEach(function(w) {
            if (!w.parsed) return;
            var m = w.parsed.getMonth();
            if (m !== prevMonth) {
                monthGroups.push({ month: m, count: 1 });
                prevMonth = m;
            } else {
                monthGroups[monthGroups.length - 1].count++;
            }
        });

        monthGroups.forEach(function(mg) {
            var th = document.createElement('th');
            th.colSpan = mg.count;
            th.textContent = monthNames[mg.month];
            thRow.appendChild(th);
        });
        thead.appendChild(thRow);

        // Week numbers sub-header
        var weekRow = document.createElement('tr');
        weekRow.innerHTML = '<th></th>';
        allWeeks.forEach(function(w) {
            var th = document.createElement('th');
            th.textContent = (w.semaine || '').replace('S', '');
            th.style.fontSize = '0.55em';
            th.style.color = '#94a3b8';
            weekRow.appendChild(th);
        });
        thead.appendChild(weekRow);
        table.appendChild(thead);

        // Body: one row per class
        var tbody = document.createElement('tbody');
        allPrevue.forEach(function(prevue) {
            var tr = document.createElement('tr');

            // Class label cell
            var tdLabel = document.createElement('td');
            tdLabel.className = 'class-label';
            tdLabel.textContent = prevue.classeId;
            tr.appendChild(tdLabel);

            // Build week lookup for this class
            var weekMap = {};
            (prevue.semaines || []).forEach(function(s) {
                weekMap[s.date] = s;
            });

            // One cell per week
            allWeeks.forEach(function(w) {
                var td = document.createElement('td');
                td.className = 'week-cell';
                var sem = weekMap[w.date];
                var color = sem ? situationColor(sem) : '#f8fafc';
                td.style.background = color;

                var isCurrent = w.date === currentMonday;
                if (isCurrent) {
                    td.style.outline = '2px solid var(--primary)';
                    td.style.outlineOffset = '0px';
                    td.style.zIndex = '3';
                    td.style.position = 'relative';
                }

                // Tooltip + click
                if (sem) {
                    var tipText = w.date + ' (' + w.semaine + ')';
                    var module = cleanModuleName(sem.module || '');
                    if (module && module !== 'N/A') tipText += ' ‚Äî ' + module;
                    if (sem.situation && sem.situation !== 'Normal') tipText += ' ‚Äî ' + sem.situation;
                    td.innerHTML = '<div class="tooltip">' + tipText + '</div>';
                    td.style.cursor = 'pointer';
                    (function(p, s) {
                        td.addEventListener('click', function() {
                            showWeekDetail(p.classeId, s, p.id);
                        });
                    })(prevue, sem);
                }

                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.innerHTML = '';
        container.appendChild(table);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // VUE 4 : ALERTES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function computeAlerts() {
        var alerts = [];

        // 1. From logs: checklist-based alerts
        allLogs.forEach(function(log) {
            var cl = log.checklist || {};
            if (cl.copies_ramassees && !cl.copies_corrigees) {
                alerts.push({
                    type: 'warn', icon: 'üìù',
                    text: log.classeId + ' ‚Äî Copies √† corriger',
                    detail: (log.moduleId || '') + (log.seance ? ' ‚Äî ' + log.seance : ''),
                    date: log.date || '',
                    priority: 2
                });
            }
            if (cl.copies_corrigees && !cl.copies_rendues) {
                alerts.push({
                    type: 'warn', icon: 'üì§',
                    text: log.classeId + ' ‚Äî Copies √† rendre',
                    detail: (log.moduleId || '') + (log.seance ? ' ‚Äî ' + log.seance : ''),
                    date: log.date || '',
                    priority: 1
                });
            }
            if (cl.eval_passee && !cl.eval_corrigee) {
                alerts.push({
                    type: 'err', icon: 'üî¥',
                    text: log.classeId + ' ‚Äî √âvaluation √† corriger',
                    detail: (log.moduleId || ''),
                    date: log.date || '',
                    priority: 3
                });
            }
            if (cl.eval_corrigee && !cl.eval_rendue) {
                alerts.push({
                    type: 'warn', icon: 'üì§',
                    text: log.classeId + ' ‚Äî √âvaluation √† rendre',
                    detail: (log.moduleId || ''),
                    date: log.date || '',
                    priority: 2
                });
            }
        });

        // 2. Retard vs prevue + statuts problematiques
        var today = new Date();
        allPrevue.forEach(function(prevue) {
            var behindCount = 0;
            var reporteCount = 0;
            var prevuRetardCount = 0;
            (prevue.semaines || []).forEach(function(sem) {
                var sit = (sem.situation || '').toLowerCase();
                if (sit.includes('vacances') || sit.includes('pfmp') || sit.includes('feri') || sit.includes('f√©ri')) return;
                var d = parseDate(sem.date);
                if (!d || d >= today) return;

                if (!isRealise(sem) && !isReporte(sem) && !isNonRealise(sem) && !isPrevu(sem) && sit === 'normal') {
                    behindCount++;
                }
                if (isReporte(sem)) reporteCount++;
                if (isPrevu(sem)) prevuRetardCount++;
            });
            if (behindCount > 0) {
                alerts.push({
                    type: 'info', icon: '‚è∞',
                    text: prevue.classeId + ' ‚Äî ' + behindCount + ' semaine' + (behindCount > 1 ? 's' : '') + ' en retard',
                    detail: 'Semaines pass√©es non renseign√©es',
                    date: '',
                    priority: 1
                });
            }
            if (reporteCount > 0) {
                alerts.push({
                    type: 'warn', icon: 'üîÑ',
                    text: prevue.classeId + ' ‚Äî ' + reporteCount + ' s√©ance' + (reporteCount > 1 ? 's' : '') + ' report√©e' + (reporteCount > 1 ? 's' : ''),
                    detail: 'S√©ances report√©es √† replanifier',
                    date: '',
                    priority: 2
                });
            }
            if (prevuRetardCount > 0) {
                alerts.push({
                    type: 'warn', icon: '‚ö†Ô∏è',
                    text: prevue.classeId + ' ‚Äî ' + prevuRetardCount + ' s√©ance' + (prevuRetardCount > 1 ? 's' : '') + ' pr√©vue' + (prevuRetardCount > 1 ? 's' : '') + ' non r√©alis√©e' + (prevuRetardCount > 1 ? 's' : ''),
                    detail: 'Statut "Pr√©vu" sur des semaines pass√©es',
                    date: '',
                    priority: 2
                });
            }
        });

        // Sort by priority desc, then date desc
        alerts.sort(function(a, b) {
            if (b.priority !== a.priority) return b.priority - a.priority;
            return (b.date || '').localeCompare(a.date || '');
        });

        return alerts;
    }

    function renderAlertes() {
        var container = document.getElementById('alertesContent');
        var alerts = computeAlerts();

        if (alerts.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">‚úÖ</div><p>Aucune alerte. Tout est √† jour !</p></div>';
            return;
        }

        container.innerHTML = '';

        // Group by type
        var errAlerts = alerts.filter(function(a) { return a.type === 'err'; });
        var warnAlerts = alerts.filter(function(a) { return a.type === 'warn'; });
        var infoAlerts = alerts.filter(function(a) { return a.type === 'info'; });

        if (errAlerts.length > 0) {
            var card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = '<div class="card-title">üî¥ Urgences <span class="count">' + errAlerts.length + '</span></div>';
            errAlerts.forEach(function(a) { card.appendChild(createAlertItem(a)); });
            container.appendChild(card);
        }

        if (warnAlerts.length > 0) {
            var card2 = document.createElement('div');
            card2.className = 'card';
            card2.innerHTML = '<div class="card-title">üü° √Ä traiter <span class="count">' + warnAlerts.length + '</span></div>';
            warnAlerts.forEach(function(a) { card2.appendChild(createAlertItem(a)); });
            container.appendChild(card2);
        }

        if (infoAlerts.length > 0) {
            var card3 = document.createElement('div');
            card3.className = 'card';
            card3.innerHTML = '<div class="card-title">‚ÑπÔ∏è Retards <span class="count">' + infoAlerts.length + '</span></div>';
            infoAlerts.forEach(function(a) { card3.appendChild(createAlertItem(a)); });
            container.appendChild(card3);
        }
    }

    function createAlertItem(alert) {
        var div = document.createElement('div');
        div.className = 'alert-item ' + alert.type;
        div.innerHTML = '<span class="alert-icon">' + alert.icon + '</span>' +
            '<div class="alert-text"><strong>' + alert.text + '</strong>' +
            (alert.detail ? '<br><span style="font-size:0.85em; opacity:0.8;">' + alert.detail + '</span>' : '') +
            '</div>' +
            (alert.date ? '<span class="alert-date">' + alert.date + '</span>' : '');
        return div;
    }

</script>
</body>
</html>
