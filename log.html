<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saisie Progression PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --surface: #1e293b;
            --surface-2: #334155;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: rgba(99,102,241,0.15);
            --success: #10b981;
            --success-light: rgba(16,185,129,0.15);
            --warning: #f59e0b;
            --warning-light: rgba(245,158,11,0.15);
            --danger: #ef4444;
            --danger-light: rgba(239,68,68,0.15);
            --border: #334155;
            --radius: 14px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh; padding: 15px; padding-bottom: 110px;
        }
        .container { max-width: 500px; margin: 0 auto; }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        .login-screen {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
        }
        .login-card {
            background: var(--card); border-radius: 20px; padding: 40px 30px;
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 350px; width: 100%; border: 1px solid var(--border);
        }
        .login-icon { font-size: 3em; margin-bottom: 12px; }
        .login-card h2 { font-size: 1.3em; font-weight: 800; margin-bottom: 6px; }
        .login-card p { color: var(--muted); margin-bottom: 25px; font-size: 0.9em; }
        .btn-google {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 12px 25px; border: 2px solid var(--border); border-radius: 50px;
            background: var(--surface-2); color: var(--text); font-size: 0.95em; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: all 0.2s;
        }
        .btn-google:hover { border-color: var(--primary); background: var(--primary-light); }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 18px;
        }
        .page-header h1 { font-size: 1.2em; font-weight: 800; }
        .room-badge {
            padding: 6px 14px; border-radius: 20px; font-size: 0.8em;
            font-weight: 700; background: var(--primary-light); color: var(--primary-dark);
        }
        .date-display { font-size: 0.8em; color: var(--muted); margin-bottom: 15px; }
        .back-link {
            font-size: 0.85em; color: var(--muted); text-decoration: none;
            display: inline-flex; align-items: center; gap: 4px; margin-bottom: 10px;
        }

        /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
        .card {
            background: var(--card); border-radius: var(--radius); padding: 20px;
            margin-bottom: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .card-title {
            font-weight: 700; font-size: 0.95em; margin-bottom: 14px;
            display: flex; align-items: center; gap: 8px;
        }

        /* ‚îÄ‚îÄ LABELS ‚îÄ‚îÄ */
        .field-label {
            display: block; font-size: 0.75em; font-weight: 700;
            color: var(--muted); margin-bottom: 6px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* ‚îÄ‚îÄ SELECT ‚îÄ‚îÄ */
        select {
            width: 100%; padding: 14px 40px 14px 14px;
            border: 2px solid var(--border); border-radius: 12px;
            font-size: 1em; font-family: inherit; margin-bottom: 14px;
            background: var(--surface-2); color: var(--text);
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center; background-size: 20px;
        }
        select:focus { outline: none; border-color: var(--primary); }

        /* ‚îÄ‚îÄ SEANCE PICKER ‚îÄ‚îÄ */
        .seance-grid {
            display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px;
        }
        .seance-btn {
            padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px;
            background: var(--surface-2); font-size: 0.8em; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: all 0.15s; color: var(--text);
            -webkit-tap-highlight-color: transparent; flex-shrink: 0;
        }
        .seance-btn:active { transform: scale(0.95); }
        .seance-btn.selected { border-color: var(--primary); background: var(--primary-light); color: #818cf8; }

        /* ‚îÄ‚îÄ PHASE SELECTOR ‚îÄ‚îÄ */
        .phase-grid { display: flex; gap: 8px; margin-bottom: 14px; }
        .phase-btn {
            flex: 1; padding: 10px 8px; border: 2px solid var(--border); border-radius: 10px;
            background: var(--surface-2); font-size: 0.8em; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: all 0.15s; color: var(--muted); text-align: center;
            -webkit-tap-highlight-color: transparent;
        }
        .phase-btn:active { transform: scale(0.95); }
        .phase-btn.selected { border-color: #6366f1; background: var(--primary-light); color: #818cf8; }
        .phase-btn .phase-icon { display: block; font-size: 1.2em; margin-bottom: 2px; }

        /* ‚îÄ‚îÄ MODULE SUIVANT ‚îÄ‚îÄ */
        .module-suivant-toggle {
            display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
            padding: 10px 14px; border-radius: 10px; border: 2px dashed var(--border);
            background: var(--surface); cursor: pointer; transition: all 0.15s;
            font-size: 0.82em; font-weight: 600; color: var(--muted);
            -webkit-tap-highlight-color: transparent;
        }
        .module-suivant-toggle:active { transform: scale(0.98); }
        .module-suivant-toggle.active { border-color: #6366f1; border-style: solid; background: var(--primary-light); color: #818cf8; }
        #moduleSuivantSection {
            padding: 12px; border-radius: 10px; background: var(--bg);
            border: 1px solid var(--border); margin-bottom: 14px;
        }
        #moduleSuivantSection select { width: 100%; margin-bottom: 10px; }
        .phase-badge {
            display: inline-block; padding: 2px 8px; border-radius: 6px;
            font-size: 0.7em; font-weight: 600; margin-left: 6px;
        }
        .phase-badge.cours { background: var(--success-light); color: #34d399; }
        .phase-badge.evaluation { background: rgba(245,158,11,0.15); color: #fbbf24; }
        .phase-badge.correction { background: var(--primary-light); color: #818cf8; }

        /* ‚îÄ‚îÄ STATUS BUTTONS ‚îÄ‚îÄ */
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 14px; }
        .status-btn {
            padding: 18px 8px; border: 3px solid var(--border);
            border-radius: 14px; background: var(--surface-2); cursor: pointer;
            text-align: center; transition: all 0.15s; font-family: inherit;
            -webkit-tap-highlight-color: transparent;
        }
        .status-btn:active { transform: scale(0.96); }
        .status-btn .emoji { font-size: 1.6em; display: block; margin-bottom: 4px; }
        .status-btn .label { font-size: 0.72em; font-weight: 700; color: var(--muted); }
        .status-btn.selected.s-realise { border-color: var(--success); background: var(--success-light); }
        .status-btn.selected.s-realise .label { color: var(--success); }
        .status-btn.selected.s-prevu { border-color: #6366f1; background: var(--primary-light); }
        .status-btn.selected.s-prevu .label { color: #6366f1; }
        .status-btn.selected.s-reporte { border-color: var(--warning); background: var(--warning-light); }
        .status-btn.selected.s-reporte .label { color: #92400e; }
        .status-btn.selected.s-non_realise { border-color: var(--danger); background: var(--danger-light); }
        .status-btn.selected.s-non_realise .label { color: var(--danger); }

        /* ‚îÄ‚îÄ SITUATION RAPIDE ‚îÄ‚îÄ */
        .situation-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }
        .situation-btn {
            padding: 8px 14px; border: 2px solid var(--border); border-radius: 20px;
            background: var(--surface-2); font-size: 0.78em; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: all 0.15s; color: var(--muted);
        }
        .situation-btn.selected { border-color: var(--danger); background: var(--danger-light); color: var(--danger); }

        /* ‚îÄ‚îÄ CHECKLIST ‚îÄ‚îÄ */
        .checklist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .check-btn {
            padding: 12px 10px; border: 2px solid var(--border);
            border-radius: 10px; background: var(--surface-2); cursor: pointer;
            text-align: center; font-size: 0.78em; font-weight: 600;
            transition: all 0.15s; font-family: inherit; color: var(--muted);
            -webkit-tap-highlight-color: transparent;
        }
        .check-btn:active { transform: scale(0.96); }
        .check-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary-dark); }
        .check-btn .check-icon { font-size: 1.2em; display: block; margin-bottom: 3px; }

        /* ‚îÄ‚îÄ STEPPER ‚îÄ‚îÄ */
        .stepper { display: flex; align-items: center; gap: 20px; margin-bottom: 14px; }
        .stepper-btn {
            width: 52px; height: 52px; border-radius: 50%;
            border: 2px solid var(--border); background: var(--surface-2);
            font-size: 1.5em; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            font-family: inherit; transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .stepper-btn:active { transform: scale(0.92); background: var(--bg); }
        .stepper-value { font-size: 2.2em; font-weight: 800; min-width: 50px; text-align: center; }

        /* ‚îÄ‚îÄ QUALITY ‚îÄ‚îÄ */
        .quality-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .quality-btn {
            padding: 14px 8px; border: 2px solid var(--border);
            border-radius: 12px; background: var(--surface-2); cursor: pointer;
            text-align: center; font-family: inherit; transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .quality-btn:active { transform: scale(0.96); }
        .quality-btn .emoji { font-size: 1.5em; display: block; margin-bottom: 4px; }
        .quality-btn .label { font-size: 0.72em; font-weight: 700; color: var(--muted); }
        .quality-btn.selected.q-tres_bien { border-color: var(--success); background: var(--success-light); }
        .quality-btn.selected.q-correct { border-color: var(--warning); background: var(--warning-light); }
        .quality-btn.selected.q-difficile { border-color: var(--danger); background: var(--danger-light); }

        /* ‚îÄ‚îÄ TEXT INPUTS (dark theme) ‚îÄ‚îÄ */
        input[type="text"], input[type="date"], input[type="time"], textarea, select {
            width: 100%; padding: 12px; border: 2px solid var(--border);
            border-radius: 12px; font-size: 0.95em; font-family: inherit;
            margin-bottom: 12px; color: var(--text);
            background: var(--surface-2); caret-color: #f1f5f9;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus,
        textarea:focus, select:focus { outline: none; border-color: var(--primary); }
        textarea { resize: vertical; min-height: 60px; }
        ::placeholder { color: var(--muted); opacity: 1; }
        ::-webkit-input-placeholder { color: var(--muted); }
        /* Fix Safari date/time picker */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.7);
        }

        /* ‚îÄ‚îÄ SAVE BAR ‚îÄ‚îÄ */
        .save-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 14px 15px; background: var(--surface);
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3); z-index: 100;
        }
        .btn-save {
            display: flex; align-items: center; justify-content: center;
            gap: 10px; width: 100%; max-width: 500px; margin: 0 auto;
            padding: 18px; border: none; border-radius: var(--radius);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; font-size: 1.1em; font-weight: 800; cursor: pointer;
            font-family: inherit; box-shadow: 0 4px 15px rgba(99,102,241,0.3);
            transition: all 0.15s;
        }
        .btn-save:active { transform: scale(0.98); }
        .btn-save:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ‚îÄ‚îÄ LAST LOG INFO ‚îÄ‚îÄ */
        .last-log {
            padding: 12px 14px; border-radius: 10px; margin-bottom: 14px;
            background: var(--primary-light); border: 1px solid rgba(99,102,241,0.3); font-size: 0.82em;
        }
        .last-log strong { color: #818cf8; }

        /* ‚îÄ‚îÄ VALIDE TOGGLE ‚îÄ‚îÄ */
        .valide-toggle {
            display: flex; align-items: center; gap: 14px; margin-bottom: 14px;
            padding: 14px; border-radius: 12px; border: 3px solid var(--border);
            background: var(--surface-2); cursor: pointer; transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .valide-toggle:active { transform: scale(0.98); }
        .valide-toggle.checked { border-color: var(--success); background: var(--success-light); }
        .valide-toggle .toggle-check { font-size: 1.8em; }
        .valide-toggle .toggle-text { font-weight: 700; font-size: 0.9em; }
        .valide-toggle.checked .toggle-text { color: var(--success); }

        /* ‚îÄ‚îÄ CPS SMILEYS ‚îÄ‚îÄ */
        .cps-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .cps-label { font-size: 0.72em; font-weight: 700; color: var(--muted); min-width: 70px; }
        .cps-btns { display: flex; gap: 6px; flex: 1; }
        .cps-btn {
            flex: 1; padding: 8px 4px; border: 2px solid var(--border); border-radius: 10px;
            background: var(--surface-2); cursor: pointer; text-align: center; font-size: 1.4em;
            transition: all 0.15s; -webkit-tap-highlight-color: transparent;
        }
        .cps-btn:active { transform: scale(0.92); }
        .cps-btn.selected { border-color: var(--primary); background: var(--primary-light); }

        /* ‚îÄ‚îÄ MISSED REMINDER ‚îÄ‚îÄ */
        .missed-banner {
            padding: 14px; border-radius: 12px; margin-bottom: 10px;
            background: rgba(251,146,60,0.1); border: 2px solid #fb923c; cursor: pointer;
            transition: all 0.15s; -webkit-tap-highlight-color: transparent;
        }
        .missed-banner:active { transform: scale(0.98); }
        .missed-title { font-weight: 700; font-size: 0.85em; color: #fb923c; margin-bottom: 4px; }
        .missed-detail { font-size: 0.78em; color: #fdba74; }

        /* ‚îÄ‚îÄ TODO NEXT GRID ‚îÄ‚îÄ */
        .todo-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
        .todo-btn {
            padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px;
            background: var(--surface-2); font-size: 0.78em; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: all 0.15s; color: var(--text);
            -webkit-tap-highlight-color: transparent;
        }
        .todo-btn:active { transform: scale(0.95); }
        .todo-btn.selected { border-color: var(--primary); background: var(--primary-light); color: var(--primary-dark); }
        .todo-btn.seance-chip { border-color: var(--primary); color: #818cf8; font-weight: 800; }
        .todo-btn.seance-chip.selected { background: var(--primary); color: #fff; border-color: var(--primary); }
        .todo-btn.eval-option { border-color: #f59e0b; color: #fbbf24; }
        .todo-btn.eval-option.selected { border-color: #f59e0b; background: rgba(245,158,11,0.2); color: #fbbf24; }

        /* ‚îÄ‚îÄ PRONOTE REMINDER ‚îÄ‚îÄ */
        .pronote-banner {
            padding: 14px; border-radius: 12px; margin-bottom: 10px;
            background: rgba(251,146,60,0.1); border: 2px solid #fb923c;
        }
        .pronote-banner .reminder-title { font-weight: 700; font-size: 0.85em; color: #fb923c; margin-bottom: 4px; }
        .pronote-banner .reminder-detail { font-size: 0.78em; color: #fdba74; }

        /* ‚îÄ‚îÄ CONTINUATION REMINDER ‚îÄ‚îÄ */
        .continuation-banner {
            padding: 14px; border-radius: 12px; margin-bottom: 10px;
            background: rgba(96,165,250,0.1); border: 2px solid #60a5fa;
        }
        .continuation-banner .reminder-title { font-weight: 700; font-size: 0.85em; color: #60a5fa; margin-bottom: 4px; }
        .continuation-banner .reminder-detail { font-size: 0.78em; color: #93c5fd; }

        /* ‚îÄ‚îÄ QR SCANNER ‚îÄ‚îÄ */
        .qr-scanner-card {
            background: var(--card); border-radius: var(--radius); padding: 16px;
            margin-bottom: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            text-align: center;
        }
        .btn-scan {
            display: inline-flex; align-items: center; gap: 10px;
            padding: 14px 28px; border: 2px solid var(--primary);
            border-radius: 14px; background: var(--primary-light);
            color: var(--primary-dark); font-size: 1em; font-weight: 700;
            cursor: pointer; font-family: inherit; transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-scan:active { transform: scale(0.96); }
        .btn-scan.scanning { border-color: var(--danger); background: var(--danger-light); color: var(--danger); }
        #qrReader {
            width: 100%; max-width: 350px; margin: 12px auto 0;
            border-radius: 12px; overflow: hidden; display: none;
        }
        #qrReader video { border-radius: 12px; }
        .qr-result {
            margin-top: 10px; padding: 10px 14px; border-radius: 10px;
            background: var(--success-light); border: 1px solid var(--success);
            font-weight: 600; font-size: 0.85em; color: var(--success);
            display: none;
        }

        /* ‚îÄ‚îÄ SESSION HISTORY ‚îÄ‚îÄ */
        .history-list {
            max-height: 250px; overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .history-card {
            padding: 10px 12px; border-radius: 10px;
            border: 1px solid var(--border); margin-bottom: 6px;
            background: var(--surface-2); font-size: 0.82em;
        }
        .history-card:first-child { border-color: var(--primary); background: var(--primary-light); }
        .history-card-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 4px;
        }
        .history-date { font-weight: 700; color: var(--muted); font-size: 0.9em; }
        .history-statut { font-size: 0.85em; font-weight: 700; }
        .history-detail { color: var(--muted); font-size: 0.9em; }
        .history-badges { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
        .history-badge {
            padding: 2px 6px; border-radius: 4px;
            background: var(--primary-light); color: var(--primary-dark);
            font-size: 0.75em; font-weight: 600;
        }
        .history-count {
            font-size: 0.75em; font-weight: 600; color: var(--muted);
            background: var(--bg); padding: 2px 8px; border-radius: 10px;
        }

        /* ‚îÄ‚îÄ COURSE NAV ‚îÄ‚îÄ */
        .course-nav {
            display: flex; align-items: center; gap: 8px;
            background: var(--card); border-radius: var(--radius); padding: 14px;
            margin-bottom: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .nav-arrow {
            width: 44px; height: 44px; border-radius: 50%;
            border: 2px solid var(--border); background: var(--surface-2);
            font-size: 1.2em; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            font-family: inherit; transition: all 0.15s;
            -webkit-tap-highlight-color: transparent; flex-shrink: 0;
        }
        .nav-arrow:active { transform: scale(0.92); background: var(--bg); }
        .nav-arrow:disabled { opacity: 0.3; cursor: not-allowed; }
        .nav-info { flex: 1; text-align: center; }
        .nav-time { font-size: 0.8em; color: var(--muted); font-weight: 600; }
        .nav-class { font-size: 0.95em; font-weight: 700; margin-top: 2px; }
        .nav-current { color: var(--primary-dark); }
        .nav-past { color: var(--muted); }
        .nav-counter { font-size: 0.72em; color: var(--muted); margin-top: 4px; }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast {
            position: fixed; bottom: 90px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success); color: white;
            padding: 14px 30px; border-radius: 14px;
            font-weight: 700; z-index: 1000; opacity: 0;
            transition: all 0.3s ease; font-size: 0.95em;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        @media (max-width: 400px) {
            body { padding: 10px; padding-bottom: 100px; }
            .card { padding: 16px; }
            .status-btn { padding: 16px 6px; }
            .status-btn .emoji { font-size: 1.6em; }
        }

        /* ‚îÄ‚îÄ MULTI-CHIP (remplace seance-btn) ‚îÄ‚îÄ */
        .chip { padding:9px 14px; border:2px solid var(--border); border-radius:22px; background:var(--surface-2); font-size:.8em; font-weight:700; cursor:pointer; font-family:inherit; transition:all .15s; color:var(--muted); -webkit-tap-highlight-color:transparent; white-space:nowrap; }
        .chip:active { transform:scale(.95); }
        .chip.selected { border-color:var(--primary); background:var(--primary-light); color:var(--primary-dark); }
        .chip.autre { border-style:dashed; }
        .chip.autre.selected { border-style:solid; border-color:#6366f1; background:#e0e7ff; color:#4338ca; }
        .chip-autre-input { width:100%; padding:10px 13px; border:2px solid #6366f1; border-radius:10px; font-size:.9em; font-family:inherit; margin-top:4px; margin-bottom:8px; color:var(--text); background:var(--surface-2); caret-color:#f1f5f9; display:none; }
        .chip-autre-input:focus { outline:none; border-color:var(--primary); }

        /* ‚îÄ‚îÄ HISTORIQUE TOP ‚îÄ‚îÄ */
        .history-compact { padding:11px 13px; border-radius:10px; border:1px solid var(--border); background:var(--surface-2); margin-bottom:7px; font-size:.82em; }
        .history-compact:first-child { border-color:var(--primary); background:var(--primary-light); }
        .history-compact-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:3px; }
        .history-compact-date { font-weight:800; color:var(--muted); }
        .history-compact-statut { font-weight:700; font-size:.9em; }
        .history-compact-detail { color:var(--muted); line-height:1.4; }

        /* ‚îÄ‚îÄ BANNERS (dark theme) ‚îÄ‚îÄ */
        .banner { padding:12px 14px; border-radius:11px; margin-bottom:8px; }
        .banner-warn { background:rgba(251,146,60,0.1); border:2px solid #fb923c; }
        .banner-info { background:rgba(96,165,250,0.1); border:2px solid #60a5fa; }
        .banner-situation { background:rgba(251,191,36,0.1); border:2px solid #fbbf24; }
        .banner-title { font-weight:800; font-size:.84em; margin-bottom:2px; }
        .banner-warn .banner-title { color:#fb923c; }
        .banner-info .banner-title { color:#60a5fa; }
        .banner-situation .banner-title { color:#fbbf24; }
        .banner-detail { font-size:.77em; }
        .banner-warn .banner-detail { color:#fdba74; }
        .banner-info .banner-detail { color:#93c5fd; }
        .banner-situation .banner-detail { color:#fcd34d; }

        /* ‚îÄ‚îÄ QUALIT√â √âTENDUE ‚îÄ‚îÄ */
        .quality-dim { margin-bottom:10px; }
        .quality-dim-title { font-size:.72em; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:5px; }
        .quality-chips { display:flex; flex-wrap:wrap; gap:6px; }
        .q-chip { padding:7px 12px; border:2px solid var(--border); border-radius:18px; background:var(--surface-2); font-size:.77em; font-weight:700; cursor:pointer; font-family:inherit; color:var(--muted); transition:all .15s; -webkit-tap-highlight-color:transparent; }
        .q-chip:active { transform:scale(.95); }
        .q-chip.selected { border-color:var(--primary); background:var(--primary-light); color:var(--primary-dark); }

        /* ‚îÄ‚îÄ M√âT√âO GLOBALE ‚îÄ‚îÄ */
        .meteo-grid { display:flex; gap:7px; margin-bottom:12px; }
        .meteo-btn { flex:1; padding:10px 4px; border:2px solid var(--border); border-radius:11px; background:var(--surface-2); cursor:pointer; text-align:center; font-family:inherit; transition:all .15s; -webkit-tap-highlight-color:transparent; }
        .meteo-btn:active { transform:scale(.95); }
        .meteo-btn .m-emoji { font-size:1.5em; display:block; margin-bottom:2px; }
        .meteo-btn .m-label { font-size:.58em; font-weight:700; color:var(--muted); line-height:1.2; }
        .meteo-btn.selected { border-color:var(--primary); background:var(--primary-light); }
        .meteo-btn.selected .m-label { color:var(--primary-dark); }

        /* ‚îÄ‚îÄ CPS MOTS-CLES ‚îÄ‚îÄ */
        .cps-mots { display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; margin-bottom:8px; }
        .cps-mot { padding:5px 10px; border:2px solid var(--border); border-radius:14px; background:var(--surface-2); font-size:.72em; font-weight:700; cursor:pointer; font-family:inherit; color:var(--muted); transition:all .14s; -webkit-tap-highlight-color:transparent; }
        .cps-mot.selected { border-color:#6366f1; background:#e0e7ff; color:#4338ca; }

        /* ‚îÄ‚îÄ STATUT LABEL ‚îÄ‚îÄ */
        .statut-info { font-size:.82em; color:var(--muted); padding:7px 11px; background:var(--bg); border-radius:8px; margin-bottom:10px; display:none; }
        .statut-info strong { color:var(--success); }

        /* ‚îÄ‚îÄ STUDENTS GRID ‚îÄ‚îÄ */
        .students-checklist { display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:9px; max-height:200px; overflow-y:auto; }
        .student-item { display:flex; align-items:center; gap:6px; padding:7px 9px; border:2px solid var(--border); border-radius:8px; background:var(--surface-2); cursor:pointer; font-size:.78em; font-weight:600; transition:all .12s; -webkit-tap-highlight-color:transparent; user-select:none; }
        .student-item.absent { border-color:var(--danger); background:var(--danger-light); color:var(--danger); }
        .student-item.sans-copie { border-color:var(--warning); background:var(--warning-light); color:#92400e; }
        .student-item.absent.sans-copie { border-color:var(--danger); background:linear-gradient(135deg, var(--danger-light), var(--warning-light)); }
        .student-item.no-cours { border-color:var(--warning); background:var(--warning-light); color:#92400e; }
        .student-item .student-badges { display:flex; gap:3px; margin-left:auto; font-size:.75em; }
        .student-item .badge-abs { display:none; color:var(--danger); }
        .student-item .badge-sc { display:none; color:var(--warning); }
        .student-item.absent .badge-abs { display:inline; }
        .student-item.sans-copie .badge-sc { display:inline; }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <div class="login-icon">üìù</div>
        <h2>Saisie Progression</h2>
        <p>Connectez-vous pour continuer</p>
        <button class="btn-google" id="btnGoogle">Connexion Google</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FORM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="formScreen" style="display:none;">
<div class="container">

    <a href="index.html" class="back-link">‚Üê Accueil</a>

    <div class="page-header">
        <h1>üìù Saisie rapide</h1>
        <div class="room-badge" id="roomBadge" style="display:none;">Salle <span id="roomNum"></span></div>
    </div>
    <div class="date-display" id="dateJour"></div>

    <!-- PLANIFICATION FUTURE -->
    <div class="module-suivant-toggle" id="planifToggle" style="margin-bottom:10px;">
        <span id="planifIcon">‚òê</span>
        <span>üìÖ Planifier (date future / CCF / √©v√©nement)</span>
    </div>
    <div id="planifSection" style="display:none; margin-bottom:14px;">
        <div style="padding:12px; border-radius:10px; background:var(--bg); border:1px solid var(--border);">
            <label class="field-label">Date cible</label>
            <input type="date" id="planifDate" style="width:100%; padding:12px; border:2px solid var(--border); border-radius:12px; font-size:1em; font-family:inherit; margin-bottom:10px; background:var(--surface-2); color:var(--text);">
            <label class="field-label">Type</label>
            <div class="chip-grid">
                <button class="chip" onclick="selectPlanifType('CCF', this)">CCF</button>
                <button class="chip" onclick="selectPlanifType('R√©union', this)">R√©union</button>
                <button class="chip" onclick="selectPlanifType('√âv√©nement', this)">√âv√©nement</button>
                <button class="chip" onclick="selectPlanifType('Rattrapage', this)">Rattrapage</button>
            </div>
        </div>
    </div>

    <!-- QR SCANNER -->
    <div class="qr-scanner-card">
        <button class="btn-scan" id="btnScan" onclick="toggleQrScanner()">üì∑ Scanner un QR code</button>
        <div id="qrReader"></div>
        <div class="qr-result" id="qrResult"></div>
    </div>

    <!-- COURSE NAV ‚Äî navigation entre les cours du jour -->
    <div class="course-nav" id="courseNav" style="display:none;">
        <button class="nav-arrow" id="navPrev" onclick="navigateCourse(-1)">‚óÄ</button>
        <div class="nav-info">
            <div class="nav-time" id="navTime"></div>
            <div class="nav-class" id="navClass"></div>
            <div class="nav-counter" id="navCounter"></div>
        </div>
        <button class="nav-arrow" id="navNext" onclick="navigateCourse(1)">‚ñ∂</button>
    </div>

    <!-- MISSED CLASSES REMINDER -->
    <div id="missedReminder" style="display:none;"></div>

    <!-- PRONOTE + TODO REMINDERS -->
    <div id="pronoteReminder" style="display:none;"></div>

    <!-- LAST LOG -->
    <div class="last-log" id="lastLogInfo" style="display:none;"></div>

    <!-- SESSION HISTORY -->
    <div id="sessionHistory" style="display:none;">
        <div class="card">
            <div class="card-title">üìã Historique <span class="history-count" id="historyCount"></span></div>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>

    <!-- SITUATION AUTO -->
    <div id="situationAutoCard" style="display:none;"></div>

    <!-- HISTORIQUE + RAPPELS (en haut) -->
    <div id="historyTopCard" style="display:none;">
        <div class="card">
            <div class="card-title">üìã Derni√®re s√©ance <span style="background:var(--primary-light);color:var(--primary-dark);padding:2px 9px;border-radius:20px;font-size:.75em;font-weight:700;" id="historyClasseLabel"></span></div>
            <div id="lastLogBannerNew"></div>
            <div id="remindersBannerNew"></div>
            <div id="historyShortListNew"></div>
            <button id="historyToggleBtnNew" onclick="toggleFullHistoryNew()" style="background:none;border:none;color:var(--muted);font-size:.78em;font-weight:700;cursor:pointer;padding:4px 0;font-family:inherit;display:none;">‚ñº Voir tout l'historique</button>
            <div id="historyFullListNew" style="display:none;margin-top:8px;"></div>
        </div>
    </div>

    <!-- CARD 1: S√âANCE -->
    <div class="card">
        <div class="card-title">üìö S√©ance</div>

        <label class="field-label">Classe</label>
        <select id="selectClasse">
            <option value="">-- S√©lectionner --</option>
        </select>

        <label class="field-label">Module</label>
        <select id="selectModule">
            <option value="">-- S√©lectionner --</option>
        </select>

        <div class="toggle-row" id="moduleAutreToggle" style="margin-top:-4px;margin-bottom:10px;">
            <span id="moduleAutreIcon">‚òê</span>
            <span>Module non list√© ‚Äî saisir manuellement</span>
        </div>
        <input type="text" id="moduleAutreInput" class="chip-autre-input" placeholder="D√©crire le module..." style="display:none;">

        <label class="field-label">Phase(s) ‚Äî plusieurs choix possibles</label>
        <div class="chip-grid" id="phaseGrid"></div>
        <input type="text" id="phaseAutreInput" class="chip-autre-input" placeholder="Autre phase...">

        <div class="module-suivant-toggle" id="moduleSuivantToggle">
            <span id="moduleSuivantIcon">‚òê</span>
            <span>+ Module suivant (m√™me s√©ance)</span>
        </div>
        <div id="moduleSuivantSection" style="display:none;">
            <label class="field-label">Module suivant</label>
            <select id="selectModuleSuivant">
                <option value="">-- S√©lectionner --</option>
            </select>
            <label class="field-label">Phase</label>
            <div class="phase-grid" id="phaseSuivantGrid"></div>
        </div>

        <label class="field-label">S√©ance(s) ‚Äî plusieurs choix possibles</label>
        <div class="chip-grid" id="seanceGrid"></div>
        <input type="text" id="seanceAutreInput" class="chip-autre-input" placeholder="Autre s√©ance...">
    </div>

    <!-- CARD 2: STATUT -->
    <div class="card">
        <div class="card-title">üìå Statut</div>
        <div class="status-grid">
            <button class="status-btn s-realise" onclick="selectStatut('R√©alis√©', this)">
                <span class="emoji">‚úÖ</span><span class="label">R√©alis√©</span>
            </button>
            <button class="status-btn s-prevu" onclick="selectStatut('Pr√©vu', this)">
                <span class="emoji">üìã</span><span class="label">Pr√©vu</span>
            </button>
            <button class="status-btn s-reporte" onclick="selectStatut('Report√©', this)">
                <span class="emoji">üîÑ</span><span class="label">Report√©</span>
            </button>
            <button class="status-btn s-non_realise" onclick="selectStatut('Non r√©alis√©', this)">
                <span class="emoji">‚ùå</span><span class="label">Non r√©alis√©</span>
            </button>
        </div>

        <!-- VALID√â TOGGLE -->
        <div class="valide-toggle" id="valideToggle" onclick="toggleValide()">
            <span class="toggle-check" id="valideIcon">‚òê</span>
            <span class="toggle-text">Marquer comme valid√©</span>
        </div>

        <label class="field-label">Arr√™t pr√©cis (o√π on en est)</label>
        <input type="text" id="inputArret" placeholder="ex: exercice 3 question 2">

        <label class="field-label">Situation particuli√®re</label>
        <div class="chip-grid">
            <button class="chip" onclick="toggleSituation('Annul√©', this)">Annul√©</button>
            <button class="chip" onclick="toggleSituation('Sortie scolaire', this)">Sortie</button>
            <button class="chip" onclick="toggleSituation('Jours f√©ri√©s', this)">F√©ri√©</button>
            <button class="chip" onclick="toggleSituation('PFMP', this)">PFMP</button>
            <button class="chip" onclick="toggleSituation('Parcours Y', this)">Parcours Y</button>
            <button class="chip" onclick="toggleSituation('CCF', this)">CCF</button>
            <button class="chip" onclick="toggleSituation('BAC BLANC', this)">BAC BLANC</button>
            <button class="chip" onclick="toggleSituation('Epreuv.Pr√©pa.BAC', this)">√âpreuves BAC</button>
            <button class="chip" onclick="toggleSituation('Absence administrative', this)">Abs. admin</button>
            <button class="chip" onclick="toggleSituation('Formation', this)">Formation</button>
            <button class="chip" onclick="toggleSituation('Absence personnel', this)">Abs. perso</button>
            <button class="chip" onclick="toggleSituation('Autres', this)">Autres</button>
        </div>
    </div>

    <!-- CARD 3: DISTRIBUTION + √âVALUATIONS -->
    <div class="card">
        <div class="card-title">üìÑ Distribution et √©valuations</div>
        <div class="checklist-grid" id="checklistGrid"></div>
    </div>

    <!-- CARD 3b: TYPE D'√âVALUATION -->
    <div class="card">
        <div class="card-title">üîç Type d'√©valuation</div>
        <label class="field-label">√âvaluation diagnostique</label>
        <div class="chip-grid" id="evalDiagGrid">
            <button class="chip" onclick="toggleEvalDiag('Quiz', this)">Quiz</button>
            <button class="chip" onclick="toggleEvalDiag('QCM', this)">QCM</button>
            <button class="chip" onclick="toggleEvalDiag('Brainstorming / Nuage de mots', this)">Brainstorming</button>
            <button class="chip" onclick="toggleEvalDiag('Oral / Tour de table', this)">Oral</button>
            <button class="chip" onclick="toggleEvalDiag('Carte mentale', this)">Carte mentale</button>
            <button class="chip" onclick="toggleEvalDiag('Vrai/Faux', this)">Vrai/Faux</button>
            <button class="chip" onclick="toggleEvalDiag('Auto-positionnement', this)">Auto-√©val</button>
            <button class="chip" onclick="toggleEvalDiag('Questionnaire', this)">Questionnaire</button>
            <button class="chip" onclick="toggleEvalDiag('Exercice mapse.fr', this)">mapse.fr</button>
            <button class="chip" onclick="toggleEvalDiag('En ligne', this)">üåê En ligne</button>
        </div>
        <label class="field-label" style="margin-top:10px;">√âvaluation formative</label>
        <div class="chip-grid" id="evalFormGrid">
            <button class="chip" onclick="toggleEvalForm('Quiz', this)">Quiz</button>
            <button class="chip" onclick="toggleEvalForm('QCM', this)">QCM</button>
            <button class="chip" onclick="toggleEvalForm('Questionnaire', this)">Questionnaire</button>
            <button class="chip" onclick="toggleEvalForm('Exercice mapse.fr', this)">mapse.fr</button>
            <button class="chip" onclick="toggleEvalForm('Oral / Tour de table', this)">Oral</button>
            <button class="chip" onclick="toggleEvalForm('Carte mentale', this)">Carte mentale</button>
            <button class="chip" onclick="toggleEvalForm('En ligne', this)">üåê En ligne</button>
        </div>
        <label class="field-label" style="margin-top:10px;">√âvaluation sommative / certificative</label>
        <div class="chip-grid" id="evalSommGrid">
            <button class="chip" onclick="toggleEvalSomm('√âvaluation sommative', this)">Sommative</button>
            <button class="chip" onclick="toggleEvalSomm('CCF', this)">CCF</button>
            <button class="chip" onclick="toggleEvalSomm('En ligne', this)">üåê En ligne</button>
        </div>
    </div>

    <!-- CARD 4: CLASSE & √âL√àVES -->
    <div class="card">
        <div class="card-title">üë• Classe ‚Äî Liste des √©l√®ves</div>

        <!-- STUDENT ROSTER - visible quand classe s√©lectionn√©e -->
        <div id="studentRosterSection" style="display:none; margin-bottom:14px;">
            <div style="font-size:.72em; color:var(--muted); margin-bottom:8px; font-weight:600;">
                Cliquer = <span style="color:var(--danger);">Absent</span> ¬∑ Double-cliquer = <span style="color:var(--warning);">Sans copie</span>
            </div>
            <div id="studentRosterGrid" class="students-checklist" style="max-height:300px;"></div>
            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                <div style="font-size:.72em; color:var(--muted); display:flex; align-items:center; gap:4px;">
                    <span style="width:10px;height:10px;border-radius:3px;background:var(--danger-light);border:1px solid var(--danger);display:inline-block;"></span> Absent
                </div>
                <div style="font-size:.72em; color:var(--muted); display:flex; align-items:center; gap:4px;">
                    <span style="width:10px;height:10px;border-radius:3px;background:var(--warning-light);border:1px solid var(--warning);display:inline-block;"></span> Sans copie
                </div>
                <span id="rosterAbsCount" style="font-size:.72em; font-weight:700; color:var(--danger); margin-left:auto;"></span>
                <span id="rosterSansCopieCount" style="font-size:.72em; font-weight:700; color:var(--warning);"></span>
            </div>
        </div>
        <div id="studentRosterEmpty" style="display:none; margin-bottom:14px;">
            <div style="font-size:.78em; color:var(--muted); padding:12px; background:var(--bg); border-radius:10px; border:1px dashed var(--border); text-align:center;">
                Aucune liste √©l√®ve charg√©e.<br>
                <span style="font-size:.9em;">Importez vos CSV √©l√®ves depuis le <a href="dashboard.html" style="color:var(--primary);font-weight:700;">Dashboard</a></span>
            </div>
        </div>

        <label class="field-label">Absences</label>
        <div class="stepper" id="absStepper">
            <button class="stepper-btn" onclick="changeAbs(-1)">‚àí</button>
            <span class="stepper-value" id="absCount">0</span>
            <button class="stepper-btn" onclick="changeAbs(1)">+</button>
        </div>
        <div id="absChipsContainer" style="display:none; margin-bottom:10px;">
            <div style="font-size:.72em; color:var(--muted); margin-bottom:6px; font-weight:600;">Cliquer pour marquer absent :</div>
            <div id="absChipsGrid" class="students-checklist"></div>
        </div>
        <div id="absNoList" style="display:none;">
        </div>
        <input type="text" id="absencesNoms" placeholder="Noms des absents (optionnel)" style="margin-bottom:10px;">
        <div id="elevesSansCours" style="display:none; margin-bottom:14px;">
            <div style="font-size:.72em; color:var(--warning); margin-bottom:6px; font-weight:700; text-transform:uppercase; letter-spacing:.5px;">‚ö†Ô∏è √âl√®ves sans cours (absents ce jour)</div>
            <div id="elevesSansCoursGrid" class="students-checklist"></div>
        </div>

        <label class="field-label">Qualit√© de la s√©ance</label>
        <div class="quality-dim">
            <div class="quality-dim-title">Engagement des √©l√®ves</div>
            <div class="quality-chips">
                <button class="q-chip" onclick="toggleQualityDim('engagement','tres_actifs',this)">üôã Tr√®s actifs</button>
                <button class="q-chip" onclick="toggleQualityDim('engagement','actifs',this)">üëç Actifs</button>
                <button class="q-chip" onclick="toggleQualityDim('engagement','passifs',this)">üòê Passifs</button>
                <button class="q-chip" onclick="toggleQualityDim('engagement','difficile',this)">üò§ Difficile</button>
            </div>
        </div>
        <div class="quality-dim">
            <div class="quality-dim-title">Ambiance</div>
            <div class="quality-chips">
                <button class="q-chip" onclick="toggleQualityDim('ambiance','excellente',this)">üåü Excellente</button>
                <button class="q-chip" onclick="toggleQualityDim('ambiance','bonne',this)">üòä Bonne</button>
                <button class="q-chip" onclick="toggleQualityDim('ambiance','tendue',this)">üò¨ Tendue</button>
                <button class="q-chip" onclick="toggleQualityDim('ambiance','agitee',this)">üå™ Agit√©e</button>
            </div>
        </div>
        <div class="quality-dim">
            <div class="quality-dim-title">Rythme & Compr√©hension</div>
            <div class="quality-chips">
                <button class="q-chip" onclick="toggleQualityDim('rythme','fluide',this)">üèÑ Fluide</button>
                <button class="q-chip" onclick="toggleQualityDim('rythme','adapte',this)">‚öñÔ∏è Adapt√©</button>
                <button class="q-chip" onclick="toggleQualityDim('rythme','lent',this)">üê¢ Lent</button>
                <button class="q-chip" onclick="toggleQualityDim('comprehension','bonne',this)">üí° Bien compris</button>
                <button class="q-chip" onclick="toggleQualityDim('comprehension','partielle',this)">ü§î Partiel</button>
                <button class="q-chip" onclick="toggleQualityDim('comprehension','difficile',this)">üòµ Difficile</button>
            </div>
        </div>
    </div>

    <!-- CARD 5: NOTES + PR√âVOIR -->
    <div class="card">
        <div class="card-title">üí¨ Notes</div>
        <label class="field-label">Remarque (optionnel)</label>
        <textarea id="remarque" placeholder="Note libre..."></textarea>

        <label class="field-label">Pr√©voir pour la prochaine s√©ance</label>
        <div class="chip-grid" id="todoGrid"></div>
        <input type="text" id="todoNote" placeholder="Note libre compl√©mentaire...">
    </div>

    <!-- CARD 6: CPS + M√âT√âO -->
    <div class="card">
        <div class="card-title">üß† Mon ressenti ‚Äî M√©t√©o de la s√©ance</div>

        <label class="field-label">M√©t√©o globale</label>
        <div class="meteo-grid">
            <button class="meteo-btn" onclick="selectMeteo('‚õà','Tr√®s difficile',this)"><span class="m-emoji">‚õà</span><span class="m-label">Tr√®s difficile</span></button>
            <button class="meteo-btn" onclick="selectMeteo('üåß','Difficile',this)"><span class="m-emoji">üåß</span><span class="m-label">Difficile</span></button>
            <button class="meteo-btn" onclick="selectMeteo('‚õÖ','Mitig√©',this)"><span class="m-emoji">‚õÖ</span><span class="m-label">Mitig√©</span></button>
            <button class="meteo-btn" onclick="selectMeteo('üå§','Bien',this)"><span class="m-emoji">üå§</span><span class="m-label">Bien</span></button>
            <button class="meteo-btn" onclick="selectMeteo('‚òÄÔ∏è','Excellent',this)"><span class="m-emoji">‚òÄÔ∏è</span><span class="m-label">Excellent</span></button>
        </div>

        <label class="field-label" style="margin-top:4px;">üß© Cognitif</label>
        <div class="cps-btns" id="cpsCognitif">
            <button class="cps-btn" onclick="selectCps('cognitif','1',this)">üò©</button>
            <button class="cps-btn" onclick="selectCps('cognitif','2',this)">üòî</button>
            <button class="cps-btn" onclick="selectCps('cognitif','3',this)">üòê</button>
            <button class="cps-btn" onclick="selectCps('cognitif','4',this)">üôÇ</button>
            <button class="cps-btn" onclick="selectCps('cognitif','5',this)">ü§©</button>
        </div>
        <div class="cps-mots" id="cpsCognitifMots">
            <button class="cps-mot" onclick="toggleCpsMot('cognitif','Stimulant',this)">Stimulant</button>
            <button class="cps-mot" onclick="toggleCpsMot('cognitif','Fluide',this)">Fluide</button>
            <button class="cps-mot" onclick="toggleCpsMot('cognitif','Fatigant',this)">Fatigant</button>
            <button class="cps-mot" onclick="toggleCpsMot('cognitif','Trop charg√©',this)">Trop charg√©</button>
            <button class="cps-mot" onclick="toggleCpsMot('cognitif','Bien pr√©par√©',this)">Bien pr√©par√©</button>
            <button class="cps-mot" onclick="toggleCpsMot('cognitif','Improvisation',this)">Improvisation</button>
        </div>

        <label class="field-label" style="margin-top:8px;">üíõ √âmotionnel</label>
        <div class="cps-btns" id="cpsEmotionnel">
            <button class="cps-btn" onclick="selectCps('emotionnel','1',this)">üò©</button>
            <button class="cps-btn" onclick="selectCps('emotionnel','2',this)">üòî</button>
            <button class="cps-btn" onclick="selectCps('emotionnel','3',this)">üòê</button>
            <button class="cps-btn" onclick="selectCps('emotionnel','4',this)">üôÇ</button>
            <button class="cps-btn" onclick="selectCps('emotionnel','5',this)">ü§©</button>
        </div>
        <div class="cps-mots" id="cpsEmotionnelMots">
            <button class="cps-mot" onclick="toggleCpsMot('emotionnel','Serein',this)">Serein</button>
            <button class="cps-mot" onclick="toggleCpsMot('emotionnel','Enthousiaste',this)">Enthousiaste</button>
            <button class="cps-mot" onclick="toggleCpsMot('emotionnel','Tendu',this)">Tendu</button>
            <button class="cps-mot" onclick="toggleCpsMot('emotionnel','√âpuis√©',this)">√âpuis√©</button>
            <button class="cps-mot" onclick="toggleCpsMot('emotionnel','Satisfait',this)">Satisfait</button>
            <button class="cps-mot" onclick="toggleCpsMot('emotionnel','Stress√©',this)">Stress√©</button>
            <button class="cps-mot" onclick="toggleCpsMot('emotionnel','Motiv√©',this)">Motiv√©</button>
            <button class="cps-mot" onclick="toggleCpsMot('emotionnel','Frustr√©',this)">Frustr√©</button>
        </div>

        <label class="field-label" style="margin-top:8px;">ü§ù Social</label>
        <div class="cps-btns" id="cpsSocial">
            <button class="cps-btn" onclick="selectCps('social','1',this)">üò©</button>
            <button class="cps-btn" onclick="selectCps('social','2',this)">üòî</button>
            <button class="cps-btn" onclick="selectCps('social','3',this)">üòê</button>
            <button class="cps-btn" onclick="selectCps('social','4',this)">üôÇ</button>
            <button class="cps-btn" onclick="selectCps('social','5',this)">ü§©</button>
        </div>
        <div class="cps-mots" id="cpsSocialMots">
            <button class="cps-mot" onclick="toggleCpsMot('social','Bonne coh√©sion',this)">Bonne coh√©sion</button>
            <button class="cps-mot" onclick="toggleCpsMot('social','√âchanges riches',this)">√âchanges riches</button>
            <button class="cps-mot" onclick="toggleCpsMot('social','Conflits',this)">Conflits</button>
            <button class="cps-mot" onclick="toggleCpsMot('social','Entraide',this)">Entraide</button>
            <button class="cps-mot" onclick="toggleCpsMot('social','In√©galit√©s',this)">In√©galit√©s</button>
            <button class="cps-mot" onclick="toggleCpsMot('social','Solidaire',this)">Solidaire</button>
        </div>
    </div>

</div>
</div>

<!-- SAVE BAR -->
<div class="save-bar" id="saveBar" style="display:none;">
    <button class="btn-save" id="btnSave">üíæ ENREGISTRER</button>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
        getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot,
        collection, query, orderBy, limit, serverTimestamp, where
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import {
        getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect,
        getRedirectResult, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IMPORTS UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    import {
        FIREBASE_CONFIG, MODULES_PSE, CLASSES_CONFIG, THEME_LABELS, CHECKLIST as CHECKLIST_ITEMS_UTILS,
        CLASS_ALIAS_GROUPS as CAG_UTILS, EDT, VACANCES, FERIES, PFMP,
        normalizeClass as normalizeClassUtil, classesMatch as classesMatchUtil,
        detectClassGroup as detectClassGroupUtil, getSemaineType, coursSePasse,
        getLundi, formatDateISO, formatDateCourt, isVacances, isFerie, isPFMP,
        getCoursForDay, cleanModuleName, SEANCES as SEANCES_UTILS,
        STUDENTS_STORAGE_KEY, getModulesForClasse, getNiveauForClasse
    } from './assets/utils.js';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const app = initializeApp(FIREBASE_CONFIG);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentUser = null;
    let absences = 0;
    let selectedStatut = '';
    let selectedQualite = '';
    let selectedSeance = '';
    let selectedSituation = '';
    let checklist = {};
    let selectedTodo = null; // { action, label, reminderPronote, reminderType }
    let allPrevue = [];
    let studentsCache = [];
    const STUDENTS_DOC_REF = ['progression_config', 'students_roster'];

    const params = new URLSearchParams(window.location.search);
    const room = params.get('room') || '';
    const paramDate = params.get('date') || '';  // YYYY-MM-DD from index.html
    const paramClasse = params.get('classe') || '';  // class ID from index.html
    const quickMode = params.get('quick') === '1';

    // Par d√©faut, l'app d√©marre sur l'accueil (index.html).
    // On reste sur saisie rapide uniquement si on a un contexte explicite.
    if (!room && !paramDate && !paramClasse && !quickMode) {
        window.location.replace('index.html');
    }

    function getContextDateISO() {
        return paramDate || formatDateISO(new Date());
    }

    function getContextDateObject() {
        var iso = getContextDateISO();
        var d = parseLocalDate(iso) || new Date();
        if (Number.isNaN(d.getTime())) d = new Date();
        return d;
    }

    function parseLocalDate(value) {
        if (!value) return null;
        if (value instanceof Date) return new Date(value.getFullYear(), value.getMonth(), value.getDate(), 12, 0, 0, 0);
        var str = String(value).trim();
        var fr = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (fr) return new Date(parseInt(fr[3]), parseInt(fr[2]) - 1, parseInt(fr[1]), 12, 0, 0, 0);
        var iso = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})(?:$|T)/);
        if (iso) return new Date(parseInt(iso[1]), parseInt(iso[2]) - 1, parseInt(iso[3]), 12, 0, 0, 0);
        var d = new Date(str);
        if (Number.isNaN(d.getTime())) return null;
        return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0, 0);
    }

    function toISODateLocal(date) {
        var d = new Date(date);
        return d.getFullYear() + '-' +
            String(d.getMonth() + 1).padStart(2, '0') + '-' +
            String(d.getDate()).padStart(2, '0');
    }

    function readStudentsFromLocal() {
        try {
            var raw = localStorage.getItem(STUDENTS_STORAGE_KEY);
            var parsed = raw ? JSON.parse(raw) : [];
            return Array.isArray(parsed) ? parsed : [];
        } catch (_) {
            return [];
        }
    }

    async function hydrateStudentsCache() {
        var local = readStudentsFromLocal();
        if (local.length > 0) {
            studentsCache = local;
            return;
        }
        try {
            var snap = await getDoc(doc(db, STUDENTS_DOC_REF[0], STUDENTS_DOC_REF[1]));
            if (!snap.exists()) return;
            var data = snap.data() || {};
            var cloudStudents = Array.isArray(data.students) ? data.students : [];
            if (!cloudStudents.length) return;
            studentsCache = cloudStudents;
            localStorage.setItem(STUDENTS_STORAGE_KEY, JSON.stringify(cloudStudents));
        } catch (err) {
            console.warn('Students cloud fetch error:', err);
        }
    }

    function getMondayLocal(date) {
        var d = parseLocalDate(date) || new Date(date);
        if (Number.isNaN(d.getTime())) return null;
        var day = d.getDay();
        var diff = d.getDate() - day + (day === 0 ? -6 : 1);
        var monday = new Date(d);
        monday.setDate(diff);
        monday.setHours(12, 0, 0, 0);
        return monday;
    }

    function sameWeekLocal(a, b) {
        var ma = getMondayLocal(a);
        var mb = getMondayLocal(b);
        if (!ma || !mb) return false;
        return ma.getTime() === mb.getTime();
    }

    // Checklist items
    const CHECKLIST = [
        { key: 'eval_diagnostique', label: '√âval diagnostique', icon: 'üîç' },
        { key: 'cours_complet', label: 'Cours complet distribu√©', icon: 'üìÑ' },
        { key: 'cours_seance', label: 'Cours s√©ance seule', icon: 'üìÉ' },
        { key: 'docs_distribues', label: 'Docs distribu√©s', icon: 'üìã' },
        { key: 'devoir_donne', label: 'Devoir donn√©', icon: 'üìù' },
        { key: 'copies_ramassees', label: 'Copies ramass√©es', icon: 'üì•' },
        { key: 'copies_corrigees', label: 'Copies corrig√©es', icon: '‚úèÔ∏è' },
        { key: 'copies_rendues', label: 'Copies rendues', icon: 'üì§' },
        { key: 'auto_eval_ligne', label: 'Auto-√©val en ligne', icon: 'üíª' },
        { key: 'exercice_en_ligne', label: 'Exercice en ligne', icon: 'üåê' },
        { key: 'eval_formative', label: '√âval formative', icon: 'üìä' },
        { key: 'eval_sommative', label: '√âval sommative', icon: 'üìù' },
        { key: 'eval_corrigee', label: '√âval corrig√©e', icon: '‚úÖ' },
        { key: 'eval_rendue', label: '√âval rendue', icon: 'üì§' }
    ];

    // CPS state
    let cps = { cognitif: '', emotionnel: '', social: '' };
    let isValide = false;
    let selectedEvalDiag = '';
    // Planification future
    let planifEnabled = false;
    let planifType = '';
    let selectedEvalForm = '';
    let selectedEvalSomm = '';

    // S√©ance options (local list used by UI dropdowns ‚Äî SEANCES_UTILS imported from utils.js is the compact version)
    const SEANCES = ['S√©ance 1', 'S√©ance 1-2', 'S√©ance 2', 'S√©ance 2-3', 'S√©ance 3', 'S√©ance 3-4', 'S√©ance 4', 'S√©ance 4-5', 'S√©ance 5', 'S√©ance 6', '√âvaluation', 'Correction', 'Corr.+s√©ance 1'];

    // CLASSES_CONFIG, MODULES_PSE, THEME_LABELS ‚Üí imported from utils.js (no redeclaration)

    // MODULES_PSE, THEME_LABELS ‚Üí imported from utils.js
    // EDT ‚Üí imported from utils.js, alias for legacy code
    let EMPLOI_DU_TEMPS = EDT.map(function(c) {
        return { jour: c.jour, heure: c.heure, classe: c.classe, salle: c.salle || '', note: c.note || '' };
    });

    // Try to load Pronote EDT from Firestore for smarter auto-detect
    let pronoteEvents = [];

    // Course navigation state
    let todayCourses = [];
    let courseNavIndex = -1;

    // History state (for smart checklist)
    let currentClassLogs = [];

    // Phase & module suivant state
    let selectedPhase = 'cours';
    let moduleSuivantEnabled = false;
    let selectedModuleSuivant = '';
    let selectedPhaseSuivant = 'cours';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('formScreen').style.display = 'block';
            document.getElementById('saveBar').style.display = 'block';
            initForm();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('formScreen').style.display = 'none';
            document.getElementById('saveBar').style.display = 'none';
        }
    });

    document.getElementById('btnGoogle').addEventListener('click', async () => {
        try { await signInWithPopup(auth, googleProvider); }
        catch (e) {
            if (e.code === 'auth/popup-blocked') await signInWithRedirect(auth, googleProvider);
            else alert('Erreur: ' + e.message);
        }
    });
    getRedirectResult(auth).catch(e => {});

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT FORM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function initForm() {
        // Date ‚Äî use paramDate if provided (from index.html click)
        var now = parseLocalDate(paramDate) || new Date();
        var displayDate = now.toLocaleDateString('fr-FR', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
        });
        // Show semaine A/B badge
        var semType = getSemaineType(now);
        document.getElementById('dateJour').innerHTML = displayDate +
            ' <span style="display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;' +
            (semType === 'SA' ? 'background:rgba(99,102,241,0.2);color:#818cf8;">' : 'background:rgba(16,185,129,0.2);color:#34d399;">') +
            semType + '</span>';

        // Room
        if (room) {
            document.getElementById('roomBadge').style.display = 'block';
            document.getElementById('roomNum').textContent = room;
        }

        // Load progressions from Firestore (real-time)
        var select = document.getElementById('selectClasse');
        await new Promise(function(resolve) {
            onSnapshot(collection(db, 'progression_prevue'), function(snap) {
                allPrevue = [];
                snap.forEach(function(d) { allPrevue.push({ id: d.id, ...d.data() }); });
                allPrevue.sort(function(a, b) { return a.classeId.localeCompare(b.classeId); });
                // Rebuild classe dropdown
                var currentVal = select.value;
                select.innerHTML = '<option value="">-- S√©lectionner --</option>';
                allPrevue.forEach(function(p) {
                    var opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.classeId;
                    opt.dataset.niveau = p.niveau;
                    select.appendChild(opt);
                });
                if (currentVal) select.value = currentVal;
                resolve();
            }, function(e) { console.error('Load prevue error:', e); resolve(); });
        });

        // Load Pronote events from Firestore
        try {
            var edtDoc = await getDoc(doc(db, 'progression_config', 'emploi_du_temps'));
            if (edtDoc.exists()) {
                pronoteEvents = edtDoc.data().events || [];
            }
        } catch (e) { console.error('Load EDT error:', e); }

        // Load students cache (local first, cloud fallback)
        await hydrateStudentsCache();

        // ‚îÄ‚îÄ AUTO-DETECT CLASS ‚îÄ‚îÄ
        var todayStr = paramDate || toISODateLocal(now);
        // If paramClasse is provided (from index.html), use it directly
        var detection;
        if (paramClasse) {
            detection = { classe: paramClasse, location: '', source: 'url_param' };
            var selectedFromParam = selectClasseFromDetected(paramClasse);
            if (!selectedFromParam) {
                console.warn('Classe URL non trouv√©e dans progression_prevue:', paramClasse);
                showToast('‚ö†Ô∏è Classe non trouv√©e : s√©lectionnez-la manuellement');
            }
        } else {
            detection = detectCurrentClass(room);
        }

        // ‚îÄ‚îÄ BUILD COURSE NAVIGATION (fl√®ches gauche/droite) ‚îÄ‚îÄ
        buildCourseNav();

        // ‚îÄ‚îÄ AUTO-DETECT RESULT: hide QR scanner if class found on page load ‚îÄ‚îÄ
        if (detection.classe) {
            var qrCard = document.querySelector('.qr-scanner-card');
            var qrResult = document.getElementById('qrResult');
            // Hide scan button, show compact success
            document.getElementById('btnScan').style.display = 'none';
            qrResult.style.display = 'block';
            var detMsg = '‚úÖ ' + detection.classe;
            if (detection.location) detMsg += ' ‚Äî Salle ' + detection.location;
            qrResult.textContent = detMsg;
            qrResult.style.background = 'rgba(16,185,129,0.15)';
            qrResult.style.borderColor = '#16a34a';
            qrResult.style.color = '#166534';
        }

        // ‚îÄ‚îÄ CHECK FOR MISSED CLASSES (s√©ances oubli√©es) ‚îÄ‚îÄ
        await checkMissedClasses(todayStr, now);

        // Build checklist
        buildChecklist();
        // Build seance picker
        buildSeancePicker();
        // Build todo grid
        buildTodoGrid();
        // Init phase & module suivant & planification
        buildPhaseSelector('phaseGrid', true);
        initModuleSuivantToggle();
        initPlanifToggle();
        initModuleAutreToggle();

        // Bind classe change
        select.addEventListener('change', onClasseChange);

        // Bind save
        document.getElementById('btnSave').addEventListener('click', saveLog);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLASS MATCHING (Pronote aliases -> Cockpit classes) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const CLASS_ALIAS_GROUPS = {
        CAP_VAN: ['CPSE1', 'CAPVAN', 'C1VAN', 'C2VAN', 'C1VANC2VAN'],
        PREMIERE_AGORA: ['BPSE2', '1AGORA', '1EREAGORA', 'PREMIEREAGORA', 'B1AGO', 'B1AGORA', 'B1AGO1', 'B1AGO2'],
        TERMINALE_AGORA: ['TAGORA', 'BTAGO', 'BTAGORA', 'BTAGO1', 'BTAGO2'],
        B2_AGORA: ['B2GATL1', 'B2GATL2', 'B2AGO', 'B2AGORA']
    };

    function normalizeClassKey(v) {
        return (v || '')
            .toString()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toUpperCase()
            .replace(/[^A-Z0-9]/g, '');
    }

    function detectClassGroup(rawClass) {
        var norm = normalizeClassKey(rawClass);
        if (!norm) return '';
        var groups = Object.keys(CLASS_ALIAS_GROUPS);
        for (var i = 0; i < groups.length; i++) {
            var g = groups[i];
            var aliases = CLASS_ALIAS_GROUPS[g];
            for (var j = 0; j < aliases.length; j++) {
                var aliasNorm = normalizeClassKey(aliases[j]);
                if (!aliasNorm) continue;
                if (norm === aliasNorm || norm.includes(aliasNorm) || aliasNorm.includes(norm)) {
                    return g;
                }
            }
        }
        return '';
    }

    function classesMatch(a, b) {
        var na = normalizeClassKey(a);
        var nb = normalizeClassKey(b);
        if (!na || !nb) return false;
        if (na === nb) return true;
        if (na.includes(nb) || nb.includes(na)) return true;

        var ga = detectClassGroup(na);
        var gb = detectClassGroup(nb);
        if (ga && gb && ga === gb) return true;

        return false;
    }

    function findBestClasseOptionIndex(rawClass, selectEl) {
        if (!rawClass || !selectEl) return -1;
        var targetNorm = normalizeClassKey(rawClass);
        if (!targetNorm) return -1;

        var bestIdx = -1;
        var bestScore = -1;
        var targetGroup = detectClassGroup(rawClass);

        for (var i = 0; i < selectEl.options.length; i++) {
            var prevue = allPrevue.find(function(p) { return p.id === selectEl.options[i].value; });
            if (!prevue || !prevue.classeId) continue;

            var candidateNorm = normalizeClassKey(prevue.classeId);
            if (!candidateNorm) continue;
            if (!classesMatch(rawClass, prevue.classeId)) continue;

            var score = 10;
            if (candidateNorm === targetNorm) score = 100;
            else if (targetGroup && detectClassGroup(prevue.classeId) === targetGroup) score = 90;
            else if (candidateNorm.includes(targetNorm) || targetNorm.includes(candidateNorm)) score = 80;

            if (score > bestScore) {
                bestScore = score;
                bestIdx = i;
            }
        }
        return bestIdx;
    }

    function selectClasseFromDetected(rawClass) {
        var select = document.getElementById('selectClasse');
        if (!select || !rawClass) return false;
        var idx = findBestClasseOptionIndex(rawClass, select);
        if (idx < 0) return false;
        select.selectedIndex = idx;
        onClasseChange();
        return true;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTO-DETECT CLASS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function detectCurrentClass(roomParam) {
        var now = new Date();
        var detectedClasse = '';
        var detectedEvent = null;
        var todayStr = toISODateLocal(now);
        var currentMs = now.getTime();
        var select = document.getElementById('selectClasse');

        // 1) Pronote events: find today's event closest to current time
        if (pronoteEvents.length > 0) {
            var bestPronote = null;
            var bestPronoteDiff = Infinity;

            pronoteEvents.forEach(function(ev) {
                if (!ev.start) return;
                var evDate = new Date(ev.start);
                var evDateStr = toISODateLocal(evDate);
                if (evDateStr !== todayStr) return;

                // If room param, filter by room
                if (roomParam) {
                    var evSalle = (ev.location || '').toLowerCase();
                    if (!evSalle.includes(roomParam.toLowerCase()) && !roomParam.toLowerCase().includes(evSalle)) return;
                }

                // Time proximity: event start within -30 to +120 minutes of now
                var diffMin = (currentMs - evDate.getTime()) / 60000;
                if (diffMin >= -30 && diffMin < 120 && Math.abs(diffMin) < bestPronoteDiff) {
                    bestPronoteDiff = Math.abs(diffMin);
                    bestPronote = ev;
                }
            });

            if (bestPronote && bestPronote.classe) {
                detectedClasse = bestPronote.classe;
                detectedEvent = bestPronote;
                // Show room badge from Pronote detection
                if (bestPronote.location) {
                    document.getElementById('roomBadge').style.display = 'block';
                    document.getElementById('roomNum').textContent = bestPronote.location;
                }
            }
        }

        // 2) Fallback: static EMPLOI_DU_TEMPS (only if room is provided)
        if (!detectedClasse && roomParam) {
            var dayOfWeek = now.getDay();
            var currentTime = now.getHours() * 60 + now.getMinutes();
            var bestMatch = null;
            var bestDiff = Infinity;
            EMPLOI_DU_TEMPS.forEach(function(e) {
                if (e.jour !== dayOfWeek) return;
                if (!roomParam.includes(e.salle) && !e.salle.includes(roomParam)) return;
                var parts = e.heure.split(':');
                var eTime = parseInt(parts[0]) * 60 + parseInt(parts[1]);
                var diff = currentTime - eTime;
                if (diff >= -30 && diff < 120 && Math.abs(diff) < bestDiff) {
                    bestDiff = Math.abs(diff);
                    bestMatch = e;
                }
            });
            if (bestMatch) detectedClasse = bestMatch.classe;
        }

        // 3) Apply detection to dropdown (with aliases)
        if (detectedClasse) {
            selectClasseFromDetected(detectedClasse);
        }

        // Return detection info for QR scanner feedback
        return {
            classe: detectedClasse,
            event: detectedEvent,
            location: detectedEvent ? detectedEvent.location : '',
            summary: detectedEvent ? detectedEvent.summary : ''
        };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function extractModuleId(str) {
        if (!str) return '';
        str = str.trim();
        var m = str.match(/^([A-Z]+\d+(\.\d+)?)/i);
        return m ? m[1].toUpperCase() : str;
    }

    function populateModuleDropdown(selectEl, moduleList) {
        var themes = {};
        moduleList.forEach(function(mod) {
            var t = mod.theme || '?';
            if (!themes[t]) themes[t] = [];
            themes[t].push(mod);
        });
        Object.keys(themes).sort().forEach(function(themeKey) {
            var optgroup = document.createElement('optgroup');
            optgroup.label = THEME_LABELS[themeKey] || ('Th√®me ' + themeKey);
            themes[themeKey].forEach(function(mod) {
                var opt = document.createElement('option');
                opt.value = mod.id;
                opt.textContent = mod.id + ' - ' + mod.titre;
                optgroup.appendChild(opt);
            });
            selectEl.appendChild(optgroup);
        });
    }

    function buildPhaseSelector(containerId, isPrimary) {
        var container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        var phases = [
            { id: 'cours', label: 'üìñ Cours' },
            { id: 'evaluation', label: 'üìù √âvaluation' },
            { id: 'correction', label: '‚úÖ Correction' },
            { id: 'exercice', label: 'üí° Exercice' }
        ];
        if (isPrimary) {
            // Multi-select pour phase principale
            phases.forEach(function(phase) {
                var btn = document.createElement('button');
                btn.className = 'chip';
                btn.type = 'button';
                btn.textContent = phase.label;
                btn.addEventListener('click', function() {
                    window.togglePhase(phase.id, btn);
                });
                container.appendChild(btn);
            });
            // Bouton Autre
            var autreBtn = document.createElement('button');
            autreBtn.className = 'chip autre';
            autreBtn.textContent = '+ Autre';
            autreBtn.type = 'button';
            autreBtn.addEventListener('click', function() {
                var inp = document.getElementById('phaseAutreInput');
                var visible = inp && inp.style.display !== 'none';
                if (inp) inp.style.display = visible ? 'none' : 'block';
                autreBtn.classList.toggle('selected', !visible);
                if (!visible && inp) inp.focus();
            });
            container.appendChild(autreBtn);
        } else {
            // Single select pour phase suivant
            phases.slice(0,3).forEach(function(phase) {
                var btn = document.createElement('button');
                btn.className = 'chip' + (phase.id === selectedPhaseSuivant ? ' selected' : '');
                btn.type = 'button';
                btn.textContent = phase.label;
                btn.addEventListener('click', function() {
                    container.querySelectorAll('.chip').forEach(function(b) { b.classList.remove('selected'); });
                    btn.classList.add('selected');
                    selectedPhaseSuivant = phase.id;
                });
                container.appendChild(btn);
            });
        }
    }

    function resetModuleSuivant() {
        moduleSuivantEnabled = false;
        selectedModuleSuivant = '';
        selectedPhaseSuivant = 'cours';
        selectedPhase = 'cours';
        selectedPhases = [];
        var toggle = document.getElementById('moduleSuivantToggle');
        if (toggle) { toggle.classList.remove('active'); }
        var icon = document.getElementById('moduleSuivantIcon');
        if (icon) { icon.textContent = '‚òê'; }
        var section = document.getElementById('moduleSuivantSection');
        if (section) { section.style.display = 'none'; }
        // Reset chips phase
        var phaseGrid = document.getElementById('phaseGrid');
        if (phaseGrid) phaseGrid.querySelectorAll('.chip').forEach(function(b) { b.classList.remove('selected'); });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESOLVE NIVEAU (with fallbacks) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function resolveNiveau(prevue) {
        // 1) Try CLASSES_CONFIG mapping
        var niveau = CLASSES_CONFIG[prevue.classeId] || null;
        if (niveau && MODULES_PSE[niveau]) return niveau;
        // 2) Try prevue.niveau directly (stored from CSV import)
        if (prevue.niveau && MODULES_PSE[prevue.niveau]) return prevue.niveau;
        // 3) Try fuzzy match on classeId
        var cid = (prevue.classeId || '').toUpperCase();
        if (/^C[12]/.test(cid) || /CAP/i.test(cid)) return 'CAP';
        if (/^BT/.test(cid) || /TERM/i.test(cid)) return 'BAC_PRO_TERM';
        if (/^B1/.test(cid) || /1[E√à]RE/i.test(cid)) return 'BAC_PRO_1ERE';
        if (/^B2/.test(cid) || /2NDE/i.test(cid)) return 'BAC_PRO_2NDE';
        return null;
    }

    function extractModulesFromSemaines(prevue) {
        var modules = [];
        var seen = {};
        (prevue.semaines || []).forEach(function(s) {
            var m = (s.module || s.moduleBase || '').trim();
            if (m && m !== 'N/A' && m !== 'Pr√©sentation PSE' && !seen[m]) {
                seen[m] = true;
                modules.push(m);
            }
        });
        return modules;
    }

    function populateModuleSuivantDropdown() {
        var selectSuivant = document.getElementById('selectModuleSuivant');
        if (!selectSuivant) return;
        selectSuivant.innerHTML = '<option value="">-- S√©lectionner --</option>';
        var classeDocId = document.getElementById('selectClasse').value;
        if (!classeDocId) return;
        var prevue = allPrevue.find(function(p) { return p.id === classeDocId; });
        if (!prevue) return;
        var niveau = resolveNiveau(prevue);
        if (niveau && MODULES_PSE[niveau]) {
            populateModuleDropdown(selectSuivant, MODULES_PSE[niveau]);
        } else {
            // Fallback: extract from semaines
            extractModulesFromSemaines(prevue).forEach(function(m) {
                var opt = document.createElement('option');
                opt.value = m; opt.textContent = m;
                selectSuivant.appendChild(opt);
            });
        }
        selectSuivant.onchange = function() {
            selectedModuleSuivant = selectSuivant.value;
        };
    }

    function initModuleSuivantToggle() {
        var toggle = document.getElementById('moduleSuivantToggle');
        if (!toggle) return;
        toggle.addEventListener('click', function() {
            moduleSuivantEnabled = !moduleSuivantEnabled;
            toggle.classList.toggle('active', moduleSuivantEnabled);
            document.getElementById('moduleSuivantIcon').textContent = moduleSuivantEnabled ? '‚òë' : '‚òê';
            var section = document.getElementById('moduleSuivantSection');
            section.style.display = moduleSuivantEnabled ? 'block' : 'none';
            if (moduleSuivantEnabled) {
                populateModuleSuivantDropdown();
                buildPhaseSelector('phaseSuivantGrid', false);
            } else {
                selectedModuleSuivant = '';
                selectedPhaseSuivant = 'cours';
            }
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PLANIFICATION FUTURE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function initPlanifToggle() {
        var toggle = document.getElementById('planifToggle');
        if (!toggle) return;
        toggle.addEventListener('click', function() {
            planifEnabled = !planifEnabled;
            toggle.classList.toggle('active', planifEnabled);
            document.getElementById('planifIcon').textContent = planifEnabled ? '‚òë' : '‚òê';
            document.getElementById('planifSection').style.display = planifEnabled ? 'block' : 'none';
            if (!planifEnabled) {
                planifType = '';
                document.getElementById('planifDate').value = '';
                document.querySelectorAll('#planifSection .situation-btn').forEach(function(b) { b.classList.remove('selected'); });
            }
        });
    }

    window.selectPlanifType = function(type, btn) {
        document.querySelectorAll('#planifSection .situation-btn').forEach(function(b) { b.classList.remove('selected'); });
        if (planifType === type) { planifType = ''; }
        else { planifType = type; btn.classList.add('selected'); }
    };

    function findWeekByDate(classeDocId, dateStr) {
        if (!classeDocId || !dateStr) return null;
        var prevue = allPrevue.find(function(p) { return p.id === classeDocId; });
        if (!prevue || !prevue.semaines) return null;
        var target = parseLocalDate(dateStr);
        if (!target) return null;
        for (var i = 0; i < prevue.semaines.length; i++) {
            var sem = prevue.semaines[i];
            var semDate = parseLocalDate(sem && sem.date);
            if (!semDate) continue;
            if (sameWeekLocal(target, semDate) || semDate.getTime() === target.getTime()) {
                return { week: sem, index: i };
            }
        }
        return null;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIND CURRENT WEEK FROM PROGRESSION PREVUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function findCurrentWeekPrevue(classeDocId, targetDate) {
        if (!classeDocId) return null;
        var prevue = allPrevue.find(function(p) { return p.id === classeDocId; });
        if (!prevue || !prevue.semaines) return null;

        var refDate;
        if (typeof targetDate === 'string' && targetDate) {
            refDate = parseLocalDate(targetDate);
        } else if (targetDate instanceof Date) {
            refDate = new Date(targetDate);
        } else {
            refDate = getContextDateObject();
        }
        if (Number.isNaN(refDate.getTime())) refDate = new Date();
        refDate.setHours(12, 0, 0, 0);

        for (var i = 0; i < prevue.semaines.length; i++) {
            var sem = prevue.semaines[i];
            if (!sem.date) continue;
            var semDate = parseLocalDate(sem.date);
            if (!semDate) continue;
            if (sameWeekLocal(refDate, semDate) || semDate.getTime() === refDate.getTime()) {
                return { week: sem, index: i };
            }
        }
        return null;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SYNC PREVUE AFTER LOG SAVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function syncPrevue(classeDocId, statut, situation) {
        // Use planified date if set, otherwise session context date
        var planifDate = planifEnabled ? document.getElementById('planifDate').value : '';
        var contextDate = planifDate || getContextDateISO();
        var weekInfo = findWeekByDate(classeDocId, contextDate) || findCurrentWeekPrevue(classeDocId, contextDate);
        if (!weekInfo) return;

        var prevue = allPrevue.find(function(p) { return p.id === classeDocId; });
        if (!prevue || !prevue.semaines) return;

        var sem = prevue.semaines[weekInfo.index];

        // Mapping statut
        if (statut === 'R√©alis√©') { sem.valide = true; sem.statut = 'R√©alis√©'; }
        else if (statut === 'Report√©') { sem.valide = false; sem.statut = 'Report√©'; }
        else if (statut === 'Non r√©alis√©') { sem.valide = false; sem.statut = 'Non r√©alis√©'; }
        else if (statut === 'Pr√©vu') { sem.valide = false; sem.statut = 'Pr√©vu'; }

        // Valid√© toggle override
        if (isValide) sem.valide = true;

        // Sync s√©ance
        if (selectedSeance) sem.seance = selectedSeance;

        // Sync phase
        if (selectedPhase) sem.phase = selectedPhase;

        // Sync evaluations
        if (selectedEvalDiag) sem.evalDiag = selectedEvalDiag;
        if (selectedEvalForm) sem.evalForm = selectedEvalForm;
        if (selectedEvalSomm) sem.evaluation = selectedEvalSomm;

        // Situation sp√©ciale (Annul√©, PFMP, etc.)
        if (situation && situation !== 'Normal') {
            sem.situation = situation;
            sem.valide = false;
        }

        // ‚îÄ‚îÄ Propager module suivant sur la prochaine semaine utile ‚îÄ‚îÄ
        if (moduleSuivantEnabled && selectedModuleSuivant) {
            for (var j = weekInfo.index + 1; j < prevue.semaines.length; j++) {
                var nextSem = prevue.semaines[j];
                var sit = (nextSem.situation || 'Normal').toLowerCase();
                var isNormal = sit === 'normal' || sit === '' || sit === 'n/a';
                if (isNormal) {
                    nextSem.moduleBase = selectedModuleSuivant;
                    nextSem.module = selectedModuleSuivant;
                    nextSem.phase = selectedPhaseSuivant;
                    nextSem.transition = '';
                    break;
                }
            }
        }

        await updateDoc(doc(db, 'progression_prevue', classeDocId), { semaines: prevue.semaines });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLASSE CHANGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function onClasseChange() {
        var classeDocId = document.getElementById('selectClasse').value;
        var selectModule = document.getElementById('selectModule');
        selectModule.innerHTML = '<option value="">-- S√©lectionner --</option>';

        // Reset phase & module suivant
        resetModuleSuivant();
        buildPhaseSelector('phaseGrid', true);

        if (!classeDocId) return;

        // Get the prevue for this class
        var prevue = allPrevue.find(function(p) { return p.id === classeDocId; });
        if (!prevue) return;

        // Determine niveau with fallbacks
        var niveau = resolveNiveau(prevue);

        if (niveau && MODULES_PSE[niveau]) {
            populateModuleDropdown(selectModule, MODULES_PSE[niveau]);
        } else {
            // Fallback: extract from prevue.semaines
            extractModulesFromSemaines(prevue).forEach(function(m) {
                var opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                selectModule.appendChild(opt);
            });
        }

        // ‚îÄ‚îÄ AUTO-SELECT MODULE from progression_prevue (current week) ‚îÄ‚îÄ
        var contextDate = getContextDateISO();
        var weekInfo = findWeekByDate(classeDocId, contextDate) || findCurrentWeekPrevue(classeDocId, contextDate);
        if (weekInfo && weekInfo.week.module) {
            var expectedId = extractModuleId(weekInfo.week.module);
            var matched = false;
            for (var i = 0; i < selectModule.options.length; i++) {
                if (selectModule.options[i].value === expectedId) {
                    selectModule.selectedIndex = i;
                    matched = true;
                    break;
                }
            }
            // Fallback: try full string match (legacy format)
            if (!matched) {
                var expectedFull = weekInfo.week.module.trim();
                for (var i = 0; i < selectModule.options.length; i++) {
                    if (selectModule.options[i].value === expectedFull) {
                        selectModule.selectedIndex = i;
                        break;
                    }
                }
            }
        }

        // Load last log + history for this class
        await loadLastLog(classeDocId, prevue.classeId);
        // Afficher historique en haut de page
        showHistoryTop(classeDocId, prevue.classeId);
        // Situation auto depuis progression pr√©vue
        var weekInfoSit = findWeekByDate(classeDocId, contextDate) || findCurrentWeekPrevue(classeDocId, contextDate);
        if (weekInfoSit) {
            var sitPrevue = (weekInfoSit.week.situation || '').toLowerCase();
            var situAutoCard = document.getElementById('situationAutoCard');
            if (situAutoCard) {
                if (sitPrevue && sitPrevue !== 'normal' && sitPrevue !== '' && sitPrevue !== 'n/a') {
                    situAutoCard.style.display = 'block';
                    situAutoCard.innerHTML = '<div class="banner banner-situation" style="margin-bottom:12px;">' +
                        '<div class="banner-title">üìã Situation pr√©vue cette semaine : ' + weekInfoSit.week.situation + '</div>' +
                        '<div class="banner-detail">D\'apr√®s votre progression. Si confirm√©, s√©lectionnez-la ci-dessous.</div></div>';
                } else { situAutoCard.style.display = 'none'; }
            }
        }

        // Rebuild checklist (uses currentClassLogs for smart distribution)
        buildChecklist();

        // Check for module delay vs planned progression
        await checkModuleDelay(classeDocId);

        // Rebuild checklist when module changes too
        selectModule.onchange = function() { buildChecklist(); };

        // Reset student tracking for new class
        absentsEleves = [];
        elevesSansCopie = [];
        absences = 0;
        document.getElementById('absCount').textContent = '0';
        document.getElementById('absencesNoms').value = '';

        // Load student roster for this class
        renderAbsenceChips(classeDocId, prevue ? prevue.classeId : classeDocId);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LAST LOG + HISTORIQUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadLastLog(classeDocId, classeLabel) {
        var infoDiv = document.getElementById('lastLogInfo');
        var historyContainer = document.getElementById('sessionHistory');
        var historyList = document.getElementById('historyList');

        try {
            var logsSnap = await getDocs(collection(db, 'progression_logs'));
            var classLogs = [];
            logsSnap.forEach(function(d) {
                var data = d.data();
                if (data.classeId === classeLabel || data.classeDocId === classeDocId) {
                    classLogs.push(data);
                }
            });

            // Store for Feature 6 (smart distribution)
            currentClassLogs = classLogs;

            if (classLogs.length === 0) {
                infoDiv.style.display = 'none';
                historyContainer.style.display = 'none';
                return;
            }

            // Sort by date desc
            classLogs.sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });
            var last = classLogs[0];

            // ‚îÄ‚îÄ DISPLAY LAST LOG INFO ‚îÄ‚îÄ
            var todoDisplay = '';
            if (last.todoNext) {
                if (typeof last.todoNext === 'object') {
                    todoDisplay = last.todoNext.label || '';
                    if (last.todoNext.note) todoDisplay += ' ‚Äî ' + last.todoNext.note;
                } else {
                    todoDisplay = last.todoNext;
                }
            }

            var lastPhaseTag = last.phase && last.phase !== 'cours' ?
                ' <span class="phase-badge ' + last.phase + '">' + last.phase + '</span>' : '';
            var lastSuivantTag = '';
            if (last.moduleSuivant && last.moduleSuivant.moduleId) {
                lastSuivantTag = ' + ' + last.moduleSuivant.moduleId;
            }
            infoDiv.style.display = 'block';
            infoDiv.innerHTML = '<strong>Derni√®re saisie (' + last.date + ')</strong><br>' +
                (last.moduleId || '') + lastPhaseTag + lastSuivantTag + ' ‚Äî ' + (last.seance || '') +
                (last.statut ? ' [' + last.statut + ']' : '') +
                (todoDisplay ? '<br>üìå Pr√©vu : ' + todoDisplay : '');

            // ‚îÄ‚îÄ RENDER FULL HISTORY ‚îÄ‚îÄ
            var statutIcons = { 'R√©alis√©': '‚úÖ', 'Pr√©vu': 'üìã', 'Report√©': 'üîÑ', 'Non r√©alis√©': '‚ùå' };
            var BADGE_LABELS = {
                'eval_diagnostique': '√âval diag', 'cours_complet': 'Cours complet',
                'cours_seance': 'Cours s√©ance', 'docs_distribues': 'Docs',
                'devoir_donne': 'Devoir', 'copies_ramassees': 'Copies ramass√©es',
                'copies_corrigees': 'Corrig√©es', 'copies_rendues': 'Copies rendues',
                'auto_eval_ligne': 'Auto-√©val', 'exercice_en_ligne': 'Exercice ligne',
                'eval_formative': '√âval formative', 'eval_sommative': '√âval sommative',
                'eval_corrigee': '√âval corrig√©e', 'eval_rendue': '√âval rendue'
            };

            historyContainer.style.display = 'block';
            document.getElementById('historyCount').textContent = classLogs.length + ' s√©ance' + (classLogs.length > 1 ? 's' : '');
            historyList.innerHTML = '';

            classLogs.forEach(function(log) {
                var card = document.createElement('div');
                card.className = 'history-card';

                // Checklist badges
                var badges = '';
                var cl = log.checklist || {};
                Object.keys(cl).forEach(function(key) {
                    var val = cl[key];
                    if (val && BADGE_LABELS[key]) {
                        var label = BADGE_LABELS[key];
                        // cours_seance with seanceNum
                        if (key === 'cours_seance' && typeof val === 'object' && val.seanceNum) {
                            label = 'Cours S' + val.seanceNum;
                        }
                        badges += '<span class="history-badge">' + label + '</span>';
                    }
                });

                var icon = statutIcons[log.statut] || '';
                var logPhaseTag = log.phase && log.phase !== 'cours' ?
                    '<span class="phase-badge ' + log.phase + '">' + log.phase + '</span>' : '';
                var logSuivantTag = '';
                if (log.moduleSuivant && log.moduleSuivant.moduleId) {
                    logSuivantTag = ' + ' + log.moduleSuivant.moduleId;
                }
                card.innerHTML =
                    '<div class="history-card-header">' +
                        '<span class="history-date">' + (log.date || '') + '</span>' +
                        '<span class="history-statut">' + icon + ' ' + (log.statut || '') + '</span>' +
                    '</div>' +
                    '<div class="history-detail">' +
                        (log.moduleId || '') + logSuivantTag + ' ‚Äî ' + (log.seance || '') +
                        (log.arret ? ' | Arr√™t: ' + log.arret : '') +
                    '</div>' +
                    (logPhaseTag ? '<div style="margin-top:4px;">' + logPhaseTag + '</div>' : '') +
                    (badges ? '<div class="history-badges">' + badges + '</div>' : '');

                historyList.appendChild(card);
            });

            // ‚îÄ‚îÄ AUTO-SELECT MODULE (only if not already set by progression_prevue) ‚îÄ‚îÄ
            if (last.moduleId) {
                var selectMod = document.getElementById('selectModule');
                if (!selectMod.value) {
                    var lastId = extractModuleId(last.moduleId);
                    for (var i = 0; i < selectMod.options.length; i++) {
                        if (selectMod.options[i].value === lastId || selectMod.options[i].value === last.moduleId) {
                            selectMod.selectedIndex = i;
                            break;
                        }
                    }
                }
            }

            // ‚îÄ‚îÄ SMART S√âANCE AUTO-SUGGESTION ‚îÄ‚îÄ
            var suggestedSeance = '';
            var lastSeance = last.seance || '';
            var lastStatut = last.statut || '';
            var lastSeanceMatch = lastSeance.match(/[Ss]√©ance\s*(\d+)/);
            var lastSeanceNum = lastSeanceMatch ? parseInt(lastSeanceMatch[1]) : 0;

            if (lastStatut === 'R√©alis√©' && lastSeanceNum > 0) {
                suggestedSeance = 'S√©ance ' + (lastSeanceNum + 1);
            } else if ((lastStatut === 'Report√©' || lastStatut === 'Non r√©alis√©') && lastSeanceNum > 0) {
                suggestedSeance = 'Poursuite S√©ance ' + lastSeanceNum;
            }

            // Override with todoNext if structured
            if (last.todoNext && typeof last.todoNext === 'object' && last.todoNext.action) {
                var todoAction = last.todoNext.action;
                var todoSeanceMatch = todoAction.match(/seance_(\d+)$/);
                var todoPoursuiteMatch = todoAction.match(/poursuivre_s(\d+)/);
                if (todoSeanceMatch) {
                    suggestedSeance = 'S√©ance ' + todoSeanceMatch[1];
                } else if (todoPoursuiteMatch) {
                    suggestedSeance = 'Poursuite S√©ance ' + todoPoursuiteMatch[1];
                } else if (todoAction === 'correction') {
                    suggestedSeance = 'Correction';
                }
            }

            // ‚îÄ‚îÄ PRE-FILL S√âANCE PICKER ‚îÄ‚îÄ
            if (suggestedSeance) {
                autoSelectSeance(suggestedSeance);
            }

            // ‚îÄ‚îÄ REMINDERS (Pronote + continuation) ‚îÄ‚îÄ
            showReminders(last);

        } catch (e) { console.error(e); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUILD UI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function buildSeancePicker() {
        var grid = document.getElementById('seanceGrid');
        grid.innerHTML = '';
        SEANCES.forEach(function(s) {
            var btn = document.createElement('button');
            btn.className = 'chip';
            btn.textContent = s;
            btn.addEventListener('click', function() {
                var idx = selectedSeances.indexOf(s);
                if (idx >= 0) { selectedSeances.splice(idx,1); btn.classList.remove('selected'); }
                else { selectedSeances.push(s); btn.classList.add('selected'); }
                // Compat legacy
                selectedSeance = selectedSeances[0] || '';
                buildTodoGrid();
                updateStatutInfo();
            });
            grid.appendChild(btn);
        });
        // Bouton Autre
        var autreBtn = document.createElement('button');
        autreBtn.className = 'chip autre';
        autreBtn.textContent = '+ Autre';
        autreBtn.addEventListener('click', function() {
            var inp = document.getElementById('seanceAutreInput');
            var visible = inp && inp.style.display !== 'none';
            if (inp) { inp.style.display = visible ? 'none' : 'block'; }
            autreBtn.classList.toggle('selected', !visible);
            if (!visible && inp) inp.focus();
        });
        grid.appendChild(autreBtn);
        var seanceAutreInp = document.getElementById('seanceAutreInput');
        if (seanceAutreInp) {
            seanceAutreInp.addEventListener('input', function() { seanceAutreText = this.value; updateStatutInfo(); });
        }
    }

    function updateStatutInfo() {
        var infoDiv = document.getElementById('statutLabel') || document.createElement('div');
        // Afficher ce qui va √™tre valid√© si statut = R√©alis√©
        if (selectedStatut === 'R√©alis√©') {
            var allS = selectedSeances.slice();
            if (seanceAutreText) allS.push(seanceAutreText);
            if (allS.length > 0 && infoDiv) {
                infoDiv.style.display = 'block';
                var strongEl = document.getElementById('statutSeanceLabel');
                if (strongEl) strongEl.textContent = allS.join(' + ');
            }
        }
    }

    function findDistributedSeances() {
        var distributed = [];
        var currentModule = document.getElementById('selectModule').value;
        if (!currentModule || !currentClassLogs) return distributed;

        var currentId = extractModuleId(currentModule);
        currentClassLogs.forEach(function(log) {
            if (extractModuleId(log.moduleId) !== currentId) return;
            var cl = log.checklist || {};

            // New format: object with seanceNum
            if (cl.cours_seance && typeof cl.cours_seance === 'object' && cl.cours_seance.seanceNum) {
                distributed.push(cl.cours_seance.seanceNum);
            }
            // New flat format: cours_seance_num stored separately
            else if (cl.cours_seance_num && cl.cours_seance_num > 0) {
                distributed.push(cl.cours_seance_num);
            }
            // Old boolean format: infer from seance field
            else if (cl.cours_seance === true) {
                var seanceMatch = (log.seance || '').match(/[Ss]√©ance\s*(\d+)/);
                if (seanceMatch) distributed.push(parseInt(seanceMatch[1]));
            }
        });

        return distributed;
    }

    function buildChecklist() {
        var grid = document.getElementById('checklistGrid');
        grid.innerHTML = '';

        var distributedSeances = findDistributedSeances();

        CHECKLIST.forEach(function(item) {
            if (item.key === 'cours_seance') {
                // ‚îÄ‚îÄ Special: s√©ance sub-buttons S1-S5 ‚îÄ‚îÄ
                checklist[item.key] = false;
                checklist['cours_seance_num'] = 0;

                var container = document.createElement('div');
                container.className = 'check-btn';
                container.style.gridColumn = '1 / -1';
                container.innerHTML = '<span class="check-icon">' + item.icon + '</span>' + item.label;

                var subGrid = document.createElement('div');
                subGrid.style.cssText = 'display:flex; gap:6px; margin-top:8px; justify-content:center;';

                for (var n = 1; n <= 5; n++) {
                    (function(num) {
                        var subBtn = document.createElement('button');
                        var isDistributed = distributedSeances.indexOf(num) >= 0;
                        subBtn.className = 'seance-btn' + (isDistributed ? '' : '');
                        subBtn.textContent = 'S' + num;
                        subBtn.style.cssText = 'padding:6px 12px; font-size:0.78em; min-width:38px;';

                        if (isDistributed) {
                            subBtn.style.opacity = '0.35';
                            subBtn.style.textDecoration = 'line-through';
                            subBtn.disabled = true;
                            subBtn.title = 'D√©j√† distribu√©';
                        }

                        subBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            subGrid.querySelectorAll('.seance-btn').forEach(function(b) {
                                if (!b.disabled) b.classList.remove('selected');
                            });
                            if (checklist['cours_seance_num'] === num) {
                                checklist[item.key] = false;
                                checklist['cours_seance_num'] = 0;
                                container.classList.remove('active');
                            } else {
                                subBtn.classList.add('selected');
                                checklist[item.key] = true;
                                checklist['cours_seance_num'] = num;
                                container.classList.add('active');
                            }
                        });

                        subGrid.appendChild(subBtn);
                    })(n);
                }

                container.appendChild(subGrid);
                grid.appendChild(container);
            } else {
                // ‚îÄ‚îÄ Normal checklist item ‚îÄ‚îÄ
                checklist[item.key] = false;
                var btn = document.createElement('button');
                btn.className = 'check-btn';
                btn.innerHTML = '<span class="check-icon">' + item.icon + '</span>' + item.label;
                btn.addEventListener('click', function() {
                    checklist[item.key] = !checklist[item.key];
                    btn.classList.toggle('active', checklist[item.key]);
                    updateElevesSansCours();
                });
                grid.appendChild(btn);
            }
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TODO NEXT ‚Äî MENU INTELLIGENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function generateTodoOptions(currentSeance) {
        var options = [];
        var match = currentSeance.match(/[Ss]√©ance\s*(\d+)/);
        var seanceNum = match ? parseInt(match[1]) : 0;
        var isEval = /[√â√©]valuation/i.test(currentSeance);
        var isCorrection = /[Cc]orr/i.test(currentSeance);

        // ‚îÄ‚îÄ Chips s√©ances toujours visibles en premier (S1-S4) ‚îÄ‚îÄ
        for (var s = 1; s <= 4; s++) {
            options.push({ action: 'seance_' + s, label: 'S√©ance ' + s, isSeanceChip: true });
        }

        // ‚îÄ‚îÄ Options contextuelles ‚îÄ‚îÄ
        if (seanceNum > 0) {
            options.push({ action: 'poursuivre_s' + seanceNum, label: 'Poursuivre S' + seanceNum });
            if (seanceNum >= 4 && seanceNum < 6) {
                options.push({ action: 'seance_' + (seanceNum + 1), label: 'S√©ance ' + (seanceNum + 1) });
            }
            options.push({ action: 'seance_' + seanceNum + '_eval', label: 'S' + seanceNum + ' + √©valuation' });
        }

        if (isEval) {
            options.push({ action: 'correction', label: 'Correction' });
            options.push({ action: 'seance_suivante', label: 'S√©ance suivante' });
        }

        if (isCorrection) {
            options.push({ action: 'seance_suivante', label: 'S√©ance suivante' });
            options.push({ action: 'rendre_copies', label: 'Rendre les copies' });
        }

        // Options √©valuation (toujours disponibles)
        var always = [
            { action: 'evaluation', label: '√âvaluation' },
            { action: 'eval_diagnostique_plan', label: 'Pr√©voir √©val diagnostique', reminderPronote: true, reminderType: 'diagnostique' },
            { action: 'eval_formative_plan', label: 'Pr√©voir √©val formative', reminderPronote: true, reminderType: 'formative' },
            { action: 'eval_sommative_plan', label: 'Pr√©voir √©val sommative', reminderPronote: true, reminderType: 'sommative' },
            { action: 'correction_eval_plan', label: 'Correction + √©val' }
        ];

        always.forEach(function(a) {
            var exists = options.some(function(o) { return o.action === a.action; });
            if (!exists) options.push(a);
        });

        return options;
    }

    function buildTodoGrid() {
        var grid = document.getElementById('todoGrid');
        grid.innerHTML = '';
        var options = generateTodoOptions(selectedSeance);
        var addedSeparator = false;

        options.forEach(function(opt) {
            // Add separator after s√©ance chips
            if (!opt.isSeanceChip && !addedSeparator) {
                addedSeparator = true;
                var sep = document.createElement('div');
                sep.style.cssText = 'width:100%;height:1px;background:var(--border);margin:4px 0;';
                grid.appendChild(sep);
            }
            var btn = document.createElement('button');
            btn.className = 'todo-btn' + (opt.reminderPronote ? ' eval-option' : '') + (opt.isSeanceChip ? ' seance-chip' : '');
            btn.textContent = opt.label;
            btn.addEventListener('click', function() {
                grid.querySelectorAll('.todo-btn').forEach(function(b) { b.classList.remove('selected'); });
                if (selectedTodo && selectedTodo.action === opt.action) {
                    selectedTodo = null;
                } else {
                    btn.classList.add('selected');
                    selectedTodo = opt;
                }
            });
            if (selectedTodo && selectedTodo.action === opt.action) {
                btn.classList.add('selected');
            }
            grid.appendChild(btn);
        });
    }

    function autoSelectSeance(suggestedSeance) {
        var grid = document.getElementById('seanceGrid');
        var isPoursuite = /^Poursuite/i.test(suggestedSeance);

        if (isPoursuite) {
            var poursuiteBtn = document.createElement('button');
            poursuiteBtn.className = 'seance-btn selected';
            poursuiteBtn.style.borderColor = '#f59e0b';
            poursuiteBtn.style.background = '#fef3c7';
            poursuiteBtn.style.color = '#92400e';
            poursuiteBtn.textContent = suggestedSeance;
            poursuiteBtn.addEventListener('click', function() {
                grid.querySelectorAll('.seance-btn').forEach(function(b) { b.classList.remove('selected'); });
                poursuiteBtn.classList.add('selected');
                poursuiteBtn.style.borderColor = '#f59e0b';
                poursuiteBtn.style.background = '#fef3c7';
                poursuiteBtn.style.color = '#92400e';
                selectedSeance = suggestedSeance;
                buildTodoGrid();
            });
            grid.insertBefore(poursuiteBtn, grid.firstChild);
            selectedSeance = suggestedSeance;
            buildTodoGrid();
        } else {
            var buttons = grid.querySelectorAll('.seance-btn');
            buttons.forEach(function(btn) {
                if (btn.textContent === suggestedSeance) {
                    btn.classList.add('selected');
                    selectedSeance = suggestedSeance;
                }
            });
            buildTodoGrid();
        }
    }

    function showReminders(lastLog) {
        var container = document.getElementById('pronoteReminder');
        container.innerHTML = '';
        container.style.display = 'none';

        if (!lastLog || !lastLog.todoNext) return;

        var todo = lastLog.todoNext;
        var banners = [];

        if (typeof todo === 'object') {
            if (todo.reminderPronote && todo.reminderType) {
                var evalTypes = { 'formative': '√©val formative', 'sommative': '√©val sommative', 'diagnostique': '√©val diagnostique' };
                var evalLabel = evalTypes[todo.reminderType] || todo.reminderType;
                banners.push({
                    type: 'pronote',
                    title: '‚ö†Ô∏è Rappel : Pr√©voir noter ' + evalLabel + ' sur Pronote',
                    detail: 'Pr√©vu lors de la derni√®re saisie pour ' + (lastLog.classeId || 'cette classe')
                });
            }
            if (todo.action && todo.action.startsWith('poursuivre_')) {
                var sNum = todo.action.replace('poursuivre_s', '');
                banners.push({
                    type: 'continuation',
                    title: 'üìù S√©ance ' + sNum + ' √† terminer',
                    detail: 'Continuation depuis la derni√®re s√©ance'
                });
            }
            if (todo.label && !todo.reminderPronote && !todo.action.startsWith('poursuivre_')) {
                banners.push({
                    type: 'continuation',
                    title: 'üìå Pr√©vu : ' + todo.label,
                    detail: todo.note || ''
                });
            } else if (todo.note) {
                banners.push({
                    type: 'continuation',
                    title: 'üìå Note : ' + todo.note,
                    detail: ''
                });
            }
        } else if (typeof todo === 'string' && todo.trim()) {
            banners.push({
                type: 'continuation',
                title: 'üìå Rappel : ' + todo,
                detail: ''
            });
        }

        if (banners.length === 0) return;

        container.style.display = 'block';
        banners.forEach(function(b) {
            var div = document.createElement('div');
            div.className = b.type === 'pronote' ? 'pronote-banner' : 'continuation-banner';
            div.innerHTML = '<div class="reminder-title">' + b.title + '</div>' +
                (b.detail ? '<div class="reminder-detail">' + b.detail + '</div>' : '');
            container.appendChild(div);
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COURSE NAVIGATION (semaine enti√®re) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function buildCourseNav() {
        var nav = document.getElementById('courseNav');
        var now = new Date();
        var contextDate = getContextDateObject();
        var contextDateStr = getContextDateISO();

        // Calculate Monday and Friday of the target week (clicked date if provided)
        var monday = getLundi(contextDate);
        monday.setHours(0, 0, 0, 0);
        var friday = new Date(monday);
        friday.setDate(monday.getDate() + 4);
        friday.setHours(23, 59, 59, 999);
        var mondayStr = formatDateISO(monday);
        var fridayStr = formatDateISO(friday);

        todayCourses = [];

        if (pronoteEvents.length > 0) {
            pronoteEvents.forEach(function(ev) {
                if (!ev.start || !ev.classe) return;
                var evDate = new Date(ev.start);
                var evDateStr = formatDateISO(evDate);
                // Filter Monday‚ÜíFriday of current week
                if (evDateStr < mondayStr || evDateStr > fridayStr) return;
                todayCourses.push({
                    classe: ev.classe,
                    start: ev.start,
                    end: ev.end || '',
                    location: ev.location || '',
                    summary: ev.summary || '',
                    dateStr: evDateStr
                });
            });
        } else {
            // Fallback: static EMPLOI_DU_TEMPS ‚Äî generate all 5 weekdays
            for (var d = 0; d < 5; d++) {
                var dayTarget = new Date(monday);
                dayTarget.setDate(monday.getDate() + d);
                var targetDay = dayTarget.getDay();
                var dayStr = formatDateISO(dayTarget);

                EMPLOI_DU_TEMPS.forEach(function(e) {
                    if (e.jour !== targetDay) return;
                    var parts = e.heure.split(':');
                    var startTime = new Date(dayTarget);
                    startTime.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);
                    todayCourses.push({
                        classe: e.classe,
                        start: startTime.toISOString(),
                        end: '',
                        location: e.salle,
                        summary: '',
                        dateStr: dayStr
                    });
                });
            }
        }

        if (todayCourses.length === 0) { nav.style.display = 'none'; return; }

        todayCourses.sort(function(a, b) { return new Date(a.start) - new Date(b.start); });

        // Find best initial index ‚Äî prioritize today's current course
        var currentMs = now.getTime();
        var bestIdx = -1;
        // If opened from a clicked slot, target that exact date/class first
        if (paramDate) {
            for (var exact = 0; exact < todayCourses.length; exact++) {
                var evExact = todayCourses[exact];
                if (evExact.dateStr !== paramDate) continue;
                if (paramClasse && !classesMatch(evExact.classe, paramClasse)) continue;
                bestIdx = exact;
                break;
            }
            if (bestIdx === -1) {
                for (var sameDay = 0; sameDay < todayCourses.length; sameDay++) {
                    if (todayCourses[sameDay].dateStr === paramDate) {
                        bestIdx = sameDay;
                        break;
                    }
                }
            }
        }

        // Default behavior (current context day/time)
        if (bestIdx === -1) {
            var bestDiff = Infinity;

            // 1st pass: current course of context day
            todayCourses.forEach(function(ev, idx) {
                if (ev.dateStr !== contextDateStr) return;
                var evStart = new Date(ev.start).getTime();
                var diffMin = (currentMs - evStart) / 60000;
                if (diffMin >= -30 && diffMin < 120 && Math.abs(diffMin) < bestDiff) {
                    bestDiff = Math.abs(diffMin);
                    bestIdx = idx;
                }
            });

            // 2nd: latest past course of context day
            if (bestIdx === -1) {
                for (var i = todayCourses.length - 1; i >= 0; i--) {
                    if (todayCourses[i].dateStr !== contextDateStr) continue;
                    if (new Date(todayCourses[i].start).getTime() < currentMs) {
                        bestIdx = i;
                        break;
                    }
                }
            }

            // 3rd: first future course this week
            if (bestIdx === -1) {
                for (var j = 0; j < todayCourses.length; j++) {
                    if (new Date(todayCourses[j].start).getTime() > currentMs) {
                        bestIdx = j;
                        break;
                    }
                }
            }
        }

        // Fallback to first course
        if (bestIdx === -1) bestIdx = 0;

        courseNavIndex = bestIdx;
        nav.style.display = 'flex';
        updateCourseNav();
    }

    function updateCourseNav() {
        if (todayCourses.length === 0) return;

        var ev = todayCourses[courseNavIndex];
        var startDate = new Date(ev.start);
        var endDate = ev.end ? new Date(ev.end) : null;
        var heure = startDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        var heureFin = endDate ? endDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '';

        // Day label (e.g., "Lun 24/02") ‚Äî omit if today
        var joursCourts = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        var jourLabel = joursCourts[startDate.getDay()] + ' ' +
            String(startDate.getDate()).padStart(2, '0') + '/' +
            String(startDate.getMonth() + 1).padStart(2, '0');

        var todayStr = toISODateLocal(new Date());
        var evDateStr = ev.dateStr || toISODateLocal(startDate);
        var isToday = evDateStr === todayStr;

        document.getElementById('navTime').textContent =
            (isToday ? '' : jourLabel + '  ') + heure + (heureFin ? ' ‚Üí ' + heureFin : '');
        document.getElementById('navClass').textContent = ev.classe + (ev.location ? ' ‚Äî Salle ' + ev.location : '');
        document.getElementById('navCounter').textContent = (courseNavIndex + 1) + ' / ' + todayCourses.length;

        // Style: current, past, or future
        var now = new Date();
        var diffMin = (now.getTime() - startDate.getTime()) / 60000;
        var isCurrent = isToday && diffMin >= -30 && diffMin < 120;
        var isPast = startDate.getTime() < now.getTime() - 120 * 60000;
        var navClassEl = document.getElementById('navClass');
        navClassEl.className = 'nav-class' + (isCurrent ? ' nav-current' : '') + (isPast ? ' nav-past' : '');

        // Enable/disable arrows
        document.getElementById('navPrev').disabled = (courseNavIndex <= 0);
        document.getElementById('navNext').disabled = (courseNavIndex >= todayCourses.length - 1);
    }

    window.navigateCourse = function(direction) {
        var newIdx = courseNavIndex + direction;
        if (newIdx < 0 || newIdx >= todayCourses.length) return;
        courseNavIndex = newIdx;
        updateCourseNav();

        // Select this class in the dropdown with alias-aware matching
        var ev = todayCourses[courseNavIndex];
        selectClasseFromDetected(ev.classe);

        // Update room badge
        if (ev.location) {
            document.getElementById('roomBadge').style.display = 'block';
            document.getElementById('roomNum').textContent = ev.location;
        }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INTERACTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.selectStatut = function(val, btn) {
        document.querySelectorAll('.status-btn').forEach(function(b) { b.classList.remove('selected'); });
        btn.classList.add('selected');
        selectedStatut = val;
    };

    window.selectQualite = function(val, btn) {
        document.querySelectorAll('.quality-btn').forEach(function(b) { b.classList.remove('selected'); });
        btn.classList.add('selected');
        selectedQualite = val;
    };

    window.toggleSituation = function(val, btn) {
        if (selectedSituation === val) {
            selectedSituation = '';
            btn.classList.remove('selected');
        } else {
            document.querySelectorAll('.situation-btn').forEach(function(b) { b.classList.remove('selected'); });
            selectedSituation = val;
            btn.classList.add('selected');
        }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EVAL TOGGLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function makeEvalToggle(gridId, stateGetter, stateSetter) {
        return function(val, btn) {
            if (stateGetter() === val) {
                stateSetter('');
                btn.classList.remove('selected');
            } else {
                document.querySelectorAll('#' + gridId + ' .situation-btn').forEach(function(b) { b.classList.remove('selected'); });
                stateSetter(val);
                btn.classList.add('selected');
            }
        };
    }
    window.toggleEvalDiag = makeEvalToggle('evalDiagGrid', function() { return selectedEvalDiag; }, function(v) { selectedEvalDiag = v; });
    window.toggleEvalForm = makeEvalToggle('evalFormGrid', function() { return selectedEvalForm; }, function(v) { selectedEvalForm = v; });
    window.toggleEvalSomm = makeEvalToggle('evalSommGrid', function() { return selectedEvalSomm; }, function(v) { selectedEvalSomm = v; });

    window.changeAbs = function(delta) {
        absences = Math.max(0, Math.min(35, absences + delta));
        document.getElementById('absCount').textContent = absences;
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ABSENCE CHIPS ‚Äî Liste √©l√®ves cliquables ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderAbsenceChips(classeDocId, classeLabel) {
        // Also render the enhanced student roster
        renderStudentRoster(classeDocId, classeLabel);

        var container = document.getElementById('absChipsContainer');
        var grid = document.getElementById('absChipsGrid');
        var noList = document.getElementById('absNoList');
        if (!container || !grid) return;

        // Hide old chips ‚Äî the new roster replaces them
        container.style.display = 'none';
        if (noList) noList.style.display = 'none';
    }

    function renderStudentRoster(classeDocId, classeLabel) {
        var rosterSection = document.getElementById('studentRosterSection');
        var rosterGrid = document.getElementById('studentRosterGrid');
        var rosterEmpty = document.getElementById('studentRosterEmpty');
        if (!rosterSection || !rosterGrid) return;

        // Load students from cache/localStorage
        var allStudents = Array.isArray(studentsCache) && studentsCache.length ? studentsCache : readStudentsFromLocal();
        if (!studentsCache.length && allStudents.length) studentsCache = allStudents;

        // Filter for this class
        var students = allStudents.filter(function(s) {
            if (!s.classe) return false;
            return classesMatchUtil(s.classe, classeDocId) || classesMatchUtil(s.classe, classeLabel);
        });

        if (students.length === 0) {
            rosterSection.style.display = 'none';
            if (rosterEmpty) rosterEmpty.style.display = 'block';
            return;
        }

        if (rosterEmpty) rosterEmpty.style.display = 'none';
        students.sort(function(a, b) { return (a.name || a.code || '').localeCompare(b.name || b.code || ''); });

        rosterSection.style.display = 'block';
        rosterGrid.innerHTML = '';

        students.forEach(function(s) {
            var name = s.name || s.code || '√âl√®ve';
            var item = document.createElement('div');
            item.className = 'student-item';
            item.innerHTML = '<span class="student-name">' + name + '</span>' +
                '<span class="student-badges"><span class="badge-abs">ABS</span><span class="badge-sc">SC</span></span>';
            item.dataset.studentName = name;

            // Restore state
            if (absentsEleves.indexOf(name) >= 0) item.classList.add('absent');
            if (elevesSansCopie.indexOf(name) >= 0) item.classList.add('sans-copie');

            // Single click = toggle absent
            item.addEventListener('click', function(e) {
                var idx = absentsEleves.indexOf(name);
                if (idx >= 0) {
                    absentsEleves.splice(idx, 1);
                    item.classList.remove('absent');
                } else {
                    absentsEleves.push(name);
                    item.classList.add('absent');
                    // Auto-mark sans copie when absent
                    if (elevesSansCopie.indexOf(name) < 0) {
                        elevesSansCopie.push(name);
                        item.classList.add('sans-copie');
                    }
                }
                syncRosterCounts();
            });

            // Double-click = toggle sans copie only
            item.addEventListener('dblclick', function(e) {
                e.preventDefault();
                var idx = elevesSansCopie.indexOf(name);
                if (idx >= 0) {
                    elevesSansCopie.splice(idx, 1);
                    item.classList.remove('sans-copie');
                } else {
                    elevesSansCopie.push(name);
                    item.classList.add('sans-copie');
                }
                syncRosterCounts();
            });

            rosterGrid.appendChild(item);
        });

        syncRosterCounts();
    }

    function syncRosterCounts() {
        // Sync absence count + text field
        absences = absentsEleves.length;
        document.getElementById('absCount').textContent = absences;
        document.getElementById('absencesNoms').value = absentsEleves.join(', ');

        // Update roster count badges
        var absLabel = document.getElementById('rosterAbsCount');
        var scLabel = document.getElementById('rosterSansCopieCount');
        if (absLabel) absLabel.textContent = absentsEleves.length ? (absentsEleves.length + ' absent(s)') : '';
        if (scLabel) scLabel.textContent = elevesSansCopie.length ? (elevesSansCopie.length + ' sans copie') : '';

        // Update "√©l√®ves sans cours"
        updateElevesSansCours();
    }

    function updateElevesSansCours() {
        var container = document.getElementById('elevesSansCours');
        var grid = document.getElementById('elevesSansCoursGrid');
        if (!container || !grid) return;

        // Show if there are students marked "sans copie"
        if (elevesSansCopie.length === 0) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        grid.innerHTML = '';
        elevesSansCopie.forEach(function(name) {
            var isAbsent = absentsEleves.indexOf(name) >= 0;
            var item = document.createElement('div');
            item.className = 'student-item no-cours';
            item.innerHTML = '<span>' + name + '</span><span style="font-size:.7em;margin-left:auto;">' +
                (isAbsent ? 'absent + sans copie' : 'sans copie') + '</span>';
            grid.appendChild(item);
        });
    }

    window.toggleValide = function() {
        isValide = !isValide;
        var el = document.getElementById('valideToggle');
        el.classList.toggle('checked', isValide);
        document.getElementById('valideIcon').textContent = isValide ? '‚òë' : '‚òê';
    };

    window.selectCps = function(dimension, value, btn) {
        var container = btn.parentElement;
        container.querySelectorAll('.cps-btn').forEach(function(b) { b.classList.remove('selected'); });
        if (cps[dimension] === value) {
            cps[dimension] = '';
        } else {
            btn.classList.add('selected');
            cps[dimension] = value;
        }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function saveLog() {
        var classeDocId = document.getElementById('selectClasse').value;
        var moduleAutreInp = document.getElementById('moduleAutreInput');
        var moduleId = (moduleAutreEnabled && moduleAutreInp && moduleAutreInp.value.trim())
            ? moduleAutreInp.value.trim()
            : document.getElementById('selectModule').value;

        // For special situations, only classe is required
        if (selectedSituation) {
            if (!classeDocId) { showToast('S√©lectionnez une classe'); return; }
        } else {
            if (!classeDocId || !moduleId) { showToast('S√©lectionnez classe et module'); return; }
            if (!selectedStatut) { showToast('S√©lectionnez le statut'); return; }
        }

        var btnSave = document.getElementById('btnSave');
        btnSave.disabled = true;
        btnSave.textContent = '‚è≥ Enregistrement...';

        var prevue = allPrevue.find(function(p) { return p.id === classeDocId; });
        var classeLabel = prevue ? prevue.classeId : classeDocId;
        var planifDate = planifEnabled ? document.getElementById('planifDate').value : '';
        var today = planifDate || paramDate || toISODateLocal(new Date());

        var data = {
            timestamp: serverTimestamp(),
            planification: planifEnabled ? { type: planifType, dateCible: planifDate } : null,
            date: today,
            room: room,
            classeDocId: classeDocId,
            classeId: classeLabel,
            moduleId: moduleId,
            phase: selectedPhase,
            moduleSuivant: moduleSuivantEnabled && selectedModuleSuivant ? {
                moduleId: selectedModuleSuivant,
                phase: selectedPhaseSuivant
            } : null,
            seance: selectedSeance,
            statut: selectedStatut,
            situation: selectedSituation || 'Normal',
            isValide: isValide,
            arret: document.getElementById('inputArret').value.trim(),
            checklist: (function() {
                var cl = Object.assign({}, checklist);
                // Save cours_seance as structured object if seance number selected
                if (cl.cours_seance && cl.cours_seance_num) {
                    cl.cours_seance = { distributed: true, seanceNum: cl.cours_seance_num };
                }
                delete cl.cours_seance_num; // don't save temp field
                return cl;
            })(),
            evalDiag: selectedEvalDiag || '',
            evalForm: selectedEvalForm || '',
            evalSomm: selectedEvalSomm || '',
            cps: Object.assign({}, cps),
            cpsMots: JSON.parse(JSON.stringify(cpsMots)),
            meteo: selectedMeteo || null,
            qualiteDim: JSON.parse(JSON.stringify(qualityData)),
            phases: (function() {
                var allP = selectedPhases.slice();
                var autreInp = document.getElementById('phaseAutreInput');
                if (autreInp && autreInp.style.display !== 'none' && autreInp.value) allP.push(autreInp.value);
                return allP;
            })(),
            seances: (function() {
                var allS = selectedSeances.slice();
                var autreInp = document.getElementById('seanceAutreInput');
                if (autreInp && autreInp.style.display !== 'none' && autreInp.value) allS.push(autreInp.value);
                return allS;
            })(),
            todos: selectedTodos.map(function(t) { return {action:t.action||'',label:t.label||'',note:document.getElementById('todoNote').value.trim()}; }),
            absentsEleves: absentsEleves.slice(),
            elevesSansCopie: elevesSansCopie.slice(),
            absences: absences,
            absencesNoms: document.getElementById('absencesNoms').value.trim(),
            qualite: selectedQualite,
            remarque: document.getElementById('remarque').value.trim(),
            todoNext: selectedTodo ? {
                action: selectedTodo.action,
                label: selectedTodo.label,
                note: document.getElementById('todoNote').value.trim(),
                reminderPronote: selectedTodo.reminderPronote || false,
                reminderType: selectedTodo.reminderType || ''
            } : {
                action: '',
                label: '',
                note: document.getElementById('todoNote').value.trim(),
                reminderPronote: false,
                reminderType: ''
            },
            userId: currentUser.uid
        };

        try {
            // UPSERT: m√™me docId par jour + classe = pas de doublon
            var docId = today + '_' + classeDocId;

            // Promise.race avec timeout 10s pour √©viter le blocage mobile
            var savePromise = setDoc(doc(db, 'progression_logs', docId), data);
            var timeoutPromise = new Promise(function(_, reject) {
                setTimeout(function() { reject(new Error('Timeout ‚Äî v√©rifiez votre connexion')); }, 10000);
            });
            await Promise.race([savePromise, timeoutPromise]);

            // Sync progression_prevue (timeout 5s, non bloquant)
            try {
                var syncTimeout = new Promise(function(_, reject) {
                    setTimeout(function() { reject(new Error('Sync timeout')); }, 5000);
                });
                await Promise.race([syncPrevue(classeDocId, selectedStatut, selectedSituation), syncTimeout]);
            } catch (syncErr) {
                console.warn('Prevue sync failed (log saved):', syncErr);
            }

            btnSave.textContent = '‚úÖ Enregistr√© !';
            btnSave.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            showToast('‚úÖ Enregistr√© !');
            setTimeout(function() { window.location.href = 'index.html'; }, 1500);
        } catch (err) {
            console.error('Save error:', err);
            btnSave.textContent = '‚ùå Erreur ‚Äî r√©essayer';
            btnSave.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            showToast('‚ùå Erreur : ' + err.message);
            setTimeout(function() {
                btnSave.disabled = false;
                btnSave.textContent = 'üíæ ENREGISTRER';
                btnSave.style.background = '';
            }, 3000);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MISSED CLASSES CHECK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function checkMissedClasses(todayStr, now) {
        if (pronoteEvents.length === 0) return;

        // Get today's past events
        var pastEvents = [];
        pronoteEvents.forEach(function(ev) {
            if (!ev.start || !ev.classe) return;
            var evDate = new Date(ev.start);
            var evEnd = ev.end ? new Date(ev.end) : null;
            var evDateStr = toISODateLocal(evDate);
            if (evDateStr !== todayStr) return;
            // Only past events (ended more than 5 min ago)
            if (evEnd && now.getTime() - evEnd.getTime() > 5 * 60000) {
                pastEvents.push(ev);
            }
        });

        if (pastEvents.length === 0) return;

        // Load today's logs
        var todayLogs = [];
        try {
            var logsSnap = await getDocs(collection(db, 'progression_logs'));
            logsSnap.forEach(function(d) {
                var data = d.data();
                if (data.date === todayStr) todayLogs.push(data);
            });
        } catch (e) { return; }

        // Find events without matching logs
        var missed = [];
        pastEvents.forEach(function(ev) {
            var hasLog = todayLogs.some(function(log) {
                return ev.classe && log.classeId && classesMatch(ev.classe, log.classeId);
            });
            if (!hasLog) missed.push(ev);
        });

        if (missed.length === 0) return;

        // Show reminders
        var container = document.getElementById('missedReminder');
        container.style.display = 'block';
        container.innerHTML = '';

        missed.forEach(function(ev) {
            var startDate = new Date(ev.start);
            var endDate = ev.end ? new Date(ev.end) : null;
            var heure = startDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            var heureFin = endDate ? endDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '';

            var banner = document.createElement('div');
            banner.className = 'missed-banner';
            banner.innerHTML =
                '<div class="missed-title">‚ö†Ô∏è S√©ance non saisie ‚Äî ' + heure + (heureFin ? '‚Üí' + heureFin : '') + '</div>' +
                '<div class="missed-detail">' + ev.classe + ' ‚Äî ' + ev.summary +
                (ev.location ? ' (Salle ' + ev.location + ')' : '') +
                '<br>Appuyez pour saisir cette s√©ance</div>';

            banner.addEventListener('click', function() {
                // Pre-fill the form with this missed class
                selectClasseFromDetected(ev.classe);
                // Highlight the banner as selected
                container.querySelectorAll('.missed-banner').forEach(function(b) {
                    b.style.opacity = '0.4';
                });
                banner.style.opacity = '1';
                banner.style.borderColor = '#22c55e';
                banner.style.background = '#dcfce7';
                banner.querySelector('.missed-title').textContent = '‚úÖ S√©lectionn√© ‚Äî ' + heure + (heureFin ? '‚Üí' + heureFin : '');
                // Scroll to form
                document.getElementById('selectClasse').scrollIntoView({ behavior: 'smooth', block: 'center' });
            });

            container.appendChild(banner);
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QR SCANNER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let html5QrCode = null;
    let scannerRunning = false;

    window.toggleQrScanner = async function() {
        var btnScan = document.getElementById('btnScan');
        var readerDiv = document.getElementById('qrReader');

        if (scannerRunning) {
            stopQrScanner();
            return;
        }

        // Load html5-qrcode library dynamically if not already loaded
        if (typeof Html5Qrcode === 'undefined') {
            try {
                await new Promise(function(resolve, reject) {
                    var script = document.createElement('script');
                    script.src = 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            } catch (e) {
                showToast('Erreur chargement scanner');
                return;
            }
        }

        readerDiv.style.display = 'block';
        btnScan.innerHTML = '‚èπ Arr√™ter la cam√©ra';
        btnScan.classList.add('scanning');
        scannerRunning = true;

        html5QrCode = new Html5Qrcode('qrReader');
        try {
            await html5QrCode.start(
                { facingMode: 'environment' },
                { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 },
                onQrCodeScanned,
                function() {} // ignore scan failures
            );
        } catch (err) {
            showToast('Cam√©ra non disponible');
            stopQrScanner();
        }
    };

    function onQrCodeScanned(decodedText) {
        // Stop the scanner
        stopQrScanner();

        var resultDiv = document.getElementById('qrResult');
        resultDiv.style.display = 'block';
        resultDiv.textContent = 'üîÑ Synchronisation emploi du temps...';
        resultDiv.style.background = '#fef3c7';
        resultDiv.style.borderColor = '#f59e0b';
        resultDiv.style.color = '#92400e';

        try {
            var url = new URL(decodedText);
            var qrRoom = url.searchParams.get('room') || '';

            // Update room badge
            if (qrRoom) {
                document.getElementById('roomBadge').style.display = 'block';
                document.getElementById('roomNum').textContent = qrRoom;
            }

            // Detect current class based on Pronote + time + room
            var detection = detectCurrentClass(qrRoom);

            if (detection.classe) {
                // Success: class detected
                var msg = '‚úÖ ' + detection.classe;
                if (detection.location) msg += ' ‚Äî Salle ' + detection.location;
                if (detection.summary) msg += '\nüìö ' + detection.summary;
                resultDiv.textContent = msg;
                resultDiv.style.background = '#dcfce7';
                resultDiv.style.borderColor = '#16a34a';
                resultDiv.style.color = '#166534';
                showToast('Classe d√©tect√©e !');

                // Scroll to the form
                document.getElementById('selectClasse').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                // No class found
                resultDiv.textContent = '‚ö†Ô∏è Aucun cours d√©tect√© pour cette heure';
                resultDiv.style.background = '#fef3c7';
                resultDiv.style.borderColor = '#f59e0b';
                resultDiv.style.color = '#92400e';
                showToast('Pas de cours en ce moment');
            }
        } catch (e) {
            resultDiv.textContent = 'üìé ' + decodedText;
            resultDiv.style.background = '';
            resultDiv.style.borderColor = '';
            resultDiv.style.color = '';
        }
    }

    function stopQrScanner() {
        var btnScan = document.getElementById('btnScan');
        var readerDiv = document.getElementById('qrReader');

        if (html5QrCode && scannerRunning) {
            html5QrCode.stop().then(function() {
                html5QrCode.clear();
            }).catch(function() {});
        }

        readerDiv.style.display = 'none';
        btnScan.innerHTML = 'üì∑ Scanner un QR code';
        btnScan.classList.remove('scanning');
        scannerRunning = false;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE DELAY DETECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function checkModuleDelay(classeDocId) {
        var contextDate = getContextDateISO();
        var weekInfo = findWeekByDate(classeDocId, contextDate) || findCurrentWeekPrevue(classeDocId, contextDate);
        if (!weekInfo) return;
        var currentWeek = weekInfo.week;

        var prevue = allPrevue.find(function(p) { return p.id === classeDocId; });
        if (!prevue) return;

        // Get latest log for this class
        var classeLabel = prevue.classeId;
        var logsSnap = null;
        try {
            logsSnap = await getDocs(collection(db, 'progression_logs'));
        } catch (e) { return; }

        var classLogs = [];
        logsSnap.forEach(function(d) {
            var data = d.data();
            if (data.classeId === classeLabel || data.classeDocId === classeDocId) {
                classLogs.push(data);
            }
        });

        if (classLogs.length === 0) return;

        classLogs.sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });
        var lastLog = classLogs[0];

        // Compare expected module/seance vs last logged
        var expectedModule = currentWeek.module || '';
        var expectedSeance = currentWeek.seance || '';
        var lastModule = lastLog.moduleId || '';
        var lastSeance = lastLog.seance || '';

        if (!expectedModule || expectedModule === 'N/A') return;

        // Determine if there's a delay
        var delayInfo = '';
        if (extractModuleId(lastModule) !== extractModuleId(expectedModule)) {
            delayInfo = 'Module pr√©vu : <strong>' + expectedModule + '</strong><br>' +
                'Dernier module logu√© : <strong>' + lastModule + '</strong>';
        } else if (expectedSeance && lastSeance && expectedSeance !== 'N/A') {
            // Same module, check seance progression
            var expectedNum = parseInt(expectedSeance.replace(/[^\d]/g, '')) || 0;
            var lastNum = parseInt(lastSeance.replace(/[^\d]/g, '')) || 0;
            if (lastNum < expectedNum - 1) {
                delayInfo = 'S√©ance pr√©vue : <strong>' + expectedSeance + '</strong><br>' +
                    'Derni√®re s√©ance logu√©e : <strong>' + lastSeance + '</strong>';
            }
        }

        if (!delayInfo) return;

        // Show delay alert
        var infoDiv = document.getElementById('lastLogInfo');
        infoDiv.style.display = 'block';
        infoDiv.innerHTML = infoDiv.innerHTML +
            '<div style="margin-top:10px;padding:10px;border-radius:8px;background:#fef3c7;border:1px solid #f59e0b;font-size:0.82em;">' +
            '<strong style="color:#92400e;">‚ö†Ô∏è Retard d√©tect√©</strong><br>' +
            '<span style="color:#78350f;">' + delayInfo + '</span>' +
            '</div>';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showToast(msg) {
        var t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(function() { t.classList.remove('show'); }, 2500);
    }

    // ‚îÄ‚îÄ NOUVELLES VARIABLES D'√âTAT ‚îÄ‚îÄ
    let selectedPhases = [];
    let phaseAutreText = '';
    let selectedSeances = [];
    let seanceAutreText = '';
    let moduleAutreEnabled = false;
    let qualityData = {};
    let cpsMots = { cognitif: [], emotionnel: [], social: [] };
    let selectedMeteo = null;
    let selectedTodos = [];
    let absentsEleves = [];
    let elevesSansCopie = [];
    let distribSeances = [];
    let absCoursEleves = [];

    // ‚îÄ‚îÄ TOGGLE PHASE (multi-select) ‚îÄ‚îÄ
    window.togglePhase = function(phase, btn) {
        // Remplace la s√©lection unique par multi
        var idx = selectedPhases.indexOf(phase);
        if (idx >= 0) { selectedPhases.splice(idx,1); btn.classList.remove('selected'); }
        else { selectedPhases.push(phase); btn.classList.add('selected'); }
        // Compatibilit√© avec l'ancien selectedPhase
        selectedPhase = selectedPhases[0] || 'cours';
    };

    // ‚îÄ‚îÄ TOGGLE PHASE SUIVANT ‚îÄ‚îÄ
    window.togglePhaseSuivant2 = function(phase, btn) {
        document.querySelectorAll('#phaseSuivantGrid .chip').forEach(function(b) { b.classList.remove('selected'); });
        btn.classList.add('selected');
        selectedPhaseSuivant = phase;
    };

    // ‚îÄ‚îÄ QUALIT√â √âTENDUE ‚îÄ‚îÄ
    window.toggleQualityDim = function(dim, val, btn) {
        var container = btn.closest('.quality-chips');
        if (qualityData[dim] === val) {
            qualityData[dim] = '';
            btn.classList.remove('selected');
        } else {
            container.querySelectorAll('.q-chip').forEach(function(b) { b.classList.remove('selected'); });
            qualityData[dim] = val;
            btn.classList.add('selected');
        }
    };

    // ‚îÄ‚îÄ M√âT√âO GLOBALE ‚îÄ‚îÄ
    window.selectMeteo = function(emoji, label, btn) {
        document.querySelectorAll('.meteo-btn').forEach(function(b) { b.classList.remove('selected'); });
        btn.classList.add('selected');
        selectedMeteo = { emoji: emoji, label: label };
    };

    // ‚îÄ‚îÄ CPS MOTS-CL√âS ‚îÄ‚îÄ
    window.toggleCpsMot = function(dim, mot, btn) {
        var arr = cpsMots[dim];
        var idx = arr.indexOf(mot);
        if (idx >= 0) { arr.splice(idx,1); btn.classList.remove('selected'); }
        else { arr.push(mot); btn.classList.add('selected'); }
    };

    // ‚îÄ‚îÄ MODULE AUTRE ‚îÄ‚îÄ
    function initModuleAutreToggle() {
        var toggle = document.getElementById('moduleAutreToggle');
        if (!toggle) return;
        toggle.addEventListener('click', function() {
            moduleAutreEnabled = !moduleAutreEnabled;
            toggle.classList.toggle('active', moduleAutreEnabled);
            document.getElementById('moduleAutreIcon').textContent = moduleAutreEnabled ? '‚òë' : '‚òê';
            var inp = document.getElementById('moduleAutreInput');
            var sel = document.getElementById('selectModule');
            inp.style.display = moduleAutreEnabled ? 'block' : 'none';
            sel.style.opacity = moduleAutreEnabled ? '0.4' : '1';
            if (moduleAutreEnabled) inp.focus();
        });
    }

    // ‚îÄ‚îÄ HISTORIQUE TOP ‚îÄ‚îÄ
    function showHistoryTop(classeDocId, classeLabel) {
        var topCard = document.getElementById('historyTopCard');
        var lastBanner = document.getElementById('lastLogBannerNew');
        var remindersBanner = document.getElementById('remindersBannerNew');
        var shortList = document.getElementById('historyShortListNew');
        if (!topCard || !currentClassLogs || currentClassLogs.length === 0) {
            if (topCard) topCard.style.display = 'none';
            return;
        }
        topCard.style.display = 'block';
        document.getElementById('historyClasseLabel').textContent = classeLabel;
        var last = currentClassLogs[0];
        var seancesL = Array.isArray(last.seances) ? last.seances.join(' + ') : (last.seance || '');
        var phases = Array.isArray(last.phases) ? last.phases.join('+') : (last.phase || '');
        var meteo = last.meteo ? last.meteo.emoji + ' ' : '';
        lastBanner.innerHTML = '<div class="history-compact"><div class="history-compact-header">' +
            '<span class="history-compact-date">' + (last.date||'') + '</span>' +
            '<span class="history-compact-statut">' + (last.statut||'') + ' ' + meteo + '</span>' +
            '</div><div class="history-compact-detail">' +
            (last.moduleId||'') + ' ‚Äî ' + seancesL + (phases?' ['+phases+']':'') +
            (last.arret ? '<br>üìç Arr√™t : <em>' + last.arret + '</em>' : '') +
            '</div></div>';

        // Reminders
        var remHtml = '';
        var cl = last.checklist || {};
        if (cl.copies_ramassees && !cl.copies_corrigees) remHtml += '<div class="banner banner-warn"><div class="banner-title">üìù Copies √† corriger</div></div>';
        if (cl.copies_corrigees && !cl.copies_rendues) remHtml += '<div class="banner banner-warn"><div class="banner-title">üì§ Copies √† rendre</div></div>';
        if (cl.eval_corrigee && !cl.eval_rendue) remHtml += '<div class="banner banner-warn"><div class="banner-title">üì§ √âvaluation √† rendre</div></div>';
        if (last.todos && Array.isArray(last.todos)) {
            last.todos.forEach(function(t) {
                remHtml += '<div class="banner banner-info"><div class="banner-title">üìå ' + (t.label||t) + '</div>' +
                    (t.note ? '<div class="banner-detail">'+t.note+'</div>' : '') + '</div>';
            });
        } else if (last.todoNext && last.todoNext.label) {
            remHtml += '<div class="banner banner-info"><div class="banner-title">üìå ' + last.todoNext.label + '</div>' +
                (last.todoNext.note ? '<div class="banner-detail">'+last.todoNext.note+'</div>' : '') + '</div>';
        }
        remindersBanner.innerHTML = remHtml;

        // Short history
        shortList.innerHTML = '';
        currentClassLogs.slice(1,4).forEach(function(log) {
            var d = document.createElement('div');
            d.className = 'history-compact';
            var sl = Array.isArray(log.seances)?log.seances.join('+'):(log.seance||'');
            var m = log.meteo ? log.meteo.emoji : '';
            d.innerHTML = '<div class="history-compact-header"><span class="history-compact-date">'+
                (log.date||'')+'</span><span class="history-compact-statut">'+(log.statut||'')+' '+m+
                '</span></div><div class="history-compact-detail">'+(log.moduleId||'')+' ‚Äî '+sl+'</div>';
            shortList.appendChild(d);
        });
        var toggleBtn = document.getElementById('historyToggleBtnNew');
        if (currentClassLogs.length > 4) {
            toggleBtn.style.display = 'block';
            toggleBtn.textContent = '‚ñº Voir tout (' + currentClassLogs.length + ' s√©ances)';
        } else { toggleBtn.style.display = 'none'; }
    }

    window.toggleFullHistoryNew = function() {
        var full = document.getElementById('historyFullListNew');
        var btn = document.getElementById('historyToggleBtnNew');
        if (full.style.display === 'none') {
            full.innerHTML = '';
            currentClassLogs.slice(4).forEach(function(log) {
                var d = document.createElement('div');
                d.className = 'history-compact';
                var sl = Array.isArray(log.seances)?log.seances.join('+'):(log.seance||'');
                d.innerHTML = '<div class="history-compact-header"><span class="history-compact-date">'+(log.date||'')+'</span><span class="history-compact-statut">'+(log.statut||'')+'</span></div><div class="history-compact-detail">'+(log.moduleId||'')+' ‚Äî '+sl+'</div>';
                full.appendChild(d);
            });
            full.style.display = 'block';
            btn.textContent = '‚ñ≤ R√©duire';
        } else { full.style.display='none'; btn.textContent='‚ñº Voir tout ('+currentClassLogs.length+' s√©ances)'; }
    };

    // ‚îÄ‚îÄ UPSERT SAVE (pas de doublon par jour) ‚îÄ‚îÄ
    // Surcharge de la fonction saveLog pour changer le docId
    const _originalSaveLog = typeof saveLog !== 'undefined' ? saveLog : null;

</script>
</body>
</html>
