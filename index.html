<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cockpit Progression PSE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-2: #334155;
            --border: #334155;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: rgba(99,102,241,0.15);
            --success: #10b981;
            --success-light: rgba(16,185,129,0.15);
            --warning: #f59e0b;
            --warning-light: rgba(245,158,11,0.15);
            --danger: #ef4444;
            --danger-light: rgba(239,68,68,0.15);
            --pfmp: #8b5cf6;
            --pfmp-light: rgba(139,92,246,0.15);
            --radius: 14px;
            --font: 'DM Sans', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        /* ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê */
        .login-screen {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; min-height: 100vh; gap: 24px; padding: 24px;
        }
        .login-logo { font-size: 48px; }
        .login-title { font-size: 28px; font-weight: 800; }
        .login-sub { color: var(--muted); text-align: center; font-size: 15px; }
        .btn-google {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 28px; background: var(--surface); border: 1px solid var(--border);
            border-radius: var(--radius); color: var(--text);
            font-family: var(--font); font-size: 16px; font-weight: 600; cursor: pointer;
            transition: background 0.2s;
        }
        .btn-google:hover { background: var(--surface-2); }
        .btn-google svg { flex-shrink: 0; }

        /* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
        .header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 20px; border-bottom: 1px solid var(--border);
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-left h1 { font-size: 18px; font-weight: 700; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .header-btn {
            width: 40px; height: 40px; border-radius: 10px; border: none;
            background: var(--surface); color: var(--muted); font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .header-btn:hover { background: var(--surface-2); color: var(--text); }
        .user-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            border: 2px solid var(--border);
        }

        /* ‚ïê‚ïê‚ïê WEEK NAV ‚ïê‚ïê‚ïê */
        .week-nav {
            display: flex; align-items: center; justify-content: center;
            gap: 12px; padding: 16px 20px;
            flex-wrap: wrap;
        }
        .week-nav-btn {
            width: 36px; height: 36px; border-radius: 10px; border: none;
            background: var(--surface); color: var(--text); font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.15s;
        }
        .week-nav-btn:hover { background: var(--surface-2); }
        .week-label { font-size: 16px; font-weight: 600; text-align: center; min-width: 260px; }
        .week-label small { display: block; font-size: 12px; font-weight: 500; color: var(--muted); margin-top: 2px; }
        .badge-ab {
            display: inline-block; padding: 3px 10px; border-radius: 8px;
            font-size: 12px; font-weight: 700; margin-left: 8px;
        }
        .badge-sa { background: rgba(99,102,241,0.2); color: #818cf8; }
        .badge-sb { background: rgba(16,185,129,0.2); color: #34d399; }
        .btn-today {
            padding: 8px 16px; border-radius: 10px; border: none;
            background: var(--primary-light); color: var(--primary);
            font-family: var(--font); font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.15s;
        }
        .btn-today:hover { background: var(--primary); color: #fff; }

        /* ‚ïê‚ïê‚ïê WEEK GRID ‚ïê‚ïê‚ïê */
        .week-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 0 12px 120px 12px;
            min-height: 400px;
        }
        @media (max-width: 700px) {
            .week-grid {
                grid-template-columns: repeat(5, minmax(140px, 1fr));
                overflow-x: auto;
            }
        }
        .day-col { min-width: 0; }
        .day-header {
            text-align: center; padding: 10px 4px;
            font-size: 13px; font-weight: 600; color: var(--muted);
            border-bottom: 2px solid var(--border);
            margin-bottom: 8px;
        }
        .day-header.today { color: var(--primary); border-bottom-color: var(--primary); }
        .day-header .day-name { text-transform: uppercase; letter-spacing: 0.5px; font-size: 11px; }
        .day-header .day-date { font-size: 22px; font-weight: 800; color: var(--text); margin-top: 2px; }
        .day-header.today .day-date { color: var(--primary); }

        /* ‚ïê‚ïê‚ïê COURSE BLOCKS ‚ïê‚ïê‚ïê */
        .course-block {
            border-radius: 12px; padding: 12px;
            margin-bottom: 8px; cursor: pointer;
            transition: all 0.15s; position: relative;
            border: 1px solid transparent;
            min-height: 80px;
        }
        .course-block:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .course-block:active { transform: translateY(0); }
        .course-block.no-click { cursor: default; opacity: 0.7; }
        .course-block.no-click:hover { transform: none; box-shadow: none; }

        .cb-heure { font-size: 11px; font-weight: 600; opacity: 0.8; margin-bottom: 4px; }
        .cb-classe { font-size: 15px; font-weight: 700; margin-bottom: 3px; }
        .cb-module { font-size: 12px; opacity: 0.85; line-height: 1.3; }
        .cb-status { font-size: 11px; margin-top: 6px; font-weight: 600; opacity: 0.9; }
        .cb-badge-alt {
            position: absolute; top: 6px; right: 8px;
            font-size: 10px; font-weight: 700; padding: 1px 6px;
            border-radius: 4px; background: rgba(255,255,255,0.15);
        }

        /* Block colors */
        .cb-realise   { background: #10b981; color: #fff; }
        .cb-reporte   { background: #f59e0b; color: #fff; }
        .cb-non-real  { background: #dc2626; color: #fff; }
        .cb-annule    { background: #6b7280; color: #fff; }
        .cb-a-saisir  { background: var(--primary); color: #fff; border: 2px dashed rgba(255,255,255,0.3); }
        .cb-planifie  { background: #818cf8; color: #fff; }
        .cb-vide      { background: var(--surface); color: var(--muted); border: 1px solid var(--border); }
        .cb-pfmp      { background: var(--pfmp); color: #fff; }
        .cb-vacances  { background: #374151; color: #9ca3af; }
        .cb-ferie     { background: #4b5563; color: #9ca3af; }

        /* ‚ïê‚ïê‚ïê VACANCES BANNER ‚ïê‚ïê‚ïê */
        .vacances-banner {
            grid-column: 1 / -1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 40px 20px;
            text-align: center;
            color: var(--muted);
            font-size: 16px;
        }
        .vacances-banner .emoji { font-size: 36px; margin-bottom: 8px; display: block; }

        /* ‚ïê‚ïê‚ïê ALERTS BAR ‚ïê‚ïê‚ïê */
        .alerts-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 12px 20px;
            display: flex; align-items: center; gap: 16px;
            overflow-x: auto; white-space: nowrap;
            z-index: 100;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .alert-chip {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 8px;
            font-size: 12px; font-weight: 600;
            flex-shrink: 0;
        }
        .alert-chip.urgent { background: var(--danger-light); color: var(--danger); }
        .alert-chip.warn { background: var(--warning-light); color: var(--warning); }
        .alert-chip.info { background: var(--primary-light); color: var(--primary); }

        /* ‚ïê‚ïê‚ïê NAV LINKS ‚ïê‚ïê‚ïê */
        .nav-links {
            display: flex; gap: 8px; padding: 0 20px 12px;
            justify-content: center;
        }
        .nav-link {
            padding: 8px 16px; border-radius: 10px;
            background: var(--surface); border: 1px solid var(--border);
            color: var(--muted); text-decoration: none;
            font-size: 13px; font-weight: 500;
            transition: all 0.15s;
        }
        .nav-link:hover { color: var(--text); background: var(--surface-2); }

        /* ‚ïê‚ïê‚ïê MODAL DETAIL ‚ïê‚ïê‚ïê */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.7); z-index: 1000;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px;
            max-width: 480px; width: 100%; max-height: 80vh; overflow-y: auto;
        }
        .modal-box h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
        .modal-close {
            float: right; background: none; border: none; color: var(--muted);
            font-size: 20px; cursor: pointer; padding: 4px;
        }
        .modal-close:hover { color: var(--text); }
        .detail-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid var(--border);
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-size: 13px; color: var(--muted); }
        .detail-value { font-size: 14px; font-weight: 600; }

        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal {
            flex: 1; padding: 12px; border: none; border-radius: 10px;
            font-family: var(--font); font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.15s; text-decoration: none;
            text-align: center;
        }
        .btn-modal.primary { background: var(--primary); color: #fff; }
        .btn-modal.primary:hover { background: var(--primary-hover); }
        .btn-modal.secondary { background: var(--surface-2); color: var(--text); }

        /* ‚ïê‚ïê‚ïê SETTINGS MODAL ‚ïê‚ïê‚ïê */
        .settings-modal .modal-box { max-width: 600px; }
        .settings-tabs {
            display: flex; gap: 4px; margin-bottom: 16px;
            background: var(--bg); border-radius: 10px; padding: 4px;
        }
        .settings-tab {
            flex: 1; padding: 8px 12px; border: none; border-radius: 8px;
            background: transparent; color: var(--muted);
            font-family: var(--font); font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.15s;
        }
        .settings-tab.active { background: var(--surface-2); color: var(--text); }
        .settings-section { display: none; }
        .settings-section.active { display: block; }

        /* Import zone */
        .import-zone {
            border: 2px dashed var(--border); border-radius: var(--radius);
            padding: 30px 20px; text-align: center; cursor: pointer;
            transition: all 0.2s; margin-bottom: 12px;
        }
        .import-zone:hover, .import-zone.dragover {
            border-color: var(--primary); background: var(--primary-light);
        }
        .import-zone .icon { font-size: 32px; margin-bottom: 8px; }
        .import-zone p { color: var(--muted); font-size: 13px; }
        .import-progress { margin-top: 12px; }
        .import-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; background: var(--bg); border-radius: 8px;
            margin-bottom: 4px; font-size: 13px;
        }
        .import-item .status.ok { color: var(--success); }
        .import-item .status.err { color: var(--danger); }

        /* Sync section */
        .btn-sync {
            display: flex; align-items: center; gap: 8px;
            padding: 12px 20px; background: var(--primary-light); color: var(--primary);
            border: 1px solid var(--primary); border-radius: var(--radius);
            font-family: var(--font); font-size: 14px; font-weight: 600;
            cursor: pointer; width: 100%; justify-content: center;
            transition: all 0.15s;
        }
        .btn-sync:hover { background: var(--primary); color: #fff; }
        .btn-sync:disabled { opacity: 0.5; cursor: not-allowed; }
        .sync-status { margin-top: 10px; font-size: 13px; color: var(--muted); }

        /* QR section */
        .qr-card {
            text-align: center; padding: 20px;
            background: var(--bg); border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        .qr-card h4 { font-size: 14px; margin-bottom: 4px; }
        .qr-card .qr-sub { font-size: 12px; color: var(--muted); margin-bottom: 12px; }
        .qr-card img { border-radius: 8px; background: #fff; padding: 8px; }
        .qr-card .qr-url { font-size: 10px; color: var(--muted); word-break: break-all; margin-top: 8px; }
        .btn-print {
            margin-top: 10px; padding: 8px 16px; border: 1px solid var(--border);
            border-radius: 8px; background: var(--surface); color: var(--text);
            font-family: var(--font); font-size: 12px; cursor: pointer;
        }

        /* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: var(--surface-2); color: var(--text);
            padding: 12px 24px; border-radius: 10px;
            font-size: 14px; font-weight: 600;
            opacity: 0; transition: all 0.3s; pointer-events: none;
            z-index: 2000;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ‚ïê‚ïê‚ïê HIDDEN ‚ïê‚ïê‚ïê */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê -->
<div class="login-screen" id="loginScreen">
    <div class="login-logo">üìä</div>
    <div class="login-title">CockpitPSE</div>
    <div class="login-sub">Pilotage de progression ‚Äî PSE</div>
    <button class="btn-google" id="btnGoogle">
        <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        Connexion Google
    </button>
</div>

<!-- ‚ïê‚ïê‚ïê MAIN SCREEN ‚ïê‚ïê‚ïê -->
<div id="mainScreen" style="display:none;">

    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <h1>üìä CockpitPSE</h1>
        </div>
        <div class="header-right">
            <button class="header-btn" id="btnSettings" title="Param√®tres">‚öôÔ∏è</button>
            <button class="header-btn" id="btnLogout" title="D√©connexion">üö™</button>
            <img class="user-avatar hidden" id="userPhoto" src="" alt="">
        </div>
    </div>

    <!-- WEEK NAV -->
    <div class="week-nav">
        <button class="week-nav-btn" id="btnPrev" title="Semaine pr√©c√©dente">‚óÄ</button>
        <div class="week-label" id="weekLabel">
            Chargement...
            <small id="weekDates"></small>
        </div>
        <button class="week-nav-btn" id="btnNext" title="Semaine suivante">‚ñ∂</button>
        <button class="btn-today" id="btnToday">Aujourd'hui</button>
    </div>

    <!-- NAV LINKS -->
    <div class="nav-links">
        <a href="log.html" class="nav-link">‚úèÔ∏è Saisie rapide</a>
        <a href="dashboard.html" class="nav-link">üìà Dashboard</a>
        <a href="init.html" class="nav-link">üöÄ Init</a>
    </div>

    <!-- WEEK GRID -->
    <div class="week-grid" id="weekGrid">
        <!-- Generated dynamically -->
    </div>

    <!-- ALERTS BAR -->
    <div class="alerts-bar" id="alertsBar" style="display:none;">
        <!-- Generated dynamically -->
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê DETAIL MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="detailModal">
    <div class="modal-box">
        <button class="modal-close" onclick="closeDetailModal()">&times;</button>
        <h3 id="detailTitle">D√©tail</h3>
        <div id="detailContent"></div>
        <div class="modal-actions" id="detailActions"></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê SETTINGS MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay settings-modal" id="settingsModal">
    <div class="modal-box">
        <button class="modal-close" onclick="closeSettings()">&times;</button>
        <h3>‚öôÔ∏è Param√®tres</h3>
        <div class="settings-tabs">
            <button class="settings-tab active" data-stab="import">üì• Import CSV</button>
            <button class="settings-tab" data-stab="pronote">üìÖ Pronote</button>
            <button class="settings-tab" data-stab="qr">üì± QR Code</button>
        </div>
        <div class="settings-section active" id="stabImport">
            <div class="import-zone" id="importZone">
                <div class="icon">üìÇ</div>
                <p>Glissez vos CSV ici ou cliquez pour s√©lectionner</p>
                <input type="file" id="fileInput" accept=".csv,.txt" multiple style="display:none;">
            </div>
            <div class="import-progress" id="importProgress"></div>
        </div>
        <div class="settings-section" id="stabPronote">
            <p style="color:var(--muted);font-size:13px;margin-bottom:12px;">Synchroniser l'emploi du temps depuis Pronote (iCal)</p>
            <button class="btn-sync" id="btnSync">üîÑ Synchroniser Pronote</button>
            <div class="sync-status" id="syncStatus"></div>
        </div>
        <div class="settings-section" id="stabQr">
            <div class="qr-card" id="qrCard"></div>
        </div>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, serverTimestamp }
        from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut }
        from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import {
        FIREBASE_CONFIG, EDT, VACANCES, FERIES, ABSENCES_PERSO, PFMP,
        CLASS_GROUPS, CLASS_ALIAS_GROUPS, ALL_CLASSES,
        getLundi, getSemaineType, coursSePasse, formatDateISO, formatDateCourt,
        formatSemaineLabel, isVacances, isFerie, isAbsencePerso, isPFMP,
        classesMatch, normalizeClass, getCoursForDay, MOIS, MOIS_COURTS,
        BLOC_COLORS, cleanModuleName, CLASSES_CONFIG, MODULES_PSE, ANNEE_SCOLAIRE
    } from './assets/utils.js';

    // ‚ïê‚ïê‚ïê FIREBASE ‚ïê‚ïê‚ïê
    const app = initializeApp(FIREBASE_CONFIG);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
    let currentUser = null;
    let currentMonday = getLundi(new Date());
    let allPrevue = [];
    let allLogs = [];
    let unsubPrevue = null;
    let unsubLogs = null;

    // ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            if (user.photoURL) {
                const photo = document.getElementById('userPhoto');
                photo.src = user.photoURL;
                photo.classList.remove('hidden');
            }
            loadAllData();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
        }
    });

    document.getElementById('btnGoogle').addEventListener('click', async () => {
        try {
            await signInWithPopup(auth, googleProvider);
        } catch (e) {
            // Ignore user-initiated cancellations silently
            const ignoreCodes = [
                'auth/popup-closed-by-user',
                'auth/cancelled-popup-request',
                'auth/user-cancelled'
            ];
            if (ignoreCodes.includes(e.code)) {
                console.log('Auth popup cancelled by user');
                return;
            }
            // Popup blocked ‚Üí fallback to redirect
            if (e.code === 'auth/popup-blocked' || e.code === 'auth/internal-error') {
                try { await signInWithRedirect(auth, googleProvider); }
                catch (redirectErr) { console.error('Redirect auth error:', redirectErr); }
                return;
            }
            console.error('Auth error:', e);
            showToast('‚ùå Erreur connexion');
        }
    });

    // Handle redirect result (silently ‚Äî don't block navigation)
    getRedirectResult(auth).then(result => {
        if (result && result.user) console.log('Redirect auth OK:', result.user.email);
    }).catch(err => {
        // Never block ‚Äî just log
        if (err.code !== 'auth/popup-closed-by-user') {
            console.warn('Redirect result error (non-bloquant):', err.code);
        }
    });

    document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

    // ‚ïê‚ïê‚ïê LOAD DATA ‚ïê‚ïê‚ïê
    function loadAllData() {
        if (unsubPrevue) { unsubPrevue(); }
        if (unsubLogs) { unsubLogs(); }

        unsubPrevue = onSnapshot(collection(db, 'progression_prevue'), (snap) => {
            allPrevue = [];
            snap.forEach(d => allPrevue.push({ id: d.id, ...d.data() }));
            allPrevue.sort((a, b) => a.classeId.localeCompare(b.classeId));
            renderWeek();
        }, err => console.error('prevue error:', err));

        unsubLogs = onSnapshot(collection(db, 'progression_logs'), (snap) => {
            allLogs = [];
            snap.forEach(d => allLogs.push({ id: d.id, ...d.data() }));
            renderWeek();
        }, err => console.error('logs error:', err));

        loadPronoteEdt();
    }

    // ‚ïê‚ïê‚ïê WEEK NAVIGATION ‚ïê‚ïê‚ïê
    document.getElementById('btnPrev').addEventListener('click', () => {
        currentMonday = new Date(currentMonday);
        currentMonday.setDate(currentMonday.getDate() - 7);
        renderWeek();
    });
    document.getElementById('btnNext').addEventListener('click', () => {
        currentMonday = new Date(currentMonday);
        currentMonday.setDate(currentMonday.getDate() + 7);
        renderWeek();
    });
    document.getElementById('btnToday').addEventListener('click', () => {
        currentMonday = getLundi(new Date());
        renderWeek();
    });

    // ‚ïê‚ïê‚ïê GROUP CONCURRENT COURSES (C1VAN + C2VAN same slot) ‚ïê‚ïê‚ïê
    function groupConcurrentCourses(courses) {
        const groups = {};
        courses.forEach(c => {
            if (c.type === 'chef_oeuvre') {
                groups['__co_' + c.heure] = [c];
                return;
            }
            const key = c.heure + '|' + (c.heureFin || '') + '|' + (c.salle || '');
            if (!groups[key]) groups[key] = [];
            groups[key].push(c);
        });
        const result = [];
        Object.values(groups).forEach(group => {
            if (group.length === 1) {
                result.push(group[0]);
            } else {
                const merged = Object.assign({}, group[0]);
                merged.classe = group.map(c => c.classe).join(' + ');
                merged._grouped = true;
                merged._classes = group.map(c => c.classe);
                result.push(merged);
            }
        });
        result.sort((a, b) => a.heure.localeCompare(b.heure));
        return result;
    }

    // ‚ïê‚ïê‚ïê RENDER WEEK VIEW ‚ïê‚ïê‚ïê
    function renderWeek() {
        const grid = document.getElementById('weekGrid');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayISO = formatDateISO(today);
        const semType = getSemaineType(currentMonday);

        // Update header
        const vendredi = new Date(currentMonday);
        vendredi.setDate(vendredi.getDate() + 4);
        document.getElementById('weekLabel').innerHTML =
            formatSemaineLabel(currentMonday) +
            ` <span class="badge-ab badge-${semType.toLowerCase()}">${semType}</span>` +
            `<small>${currentMonday.getFullYear()}</small>`;

        // Check if entire week is vacances
        const vacCheck = isVacances(currentMonday);
        if (vacCheck) {
            // Check if ALL 5 days are in vacances
            let allVac = true;
            for (let d = 0; d < 5; d++) {
                const day = new Date(currentMonday);
                day.setDate(day.getDate() + d);
                if (!isVacances(day)) { allVac = false; break; }
            }
            if (allVac) {
                grid.innerHTML = `<div class="vacances-banner"><span class="emoji">üèñÔ∏è</span>Vacances ‚Äî ${vacCheck.label}</div>`;
                renderAlerts();
                return;
            }
        }

        grid.innerHTML = '';
        const dayOffsets = [0, 1, 2, 3, 4]; // Mon to Fri
        const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];

        for (let i = 0; i < 5; i++) {
            const dayDate = new Date(currentMonday);
            dayDate.setDate(dayDate.getDate() + dayOffsets[i]);
            const dateISO = formatDateISO(dayDate);
            const isToday = dateISO === todayISO;
            const isPast = dayDate < today;

            const col = document.createElement('div');
            col.className = 'day-col';

            // Day header
            const header = document.createElement('div');
            header.className = 'day-header' + (isToday ? ' today' : '');
            header.innerHTML = `<div class="day-name">${dayNames[i]}</div><div class="day-date">${dayDate.getDate()}</div>`;
            col.appendChild(header);

            // Check special day conditions
            const vacDay = isVacances(dayDate);
            const ferDay = isFerie(dayDate);
            const absDay = isAbsencePerso(dayDate);

            if (vacDay) {
                col.appendChild(createSpecialBlock('üèñÔ∏è', 'Vacances', vacDay.label, 'cb-vacances'));
                grid.appendChild(col);
                continue;
            }
            if (ferDay) {
                col.appendChild(createSpecialBlock('üéâ', 'F√©ri√©', ferDay.label, 'cb-ferie'));
                grid.appendChild(col);
                continue;
            }
            if (absDay) {
                col.appendChild(createSpecialBlock('üö´', 'Absence', absDay.label, 'cb-ferie'));
                grid.appendChild(col);
                continue;
            }

            // Wednesday check ‚Äî no PSE courses
            const dayOfWeek = dayDate.getDay();
            if (dayOfWeek === 3) { // Mercredi
                const empty = document.createElement('div');
                empty.className = 'course-block cb-vide no-click';
                empty.style.textAlign = 'center';
                empty.style.minHeight = '60px';
                empty.style.display = 'flex';
                empty.style.alignItems = 'center';
                empty.style.justifyContent = 'center';
                empty.innerHTML = '<span style="font-size:13px;">‚Äî</span>';
                col.appendChild(empty);
                grid.appendChild(col);
                continue;
            }

            // Get courses for this day and group concurrent ones (C1VAN + C2VAN)
            const rawCourses = getCoursForDay(dayDate);
            const courses = groupConcurrentCourses(rawCourses);

            if (courses.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'course-block cb-vide no-click';
                empty.style.textAlign = 'center';
                empty.innerHTML = '<span style="font-size:12px;color:var(--muted);">Pas de cours</span>';
                col.appendChild(empty);
            } else {
                courses.forEach(cours => {
                    const block = createCourseBlock(cours, dayDate, dateISO, isPast, isToday);
                    col.appendChild(block);
                });
            }

            grid.appendChild(col);
        }

        renderAlerts();
    }

    function createSpecialBlock(emoji, title, sub, cssClass) {
        const block = document.createElement('div');
        block.className = `course-block ${cssClass} no-click`;
        block.innerHTML = `<div style="text-align:center;padding:8px 0;">
            <div style="font-size:20px;">${emoji}</div>
            <div style="font-size:13px;font-weight:600;margin-top:4px;">${title}</div>
            <div style="font-size:11px;opacity:0.8;">${sub}</div>
        </div>`;
        return block;
    }

    function createCourseBlock(cours, dayDate, dateISO, isPast, isToday) {
        const classeId = cours.classe;
        const block = document.createElement('div');

        // ‚îÄ‚îÄ CHEF D'OEUVRE ‚Üí gray non-clickable ‚îÄ‚îÄ
        if (cours.type === 'chef_oeuvre') {
            block.className = 'course-block no-click';
            block.style.cssText = 'background:var(--surface);color:var(--muted);cursor:default;';
            block.innerHTML = `
                <div class="cb-heure">${cours.heure}‚Äì${cours.heureFin}</div>
                <div class="cb-classe">üé® Chef d'≈ìuvre ¬∑ ${cours.classe} ¬∑ ${cours.salle || ''}</div>`;
            return block;
        }

        // Determine which classes to check (for grouped courses)
        const classesToCheck = cours._grouped ? cours._classes : [classeId];

        // Check PFMP ‚Äî for grouped courses, ALL classes must be in PFMP
        let pfmpPeriod = null;
        let allPfmp = true;
        classesToCheck.forEach(c => {
            const p = isPFMP(dayDate, c);
            if (p) { if (!pfmpPeriod) pfmpPeriod = p; }
            else { allPfmp = false; }
        });
        if (pfmpPeriod && allPfmp) {
            block.className = 'course-block cb-pfmp no-click';
            block.innerHTML = `
                <div class="cb-heure">${cours.heure}‚Äì${cours.heureFin}</div>
                <div class="cb-classe">${classeId}</div>
                <div class="cb-module">üè≠ ${pfmpPeriod.label || 'PFMP'}</div>`;
            return block;
        }

        // Find matching log (check any class in the group)
        let log = null;
        classesToCheck.forEach(c => { if (!log) log = findLog(dateISO, c); });

        // Find matching prevue (check any class in the group)
        let prevue = null;
        if (cours._grouped) {
            cours._classes.forEach(c => { if (!prevue) prevue = findPrevueForWeek(c, dayDate); });
        } else {
            prevue = findPrevueForWeek(classeId, dayDate);
        }

        // Alternance badge
        const altBadge = cours.alternance !== 'toutes' ? `<span class="cb-badge-alt">${cours.alternance}</span>` : '';

        if (log) {
            // ‚îÄ‚îÄ SAISIE EXISTS ‚îÄ‚îÄ
            const statut = (log.statut || '').toLowerCase();
            let cssClass = 'cb-realise';
            let icon = '‚úÖ';
            if (statut.includes('report')) { cssClass = 'cb-reporte'; icon = 'üîÑ'; }
            else if (statut.includes('non') || statut.includes('annul')) { cssClass = 'cb-annule'; icon = 'üö´'; }

            const moduleText = log.moduleId ? cleanModuleName(log.moduleId) : '';
            const seanceText = log.seance || '';
            const meteoEmoji = log.meteo ? (log.meteo.emoji || '') : '';

            block.className = `course-block ${cssClass}`;
            block.innerHTML = `${altBadge}
                <div class="cb-heure">${cours.heure}‚Äì${cours.heureFin}</div>
                <div class="cb-classe">${classeId} ${meteoEmoji}</div>
                <div class="cb-module">${moduleText}${seanceText ? ' ‚Äî ' + seanceText : ''}</div>
                <div class="cb-status">${icon} ${log.statut || 'R√©alis√©'}</div>`;
            block.addEventListener('click', () => showLogDetail(log, cours, dateISO));

        } else if (isPast || isToday) {
            // ‚îÄ‚îÄ PAST / TODAY WITHOUT LOG ‚Üí √Ä SAISIR ‚îÄ‚îÄ
            const moduleText = prevue ? cleanModuleName(prevue.module || prevue.moduleBase || '') : '';

            block.className = 'course-block cb-a-saisir';
            block.innerHTML = `${altBadge}
                <div class="cb-heure">${cours.heure}‚Äì${cours.heureFin}</div>
                <div class="cb-classe">${classeId}</div>
                <div class="cb-module">${moduleText || '√Ä saisir'}</div>
                <div class="cb-status">‚óã Non saisi</div>`;
            block.addEventListener('click', () => {
                if (cours._grouped) {
                    showGroupedClassPicker(cours._classes, dateISO);
                } else {
                    window.location.href = `log.html?date=${dateISO}&classe=${classeId}`;
                }
            });

        } else if (prevue) {
            // ‚îÄ‚îÄ FUTURE WITH PLAN ‚îÄ‚îÄ
            const moduleText = cleanModuleName(prevue.module || prevue.moduleBase || '');
            const seanceText = prevue.seance || '';

            block.className = 'course-block cb-planifie';
            block.innerHTML = `${altBadge}
                <div class="cb-heure">${cours.heure}‚Äì${cours.heureFin}</div>
                <div class="cb-classe">${classeId}</div>
                <div class="cb-module">${moduleText}${seanceText ? ' ‚Äî ' + seanceText : ''}</div>
                <div class="cb-status">üìÖ Planifi√©</div>`;
            block.addEventListener('click', () => {
                if (cours._grouped) {
                    showGroupedClassPicker(cours._classes, dateISO, cours, prevue);
                } else {
                    showPlanDetail(prevue, cours, dateISO, classeId);
                }
            });

        } else {
            // ‚îÄ‚îÄ FUTURE WITHOUT PLAN ‚îÄ‚îÄ
            block.className = 'course-block cb-vide';
            block.innerHTML = `${altBadge}
                <div class="cb-heure">${cours.heure}‚Äì${cours.heureFin}</div>
                <div class="cb-classe">${classeId}</div>
                <div class="cb-module" style="color:var(--muted);">Non planifi√©</div>`;
            block.addEventListener('click', () => {
                if (cours._grouped) {
                    showGroupedClassPicker(cours._classes, dateISO, cours, null);
                } else {
                    showPlanDetail(null, cours, dateISO, classeId);
                }
            });
        }

        return block;
    }

    // ‚ïê‚ïê‚ïê GROUPED CLASS PICKER (C1VAN + C2VAN) ‚ïê‚ïê‚ïê
    function showGroupedClassPicker(classes, dateISO, coursObj, prevueObj) {
        const isFutureMode = arguments.length > 2;
        const existing = document.getElementById('groupedClassPicker');
        if (existing) existing.remove();

        const overlay = document.createElement('div');
        overlay.id = 'groupedClassPicker';
        overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;';
        overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });

        const modal = document.createElement('div');
        modal.style.cssText = 'background:var(--surface);border-radius:var(--radius);padding:24px;min-width:260px;max-width:340px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.4);';
        modal.innerHTML = '<div style="font-size:16px;font-weight:600;margin-bottom:16px;color:var(--text);">Quelle classe ?</div>';

        classes.forEach(c => {
            const btn = document.createElement('button');
            btn.textContent = c;
            btn.style.cssText = 'display:block;width:100%;padding:14px;margin-bottom:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);font-size:15px;font-weight:600;cursor:pointer;transition:all 0.15s;';
            btn.addEventListener('mouseenter', () => { btn.style.background = 'var(--primary)'; btn.style.borderColor = 'var(--primary)'; });
            btn.addEventListener('mouseleave', () => { btn.style.background = 'var(--surface-2)'; btn.style.borderColor = 'var(--border)'; });
            btn.addEventListener('click', () => {
                overlay.remove();
                if (isFutureMode) {
                    const chosenPrevue = findPrevueForWeek(c, new Date(dateISO + 'T12:00:00'));
                    showPlanDetail(chosenPrevue, coursObj, dateISO, c);
                } else {
                    window.location.href = `log.html?date=${dateISO}&classe=${c}`;
                }
            });
            modal.appendChild(btn);
        });

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Annuler';
        cancelBtn.style.cssText = 'display:block;width:100%;padding:10px;border:none;background:transparent;color:var(--muted);font-size:13px;cursor:pointer;margin-top:4px;';
        cancelBtn.addEventListener('click', () => overlay.remove());
        modal.appendChild(cancelBtn);

        overlay.appendChild(modal);
        document.body.appendChild(overlay);
    }

    // ‚ïê‚ïê‚ïê FIND DATA HELPERS ‚ïê‚ïê‚ïê
    function findLog(dateISO, classeId) {
        // docId pattern: YYYY-MM-DD_CLASSEID
        for (let i = 0; i < allLogs.length; i++) {
            const log = allLogs[i];
            const logDate = log.date || '';
            const logClasse = log.classeDocId || log.classeId || '';
            if (logDate === dateISO && classesMatch(logClasse, classeId)) return log;
        }
        return null;
    }

    function findPrevueForWeek(classeId, dayDate) {
        const dateStr = formatDateISO(dayDate);
        // Convert to DD/MM/YYYY for matching against prevue semaines
        const dd = String(dayDate.getDate()).padStart(2, '0');
        const mm = String(dayDate.getMonth() + 1).padStart(2, '0');
        const yyyy = dayDate.getFullYear();
        const dateFR = `${dd}/${mm}/${yyyy}`;

        // Find the Monday of this week in DD/MM/YYYY format for week matching
        const mondayOfWeek = getLundi(dayDate);
        const mondayDD = String(mondayOfWeek.getDate()).padStart(2, '0');
        const mondayMM = String(mondayOfWeek.getMonth() + 1).padStart(2, '0');
        const mondayYYYY = mondayOfWeek.getFullYear();
        const mondayStr = `${mondayDD}/${mondayMM}/${mondayYYYY}`;

        for (let i = 0; i < allPrevue.length; i++) {
            const p = allPrevue[i];
            if (!classesMatch(p.classeId, classeId)) continue;
            const semaines = p.semaines || [];
            for (let j = 0; j < semaines.length; j++) {
                const sem = semaines[j];
                const semDate = (sem.date || '').trim();
                // Match: semaine date is the Monday of this week
                if (semDate === mondayStr || semDate === dateFR) {
                    // Skip vacances/PFMP situations
                    const sit = (sem.situation || '').toLowerCase();
                    if (sit.includes('vacances') || sit.includes('pfmp')) continue;
                    return sem;
                }
            }
        }
        return null;
    }

    // ‚ïê‚ïê‚ïê DETAIL MODALS ‚ïê‚ïê‚ïê
    function showLogDetail(log, cours, dateISO) {
        const modal = document.getElementById('detailModal');
        document.getElementById('detailTitle').textContent = `${log.classeId || cours.classe} ‚Äî ${dateISO}`;

        const moduleText = log.moduleId || '';
        const seanceText = log.seance || '';
        const statutText = log.statut || '';
        const arretText = log.arret || '';
        const meteo = log.meteo ? `${log.meteo.emoji || ''} ${log.meteo.label || ''}` : '';

        let html = '';
        if (moduleText) html += detailRow('Module', moduleText);
        if (seanceText) html += detailRow('S√©ance', seanceText);
        if (statutText) html += detailRow('Statut', statutText);
        if (arretText) html += detailRow('Arr√™t', arretText);
        if (meteo) html += detailRow('M√©t√©o', meteo);

        // Checklist
        const cl = log.checklist || {};
        const checkItems = Object.keys(cl).filter(k => cl[k]);
        if (checkItems.length > 0) {
            html += detailRow('Checklist', checkItems.map(k => k.replace(/_/g, ' ')).join(', '));
        }

        // CPS
        if (log.cps) {
            const cpsText = Object.entries(log.cps)
                .filter(([k, v]) => v)
                .map(([k, v]) => `${k}: ${v}`)
                .join(', ');
            if (cpsText) html += detailRow('CPS', cpsText);
        }

        // Notes
        if (log.remarque) html += detailRow('Notes', log.remarque);

        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailActions').innerHTML = `
            <a href="log.html?date=${dateISO}&classe=${cours.classe}" class="btn-modal primary">‚úèÔ∏è Modifier</a>
            <button class="btn-modal secondary" onclick="closeDetailModal()">Fermer</button>`;
        modal.classList.add('active');
    }

    function showPlanDetail(prevue, cours, dateISO, classeId) {
        const modal = document.getElementById('detailModal');
        document.getElementById('detailTitle').textContent = `${classeId} ‚Äî ${dateISO}`;

        let html = '';
        html += detailRow('Horaire', `${cours.heure} ‚Äì ${cours.heureFin}`);
        html += detailRow('Salle', cours.salle);
        if (cours.alternance !== 'toutes') html += detailRow('Alternance', cours.alternance);

        if (prevue) {
            if (prevue.module || prevue.moduleBase) html += detailRow('Module pr√©vu', prevue.module || prevue.moduleBase);
            if (prevue.seance) html += detailRow('S√©ance', prevue.seance);
            if (prevue.phase) html += detailRow('Phase', prevue.phase);
            if (prevue.situation && prevue.situation !== 'Normal') html += detailRow('Situation', prevue.situation);
        } else {
            html += '<p style="color:var(--muted);font-size:13px;padding:12px 0;">Aucune planification pour cette semaine. Utilisez le Dashboard pour planifier.</p>';
        }

        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailActions').innerHTML = `
            <a href="log.html?date=${dateISO}&classe=${classeId}" class="btn-modal primary">‚úèÔ∏è Saisir</a>
            <a href="dashboard.html" class="btn-modal secondary">üìà Dashboard</a>`;
        modal.classList.add('active');
    }

    function detailRow(label, value) {
        return `<div class="detail-row"><span class="detail-label">${label}</span><span class="detail-value">${value}</span></div>`;
    }

    window.closeDetailModal = function() {
        document.getElementById('detailModal').classList.remove('active');
    };

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(m => {
        m.addEventListener('click', (e) => {
            if (e.target === m) m.classList.remove('active');
        });
    });

    // ‚ïê‚ïê‚ïê ALERTS ‚ïê‚ïê‚ïê
    function renderAlerts() {
        const bar = document.getElementById('alertsBar');
        const alerts = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // 1. Cours pass√©s non saisis (cette semaine)
        for (let d = 0; d < 5; d++) {
            const dayDate = new Date(currentMonday);
            dayDate.setDate(dayDate.getDate() + d);
            if (dayDate > today) continue;
            if (isVacances(dayDate) || isFerie(dayDate) || isAbsencePerso(dayDate)) continue;

            const courses = getCoursForDay(dayDate);
            courses.forEach(cours => {
                if (isPFMP(dayDate, cours.classe)) return;
                const log = findLog(formatDateISO(dayDate), cours.classe);
                if (!log) {
                    const daysAgo = Math.round((today - dayDate) / (24 * 60 * 60 * 1000));
                    alerts.push({
                        type: 'urgent',
                        text: `${cours.classe} ‚Äî non saisi` + (daysAgo > 0 ? ` (il y a ${daysAgo}j)` : ' (aujourd\'hui)')
                    });
                }
            });
        }

        // 2. Copies chain alerts from all logs
        allLogs.forEach(log => {
            const cl = log.checklist || {};
            if (cl.copies_ramassees && !cl.copies_corrigees) {
                alerts.push({ type: 'warn', text: `${log.classeId} ‚Äî copies √† corriger` });
            }
            if (cl.copies_corrigees && !cl.copies_rendues) {
                alerts.push({ type: 'info', text: `${log.classeId} ‚Äî copies √† rendre` });
            }
        });

        if (alerts.length === 0) {
            bar.style.display = 'none';
            return;
        }

        bar.style.display = 'flex';
        bar.innerHTML = alerts.map(a =>
            `<span class="alert-chip ${a.type}">${a.type === 'urgent' ? 'üî¥' : a.type === 'warn' ? 'üü†' : 'üü°'} ${a.text}</span>`
        ).join('');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SETTINGS ‚Äî CSV Import, Pronote, QR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Settings tabs
    document.querySelectorAll('.settings-tab').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('stab' + btn.dataset.stab.charAt(0).toUpperCase() + btn.dataset.stab.slice(1)).classList.add('active');
        });
    });

    document.getElementById('btnSettings').addEventListener('click', () => {
        document.getElementById('settingsModal').classList.add('active');
        renderQrCode();
    });

    window.closeSettings = function() {
        document.getElementById('settingsModal').classList.remove('active');
    };

    // ‚ïê‚ïê‚ïê CSV IMPORT ‚ïê‚ïê‚ïê
    function normalizeClassToken(v) {
        return (v || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .toUpperCase().replace(/[^A-Z0-9]/g, '');
    }

    function looksLikeClassValue(v) {
        var raw = (v || '').toString().trim();
        if (!raw) return false;
        var lower = raw.toLowerCase();
        if (['n/a','na','-'].includes(lower) || /vacances|pfmp|jour|f√©ri|ferie|s√©ance|seance|brainstorming|questionnaire|√©valuation|evaluation|correction/i.test(lower)) return false;
        var norm = normalizeClassToken(raw);
        if (!norm) return false;
        return /^(C[12]|B[12]|BT|CAP|BAC|TAG)/.test(norm) || /(PSR|CAN|JP|HORT|VAN|MELEC|AGO|AGORA|GATL)/.test(norm);
    }

    function buildClassDocId(v) {
        return (v || '').toString().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .toUpperCase().replace(/[^A-Z0-9]+/g, '_').replace(/^_+|_+$/g, '');
    }

    function parseCSV(text, filename) {
        var sep = ';';
        var lines = text.split('\n');
        if (lines.length < 2) return null;
        var header = lines[0].split(sep).map(h => h.trim());

        var moduleColCandidates = [], suiteColCandidates = [];
        for (var h = 0; h < header.length; h++) {
            if (header[h].match(/^Modules\s/i)) moduleColCandidates.push(h);
            if (header[h].match(/^Suite\s/i)) suiteColCandidates.push(h);
        }

        var colMap = {};
        header.forEach((name, idx) => {
            var n = name.toLowerCase().trim();
            if (n === 'semaines' || n.startsWith('semaines')) colMap.semaine = idx;
            if (n === 's') colMap.s = idx;
            if (n === 'a/b') colMap.ab = idx;
            if (n === 'situation') colMap.situation = idx;
            if (n === 'dates' || n.startsWith('dates')) colMap.dates = idx;
            if (n === 'classe') colMap.classe = idx;
            if (n.startsWith('objectif du module')) colMap.objectifModule = idx;
            if (n.startsWith('objectif de la')) colMap.objectifSeance = idx;
            if (n === 'nb de s√©ances pr√©vues' || n.match(/nb.*s.ances/i)) colMap.nbSeances = idx;
            if (n.startsWith('s√©ances') || n.startsWith('seances')) colMap.seance = idx;
            if (n === 'statut') colMap.statut = idx;
            if (n === 'valid√©' || n === 'valide') colMap.valide = idx;
            if (n.match(/√©valuations? diagn/i) || n.match(/evaluations? diagn/i)) colMap.evalDiag = idx;
            if (n.match(/√©valuations? form/i) || n.match(/evaluations? form/i)) colMap.evalForm = idx;
            if (n.match(/^√©valuation$/i) || n.match(/^evaluation$/i)) colMap.evaluation = idx;
        });

        var rows = [];
        var currentRow = [], inQuote = false, currentField = '';
        for (var i = 1; i < lines.length; i++) {
            var line = lines[i];
            if (!inQuote) { currentRow = []; currentField = ''; }
            for (var c = 0; c < line.length; c++) {
                var ch = line[c];
                if (ch === '"') inQuote = !inQuote;
                else if (ch === sep && !inQuote) { currentRow.push(currentField.trim()); currentField = ''; }
                else currentField += ch;
            }
            if (inQuote) { currentField += '\n'; continue; }
            currentRow.push(currentField.trim());
            if (currentRow.length > 1 && currentRow[0]) rows.push(currentRow);
        }

        var activeModuleCol = -1;
        for (var mc = 0; mc < moduleColCandidates.length; mc++) {
            var col = moduleColCandidates[mc];
            for (var r = 0; r < Math.min(rows.length, 15); r++) {
                var val = (rows[r][col] || '').trim();
                if (val && val !== 'N/A' && val !== 'Vacances scolaires' && val !== 'PFMP') { activeModuleCol = col; break; }
            }
            if (activeModuleCol >= 0) break;
        }

        var activeSuiteCol = -1;
        for (var sc = 0; sc < suiteColCandidates.length; sc++) {
            var col2 = suiteColCandidates[sc];
            for (var r2 = 0; r2 < Math.min(rows.length, 20); r2++) {
                var val2 = (rows[r2][col2] || '').trim();
                if (val2 && val2 !== 'N/A' && val2.match(/[‚û©‚û´‚á®]/)) { activeSuiteCol = col2; break; }
            }
            if (activeSuiteCol >= 0) break;
        }

        var classeId = '';
        var classeFromFile = filename.replace(/-Tableau.*$/i, '').replace(/\.csv$/i, '').trim();
        var classCounts = {};
        if (colMap.classe !== undefined) {
            for (var r3 = 0; r3 < rows.length; r3++) {
                var cv = (rows[r3][colMap.classe] || '').trim();
                if (!looksLikeClassValue(cv)) continue;
                classCounts[cv] = (classCounts[cv] || 0) + 1;
            }
        }
        var bestClass = '', bestCount = 0;
        Object.keys(classCounts).forEach(k => { if (classCounts[k] > bestCount) { bestClass = k; bestCount = classCounts[k]; } });
        if (bestClass) classeId = bestClass;
        if (looksLikeClassValue(classeFromFile)) classeId = classeFromFile;
        if (!classeId) classeId = classeFromFile;

        var niveau = 'INCONNU';
        if (activeModuleCol >= 0) {
            var colH = header[activeModuleCol] || '';
            if (colH.match(/CAP/i)) niveau = 'CAP';
            else if (colH.match(/BACPRO\s*T/i)) niveau = 'BAC_PRO_TERM';
            else if (colH.match(/BACPRO\s*1/i)) niveau = 'BAC_PRO_1ERE';
            else if (colH.match(/BACPRO\s*2/i)) niveau = 'BAC_PRO_2NDE';
        }

        var semaines = [];
        for (var r4 = 0; r4 < rows.length; r4++) {
            var row = rows[r4];
            var dateStr = (row[colMap.semaine] || '').trim();
            if (!dateStr) continue;
            var situation = (row[colMap.situation] || '').trim();
            var moduleVal = activeModuleCol >= 0 ? (row[activeModuleCol] || '').trim() : '';
            var suiteVal = activeSuiteCol >= 0 ? (row[activeSuiteCol] || '').trim() : '';
            moduleVal = moduleVal.replace(/\n/g, ' ').trim();
            suiteVal = suiteVal.replace(/\n/g, ' ').trim();
            if (moduleVal === situation) moduleVal = '';

            var phase = 'cours', transition = '', moduleBase = moduleVal;
            if (moduleVal) {
                var transMatch = moduleVal.match(/\+\s*(module suivant|suite module)/i);
                if (transMatch) transition = transMatch[1].toLowerCase().replace(/\s+/g, '_');
                if (moduleVal.match(/[‚Äì\-]\s*[√â√©Ee]valuation/i)) phase = 'evaluation';
                else if (moduleVal.match(/[‚Äì\-]\s*Corr(ection|\.)/i)) phase = 'correction';
                else if (moduleVal.match(/Pr[√©e]sentation\s+PSE/i)) phase = 'presentation';
                else if (moduleVal.match(/^(√âvaluation|Evaluation)$/i)) phase = 'evaluation';
                else if (moduleVal.match(/^Correction/i)) phase = 'correction';
                moduleBase = moduleVal.replace(/\s*[‚Äì\-]\s*(√âvaluation|Evaluation|Correction|Corr\.).*$/i, '').trim();
                if (!moduleBase || moduleBase === moduleVal) {
                    var codeMatch = moduleVal.match(/^([A-Z]+\d+(?:\.\d+)?)\s*[‚Äì\-]\s*/i);
                    if (codeMatch) moduleBase = moduleVal.replace(/\s*[‚Äì\-]\s*(√âvaluation|Evaluation|Correction|Corr\.).*$/i, '').trim();
                }
            }

            var suiteTransition = '';
            if (suiteVal) {
                if (suiteVal.match(/Module suivant/i)) suiteTransition = 'module_suivant';
                else if (suiteVal.match(/Suite module/i)) suiteTransition = 'suite_module';
            }

            var sem = {
                date: dateStr, semaine: (row[colMap.s] || '').trim(), ab: (row[colMap.ab] || '').trim(),
                situation: situation, module: moduleVal || '', moduleBase: moduleBase || '', phase: phase,
                transition: transition, suiteModule: suiteVal || '', suiteTransition: suiteTransition,
                seance: colMap.seance !== undefined ? (row[colMap.seance] || '').trim() : '',
                nbSeancesPrevues: colMap.nbSeances !== undefined ? parseInt(row[colMap.nbSeances]) || 0 : 0,
                objectifModule: colMap.objectifModule !== undefined ? (row[colMap.objectifModule] || '').trim() : '',
                objectifSeance: colMap.objectifSeance !== undefined ? (row[colMap.objectifSeance] || '').trim() : '',
                statut: colMap.statut !== undefined ? (row[colMap.statut] || '').trim() : '',
                valide: colMap.valide !== undefined ? (row[colMap.valide] || '').trim().toUpperCase() === 'VRAI' : false
            };
            if (colMap.evalDiag !== undefined) sem.evalDiag = (row[colMap.evalDiag] || '').trim();
            if (colMap.evalForm !== undefined) sem.evalForm = (row[colMap.evalForm] || '').trim();
            if (colMap.evaluation !== undefined) sem.evaluation = (row[colMap.evaluation] || '').trim();
            semaines.push(sem);
        }

        return { classeId, csvFilename: filename, niveau, semaines };
    }

    // CSV import handlers
    var importZone = document.getElementById('importZone');
    var fileInput = document.getElementById('fileInput');

    importZone.addEventListener('click', () => fileInput.click());
    importZone.addEventListener('dragover', (e) => { e.preventDefault(); importZone.classList.add('dragover'); });
    importZone.addEventListener('dragleave', () => importZone.classList.remove('dragover'));
    importZone.addEventListener('drop', (e) => { e.preventDefault(); importZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    async function handleFiles(files) {
        var progressDiv = document.getElementById('importProgress');
        progressDiv.innerHTML = '';
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            if (!file.name.endsWith('.csv') && !file.name.endsWith('.txt')) { addItem(progressDiv, file.name, 'Pas un CSV', 'err'); continue; }
            if (file.name.toLowerCase().includes('vierge')) { addItem(progressDiv, file.name, 'Ignor√© (vierge)', 'err'); continue; }
            try {
                var text = await file.text();
                var parsed = parseCSV(text, file.name);
                if (!parsed || parsed.semaines.length === 0) { addItem(progressDiv, file.name, 'Aucune donn√©e', 'err'); continue; }
                var docId = buildClassDocId(parsed.classeId);
                if (!docId) throw new Error('Classe invalide');
                await setDoc(doc(db, 'progression_prevue', docId), {
                    classeId: parsed.classeId, csvFilename: parsed.csvFilename, niveau: parsed.niveau,
                    semaines: parsed.semaines, importedAt: serverTimestamp(), importedBy: currentUser.uid
                });
                addItem(progressDiv, parsed.classeId + ' (' + parsed.semaines.length + ' sem.)', '‚úì Import√©', 'ok');
            } catch (err) {
                addItem(progressDiv, file.name, 'Erreur: ' + err.message, 'err');
            }
        }
        showToast('Import termin√© !');
    }

    function addItem(container, name, status, type) {
        var div = document.createElement('div');
        div.className = 'import-item';
        div.innerHTML = `<span>${name}</span><span class="status ${type}">${status}</span>`;
        container.appendChild(div);
    }

    // ‚ïê‚ïê‚ïê PRONOTE SYNC ‚ïê‚ïê‚ïê
    const ICS_URL = 'https://0692390y.index-education.net/pronote/ical/mesinformations.ics?icalsecurise=5FCC8714D0288D0C735DBB51F2A682873D9407D68F403E748C4860B26B18CFA16BE48C43C48C24A416FA30C689813A61&version=2025.2.9&param=900A75DF9ED8C62E212781A9E4DCC937';
    const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

    document.getElementById('btnSync').addEventListener('click', syncPronote);

    async function syncPronote() {
        var btn = document.getElementById('btnSync');
        var status = document.getElementById('syncStatus');
        btn.disabled = true; btn.textContent = '‚è≥ Synchronisation...'; status.textContent = 'Chargement...';
        try {
            var response = await fetch(CORS_PROXY + encodeURIComponent(ICS_URL));
            if (!response.ok) throw new Error('HTTP ' + response.status);
            var icsText = await response.text();
            var events = parseICS(icsText);
            if (events.length === 0) throw new Error('Aucun √©v√©nement trouv√©');
            await setDoc(doc(db, 'progression_config', 'emploi_du_temps'), {
                events, syncedAt: serverTimestamp(), syncedBy: currentUser.uid, eventCount: events.length
            });
            status.textContent = '‚úÖ ' + events.length + ' cours synchronis√©s';
            showToast('‚úÖ ' + events.length + ' cours synchronis√©s !');
        } catch (err) {
            status.textContent = '‚ùå Erreur: ' + err.message;
        }
        btn.disabled = false; btn.textContent = 'üîÑ Synchroniser Pronote';
    }

    function parseICS(text) {
        var events = [];
        var blocks = text.split('BEGIN:VEVENT');
        for (var i = 1; i < blocks.length; i++) {
            var block = blocks[i].split('END:VEVENT')[0];
            var ev = {}, lines = block.split('\n'), currentKey = '', currentVal = '';
            for (var j = 0; j < lines.length; j++) {
                var line = lines[j].replace(/\r$/, '');
                if (line.match(/^[\s\t]/)) { currentVal += line.substring(1); continue; }
                if (currentKey) ev[currentKey] = currentVal;
                var colonIdx = line.indexOf(':');
                if (colonIdx > 0) {
                    var rawKey = line.substring(0, colonIdx);
                    var semiIdx = rawKey.indexOf(';');
                    currentKey = semiIdx > 0 ? rawKey.substring(0, semiIdx) : rawKey;
                    currentVal = line.substring(colonIdx + 1);
                }
            }
            if (currentKey) ev[currentKey] = currentVal;
            var dtStart = parseICSDate(ev.DTSTART || '');
            var dtEnd = parseICSDate(ev.DTEND || '');
            var summary = (ev.SUMMARY || '').replace(/\\,/g, ',').replace(/\\n/g, ' ').trim();
            var location = (ev.LOCATION || '').replace(/\\,/g, ',').replace(/\\n/g, ' ').trim();
            var description = (ev.DESCRIPTION || '').replace(/\\,/g, ',').replace(/\\n/g, '\n').trim();
            if (!dtStart || !summary) continue;
            var classe = '';
            var descLines = description.split('\n');
            for (var k = 0; k < descLines.length; k++) {
                if (descLines[k].trim().match(/^(C[12]|B[12T]|CPSE|BPSE|TAG)/)) { classe = descLines[k].trim(); break; }
            }
            if (!classe) { var sumMatch = summary.match(/(C[12]\w+|B[12T]\w+|CPSE\d|BPSE\d|TAG\w+)/); if (sumMatch) classe = sumMatch[1]; }
            var salle = location.replace(/^SALLE\s*/i, '').trim();
            events.push({ start: dtStart.toISOString(), end: dtEnd ? dtEnd.toISOString() : '', summary, location: salle, classe, description: description.substring(0, 200) });
        }
        return events;
    }

    function parseICSDate(str) {
        if (!str) return null;
        str = str.replace(/[^\dTZ]/g, '');
        if (str.length < 15) return null;
        var y = parseInt(str.substring(0,4)), m = parseInt(str.substring(4,6))-1, d = parseInt(str.substring(6,8));
        var h = parseInt(str.substring(9,11)), min = parseInt(str.substring(11,13)), s = parseInt(str.substring(13,15));
        return str.endsWith('Z') ? new Date(Date.UTC(y,m,d,h,min,s)) : new Date(y,m,d,h,min,s);
    }

    async function loadPronoteEdt() {
        try {
            var edtDoc = await getDoc(doc(db, 'progression_config', 'emploi_du_temps'));
            if (edtDoc.exists()) {
                var data = edtDoc.data();
                var syncDate = data.syncedAt ? new Date(data.syncedAt.seconds * 1000).toLocaleString('fr-FR') : '';
                document.getElementById('syncStatus').textContent = '‚úÖ ' + (data.eventCount || 0) + ' cours (' + syncDate + ')';
            }
        } catch (e) {}
    }

    // ‚ïê‚ïê‚ïê QR CODE ‚ïê‚ïê‚ïê
    var BASE_URL = 'https://preventionsanteenvironnement.github.io/CockpitProgression/';

    function renderQrCode() {
        var url = BASE_URL + 'log.html';
        var qrApiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=250x250&format=png&data=' + encodeURIComponent(url);
        document.getElementById('qrCard').innerHTML = `
            <h4>QR Universel</h4>
            <div class="qr-sub">D√©tecte automatiquement la classe via Pronote</div>
            <img src="${qrApiUrl}" alt="QR Code" width="200" height="200">
            <div class="qr-url">${url}</div>
            <button class="btn-print" onclick="printQr()">üñ®Ô∏è Imprimer</button>`;
    }

    window.printQr = function() {
        var url = BASE_URL + 'log.html';
        var qrApiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=400x400&format=png&data=' + encodeURIComponent(url);
        var w = window.open('', '_blank');
        w.document.write('<html><head><title>QR CockpitPSE</title><style>body{font-family:sans-serif;text-align:center;padding:40px;}h1{font-size:2em;}p{color:#666;font-size:0.9em;word-break:break-all;}</style></head>' +
            '<body><h1>Saisie PSE</h1><img src="' + qrApiUrl + '" width="300" height="300"><p>' + url + '</p>' +
            '<script>setTimeout(function(){window.print();},500)<\/script></body></html>');
    };

    // ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê
    function showToast(msg, duration) {
        duration = duration || 2500;
        var t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), duration);
    }

</script>
</body>
</html>
