<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cockpit Progression PSE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --primary: #6366f1;
            --primary-light: #e0e7ff;
            --success: #22c55e;
            --success-light: #dcfce7;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --border: #e2e8f0;
            --radius: 14px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        .login-screen {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
        }
        .login-card {
            background: var(--card); border-radius: 20px; padding: 50px 40px;
            text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            max-width: 400px; width: 100%;
        }
        .login-icon { font-size: 3.5em; margin-bottom: 15px; }
        .login-card h2 { font-size: 1.6em; font-weight: 800; margin-bottom: 8px; }
        .login-card p { color: var(--muted); margin-bottom: 30px; }
        .btn-google {
            display: inline-flex; align-items: center; gap: 12px;
            padding: 14px 30px; border: 2px solid var(--border); border-radius: 50px;
            background: white; font-size: 1em; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: all 0.2s;
        }
        .btn-google:hover { border-color: var(--primary); background: var(--primary-light); }
        .btn-google svg { width: 20px; height: 20px; }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; flex-wrap: wrap; gap: 10px;
        }
        .header h1 { font-size: 1.5em; font-weight: 800; }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .user-email { font-size: 0.8em; color: var(--muted); }
        .btn-logout {
            padding: 8px 16px; border: 1px solid var(--border); border-radius: 8px;
            background: white; font-size: 0.8em; cursor: pointer; font-family: inherit;
        }
        .btn-logout:hover { background: var(--danger-light); color: var(--danger); border-color: var(--danger); }

        /* ‚îÄ‚îÄ QUICK ACTIONS ‚îÄ‚îÄ */
        .quick-actions {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px; margin-bottom: 25px;
        }
        .btn-quick {
            display: flex; align-items: center; gap: 12px;
            padding: 18px 16px; background: var(--card); border-radius: var(--radius);
            text-decoration: none; color: var(--text);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: all 0.2s;
            border: 2px solid transparent;
        }
        .btn-quick:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .btn-quick .icon { font-size: 1.8em; }
        .btn-quick .label { font-weight: 700; font-size: 0.85em; }
        .btn-quick .sub { font-size: 0.75em; color: var(--muted); }
        .btn-quick.primary-action { background: linear-gradient(135deg, var(--primary), #818cf8); color: white; }
        .btn-quick.primary-action .sub { color: rgba(255,255,255,0.7); }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .card {
            background: var(--card); border-radius: var(--radius); padding: 22px;
            margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .card-title {
            font-weight: 700; font-size: 1em; margin-bottom: 18px;
            display: flex; align-items: center; gap: 8px;
        }
        .card-title .count {
            background: var(--primary-light); color: var(--primary);
            padding: 2px 10px; border-radius: 20px; font-size: 0.8em;
        }

        /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px; margin-bottom: 25px;
        }
        .stat-card {
            background: var(--card); border-radius: var(--radius); padding: 18px;
            text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .stat-value { font-size: 2em; font-weight: 800; }
        .stat-label { font-size: 0.75em; color: var(--muted); font-weight: 600; margin-top: 4px; }
        .stat-card.success .stat-value { color: var(--success); }
        .stat-card.warning .stat-value { color: var(--warning); }
        .stat-card.danger .stat-value { color: var(--danger); }
        .stat-card.primary .stat-value { color: var(--primary); }

        /* ‚îÄ‚îÄ IMPORT ‚îÄ‚îÄ */
        .import-zone {
            border: 3px dashed var(--border); border-radius: var(--radius);
            padding: 40px 20px; text-align: center; cursor: pointer;
            transition: all 0.2s; position: relative;
        }
        .import-zone:hover, .import-zone.dragover { border-color: var(--primary); background: var(--primary-light); }
        .import-zone .icon { font-size: 2.5em; margin-bottom: 10px; }
        .import-zone p { color: var(--muted); font-size: 0.9em; }
        .import-zone input[type="file"] {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }
        .import-progress { margin-top: 15px; }
        .import-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 15px; background: var(--bg); border-radius: 10px;
            margin-bottom: 6px; font-size: 0.85em;
        }
        .import-item .status { font-weight: 700; }
        .import-item .status.ok { color: var(--success); }
        .import-item .status.err { color: var(--danger); }

        /* ‚îÄ‚îÄ RECENT LOGS ‚îÄ‚îÄ */
        .log-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .log-item:last-child { border-bottom: none; }
        .log-badge {
            width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
        }
        .log-badge.terminee { background: var(--success); }
        .log-badge.en_cours { background: var(--warning); }
        .log-badge.non_commencee { background: var(--border); }
        .log-info { flex: 1; }
        .log-classe { font-weight: 700; font-size: 0.9em; }
        .log-module { font-size: 0.8em; color: var(--muted); }
        .log-date { font-size: 0.75em; color: var(--muted); white-space: nowrap; }

        /* ‚îÄ‚îÄ ALERT ITEMS ‚îÄ‚îÄ */
        .alert-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; border-radius: 10px; margin-bottom: 6px;
            font-size: 0.85em; font-weight: 500;
        }
        .alert-item.warn { background: var(--warning-light); color: #92400e; }
        .alert-item.err { background: var(--danger-light); color: #991b1b; }
        .alert-item .alert-icon { font-size: 1.2em; }

        /* ‚îÄ‚îÄ CLASSES LIST ‚îÄ‚îÄ */
        .classes-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .class-card {
            padding: 14px; border-radius: 10px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .class-name { font-weight: 700; font-size: 0.9em; }
        .class-badge {
            padding: 3px 10px; border-radius: 20px; font-size: 0.7em; font-weight: 700;
        }
        .class-badge.cap { background: #dbeafe; color: #1e40af; }
        .class-badge.bac { background: #dcfce7; color: #166534; }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        .toast {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--success); color: white;
            padding: 14px 30px; border-radius: 14px;
            font-weight: 700; z-index: 1000; opacity: 0;
            transition: all 0.3s ease; font-size: 0.95em;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
        .tabs {
            display: flex; gap: 4px; margin-bottom: 20px; background: var(--bg);
            border-radius: 12px; padding: 4px; border: 1px solid var(--border);
        }
        .tab {
            flex: 1; padding: 10px 15px; border: none; border-radius: 10px;
            background: transparent; font-family: inherit; font-size: 0.85em;
            font-weight: 600; cursor: pointer; color: var(--muted); transition: all 0.2s;
        }
        .tab.active { background: white; color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }

        .section { display: none; }
        .section.active { display: block; }

        /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
        .empty { text-align: center; padding: 40px 20px; color: var(--muted); }
        .empty .icon { font-size: 2.5em; margin-bottom: 10px; }

        /* ‚îÄ‚îÄ EMPLOI DU TEMPS ‚îÄ‚îÄ */
        .edt-today { margin-bottom: 20px; }
        .edt-slot {
            display: flex; align-items: center; gap: 14px;
            padding: 14px; border-radius: 12px; margin-bottom: 8px;
            background: white; border: 2px solid var(--border); transition: all 0.15s;
        }
        .edt-slot.is-now { border-color: var(--primary); background: var(--primary-light); }
        .edt-slot.is-past { opacity: 0.5; }
        .edt-heure { font-size: 0.85em; font-weight: 800; min-width: 50px; color: var(--primary); }
        .edt-info { flex: 1; }
        .edt-classe { font-weight: 700; font-size: 0.95em; }
        .edt-matiere { font-size: 0.78em; color: var(--muted); }
        .edt-salle { font-size: 0.75em; font-weight: 700; padding: 3px 10px; border-radius: 20px; background: var(--bg); color: var(--muted); }
        .edt-sync-bar {
            display: flex; align-items: center; gap: 12px; margin-bottom: 18px; flex-wrap: wrap;
        }
        .btn-sync {
            padding: 10px 20px; border: 2px solid var(--primary); border-radius: 10px;
            background: var(--primary-light); color: var(--primary);
            font-weight: 700; font-size: 0.85em; cursor: pointer; font-family: inherit;
            transition: all 0.15s;
        }
        .btn-sync:hover { background: var(--primary); color: white; }
        .btn-sync:disabled { opacity: 0.4; cursor: not-allowed; }
        .sync-status { font-size: 0.8em; color: var(--muted); }
        .edt-day-group { margin-bottom: 20px; }
        .edt-day-title { font-weight: 700; font-size: 0.9em; margin-bottom: 8px; color: var(--primary); }

        /* ‚îÄ‚îÄ QR CODES ‚îÄ‚îÄ */
        .qr-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .qr-card {
            background: white; border-radius: var(--radius); padding: 25px;
            text-align: center; border: 2px solid var(--border);
        }
        .qr-card h3 { font-size: 1.1em; font-weight: 800; margin-bottom: 4px; }
        .qr-card .qr-sub { font-size: 0.8em; color: var(--muted); margin-bottom: 15px; }
        .qr-card img { border-radius: 10px; margin-bottom: 12px; }
        .qr-url { font-size: 0.65em; color: var(--muted); word-break: break-all; padding: 8px; background: var(--bg); border-radius: 8px; }
        .btn-print {
            display: inline-flex; align-items: center; gap: 6px; margin-top: 12px;
            padding: 8px 18px; border: 2px solid var(--border); border-radius: 8px;
            background: white; font-size: 0.8em; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: all 0.15s;
        }
        .btn-print:hover { border-color: var(--primary); background: var(--primary-light); }

        @media (max-width: 600px) {
            .container { padding: 12px; }
            .header h1 { font-size: 1.2em; }
            .quick-actions { grid-template-columns: 1fr 1fr; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .tab { font-size: 0.75em; padding: 8px 10px; white-space: nowrap; min-width: fit-content; }
            .qr-grid { grid-template-columns: 1fr; }
        }

        @media print {
            body { background: white; }
            .header, .tabs, .quick-actions, .stats-grid, #tabOverview, #tabImport, #tabClasses, #tabEdt, .toast { display: none !important; }
            #tabQr { display: block !important; }
            .qr-card { break-inside: avoid; border: 3px solid #000; page-break-inside: avoid; }
            .qr-url { font-size: 0.8em; }
            .btn-print { display: none; }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <div class="login-icon">üìä</div>
        <h2>Cockpit Progression</h2>
        <p>Suivi de progression PSE</p>
        <button class="btn-google" id="btnGoogle">
            <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Connexion Google
        </button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="mainScreen" style="display:none;">
<div class="container">

    <!-- HEADER -->
    <div class="header">
        <h1>üìä Cockpit Progression</h1>
        <div class="header-actions">
            <span class="user-email" id="userEmail"></span>
            <button class="btn-logout" id="btnLogout">D√©co</button>
        </div>
    </div>

    <!-- QUICK ACTIONS -->
    <div class="quick-actions">
        <a href="log.html" class="btn-quick primary-action">
            <div>
                <div class="icon">üìù</div>
            </div>
            <div>
                <div class="label">Saisie rapide</div>
                <div class="sub">Logger une s√©ance</div>
            </div>
        </a>
        <a href="dashboard.html" class="btn-quick">
            <div class="icon">üìà</div>
            <div>
                <div class="label">Dashboard</div>
                <div class="sub">Vue compl√®te</div>
            </div>
        </a>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab active" data-tab="overview">Accueil</button>
        <button class="tab" data-tab="import">Import CSV</button>
        <button class="tab" data-tab="classes">Classes</button>
        <button class="tab" data-tab="edt">Emploi du temps</button>
        <button class="tab" data-tab="qr">QR Codes</button>
    </div>

    <!-- ‚îÄ‚îÄ TAB: OVERVIEW ‚îÄ‚îÄ -->
    <div id="tabOverview" class="section active">
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card primary"><div class="stat-value" id="statClasses">-</div><div class="stat-label">Classes</div></div>
            <div class="stat-card success"><div class="stat-value" id="statValidees">-</div><div class="stat-label">Semaines valid√©es</div></div>
            <div class="stat-card warning"><div class="stat-value" id="statLogs">-</div><div class="stat-label">Saisies</div></div>
            <div class="stat-card danger"><div class="stat-value" id="statAlertes">-</div><div class="stat-label">Alertes</div></div>
        </div>

        <!-- ALERTS -->
        <div class="card" id="alertsCard" style="display:none;">
            <div class="card-title">‚ö†Ô∏è Alertes <span class="count" id="alertsCount"></span></div>
            <div id="alertsList"></div>
        </div>

        <!-- RECENT LOGS -->
        <div class="card">
            <div class="card-title">üìã Derni√®res saisies</div>
            <div id="recentList">
                <div class="empty">
                    <div class="icon">üìù</div>
                    <p>Aucune saisie pour l'instant.<br>Scannez un QR code ou utilisez la saisie rapide.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: IMPORT CSV ‚îÄ‚îÄ -->
    <div id="tabImport" class="section">
        <div class="card">
            <div class="card-title">üì• Importer les progressions Numbers</div>
            <p style="color:var(--muted); font-size:0.85em; margin-bottom:15px;">
                Exportez chaque onglet de Numbers en CSV, puis glissez-les ici.<br>
                Vous pouvez importer plusieurs fichiers √† la fois.
            </p>
            <div class="import-zone" id="importZone">
                <input type="file" id="fileInput" multiple accept=".csv,.txt">
                <div class="icon">üìÇ</div>
                <p><strong>Glissez vos CSV ici</strong> ou cliquez pour s√©lectionner</p>
            </div>
            <div class="import-progress" id="importProgress"></div>
        </div>

        <div class="card" id="importedCard" style="display:none;">
            <div class="card-title">‚úÖ Progressions import√©es <span class="count" id="importedCount"></span></div>
            <div id="importedList"></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: CLASSES ‚îÄ‚îÄ -->
    <div id="tabClasses" class="section">
        <div class="card">
            <div class="card-title">üéì Classes enregistr√©es</div>
            <div id="classesList" class="classes-grid">
                <div class="empty">
                    <div class="icon">üì•</div>
                    <p>Importez d'abord vos CSV Numbers.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: EMPLOI DU TEMPS ‚îÄ‚îÄ -->
    <div id="tabEdt" class="section">
        <div class="card">
            <div class="card-title">üìÖ Emploi du temps Pronote</div>
            <div class="edt-sync-bar">
                <button class="btn-sync" id="btnSync">üîÑ Synchroniser Pronote</button>
                <span class="sync-status" id="syncStatus">Non synchronis√©</span>
            </div>
            <p style="color:var(--muted); font-size:0.82em; margin-bottom:15px;">
                La synchronisation r√©cup√®re votre emploi du temps depuis Pronote et le stocke dans l'application.<br>
                Il sera utilis√© pour pr√©-remplir automatiquement la classe dans la saisie rapide.
            </p>
            <div id="edtContent">
                <div class="empty">
                    <div class="icon">üìÖ</div>
                    <p>Cliquez sur "Synchroniser Pronote" pour charger votre emploi du temps.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB: QR CODES ‚îÄ‚îÄ -->
    <div id="tabQr" class="section">
        <div class="card">
            <div class="card-title">üì± QR Code universel</div>
            <p style="color:var(--muted); font-size:0.82em; margin-bottom:18px;">
                Imprimez ce QR code. En scannant, la saisie rapide d√©tecte automatiquement la classe via votre emploi du temps Pronote.
            </p>
            <button class="btn-print" onclick="window.print()" style="margin-bottom:18px;">üñ®Ô∏è Imprimer le QR code</button>
            <div class="qr-grid" id="qrGrid"></div>
        </div>
    </div>

</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
        getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc,
        collection, query, orderBy, limit, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import {
        getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect,
        getRedirectResult, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const firebaseConfig = {
        apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0lQcLI",
        authDomain: "devoirs-pse.firebaseapp.com",
        projectId: "devoirs-pse",
        storageBucket: "devoirs-pse.firebasestorage.app",
        messagingSenderId: "614730413904",
        appId: "1:614730413904:web:a5dd478af5de30f6bede55"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    let currentUser = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            loadDataAndEdt();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
        }
    });

    document.getElementById('btnGoogle').addEventListener('click', async () => {
        try {
            await signInWithPopup(auth, googleProvider);
        } catch (e) {
            if (e.code === 'auth/popup-blocked' || e.code === 'auth/cancelled-popup-request') {
                await signInWithRedirect(auth, googleProvider);
            } else {
                console.error('Auth error:', e);
                alert('Erreur connexion : ' + e.message);
            }
        }
    });
    getRedirectResult(auth).catch(e => console.error('Redirect result error:', e));
    document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.querySelectorAll('.tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            btn.classList.add('active');
            var tabName = btn.dataset.tab;
            var sectionId = 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            document.getElementById(sectionId).classList.add('active');
        });
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showToast(msg, duration) {
        duration = duration || 2500;
        var t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(function() { t.classList.remove('show'); }, duration);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CSV PARSER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function normalizeClassToken(v) {
        return (v || '')
            .toString()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toUpperCase()
            .replace(/[^A-Z0-9]/g, '');
    }

    function looksLikeClassValue(v) {
        var raw = (v || '').toString().trim();
        if (!raw) return false;

        var lower = raw.toLowerCase();
        if (
            lower === 'n/a' ||
            lower === 'na' ||
            lower === '-' ||
            lower.includes('vacances') ||
            lower.includes('pfmp') ||
            lower.includes('jour') ||
            lower.includes('f√©ri') ||
            lower.includes('ferie') ||
            lower.includes('s√©ance') ||
            lower.includes('seance') ||
            lower.includes('brainstorming') ||
            lower.includes('questionnaire') ||
            lower.includes('√©valuation') ||
            lower.includes('evaluation') ||
            lower.includes('correction')
        ) {
            return false;
        }

        var norm = normalizeClassToken(raw);
        if (!norm) return false;

        return /^(C[12]|B[12]|BT|CAP|BAC|TAG)/.test(norm) ||
            /(PSR|CAN|JP|HORT|VAN|MELEC|AGO|AGORA|GATL)/.test(norm);
    }

    function buildClassDocId(v) {
        return (v || '')
            .toString()
            .trim()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toUpperCase()
            .replace(/[^A-Z0-9]+/g, '_')
            .replace(/^_+|_+$/g, '');
    }

    function parseCSV(text, filename) {
        // Detect separator
        var sep = ';';
        var lines = text.split('\n');
        if (lines.length < 2) return null;

        // Parse header
        var header = lines[0].split(sep).map(function(h) { return h.trim(); });

        // Find module column (the one that's NOT always N/A)
        var moduleColCandidates = [];
        var suiteColCandidates = [];
        for (var h = 0; h < header.length; h++) {
            if (header[h].match(/^Modules\s/i)) moduleColCandidates.push(h);
            if (header[h].match(/^Suite\s/i)) suiteColCandidates.push(h);
        }

        // Find key column indices
        var colMap = {};
        header.forEach(function(name, idx) {
            var n = name.toLowerCase().trim();
            if (n === 'semaines' || n.startsWith('semaines')) colMap.semaine = idx;
            if (n === 's') colMap.s = idx;
            if (n === 'a/b') colMap.ab = idx;
            if (n === 'situation') colMap.situation = idx;
            if (n === 'dates' || n.startsWith('dates')) colMap.dates = idx;
            if (n === 'classe') colMap.classe = idx;
            if (n.startsWith('objectif du module')) colMap.objectifModule = idx;
            if (n.startsWith('objectif de la')) colMap.objectifSeance = idx;
            if (n === 'nb de s√©ances pr√©vues' || n.match(/nb.*s.ances/i)) colMap.nbSeances = idx;
            if (n.startsWith('s√©ances') || n.startsWith('seances')) colMap.seance = idx;
            if (n === 'statut') colMap.statut = idx;
            if (n === 'valid√©' || n === 'valide') colMap.valide = idx;
            if (n.match(/√©valuations? diagn/i) || n.match(/evaluations? diagn/i)) colMap.evalDiag = idx;
            if (n.match(/√©valuations? form/i) || n.match(/evaluations? form/i)) colMap.evalForm = idx;
            if (n.match(/^√©valuation$/) || n.match(/^evaluation$/)) colMap.evaluation = idx;
        });

        // Parse rows - handle multi-line CSV values (quoted fields)
        var rows = [];
        var currentRow = [];
        var inQuote = false;
        var currentField = '';

        for (var i = 1; i < lines.length; i++) {
            var line = lines[i];
            if (!inQuote) {
                currentRow = [];
                currentField = '';
            }

            for (var c = 0; c < line.length; c++) {
                var ch = line[c];
                if (ch === '"') {
                    inQuote = !inQuote;
                } else if (ch === sep && !inQuote) {
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += ch;
                }
            }

            if (inQuote) {
                currentField += '\n';
                continue;
            }

            currentRow.push(currentField.trim());
            if (currentRow.length > 1 && currentRow[0]) {
                rows.push(currentRow);
            }
        }

        // Determine which module column has actual data (not N/A)
        var activeModuleCol = -1;
        for (var mc = 0; mc < moduleColCandidates.length; mc++) {
            var col = moduleColCandidates[mc];
            for (var r = 0; r < Math.min(rows.length, 15); r++) {
                var val = (rows[r][col] || '').trim();
                if (val && val !== 'N/A' && val !== 'Vacances scolaires' && val !== 'PFMP') {
                    activeModuleCol = col;
                    break;
                }
            }
            if (activeModuleCol >= 0) break;
        }

        // Also find the active "suite module" column
        var activeSuiteCol = -1;
        for (var sc = 0; sc < suiteColCandidates.length; sc++) {
            var col2 = suiteColCandidates[sc];
            for (var r2 = 0; r2 < Math.min(rows.length, 20); r2++) {
                var val2 = (rows[r2][col2] || '').trim();
                if (val2 && val2 !== 'N/A' && val2.match(/[‚û©‚û´‚á®]/)) {
                    activeSuiteCol = col2;
                    break;
                }
            }
            if (activeSuiteCol >= 0) break;
        }

        // Detect classe from data + filename
        var classeId = '';
        var classeFromFile = filename.replace(/-Tableau.*$/i, '').replace(/\.csv$/i, '').trim();
        var classCounts = {};

        if (colMap.classe !== undefined) {
            for (var r3 = 0; r3 < rows.length; r3++) {
                var cv = (rows[r3][colMap.classe] || '').trim();
                if (!looksLikeClassValue(cv)) continue;
                classCounts[cv] = (classCounts[cv] || 0) + 1;
            }
        }

        var bestClass = '';
        var bestCount = 0;
        Object.keys(classCounts).forEach(function(k) {
            if (classCounts[k] > bestCount) {
                bestClass = k;
                bestCount = classCounts[k];
            }
        });
        if (bestClass) classeId = bestClass;

        // If filename itself looks like a class label, prefer it (CSV column often contains N/A/noise)
        if (looksLikeClassValue(classeFromFile)) {
            classeId = classeFromFile;
        }

        if (!classeId) {
            // Final fallback
            classeId = classeFromFile;
        }

        // Detect niveau from module column header
        var niveau = 'INCONNU';
        if (activeModuleCol >= 0) {
            var colHeader = header[activeModuleCol] || '';
            if (colHeader.match(/CAP/i)) niveau = 'CAP';
            else if (colHeader.match(/BACPRO\s*T/i)) niveau = 'BAC_PRO_TERM';
            else if (colHeader.match(/BACPRO\s*1/i)) niveau = 'BAC_PRO_1ERE';
            else if (colHeader.match(/BACPRO\s*2/i)) niveau = 'BAC_PRO_2NDE';
        }

        // Build semaines array
        var semaines = [];
        for (var r4 = 0; r4 < rows.length; r4++) {
            var row = rows[r4];
            var dateStr = (row[colMap.semaine] || '').trim();
            if (!dateStr) continue;

            var situation = (row[colMap.situation] || '').trim();
            var moduleVal = activeModuleCol >= 0 ? (row[activeModuleCol] || '').trim() : '';
            var suiteVal = activeSuiteCol >= 0 ? (row[activeSuiteCol] || '').trim() : '';

            // Clean module name (remove trailing newlines)
            moduleVal = moduleVal.replace(/\n/g, ' ').trim();
            suiteVal = suiteVal.replace(/\n/g, ' ').trim();

            // Skip if module is same as situation (vacances etc)
            if (moduleVal === situation) moduleVal = '';

            // ‚îÄ‚îÄ Parse phase & transition from module text ‚îÄ‚îÄ
            // Examples: "C3 ‚Äì Les acteurs de pr√©vention" ‚Üí phase=cours
            //           "C3 ‚Äì √âvaluation" ‚Üí phase=evaluation
            //           "A7 ‚Äì Correction + module suivant" ‚Üí phase=correction, transition=module_suivant
            //           "Pr√©sentation PSE" ‚Üí phase=presentation
            var phase = 'cours';
            var transition = '';
            var moduleBase = moduleVal;

            if (moduleVal) {
                // Detect transition first (+ module suivant / + suite module)
                var transMatch = moduleVal.match(/\+\s*(module suivant|suite module)/i);
                if (transMatch) {
                    transition = transMatch[1].toLowerCase().replace(/\s+/g, '_');
                }

                // Detect phase from module text
                if (moduleVal.match(/[‚Äì\-]\s*[√â√©Ee]valuation/i)) {
                    phase = 'evaluation';
                } else if (moduleVal.match(/[‚Äì\-]\s*Corr(ection|\.)/i)) {
                    phase = 'correction';
                } else if (moduleVal.match(/Pr[√©e]sentation\s+PSE/i)) {
                    phase = 'presentation';
                } else if (moduleVal.match(/^(√âvaluation|Evaluation)$/i)) {
                    phase = 'evaluation';
                } else if (moduleVal.match(/^Correction/i)) {
                    phase = 'correction';
                }

                // Extract base module name (without phase/transition suffixes)
                moduleBase = moduleVal
                    .replace(/\s*[‚Äì\-]\s*(√âvaluation|Evaluation|Correction|Corr\.).*$/i, '')
                    .replace(/^\s*(√âvaluation|Evaluation|Correction|Corr\.).*$/i, moduleVal)
                    .trim();
                // If the whole string was a phase keyword, keep original as moduleBase
                if (!moduleBase || moduleBase === moduleVal) {
                    // Try to extract just the module code + title
                    var codeMatch = moduleVal.match(/^([A-Z]+\d+(?:\.\d+)?)\s*[‚Äì\-]\s*/i);
                    if (codeMatch) {
                        moduleBase = moduleVal.replace(/\s*[‚Äì\-]\s*(√âvaluation|Evaluation|Correction|Corr\.).*$/i, '').trim();
                    }
                }
            }

            // ‚îÄ‚îÄ Parse suite module transition type ‚îÄ‚îÄ
            var suiteTransition = '';
            if (suiteVal) {
                if (suiteVal.match(/Module suivant/i)) suiteTransition = 'module_suivant';
                else if (suiteVal.match(/Suite module/i)) suiteTransition = 'suite_module';
            }

            var sem = {
                date: dateStr,
                semaine: (row[colMap.s] || '').trim(),
                ab: (row[colMap.ab] || '').trim(),
                situation: situation,
                module: moduleVal || '',
                moduleBase: moduleBase || '',
                phase: phase,
                transition: transition,
                suiteModule: suiteVal || '',
                suiteTransition: suiteTransition,
                seance: colMap.seance !== undefined ? (row[colMap.seance] || '').trim() : '',
                nbSeancesPrevues: colMap.nbSeances !== undefined ? parseInt(row[colMap.nbSeances]) || 0 : 0,
                objectifModule: colMap.objectifModule !== undefined ? (row[colMap.objectifModule] || '').trim() : '',
                objectifSeance: colMap.objectifSeance !== undefined ? (row[colMap.objectifSeance] || '').trim() : '',
                statut: colMap.statut !== undefined ? (row[colMap.statut] || '').trim() : '',
                valide: colMap.valide !== undefined ? (row[colMap.valide] || '').trim().toUpperCase() === 'VRAI' : false
            };

            // Add evaluation columns if present
            if (colMap.evalDiag !== undefined) sem.evalDiag = (row[colMap.evalDiag] || '').trim();
            if (colMap.evalForm !== undefined) sem.evalForm = (row[colMap.evalForm] || '').trim();
            if (colMap.evaluation !== undefined) sem.evaluation = (row[colMap.evaluation] || '').trim();

            semaines.push(sem);
        }

        return {
            classeId: classeId,
            csvFilename: filename,
            niveau: niveau,
            semaines: semaines
        };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CSV IMPORT HANDLER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    var importZone = document.getElementById('importZone');
    var fileInput = document.getElementById('fileInput');

    importZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        importZone.classList.add('dragover');
    });
    importZone.addEventListener('dragleave', function() {
        importZone.classList.remove('dragover');
    });
    importZone.addEventListener('drop', function(e) {
        e.preventDefault();
        importZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });

    async function handleFiles(files) {
        var progressDiv = document.getElementById('importProgress');
        progressDiv.innerHTML = '';

        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            if (!file.name.endsWith('.csv') && !file.name.endsWith('.txt')) {
                addImportItem(progressDiv, file.name, 'Pas un CSV', 'err');
                continue;
            }

            // Skip vierge files
            if (file.name.toLowerCase().includes('vierge')) {
                addImportItem(progressDiv, file.name, 'Ignor√© (vierge)', 'err');
                continue;
            }

            try {
                var text = await file.text();
                var parsed = parseCSV(text, file.name);
                if (!parsed || parsed.semaines.length === 0) {
                    addImportItem(progressDiv, file.name, 'Aucune donn√©e', 'err');
                    continue;
                }

                // Save to Firestore
                var docId = buildClassDocId(parsed.classeId);
                if (!docId) throw new Error('Classe invalide (docId vide)');
                await setDoc(doc(db, 'progression_prevue', docId), {
                    classeId: parsed.classeId,
                    csvFilename: parsed.csvFilename,
                    niveau: parsed.niveau,
                    semaines: parsed.semaines,
                    importedAt: serverTimestamp(),
                    importedBy: currentUser.uid
                });

                addImportItem(progressDiv, parsed.classeId + ' (' + parsed.semaines.length + ' sem.)', '‚úì Import√©', 'ok');
            } catch (err) {
                console.error('Import error:', err);
                addImportItem(progressDiv, file.name, 'Erreur: ' + err.message, 'err');
            }
        }

        showToast('Import termin√© !');
        loadData();
    }

    function addImportItem(container, name, status, type) {
        var div = document.createElement('div');
        div.className = 'import-item';
        div.innerHTML = '<span>' + name + '</span><span class="status ' + type + '">' + status + '</span>';
        container.appendChild(div);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOAD DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    var allPrevue = [];
    var allLogs = [];

    async function loadData() {
        try {
            // Load progression prevue
            var prevueSnap = await getDocs(collection(db, 'progression_prevue'));
            allPrevue = [];
            prevueSnap.forEach(function(d) { allPrevue.push({ id: d.id, ...d.data() }); });

            // Load logs
            var logsSnap = await getDocs(collection(db, 'progression_logs'));
            allLogs = [];
            logsSnap.forEach(function(d) { allLogs.push({ id: d.id, ...d.data() }); });
            allLogs.sort(function(a, b) {
                var ta = a.timestamp ? a.timestamp.seconds : 0;
                var tb = b.timestamp ? b.timestamp.seconds : 0;
                return tb - ta;
            });

            renderOverview();
            renderClasses();
            renderImported();
        } catch (err) {
            console.error('loadData error:', err);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER OVERVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderOverview() {
        // Stats
        document.getElementById('statClasses').textContent = allPrevue.length;
        document.getElementById('statLogs').textContent = allLogs.length;

        // Count validated weeks
        var totalValidees = 0;
        allPrevue.forEach(function(p) {
            (p.semaines || []).forEach(function(s) {
                if (s.valide) totalValidees++;
            });
        });
        document.getElementById('statValidees').textContent = totalValidees;

        // Alerts
        var alerts = [];
        allLogs.forEach(function(log) {
            var cl = log.checklist || {};
            if (cl.copies_ramassees && !cl.copies_corrigees) {
                alerts.push({ type: 'warn', text: log.classeId + ' ‚Äî Copies √† corriger (' + log.date + ')' });
            }
            if (cl.copies_corrigees && !cl.copies_rendues) {
                alerts.push({ type: 'warn', text: log.classeId + ' ‚Äî Copies √† rendre (' + log.date + ')' });
            }
            if (cl.eval_passee && !cl.eval_corrigee) {
                alerts.push({ type: 'err', text: log.classeId + ' ‚Äî √âvaluation √† corriger (' + log.date + ')' });
            }
            if (cl.eval_corrigee && !cl.eval_rendue) {
                alerts.push({ type: 'warn', text: log.classeId + ' ‚Äî √âvaluation √† rendre (' + log.date + ')' });
            }
        });

        document.getElementById('statAlertes').textContent = alerts.length;

        var alertsCard = document.getElementById('alertsCard');
        var alertsList = document.getElementById('alertsList');
        if (alerts.length > 0) {
            alertsCard.style.display = 'block';
            document.getElementById('alertsCount').textContent = alerts.length;
            alertsList.innerHTML = '';
            alerts.forEach(function(a) {
                var div = document.createElement('div');
                div.className = 'alert-item ' + a.type;
                div.innerHTML = '<span class="alert-icon">' + (a.type === 'err' ? 'üî¥' : 'üü°') + '</span>' + a.text;
                alertsList.appendChild(div);
            });
        } else {
            alertsCard.style.display = 'none';
        }

        // Recent logs
        var recentDiv = document.getElementById('recentList');
        if (allLogs.length === 0) {
            recentDiv.innerHTML = '<div class="empty"><div class="icon">üìù</div><p>Aucune saisie pour l\'instant.</p></div>';
            return;
        }

        recentDiv.innerHTML = '';
        var shown = allLogs.slice(0, 10);
        shown.forEach(function(log) {
            var div = document.createElement('div');
            div.className = 'log-item';
            var dateDisplay = log.date || '';
            div.innerHTML = '<div class="log-badge ' + (log.statut || '') + '"></div>' +
                '<div class="log-info">' +
                '<div class="log-classe">' + (log.classeId || '') + '</div>' +
                '<div class="log-module">' + (log.moduleId || '') + ' ‚Äî ' + (log.seance || '') + '</div>' +
                '</div>' +
                '<div class="log-date">' + dateDisplay + '</div>';
            recentDiv.appendChild(div);
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER CLASSES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderClasses() {
        var container = document.getElementById('classesList');
        if (allPrevue.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üì•</div><p>Importez d\'abord vos CSV Numbers.</p></div>';
            return;
        }

        container.innerHTML = '';
        allPrevue.sort(function(a, b) { return a.classeId.localeCompare(b.classeId); });
        allPrevue.forEach(function(p) {
            var div = document.createElement('div');
            div.className = 'class-card';
            var niveauClass = p.niveau === 'CAP' ? 'cap' : 'bac';
            var niveauLabel = p.niveau === 'CAP' ? 'CAP' : 'BAC PRO';
            div.innerHTML = '<span class="class-name">' + p.classeId + '</span>' +
                '<span class="class-badge ' + niveauClass + '">' + niveauLabel + '</span>';
            container.appendChild(div);
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER IMPORTED ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderImported() {
        var card = document.getElementById('importedCard');
        var list = document.getElementById('importedList');
        if (allPrevue.length === 0) {
            card.style.display = 'none';
            return;
        }
        card.style.display = 'block';
        document.getElementById('importedCount').textContent = allPrevue.length;
        list.innerHTML = '';
        allPrevue.forEach(function(p) {
            var nbNormal = (p.semaines || []).filter(function(s) { return s.situation === 'Normal'; }).length;
            var nbValide = (p.semaines || []).filter(function(s) { return s.valide; }).length;
            var div = document.createElement('div');
            div.className = 'import-item';
            div.innerHTML = '<span>' + p.classeId + ' ‚Äî ' + p.niveau + ' (' + nbNormal + ' cours, ' + nbValide + ' valid√©s)</span>' +
                '<span class="status ok">‚úì</span>';
            list.appendChild(div);
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EMPLOI DU TEMPS ‚Äî PRONOTE iCal
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const ICS_URL = 'https://0692390y.index-education.net/pronote/ical/mesinformations.ics?icalsecurise=5FCC8714D0288D0C735DBB51F2A682873D9407D68F403E748C4860B26B18CFA16BE48C43C48C24A416FA30C689813A61&version=2025.2.9&param=900A75DF9ED8C62E212781A9E4DCC937';
    const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

    document.getElementById('btnSync').addEventListener('click', syncPronote);

    async function syncPronote() {
        var btn = document.getElementById('btnSync');
        var status = document.getElementById('syncStatus');
        btn.disabled = true;
        btn.textContent = '‚è≥ Synchronisation...';
        status.textContent = 'Chargement...';

        try {
            var response = await fetch(CORS_PROXY + encodeURIComponent(ICS_URL));
            if (!response.ok) throw new Error('HTTP ' + response.status);
            var icsText = await response.text();

            var events = parseICS(icsText);
            if (events.length === 0) throw new Error('Aucun √©v√©nement trouv√©');

            // Save to Firestore
            await setDoc(doc(db, 'progression_config', 'emploi_du_temps'), {
                events: events,
                syncedAt: serverTimestamp(),
                syncedBy: currentUser.uid,
                eventCount: events.length
            });

            status.textContent = '‚úÖ ' + events.length + ' cours synchronis√©s (' + new Date().toLocaleString('fr-FR') + ')';
            showToast('‚úÖ ' + events.length + ' cours synchronis√©s !');
            renderEdt(events);

        } catch (err) {
            console.error('Sync error:', err);
            status.textContent = '‚ùå Erreur: ' + err.message;
            showToast('Erreur synchronisation');
        }

        btn.disabled = false;
        btn.textContent = 'üîÑ Synchroniser Pronote';
    }

    function parseICS(text) {
        var events = [];
        var blocks = text.split('BEGIN:VEVENT');

        for (var i = 1; i < blocks.length; i++) {
            var block = blocks[i].split('END:VEVENT')[0];
            var ev = {};

            var lines = block.split('\n');
            var currentKey = '';
            var currentVal = '';

            for (var j = 0; j < lines.length; j++) {
                var line = lines[j].replace(/\r$/, '');
                // Continuation line (starts with space or tab)
                if (line.match(/^[\s\t]/)) {
                    currentVal += line.substring(1);
                    continue;
                }
                // Save previous field
                if (currentKey) {
                    ev[currentKey] = currentVal;
                }
                // Parse new field
                var colonIdx = line.indexOf(':');
                if (colonIdx > 0) {
                    var rawKey = line.substring(0, colonIdx);
                    // Remove parameters (e.g., DTSTART;TZID=...)
                    var semiIdx = rawKey.indexOf(';');
                    currentKey = semiIdx > 0 ? rawKey.substring(0, semiIdx) : rawKey;
                    currentVal = line.substring(colonIdx + 1);
                }
            }
            if (currentKey) ev[currentKey] = currentVal;

            // Parse dates
            var dtStart = parseICSDate(ev.DTSTART || '');
            var dtEnd = parseICSDate(ev.DTEND || '');
            var summary = (ev.SUMMARY || '').replace(/\\,/g, ',').replace(/\\n/g, ' ').trim();
            var location = (ev.LOCATION || '').replace(/\\,/g, ',').replace(/\\n/g, ' ').trim();
            var description = (ev.DESCRIPTION || '').replace(/\\,/g, ',').replace(/\\n/g, '\n').trim();

            if (!dtStart || !summary) continue;

            // Extract classe from description or summary
            var classe = '';
            var descLines = description.split('\n');
            for (var k = 0; k < descLines.length; k++) {
                var dl = descLines[k].trim();
                if (dl.match(/^(C[12]|B[12T]|CPSE|BPSE|TAG)/)) {
                    classe = dl;
                    break;
                }
            }
            // Also check summary
            if (!classe) {
                var sumMatch = summary.match(/(C[12]\w+|B[12T]\w+|CPSE\d|BPSE\d|TAG\w+)/);
                if (sumMatch) classe = sumMatch[1];
            }

            // Extract salle from location
            var salle = location.replace(/^SALLE\s*/i, '').trim();

            events.push({
                start: dtStart.toISOString(),
                end: dtEnd ? dtEnd.toISOString() : '',
                summary: summary,
                location: salle,
                classe: classe,
                description: description.substring(0, 200)
            });
        }

        return events;
    }

    function parseICSDate(str) {
        if (!str) return null;
        // Format: 20250901T073000Z or 20250901T093000
        str = str.replace(/[^\dTZ]/g, '');
        if (str.length < 15) return null;
        var y = parseInt(str.substring(0, 4));
        var m = parseInt(str.substring(4, 6)) - 1;
        var d = parseInt(str.substring(6, 8));
        var h = parseInt(str.substring(9, 11));
        var min = parseInt(str.substring(11, 13));
        var s = parseInt(str.substring(13, 15));

        if (str.endsWith('Z')) {
            return new Date(Date.UTC(y, m, d, h, min, s));
        }
        return new Date(y, m, d, h, min, s);
    }

    // Load EDT from Firestore on startup
    async function loadEdt() {
        try {
            var edtDoc = await getDoc(doc(db, 'progression_config', 'emploi_du_temps'));
            if (edtDoc.exists()) {
                var data = edtDoc.data();
                var syncDate = data.syncedAt ? new Date(data.syncedAt.seconds * 1000).toLocaleString('fr-FR') : '';
                document.getElementById('syncStatus').textContent = '‚úÖ ' + (data.eventCount || 0) + ' cours (' + syncDate + ')';
                renderEdt(data.events || []);
            }
        } catch (e) { console.error('loadEdt error:', e); }
    }

    function renderEdt(events) {
        var container = document.getElementById('edtContent');
        if (!events || events.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üìÖ</div><p>Aucun cours.</p></div>';
            return;
        }

        // Group by day
        var byDay = {};
        var jourNoms = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
        var now = new Date();

        events.forEach(function(ev) {
            var d = new Date(ev.start);
            var key = d.toISOString().split('T')[0];
            if (!byDay[key]) byDay[key] = [];
            byDay[key].push(ev);
        });

        // Sort days
        var days = Object.keys(byDay).sort();

        // Find today and this week
        var todayKey = now.toISOString().split('T')[0];
        var weekStart = new Date(now);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
        var weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        var weekStartKey = weekStart.toISOString().split('T')[0];
        var weekEndKey = weekEnd.toISOString().split('T')[0];

        // Show this week's events
        var weekDays = days.filter(function(d) { return d >= weekStartKey && d <= weekEndKey; });
        if (weekDays.length === 0) {
            // Show next available days
            var futureDays = days.filter(function(d) { return d >= todayKey; });
            weekDays = futureDays.slice(0, 5);
        }

        container.innerHTML = '';

        if (weekDays.length === 0) {
            container.innerHTML = '<div class="empty"><div class="icon">üìÖ</div><p>Aucun cours cette semaine.</p></div>';
            return;
        }

        weekDays.forEach(function(dayKey) {
            var dayEvents = byDay[dayKey];
            dayEvents.sort(function(a, b) { return a.start.localeCompare(b.start); });

            var d = new Date(dayKey + 'T12:00:00');
            var dayName = jourNoms[d.getDay()];
            var dateStr = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
            var isToday = dayKey === todayKey;

            var group = document.createElement('div');
            group.className = 'edt-day-group';
            group.innerHTML = '<div class="edt-day-title">' +
                (isToday ? 'üìç ' : '') + dayName.charAt(0).toUpperCase() + dayName.slice(1) + ' ' + dateStr +
                (isToday ? ' (aujourd\'hui)' : '') + '</div>';

            dayEvents.forEach(function(ev) {
                var startDate = new Date(ev.start);
                var endDate = ev.end ? new Date(ev.end) : null;
                var heure = startDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                var heureFin = endDate ? endDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '';

                var isNow = isToday && now >= startDate && endDate && now <= endDate;
                var isPast = isToday && endDate && now > endDate;

                var slot = document.createElement('div');
                slot.className = 'edt-slot' + (isNow ? ' is-now' : '') + (isPast ? ' is-past' : '');
                slot.innerHTML =
                    '<div class="edt-heure">' + heure + (heureFin ? '<br><span style="font-size:0.8em;color:var(--muted);">' + heureFin + '</span>' : '') + '</div>' +
                    '<div class="edt-info">' +
                        '<div class="edt-classe">' + (ev.classe || ev.summary) + '</div>' +
                        '<div class="edt-matiere">' + ev.summary + '</div>' +
                    '</div>' +
                    (ev.location ? '<div class="edt-salle">' + ev.location + '</div>' : '');

                group.appendChild(slot);
            });

            container.appendChild(group);
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // QR CODES GENERATOR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    var BASE_URL = 'https://preventionsanteenvironnement.github.io/CockpitProgression/';

    var QR_ROOMS = [
        { room: '', label: 'QR Universel', desc: 'D√©tecte automatiquement la classe via Pronote (heure + jour)', primary: true }
    ];

    function renderQrCodes() {
        var grid = document.getElementById('qrGrid');
        grid.innerHTML = '';

        QR_ROOMS.forEach(function(r) {
            var url = BASE_URL + 'log.html' + (r.room ? '?room=' + r.room : '');
            var qrApiUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=250x250&format=png&data=' + encodeURIComponent(url);

            var card = document.createElement('div');
            card.className = 'qr-card';
            if (r.primary) {
                card.style.borderColor = 'var(--primary)';
                card.style.background = 'var(--primary-light)';
            }
            card.innerHTML =
                (r.primary ? '<div style="font-size:0.7em;font-weight:700;color:var(--primary);margin-bottom:6px;">‚≠ê RECOMMANDE</div>' : '') +
                '<h3>' + r.label + '</h3>' +
                '<div class="qr-sub">' + r.desc + '</div>' +
                '<img src="' + qrApiUrl + '" alt="QR ' + r.label + '" width="200" height="200">' +
                '<div class="qr-url">' + url + '</div>' +
                '<button class="btn-print" onclick="printSingleQr(this)">üñ®Ô∏è Imprimer</button>';

            grid.appendChild(card);
        });
    }

    window.printSingleQr = function(btn) {
        var card = btn.closest('.qr-card');
        var title = card.querySelector('h3').textContent;
        var imgSrc = card.querySelector('img').src;
        var url = card.querySelector('.qr-url').textContent;
        var w = window.open('', '_blank');
        w.document.write('<html><head><title>QR ' + title + '</title>' +
            '<style>body{font-family:sans-serif;text-align:center;padding:40px;}h1{font-size:2em;}p{color:#666;font-size:0.9em;word-break:break-all;}</style></head>' +
            '<body><h1>' + title + '</h1><img src="' + imgSrc + '" width="300" height="300"><p>' + url + '</p>' +
            '<script>setTimeout(function(){window.print();},500)<\/script></body></html>');
    };

    // Init QR codes on load
    renderQrCodes();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOAD EDT ON STARTUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadDataAndEdt() {
        await loadData();
        await loadEdt();
    }

</script>
</body>
</html>
